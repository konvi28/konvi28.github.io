<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" type="image/webp" href="logo.webp">
    <link rel="shortcut icon" type="image/webp" href="logo.webp">
    <link rel="apple-touch-icon" href="logo.webp">
    <title>–ü–æ–µ—Ç–∏—á–Ω–∞ –ø–ª–∞—Ç—Ñ–æ—Ä–º–∞ - –°–ø—ñ–ª—å–Ω–æ—Ç–∞ –ø–æ–µ—Ç—ñ–≤</title>

    <!-- GitHub Pages SPA: –≤—ñ–¥–Ω–æ–≤–ª—é—î–º–æ URL –ø—ñ—Å–ª—è —Ä–µ–¥–∏—Ä–µ–∫—Ç—É —á–µ—Ä–µ–∑ 404.html -->
    <script>
        (function() {
            var redirect = sessionStorage.getItem('spa_redirect');
            if (redirect) {
                sessionStorage.removeItem('spa_redirect');
                // –í—ñ–¥–Ω–æ–≤–ª—é—î–º–æ —à–ª—è—Ö –±–µ–∑ –∑–∞–º—ñ–Ω–µ–Ω–Ω—è –≤ history
                window.history.replaceState(null, '', redirect);
            }
        })();
    </script>

    <!-- SEO -->
    <meta name="description" content="–ü–æ–µ—Ç–∏—á–Ω–∞ –ø–ª–∞—Ç—Ñ–æ—Ä–º–∞ KonVi ‚Äî —Å–ø—ñ–ª—å–Ω–æ—Ç–∞ —É–∫—Ä–∞—ó–Ω—Å—å–∫–∏—Ö –ø–æ–µ—Ç—ñ–≤. –ß–∏—Ç–∞–π—Ç–µ –≤—ñ—Ä—à—ñ —Ç–∞ –¥—É–º–∫–∏ –∞–≤—Ç–æ—Ä—ñ–≤.">
    <meta name="robots" content="index, follow">
    <link rel="canonical" id="canonicalTag" href="https://konvi.space/">

    <!-- Open Graph -->
    <meta property="og:type" content="website">
    <meta property="og:site_name" content="–ü–æ–µ—Ç–∏—á–Ω–∞ –ø–ª–∞—Ç—Ñ–æ—Ä–º–∞ KonVi">
    <meta property="og:title" id="ogTitle" content="–ü–æ–µ—Ç–∏—á–Ω–∞ –ø–ª–∞—Ç—Ñ–æ—Ä–º–∞ KonVi">
    <meta property="og:description" id="ogDescription" content="–°–ø—ñ–ª—å–Ω–æ—Ç–∞ —É–∫—Ä–∞—ó–Ω—Å—å–∫–∏—Ö –ø–æ–µ—Ç—ñ–≤. –ß–∏—Ç–∞–π—Ç–µ –≤—ñ—Ä—à—ñ —Ç–∞ –¥—É–º–∫–∏ –∞–≤—Ç–æ—Ä—ñ–≤.">
    <meta property="og:url" id="ogUrl" content="https://konvi.space/">
    <meta property="og:image" id="ogImage" content="https://konvi.space/logo.webp">

    <!-- Twitter Card -->
    <meta name="twitter:card" content="summary">
    <meta name="twitter:title" id="twitterTitle" content="–ü–æ–µ—Ç–∏—á–Ω–∞ –ø–ª–∞—Ç—Ñ–æ—Ä–º–∞ KonVi">
    <meta name="twitter:description" id="twitterDescription" content="–°–ø—ñ–ª—å–Ω–æ—Ç–∞ —É–∫—Ä–∞—ó–Ω—Å—å–∫–∏—Ö –ø–æ–µ—Ç—ñ–≤.">
    <meta name="twitter:image" id="twitterImage" content="https://konvi.space/logo.webp">
    <link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:ital,wght@0,300;0,400;0,500;0,600;1,300;1,400&family=Philosopher:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #2c3e50;
            --secondary: #34495e;
            --accent: #8b6f47;
            --accent-light: #b8956a;
            --accent-dark: #6d5638;
            --bg-main: #faf8f3;
            --bg-card: #ffffff;
            --bg-secondary: #f0ebe3;
            --text-main: #111111;
            --text-light: #444444;
            --text-lighter: #777777;
            --border: #e8e4dc;
            --border-light: #f5f0e8;
            --shadow: rgba(0, 0, 0, 0.08);
        }

        /* –¢—Ä–∞–≤—è–Ω–∏—Å—Ç–æ-–∑–µ–ª–µ–Ω–∞ —Ç–µ–º–∞ */
        [data-theme="green"] {
            --primary: #2d5016;
            --secondary: #3d6b1f;
            --accent: #6b8e23;
            --accent-light: #9acd32;
            --accent-dark: #4a5f1a;
            --bg-main: #f5f9f0;
            --bg-card: #ffffff;
            --bg-secondary: #e8f3e0;
            --text-main: #111111;
            --text-light: #3a4f2e;
            --text-lighter: #5a6b4a;
            --border: #d4e7c5;
            --border-light: #e8f3e0;
            --shadow: rgba(107, 142, 35, 0.1);
        }

        /* –ú–æ—Ä—Å—å–∫–∞ —Å–∏–Ω—è —Ç–µ–º–∞ */
        [data-theme="ocean"] {
            --primary: #1b4965;
            --secondary: #2c6b8f;
            --accent: #5fa8d3;
            --accent-light: #90c2e7;
            --accent-dark: #3d7a9f;
            --bg-main: #f0f7fb;
            --bg-card: #ffffff;
            --bg-secondary: #e3f1f7;
            --text-main: #111111;
            --text-light: #2d5a72;
            --text-lighter: #567a92;
            --border: #d4e8f5;
            --border-light: #e8f4fa;
            --shadow: rgba(95, 168, 211, 0.1);
        }

        /* –§—ñ–æ–ª–µ—Ç–æ–≤–æ-–ª–∞–≤–∞–Ω–¥–æ–≤–∞ —Ç–µ–º–∞ */
        [data-theme="lavender"] {
            --primary: #4a2c62;
            --secondary: #5e3a7d;
            --accent: #8b5fb0;
            --accent-light: #b794cc;
            --accent-dark: #6d4a89;
            --bg-main: #f8f5fb;
            --bg-card: #ffffff;
            --bg-secondary: #f0e9f7;
            --text-main: #111111;
            --text-light: #4a3358;
            --text-lighter: #6d5578;
            --border: #e6dced;
            --border-light: #f2ebf5;
            --shadow: rgba(139, 95, 176, 0.1);
        }

        /* –¢–µ—Ä–∞–∫–æ—Ç–æ–≤–æ-—Ä–æ–∂–µ–≤–∞ —Ç–µ–º–∞ */
        [data-theme="terracotta"] {
            --primary: #8b4513;
            --secondary: #a0522d;
            --accent: #d2691e;
            --accent-light: #e9967a;
            --accent-dark: #b35a15;
            --bg-main: #fdf7f4;
            --bg-card: #ffffff;
            --bg-secondary: #f8ede7;
            --text-main: #111111;
            --text-light: #5c3520;
            --text-lighter: #8b6854;
            --border: #f0dfce;
            --border-light: #f8ede7;
            --shadow: rgba(210, 105, 30, 0.1);
        }

        /* –¢–µ–º–Ω–∞ —Ç–µ–º–∞ */
        [data-theme="dark"] {
            --primary: #e8e6e3;
            --secondary: #d0cec9;
            --accent: #c9a961;
            --accent-light: #e0c78a;
            --accent-dark: #b08f4a;
            --bg-main: #1a1a1a;
            --bg-card: #2d2d2d;
            --bg-secondary: #242424;
            --text-main: #f0eee9;
            --text-light: #c8c8c8;
            --text-lighter: #aaaaaa;
            --border: #404040;
            --border-light: #353535;
            --shadow: rgba(0, 0, 0, 0.3);
        }

        /* –ö–∞–≤–æ–≤–∞ —Ç–µ–º–Ω–æ-–∑–µ–ª–µ–Ω–∞ —Ç–µ–º–∞ –∑ –∑–æ–ª–æ—Ç–∏–º–∏ –∞–∫—Ü–µ–Ω—Ç–∞–º–∏ */
        [data-theme="coffee"] {
            --primary: #1a3a3a;
            --secondary: #234545;
            --accent: #c9a961;
            --accent-light: #e0c78a;
            --accent-dark: #a08840;
            --bg-main: #234545;
            --bg-card: #2d5555;
            --bg-secondary: #1f4040;
            --text-main: #faf5ec;
            --text-light: #e0c070;
            --text-lighter: #c9a961;
            --border: #3d6565;
            --border-light: #2d5555;
            --shadow: rgba(0, 0, 0, 0.4);
        }

        /* –ü—Ä–∏—Ä–æ–¥–Ω–∞ –∑–µ–º–Ω–∞ —Ç–µ–º–∞ (Mother Earthed - —Å–≤—ñ—Ç–ª–∞) */
        [data-theme="earth-light"] {
            --primary: #4a5f3d;
            --secondary: #6b7c5e;
            --accent: #8b7355;
            --accent-light: #a89078;
            --accent-dark: #6d5638;
            --bg-main: #f5f3ed;
            --bg-card: #ffffff;
            --bg-secondary: #ebe8df;
            --text-main: #1a2414;
            --text-light: #3f5234;
            --text-lighter: #6b7c5e;
            --border: #d4cfbb;
            --border-light: #e8e4d5;
            --shadow: rgba(107, 124, 94, 0.1);
        }

        /* –ü—Ä–∏—Ä–æ–¥–Ω–∞ –∑–µ–º–Ω–∞ —Ç–µ–º–∞ (Mother Earthed - —Ç–µ–º–Ω–∞) */
        [data-theme="earth-dark"] {
            --primary: #e8e4d5;
            --secondary: #d4cfbb;
            --accent: #a89078;
            --accent-light: #c9b89a;
            --accent-dark: #8b7355;
            --bg-main: #2d3a26;
            --bg-card: #3d4a36;
            --bg-secondary: #374435;
            --text-main: #faf8f0;
            --text-light: #c9b89a;
            --text-lighter: #a89078;
            --border: #4a5f3d;
            --border-light: #3d4a36;
            --shadow: rgba(0, 0, 0, 0.3);
        }

        /* –õ—ñ—Å–æ–≤–∞ –∫–∞–≤–∞ —Ç–µ–º–∞ (Ravo Kafe - —Å–≤—ñ—Ç–ª–∞) */
        [data-theme="forest-light"] {
            --primary: #2d5045;
            --secondary: #3d6555;
            --accent: #8b7355;
            --accent-light: #a89078;
            --accent-dark: #6d5638;
            --bg-main: #f0ede3;
            --bg-card: #ffffff;
            --bg-secondary: #e5e0d0;
            --text-main: #0f1e17;
            --text-light: #254535;
            --text-lighter: #3d6555;
            --border: #d4cfbb;
            --border-light: #e5e0d0;
            --shadow: rgba(45, 80, 69, 0.1);
        }

        /* –õ—ñ—Å–æ–≤–∞ –∫–∞–≤–∞ —Ç–µ–º–∞ (Ravo Kafe - —Ç–µ–º–Ω–∞) */
        [data-theme="forest-dark"] {
            --primary: #e5e0d0;
            --secondary: #d4cfbb;
            --accent: #a89078;
            --accent-light: #c9b89a;
            --accent-dark: #8b7355;
            --bg-main: #1f3a32;
            --bg-card: #2d5045;
            --bg-secondary: #27453d;
            --text-main: #f5f2e8;
            --text-light: #d4c9a8;
            --text-lighter: #c9b89a;
            --border: #3d6555;
            --border-light: #2d5045;
            --shadow: rgba(0, 0, 0, 0.4);
        }

        /* –°–≤—ñ—Ç–ª–∞ —Ç–µ–º–∞ –∑ –∑–µ–ª–µ–Ω–æ-–∫–æ—Ä–∏—á–Ω–µ–≤–∏–º–∏ –µ–ª–µ–º–µ–Ω—Ç–∞–º–∏ */
        [data-theme="green-brown-light"] {
            --primary: #2a4a2d;
            --secondary: #3a5a3d;
            --accent: #6d5a3a;
            --accent-light: #8d7a5a;
            --accent-dark: #4d3a1a;
            --bg-main: #fafaf8;
            --bg-card: #ffffff;
            --bg-secondary: #f5f5f0;
            --text-main: #0e1f11;
            --text-light: #2a3a2d;
            --text-lighter: #4a5a4d;
            --border: #c5d0c5;
            --border-light: #e0e8e0;
            --shadow: rgba(42, 74, 45, 0.12);
        }

        /* –°–æ–∫–æ–≤–∏—Ç–∞ –∑–µ–ª–µ–Ω–æ-–∫–æ—Ä–∏—á–Ω–µ–≤–∞ —Ç–µ–º–∞ */
        [data-theme="green-brown-vibrant"] {
            --primary: #1d5c2e;
            --secondary: #2d7c3e;
            --accent: #b8862e;
            --accent-light: #d4a54e;
            --accent-dark: #8a5e1a;
            --bg-main: #fdfdfb;
            --bg-card: #ffffff;
            --bg-secondary: #f9f8f4;
            --text-main: #071f0e;
            --text-light: #1d5c2e;
            --text-lighter: #2d7c3e;
            --border: #b8d4b8;
            --border-light: #dceadc;
            --shadow: rgba(29, 92, 46, 0.15);
        }

        /* –ö–æ–Ω—Ç—Ä–∞—Å—Ç–Ω–∞ –ø—Ä–∏—Ä–æ–¥–Ω–∞ —Ç–µ–º–∞ (–∑–µ–±—Ä–∞/—à–∞—Ö–∏) */
        [data-theme="nature-contrast"] {
            --primary: #2a3f2a;
            --secondary: #3d5a3d;
            --accent: #6d4e2a;
            --accent-light: #8d6e4a;
            --accent-dark: #4d2e0a;
            --bg-main: #f9f5e8;
            --bg-card: #fdfdfb;
            --bg-secondary: #2a3f2a;
            --text-main: #0e0e0c;
            --text-light: #2a2a26;
            --text-lighter: #4a4a45;
            --border: #3d5a3d;
            --border-light: #d4d0bb;
            --shadow: rgba(42, 63, 42, 0.2);
        }

        /* –ú'—è–∫–∏–π –ø—Ä–∏—Ä–æ–¥–Ω–∏–π –∫–æ–Ω—Ç—Ä–∞—Å—Ç (–∑–µ–±—Ä–∞ –∑ –¥–µ–ª—ñ–∫–∞—Ç–Ω–æ—é –æ–±–≤–æ–¥–∫–æ—é) */
        [data-theme="nature-soft-contrast"] {
            --primary: #2d4a2d;
            --secondary: #3d5a3d;
            --accent: #7a5a2d;
            --accent-light: #9a7a4d;
            --accent-dark: #5a3a1d;
            --bg-main: #faf7ed;
            --bg-card: #fefefc;
            --bg-secondary: #2d4a2d;
            --text-main: #0e0e0b;
            --text-light: #2d2d28;
            --text-lighter: #4d4d48;
            --border: #e8e5d8;
            --border-light: #f2f0e8;
            --shadow: rgba(45, 74, 45, 0.15);
        }

        /* –õ—ñ—Å–æ–≤–∞ –ø–∞–ª—ñ—Ç—Ä–∞ (60% —Å–≤—ñ—Ç–ª–∞, –∫–æ–Ω—Ç—Ä–∞—Å—Ç–Ω—ñ —Ç–µ–º–Ω—ñ –µ–ª–µ–º–µ–Ω—Ç–∏) */
        [data-theme="forest-palette"] {
            --primary: #051f20;
            --secondary: #0b2b26;
            --accent: #397654;
            --accent-light: #397654;
            --accent-dark: #235a3d;
            --bg-main: #daf1de;
            --bg-card: #ffffff;
            --bg-secondary: #c9e8d0;
            --text-main: #030f10;
            --text-light: #0b2b26;
            --text-lighter: #163832;
            --border: #6b9d7d;
            --border-light: #c9e8d0;
            --shadow: rgba(5, 31, 32, 0.15);
        }

        /* –°–≤—ñ–∂–∞ —Ç—Ä–æ—è–Ω–¥–∞ (60% —Å–≤—ñ—Ç–ª–∞, —Å–æ–∫–æ–≤–∏—Ç—ñ —á–µ—Ä–≤–æ–Ω—ñ –≤—ñ–¥—Ç—ñ–Ω–∫–∏) */
        [data-theme="fresh-rose"] {
            --primary: #2d0a0a;
            --secondary: #3d1515;
            --accent: #c73e3e;
            --accent-light: #c73e3e;
            --accent-dark: #8a2828;
            --bg-main: #fde8e8;
            --bg-card: #ffffff;
            --bg-secondary: #f8d5d5;
            --text-main: #1a0505;
            --text-light: #3d1010;
            --text-lighter: #5d2020;
            --border: #e8a8a8;
            --border-light: #f8d5d5;
            --shadow: rgba(45, 10, 10, 0.15);
        }

        /* –ó–æ–ª–æ—Ç–µ –±–∞—Ä–æ–∫–∫–æ (—Ä–æ–∑–∫—ñ—à–Ω–∞ –ª—ñ—Ç–µ—Ä–∞—Ç—É—Ä–Ω–∞ —Ç–µ–º–∞) */
        [data-theme="golden-baroque"] {
            --primary: #1a1410;
            --secondary: #2d241d;
            --accent: #d4a645;
            --accent-light: #e8c875;
            --accent-dark: #b8882a;
            --bg-main: #fdfaf5;
            --bg-card: #fffef9;
            --bg-secondary: #f5eee0;
            --text-main: #0d0b08;
            --text-light: #3a2d20;
            --text-lighter: #5d4a3a;
            --border: #e8d8b8;
            --border-light: #f5eee0;
            --shadow: rgba(212, 166, 69, 0.2);
        }

        * {



        /* Admin Tabs */
        .admin-tab-btn {
            padding: 0.75rem 1.5rem;
            background: transparent;
            border: none;
            border-bottom: 3px solid transparent;
            font-family: 'Philosopher', sans-serif;
            font-size: 1rem;
            font-weight: 600;
            color: var(--text-light);
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .admin-tab-btn:hover {
            color: var(--accent);
        }

        .admin-tab-btn.active {
            color: var(--accent);
            border-bottom-color: var(--accent);
        }

        /* Theme Cards */
        .theme-card {
            border: 2px solid var(--border);
            border-radius: 8px;
            padding: 1rem;
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
            background: var(--bg-card);
        }

        .theme-card:hover {
            border-color: var(--accent);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px var(--shadow);
        }

        .theme-card.active {
            border-color: var(--accent);
            background: var(--accent-light);
            background: linear-gradient(135deg, var(--bg-card) 0%, var(--bg-secondary) 100%);
        }

        .theme-preview {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1rem;
            height: 60px;
        }

        .theme-color {
            flex: 1;
            border-radius: 6px;
            border: 1px solid rgba(0, 0, 0, 0.1);
        }

        .theme-name {
            font-weight: 600;
            color: var(--text-main);
            text-align: center;
            font-size: 0.95rem;
            font-family: 'Philosopher', sans-serif;
        }

        .theme-check {
            position: absolute;
            top: -8px;
            right: -8px;
            width: 28px;
            height: 28px;
            background: var(--accent);
            color: white;
            border-radius: 50%;
            display: none;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            box-shadow: 0 2px 8px var(--shadow);
        }

        .theme-card.active .theme-check {
            display: flex;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Cormorant Garamond', serif;
            background: var(--bg-main);
            color: var(--text-main);
            line-height: 1.9;
            font-size: 1.125rem;
            display: flex;
            flex-direction: column;
            min-height: 100dvh;
            overflow-x: hidden;
        }

        /* Header */
        .platform-header {
            background: var(--bg-card);
            border-bottom: 2px solid var(--border);
            padding: 1rem 2rem;
            box-shadow: 0 2px 8px var(--shadow);
            position: sticky;
            top: 0;
            z-index: 200;
        }

        .header-content {
            max-width: 1400px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        /* Filter panel ‚Äî collapsed by default */
        .header-filter-bar {
            background: var(--bg-card);
            border-top: 1px solid var(--border);
            max-height: 0;
            overflow: hidden;
            opacity: 0;
            transition: max-height 0.35s ease, opacity 0.35s ease, padding 0.35s ease;
            padding: 0;
        }

        .platform-header.filter-open .header-filter-bar {
            max-height: 500px;
            opacity: 1;
            padding: 0.75rem 0;
        }

        /* Toggle arrow button */
        .header-filter-toggle {
            position: absolute;
            bottom: -14px;
            left: 50%;
            transform: translateX(-50%);
            width: 28px;
            height: 28px;
            border-radius: 50%;
            background: var(--accent);
            color: white;
            border: none;
            cursor: pointer;
            font-size: 0.75rem;
            display: none; /* shown only when filter is active */
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 8px var(--shadow);
            transition: all 0.3s ease;
            z-index: 10;
        }
        .header-filter-toggle:hover {
            background: var(--accent-dark);
            transform: translateX(-50%) scale(1.1);
        }
        .platform-header.filter-active .header-filter-toggle {
            display: flex;
        }

        .logo {
            font-family: 'Philosopher', sans-serif;
            font-size: 2rem;
            font-weight: 700;
            color: var(--primary);
        }

        .header-nav {
            display: flex;
            gap: 2rem;
            align-items: center;
        }

        .nav-link {
            font-family: 'Philosopher', sans-serif;
            color: var(--text-main);
            text-decoration: none;
            font-weight: 600;
            transition: color 0.3s ease;
        }

        .nav-link:hover {
            color: var(--accent);
        }

        .user-menu {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .btn {
            padding: 0.5rem 1.5rem;
            border-radius: 8px;
            border: none;
            font-family: 'Philosopher', sans-serif;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-primary {
            background: var(--accent);
            color: white;
        }

        .btn-primary:hover {
            background: var(--accent-dark);
        }

        .btn-secondary {
            background: transparent;
            border: 2px solid var(--accent);
            color: var(--accent);
        }

        .btn-secondary:hover {
            background: var(--accent);
            color: white;
        }

        /* Main Content */
        .container {
            max-width: 1400px;
            margin: 2rem auto;
            padding: 0 2rem;
        }

        .home-grid {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 2rem;
        }

        .main-content {
            display: flex;
            flex-direction: column;
            gap: 2rem;
        }

        .sidebar {
            display: flex;
            flex-direction: column;
            gap: 2rem;
        }

        /* Cards */
        .card {
            background: var(--bg-card);
            padding: 1.5rem;
            border-radius: 12px;
            border: 1px solid var(--border-light);
            box-shadow: 0 2px 8px var(--shadow);
        }

        .card-title {
            font-family: 'Philosopher', sans-serif;
            font-size: 1.45rem;
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 1rem;
        }

        /* Featured Posts */
        .featured-post {
            background: var(--bg-card);
            padding: 2rem;
            border-radius: 12px;
            border: 1px solid var(--border-light);
            box-shadow: 0 4px 20px var(--shadow);
            margin-bottom: 1.5rem;
            transition: transform 0.3s ease;
        }

        .featured-post:hover {
            transform: translateY(-3px);
        }

        .post-type-badge {
            display: inline-block;
            padding: 4px 12px;
            background: var(--accent-light);
            color: white;
            border-radius: 15px;
            font-size: 0.85rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
        }

        .post-title {
            font-family: 'Philosopher', sans-serif;
            font-size: 1.75rem;
            color: var(--primary);
            margin-bottom: 0.8rem;
        }

        .post-author {
            color: var(--accent);
            font-weight: 600;
            margin-bottom: 0.5rem;
        }

        .post-content {
            color: var(--text-main);
            line-height: 1.95;
        }

        .post-meta {
            display: flex;
            gap: 1rem;
            color: var(--text-light);
            font-size: 1rem;
        }

        /* Random Blocks */
        .random-item {
            padding: 1rem;
            border-bottom: 1px solid var(--border-light);
        }

        .random-item:last-child {
            border-bottom: none;
        }

        .random-title {
            font-weight: 600;
            color: var(--primary);
            margin-bottom: 0.3rem;
        }

        .random-text {
            font-size: 0.95rem;
            color: var(--text-main);
        }

        /* Users List */
        .user-item {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 0.8rem;
            border-bottom: 1px solid var(--border-light);
            transition: background 0.3s ease;
        }

        .user-item:hover {
            background: var(--bg-secondary);
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--accent-light);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 700;
        }

        .user-info {
            flex: 1;
        }

        .user-name {
            font-weight: 600;
            color: var(--primary);
        }

        .user-stats {
            font-size: 0.95rem;
            color: var(--text-light);
        }

        /* Hashtag Cloud */
        .hashtag-cloud {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
        }

        .hashtag-item {
            padding: 0.4rem 1rem;
            background: var(--bg-secondary);
            border-radius: 20px;
            color: var(--accent);
            font-weight: 600;
            text-decoration: none;
            transition: all 0.3s ease;
            font-size: 1rem;
        }

        .hashtag-item:hover {
            background: var(--accent);
            color: white;
        }

        .hashtag-item.active {
            background: var(--accent);
            color: white;
        }

        /* Auth Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: var(--bg-card);
            padding: 2rem;
            border-radius: 12px;
            max-width: 400px;
            width: 90%;
        }

        .form-group {
            margin-bottom: 1rem;
        }

        .form-label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: var(--text-main);
        }

        .form-input {
            width: 100%;
            padding: 0.8rem;
            border: 2px solid var(--border);
            border-radius: 8px;
            font-family: 'Cormorant Garamond', serif;
            font-size: 1rem;
        }

        .form-input:focus {
            outline: none;
            border-color: var(--accent);
        }

        textarea.form-input {
            resize: vertical;
            min-height: 100px;
            font-family: 'Cormorant Garamond', serif;
        }

        .filter-btn {
            padding: 0.5rem 1.5rem;
        }

        .filter-btn.active {
            background: var(--accent);
            color: white;
            border-color: var(--accent);
        }

        .filter-tab {
            padding: 10px 24px;
            background: var(--bg-card);
            border: 2px solid var(--border-light);
            border-radius: 25px;
            font-family: 'Philosopher', sans-serif;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
            color: var(--text-light);
        }

        .filter-tab:hover,
        .filter-tab.active {
            background: var(--accent);
            color: white;
            border-color: var(--accent);
            transform: translateY(-2px);
        }

        .search-container {
            margin: 0;
            padding-top: 0;
        }

        .search-box {
            display: flex;
            gap: 0.5rem;
        }

        .post-actions {
            display: flex;
            gap: 0.5rem;
            margin-top: 1rem;
        }

        .btn-small {
            padding: 0.4rem 1rem;
            font-size: 0.9rem;
        }

        /* Random posts grid */
        .random-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 1rem;
        }

        .random-card {
            background: var(--bg-secondary);
            border-radius: 10px;
            padding: 1rem;
            border: 1px solid var(--border-light);
            cursor: pointer;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .random-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 20px var(--shadow);
        }

        .random-card-title {
            font-family: 'Philosopher', sans-serif;
            font-size: 1.1rem;
            font-weight: 700;
            color: var(--primary);
            line-height: 1.3;
        }

        .random-card-author {
            font-size: 0.85rem;
            color: var(--accent);
            font-weight: 600;
        }

        .random-card-content {
            font-size: 1rem;
            color: var(--text-main);
            white-space: pre-wrap;
            line-height: 1.6;
            flex: 1;
        }

        @media (max-width: 1200px) {
            .random-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (max-width: 768px) {
            .random-grid {
                grid-template-columns: 1fr;
            }
        }

        .loading {
            text-align: center;
            padding: 2rem;
            color: var(--text-light);
        }

        /* ===== HOME SEARCH BAR ===== */
        .search-filter-bar {
            background: var(--bg-card);
            max-height: 0;
            overflow: hidden;
            opacity: 0;
            transition: max-height 0.35s ease, opacity 0.35s ease;
        }
        .search-filter-bar.active {
            max-height: 400px;
            opacity: 1;
            padding: 1rem 0;
        }
        /* Toggle button strip ‚Äî always visible, sits right below search bar */
        .search-bar-toggle-wrap {
            background: var(--bg-card);
            border-bottom: 1px solid var(--border);
            text-align: center;
            padding: 0px 0 4px;
        }
        .search-bar-toggle {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 28px;
            height: 28px;
            border-radius: 50%;
            background: var(--accent);
            color: white;
            border: none;
            cursor: pointer;
            font-size: 0.75rem;
            box-shadow: 0 2px 8px var(--shadow);
            transition: background 0.3s ease, transform 0.3s ease;
        }
        .search-bar-toggle:hover {
            background: var(--accent-dark);
            transform: scale(1.1);
        }

        .search-filter-inner {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 2rem;
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .search-box-row {
            display: flex;
            gap: 0.5rem;
            align-items: center;
        }

        .search-input-main {
            flex: 1;
            padding: 9px 14px;
            border: 2px solid var(--border);
            border-radius: 8px;
            font-family: 'Cormorant Garamond', serif;
            font-size: 1.05rem;
            color: var(--text-main);
            transition: all 0.3s ease;
        }

        .search-input-main:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 3px rgba(139, 111, 71, 0.1);
            background: var(--bg-card);
        }

        .search-input-main::placeholder { color: var(--text-lighter); }

        .search-btn-main {
            padding: 9px 18px;
            background: linear-gradient(135deg, var(--accent) 0%, var(--accent-light) 100%);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-family: 'Philosopher', sans-serif;
            font-weight: 600;
            font-size: 0.9rem;
            transition: all 0.3s ease;
            white-space: nowrap;
        }

        .search-btn-main:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(139, 111, 71, 0.35);
        }

        .search-clear-btn {
            padding: 9px 14px;
            background: var(--bg-secondary);
            color: var(--text-main);
            border: 2px solid var(--border);
            border-radius: 8px;
            cursor: pointer;
            font-family: 'Philosopher', sans-serif;
            font-weight: 600;
            font-size: 0.9rem;
            transition: all 0.3s ease;
            display: none;
        }

        .search-clear-btn:hover { border-color: var(--accent); color: var(--accent); }

        .search-options-row {
            display: flex;
            gap: 1.5rem;
            justify-content: center;
        }

        .search-option-label {
            display: flex;
            align-items: center;
            gap: 0.4rem;
            cursor: pointer;
            font-family: 'Philosopher', sans-serif;
            font-size: 0.85rem;
            color: var(--text-light);
            transition: color 0.2s;
        }

        .search-option-label:hover { color: var(--accent); }
        .search-option-label input[type="radio"] { cursor: pointer; accent-color: var(--accent); }

        .home-hashtag-chips {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
            align-items: center;
        }

        .home-hashtag-filter-label {
            font-family: 'Philosopher', sans-serif;
            font-size: 0.85rem;
            color: var(--text-light);
            font-weight: 600;
            white-space: nowrap;
        }

        .home-hashtag-chip {
            padding: 4px 12px;
            background: var(--bg-secondary);
            border: 2px solid var(--border);
            color: var(--text-light);
            border-radius: 15px;
            font-size: 0.82rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .home-hashtag-chip:hover { border-color: var(--accent); color: var(--accent); }
        .home-hashtag-chip.active { background: var(--accent); color: white; border-color: var(--accent); }

        /* Profile hashtag chips ‚Äî single scrollable row */
        .profile-hashtag-scroll {
            display: flex;
            gap: 0.5rem;
            align-items: center;
            overflow-x: auto;
            overflow-y: hidden;
            flex-wrap: nowrap;
            padding-bottom: 4px;
            scrollbar-width: thin;
            scrollbar-color: var(--accent) var(--border);
        }

        .profile-hashtag-scroll::-webkit-scrollbar {
            height: 4px;
        }

        .profile-hashtag-scroll::-webkit-scrollbar-track {
            background: var(--border-light);
            border-radius: 2px;
        }

        .profile-hashtag-scroll::-webkit-scrollbar-thumb {
            background: var(--accent);
            border-radius: 2px;
        }

        .profile-hashtag-scroll .home-hashtag-filter-label {
            flex-shrink: 0;
        }

        .profile-hashtag-scroll .home-hashtag-chip {
            flex-shrink: 0;
        }

        /* Thoughts horizontal scroll row */
        .thoughts-scroll-row {
            display: flex;
            gap: 1rem;
            overflow-x: auto;
            overflow-y: hidden;
            flex-wrap: nowrap;
            padding-bottom: 8px;
            scrollbar-width: thin;
            scrollbar-color: var(--accent) var(--border-light);
        }

        .thoughts-scroll-row::-webkit-scrollbar {
            height: 5px;
        }

        .thoughts-scroll-row::-webkit-scrollbar-track {
            background: var(--border-light);
            border-radius: 3px;
        }

        .thoughts-scroll-row::-webkit-scrollbar-thumb {
            background: var(--accent);
            border-radius: 3px;
        }

        .thoughts-scroll-row .random-card {
            flex: 0 0 300px;
            min-width: 300px;
            max-width: 300px;
        }

        .search-toggle-btn {
            background: none;
            border: none;
            color: var(--text-main);
            cursor: pointer;
            font-size: 1.2rem;
            padding: 0.3rem 0.6rem;
            border-radius: 6px;
            transition: all 0.2s ease;
            line-height: 1;
        }

        .search-toggle-btn:hover { color: var(--accent); background: var(--bg-secondary); }
        .search-toggle-btn.active { color: var(--accent); }

        .search-results-banner {
            text-align: center;
            padding: 0.5rem 2rem;
            font-size: 0.9rem;
            color: var(--text-light);
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border);
            display: none;
        }

        .search-results-banner strong { color: var(--accent); }

        @media (max-width: 768px) {
            .search-filter-bar.active { max-height: 480px; }
            .search-filter-inner { padding: 0 1rem; }
            .search-box-row { flex-wrap: wrap; }
            .search-options-row { gap: 0.75rem; justify-content: flex-start; }
        }

        /* Home bottom grid */
        .home-bottom-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
            margin-bottom: 2rem;
        }

        .home-section-card {
            margin-bottom: 2rem;
            width: 100%;
            box-sizing: border-box;
            overflow: hidden;
        }

        .home-section-card .thoughts-scroll-row {
            overflow-x: auto;
        }

        /* ===== HEADER FILTER BAR ===== */
        .header-filter-inner {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0.6rem 2rem;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .header-filter-tabs {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }

        .header-search-row {
            display: flex;
            gap: 0.5rem;
            align-items: center;
        }

        .header-search-row input {
            flex: 1;
            padding: 8px 14px;
            border: 2px solid var(--border);
            border-radius: 8px;
            font-family: 'Cormorant Garamond', serif;
            font-size: 1rem;
            color: var(--text-main);
            background: var(--bg-main);
            transition: border-color 0.2s;
        }
        .header-search-row input:focus {
            outline: none;
            border-color: var(--accent);
            background: var(--bg-card);
        }
        .header-search-row input::placeholder { color: var(--text-lighter); }

        .header-search-type {
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
        }

        /* ===== PAGINATION ===== */
        .pagination-bar {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 0.35rem;
            padding: 1.5rem 0 0.5rem;
            flex-wrap: wrap;
        }

        .page-btn {
            min-width: 36px;
            height: 36px;
            padding: 0 10px;
            border: 2px solid var(--border);
            border-radius: 8px;
            background: var(--bg-card);
            color: var(--text-main);
            font-family: 'Philosopher', sans-serif;
            font-size: 0.95rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }
        .page-btn:hover:not(:disabled) {
            border-color: var(--accent);
            color: var(--accent);
            background: var(--bg-secondary);
        }
        .page-btn.active {
            background: var(--accent);
            border-color: var(--accent);
            color: white;
        }
        .page-btn:disabled {
            opacity: 0.35;
            cursor: default;
        }

        @media (max-width: 768px) {
            .header-filter-inner { padding: 0.5rem 0.75rem; }
            .header-search-type { gap: 0.5rem; }
        }

        /* ===== BURGER / MOBILE MENU ===== */
        .burger-btn {
            display: none;
            flex-direction: column;
            justify-content: center;
            gap: 5px;
            width: 36px;
            height: 36px;
            background: none;
            border: none;
            cursor: pointer;
            padding: 4px;
            border-radius: 6px;
            transition: background 0.2s;
        }
        .burger-btn:hover { background: var(--bg-secondary); }
        .burger-btn span {
            display: block;
            height: 2px;
            width: 100%;
            background: var(--text-main);
            border-radius: 2px;
            transition: all 0.3s ease;
        }
        .burger-btn.open span:nth-child(1) { transform: translateY(7px) rotate(45deg); }
        .burger-btn.open span:nth-child(2) { opacity: 0; }
        .burger-btn.open span:nth-child(3) { transform: translateY(-7px) rotate(-45deg); }

        .mobile-menu {
            display: none;
            flex-direction: column;
            background: var(--bg-card);
            border-top: 1px solid var(--border);
            padding: 0.5rem 0 1rem;
        }
        .mobile-menu.open { display: flex; }
        .mobile-nav-link {
            padding: 0.85rem 1.5rem;
            font-family: 'Philosopher', sans-serif;
            font-size: 1.05rem;
            font-weight: 600;
            color: var(--text-main);
            text-decoration: none;
            border-bottom: 1px solid var(--border-light);
            transition: background 0.2s, color 0.2s;
        }
        .mobile-nav-link:hover { background: var(--bg-secondary); color: var(--accent); }
        .mobile-menu-divider { height: 1px; background: var(--border); margin: 0.5rem 0; }
        #mobileUserMenu { padding: 0.5rem 1.5rem; display: flex; flex-direction: column; gap: 0.5rem; }
        #mobileUserMenu .btn { width: 100%; text-align: center; }
        #mobileUserMenu .mobile-user-name {
            font-family: 'Philosopher', sans-serif;
            font-weight: 600;
            color: var(--accent);
            padding: 0.5rem 0;
        }

        /* ===== COMPREHENSIVE MOBILE STYLES ===== */
        @media (max-width: 768px) {

            /* Header */
            .platform-header { padding: 0.75rem 1rem; }
            .header-nav { display: none; }
            .user-menu { display: none; }
            .burger-btn { display: flex; }
            .logo { font-size: 1.3rem; }

            /* Container */
            .container { padding: 0 0.75rem; margin: 1rem auto; }

            /* Home page inner container */
            #homePage > .container { padding: 0; }

            /* Home cards ‚Äî less padding, less margin */
            .home-section-card { padding: 0.85rem; margin-bottom: 1rem; }
            .home-section-card .card-title { font-size: 1.05rem; margin-bottom: 0.75rem; }
            .home-bottom-grid { grid-template-columns: 1fr; gap: 1rem; }

            /* Scroll cards ‚Äî full-width snapping on mobile */
            .thoughts-scroll-row {
                gap: 0.75rem !important;
                padding-bottom: 8px !important;
                scroll-snap-type: x mandatory !important;
                padding-left: 0.25rem !important;
            }
            .thoughts-scroll-row .random-card {
                flex: 0 0 78vw !important;
                min-width: 0 !important;
                max-width: 78vw !important;
                width: 78vw !important;
                scroll-snap-align: start !important;
            }

            /* Home grid ‚Äî single column */
            .home-grid { grid-template-columns: 1fr; }

            /* Cards */
            .card { padding: 1rem; border-radius: 10px; }
            .card-title { font-size: 1.15rem; }

            /* Post cards */
            .featured-post { padding: 1rem; }
            .post-title { font-size: 1.25rem; }

            /* Profile page */
            #profilePage .container { padding: 0 0.75rem; }

            /* Sticky filter replaced by header ‚Äî no top offset needed */

            /* Filter tabs wrap */
            .filter-tab { padding: 7px 14px; font-size: 0.9rem; }

            /* Search bar */
            .search-filter-bar.active { max-height: 520px; }
            .search-input-main { font-size: 1rem; }
            .search-btn-main { font-size: 0.85rem; padding: 9px 12px; }
            .search-clear-btn { font-size: 0.85rem; padding: 9px 10px; }

            /* Profile header buttons */
            #newPostBtn, #shareProfileBtn { padding: 0.4rem 0.9rem; font-size: 0.85rem; }

            /* Buttons */
            .btn { padding: 0.45rem 1rem; font-size: 0.95rem; }
            .btn-small { padding: 0.35rem 0.7rem; font-size: 0.82rem; }

            /* User items */
            .user-item { padding: 0.6rem; }
            .user-avatar { width: 34px; height: 34px; font-size: 0.9rem; }

            /* Modal */
            .modal-content { padding: 1.25rem; margin: 0 1rem; }

            /* Admin grid */
            #adminStatsGrid { grid-template-columns: repeat(2, 1fr); gap: 0.75rem; }

            /* All posts / poets / admin pages */
            #allPostsPage .card,
            #poetsPage .card,
            #adminPage .card { padding: 1rem 0.75rem; }

            /* Post page */
            #postPage .container { padding: 0 0.75rem; }
            #postPageTitle { font-size: 1.6rem !important; }
            #postPageContent { font-size: 1.05rem !important; }

            /* TOC */
            /* ‚îÄ‚îÄ TOC ‚îÄ‚îÄ */

            /* Footer */
            footer { padding: 1rem; font-size: 0.85rem; }

            /* Hashtag cloud wraps on mobile */
            .hashtag-cloud { flex-wrap: wrap; gap: 0.5rem; }
        }

        @media (max-width: 480px) {
            .logo { font-size: 1.1rem; }
            .thoughts-scroll-row .random-card { flex: 0 0 88vw !important; max-width: 88vw !important; width: 88vw !important; }
            #adminStatsGrid { grid-template-columns: 1fr; }
            .search-options-row { flex-direction: column; gap: 0.5rem; }
            .admin-tab-btn { padding: 0.5rem 0.75rem; font-size: 0.85rem; }
            .home-section-card .card-title { font-size: 1rem; }
        }

    </style>
</head>
<body>
    <!-- Header -->
    <header class="platform-header">
        <div class="header-content">
            <div href="#" class="nav-link" onclick="showHome()" class="logo">üåü –ü–æ–µ—Ç–∏—á–Ω–∞ –ü–ª–∞—Ç—Ñ–æ—Ä–º–∞</div>
            <nav class="header-nav">
                <a href="#" class="nav-link" onclick="showHome()">–ì–æ–ª–æ–≤–Ω–∞</a>
                <a href="#" class="nav-link" onclick="showPoets()">–ü–æ–µ—Ç–∏</a>
                <a href="#" class="nav-link" onclick="showAllPosts()">–í—Å—ñ –ø—É–±–ª—ñ–∫–∞—Ü—ñ—ó</a>
            </nav>
            <div class="user-menu" id="userMenu">
                <button class="btn btn-secondary" onclick="showAuthModal('login')">–£–≤—ñ–π—Ç–∏</button>
                <button class="btn btn-primary" onclick="showAuthModal('register')">–†–µ—î—Å—Ç—Ä–∞—Ü—ñ—è</button>
            </div>
            <!-- Mobile burger -->
            <button class="burger-btn" id="burgerBtn" onclick="toggleMobileMenu()" aria-label="–ú–µ–Ω—é">
                <span></span><span></span><span></span>
            </button>
        </div>
        <!-- Mobile menu dropdown -->
        <div class="mobile-menu" id="mobileMenu">
            <a href="#" class="mobile-nav-link" onclick="showHome(); closeMobileMenu()">üè† –ì–æ–ª–æ–≤–Ω–∞</a>
            <a href="#" class="mobile-nav-link" onclick="showPoets(); closeMobileMenu()">üë• –ü–æ–µ—Ç–∏</a>
            <a href="#" class="mobile-nav-link" onclick="showAllPosts(); closeMobileMenu()">üìö –í—Å—ñ –ø—É–±–ª—ñ–∫–∞—Ü—ñ—ó</a>
            <div class="mobile-menu-divider"></div>
            <div id="mobileUserMenu"></div>
        </div>

        <!-- Contextual filter bar (shown on profile/allPosts pages, inside sticky header) -->
        <div class="header-filter-bar" id="headerFilterBar">
            <div class="header-filter-inner">
                <div style="display:flex; align-items:center; gap:0.5rem;">
                    <div class="header-filter-tabs" id="headerFilterTabs" style="flex:1;"></div>
                </div>
                <div class="header-search-row">
                    <input type="text" id="headerSearchInput" autocomplete="off" placeholder="–ü–æ—à—É–∫...">
                    <button class="search-btn-main" id="headerSearchBtn" style="padding:6px 14px; font-size:0.9rem;">üîç</button>
                    <button class="search-clear-btn" id="headerClearBtn" onclick="clearHeaderSearch()" style="display:none; padding:6px 10px;">‚úï</button>
                </div>
                <div class="header-search-type" id="headerSearchType">
                    <label class="search-option-label"><input type="radio" name="headerSType" value="all" checked> –í—Å—é–¥–∏</label>
                    <label class="search-option-label"><input type="radio" name="headerSType" value="title"> –ó–∞ –Ω–∞–∑–≤–æ—é</label>
                    <label class="search-option-label"><input type="radio" name="headerSType" value="content"> –ó–∞ —Ç–µ–∫—Å—Ç–æ–º</label>
                </div>
                <!-- Hashtag chips (shown on allPosts page) -->
                <div id="headerHashtagSection" style="display:none;">
                    <div class="profile-hashtag-scroll" id="allPostsHashtagChips">
                        <span class="home-hashtag-filter-label">#Ô∏è‚É£ –•–µ—à—Ç–µ–≥–∏:</span>
                        <div id="allPostsHashtagChipsList" style="display:flex; gap:0.5rem; flex-wrap:nowrap;"></div>
                    </div>
                </div>
                <!-- TOC (shown on profile pages) -->
                <div id="headerTocSection" style="display:none;">
                    <div style="border-top: 1px solid var(--border-light); padding-top: 0.5rem; margin-top: 0.25rem;">
                        <div style="font-family:'Philosopher',sans-serif; font-size:0.85rem; color:var(--text-lighter); margin-bottom:0.4rem;">üìë –ó–º—ñ—Å—Ç</div>
                        <ul id="headerTocList" style="list-style:none; margin:0; padding:0; max-height:200px; overflow-y:auto; display:flex; flex-direction:column; gap:0.15rem;"></ul>
                    </div>
                </div>
            </div>
        </div>
        <!-- Filter toggle arrow -->
        <button class="header-filter-toggle" id="headerFilterToggle" onclick="toggleHeaderFilter()">‚ñº</button>
    </header>

    <!-- Search & Filter Bar (home only) -->
    <div class="search-filter-bar" id="searchFilterBar">
        <div class="search-filter-inner">
            <div class="search-box-row">
                <input type="text" class="search-input-main" id="homeSearchInput" autocomplete="off" placeholder="–ü–æ—à—É–∫ –∑–∞ –Ω–∞–∑–≤–æ—é, —Ç–µ–∫—Å—Ç–æ–º –∞–±–æ —Ö–µ—à—Ç–µ–≥–æ–º..." onkeypress="if(event.key==='Enter') runHomeSearch()">
                <button class="search-btn-main" onclick="runHomeSearch()">üîç –ó–Ω–∞–π—Ç–∏</button>
                <button class="search-clear-btn" id="homeClearBtn" onclick="clearHomeSearch()">‚úï –°–∫–∏–Ω—É—Ç–∏</button>
            </div>
            <div class="search-options-row">
                <label class="search-option-label">
                    <input type="radio" name="homeSearchType" value="all" checked> –í—Å—é–¥–∏
                </label>
                <label class="search-option-label">
                    <input type="radio" name="homeSearchType" value="title"> –ó–∞ –Ω–∞–∑–≤–æ—é
                </label>
                <label class="search-option-label">
                    <input type="radio" name="homeSearchType" value="content"> –ó–∞ —Ç–µ–∫—Å—Ç–æ–º
                </label>
            </div>
            <div class="profile-hashtag-scroll" id="homeHashtagChips" style="display:none;">
                <span class="home-hashtag-filter-label">#Ô∏è‚É£ –•–µ—à—Ç–µ–≥–∏:</span>
                <div id="homeHashtagChipsList" style="display:flex; gap:0.5rem; flex-wrap:nowrap;"></div>
            </div>
        </div>
    </div>
    <!-- Toggle arrow strip ‚Äî always visible -->
    <div class="search-bar-toggle-wrap" id="searchBarToggleWrap">
        <button class="search-bar-toggle" id="searchBarToggle" onclick="toggleSearchBar()">‚ñº</button>
    </div>
    <!-- Search results banner -->
    <div class="search-results-banner" id="homeSearchResultsBanner"></div>

    <!-- All Pages Wrapper -->
    <div id="pagesWrapper" style="flex: 1; width: 100%; max-width: 100%; padding: 1.5rem 1rem; box-sizing: border-box; overflow-x: hidden;">

    <!-- Home Page -->
    <div id="homePage" style="display: block; max-width: 1200px; margin: 0 auto;">
                <!-- Featured Posts -->
                <div class="card home-section-card">
                    <h2 class="card-title">‚≠ê –û–±—Ä–∞–Ω—ñ –ø—É–±–ª—ñ–∫–∞—Ü—ñ—ó</h2>
                    <div id="featuredPosts">
                        <div class="loading">–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...</div>
                    </div>
                </div>

                <!-- Random Poetry -->
                <div class="card home-section-card">
                    <h2 class="card-title">üìú –í–∏–ø–∞–¥–∫–æ–≤—ñ –≤—ñ—Ä—à—ñ</h2>
                    <div id="randomPoetry" class="random-grid">
                        <div class="loading">–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...</div>
                    </div>
                </div>

                <!-- Random Thoughts -->
                <div class="card home-section-card">
                    <h2 class="card-title">üí≠ –í–∏–ø–∞–¥–∫–æ–≤—ñ –¥—É–º–∫–∏</h2>
                    <div id="randomThoughts">
                        <div class="loading">–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...</div>
                    </div>
                </div>

                <!-- Bottom Grid -->
                <div class="home-bottom-grid">
                    <!-- Users List -->
                    <div class="card">
                        <h3 class="card-title">üë• –ü–æ–µ—Ç–∏</h3>
                        <div id="usersList">
                            <div class="loading">–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...</div>
                        </div>
                    </div>

                    <!-- Hashtag Cloud -->
                    <div class="card">
                        <h3 class="card-title">#Ô∏è‚É£ –ü–æ–ø—É–ª—è—Ä–Ω—ñ —Ç–µ–º–∏</h3>
                        <div id="hashtagCloud" class="hashtag-cloud">
                            <div class="loading">–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...</div>
                        </div>
                    </div>
                </div>
    </div><!-- /homePage -->

    <!-- Auth Modal -->
    <div id="authModal" class="modal">
        <div class="modal-content">
            <h2 class="card-title" id="authTitle">–í—Ö—ñ–¥</h2>
            
            <!-- Login Form -->
            <div id="loginForm">
                <div class="form-group">
                    <label class="form-label">Email</label>
                    <input type="email" class="form-input" id="loginEmail">
                </div>
                <div class="form-group">
                    <label class="form-label">–ü–∞—Ä–æ–ª—å</label>
                    <input type="password" class="form-input" id="loginPassword">
                </div>
                <button class="btn btn-primary" style="width: 100%; margin-bottom: 1rem;" onclick="handleLogin()">–£–≤—ñ–π—Ç–∏</button>
                <button class="btn btn-secondary" style="width: 100%;" onclick="closeAuthModal()">–°–∫–∞—Å—É–≤–∞—Ç–∏</button>
            </div>

            <!-- Register Form -->
            <div id="registerForm" style="display: none;">
                <div class="form-group">
                    <label class="form-label">–Ü–º'—è (–ø—Å–µ–≤–¥–æ–Ω—ñ–º)</label>
                    <input type="text" class="form-input" id="registerName">
                </div>
                <div class="form-group">
                    <label class="form-label">Email</label>
                    <input type="email" class="form-input" id="registerEmail">
                </div>
                <div class="form-group">
                    <label class="form-label">–ü–∞—Ä–æ–ª—å</label>
                    <input type="password" class="form-input" id="registerPassword">
                </div>
                <button class="btn btn-primary" style="width: 100%; margin-bottom: 1rem;" onclick="handleRegister()">–ó–∞—Ä–µ—î—Å—Ç—Ä—É–≤–∞—Ç–∏—Å—è</button>
                <button class="btn btn-secondary" style="width: 100%;" onclick="closeAuthModal()">–°–∫–∞—Å—É–≤–∞—Ç–∏</button>
            </div>
        </div>
    </div>

    <!-- User Profile Page -->
    <div id="profilePage" style="display: none;">
        <div class="container" style="max-width: 900px;">
            <!-- Profile Header -->
            <div class="card" style="margin-bottom: 2rem;">
                <!-- Buttons row (top right) -->
                <div id="profileBtnsRow" style="display: none; justify-content: flex-end; gap: 0.5rem; margin-bottom: 0.75rem;">
                    <button class="btn btn-secondary" onclick="shareProfile()" id="shareProfileBtn" style="display: none;">üîó –ü–æ–¥—ñ–ª–∏—Ç–∏—Å—è</button>
                    <button class="btn btn-primary" onclick="showNewPostModal()" id="newPostBtn" style="display: none;">‚ûï –ù–æ–≤–∞ –ø—É–±–ª—ñ–∫–∞—Ü—ñ—è</button>
                </div>

                <!-- Avatar + Name row -->
                <div style="display: flex; align-items: center; gap: 1.25rem; margin-bottom: 0.75rem;">
                    <div id="profileAvatarWrap" style="flex-shrink: 0;">
                        <img id="profileAvatarImg" src="" alt="" style="display:none; width:80px; height:80px; border-radius:50%; object-fit:cover; border:3px solid var(--accent); box-shadow:0 2px 8px var(--shadow);">
                        <div id="profileAvatarPlaceholder" style="width:80px; height:80px; border-radius:50%; background:var(--bg-secondary); border:3px solid var(--border); display:flex; align-items:center; justify-content:center; font-size:2rem; color:var(--text-lighter);">üë§</div>
                    </div>
                    <h2 class="card-title" id="profileName" style="margin:0;">–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...</h2>
                </div>

                <!-- Bio Block -->
                <div id="profileBioBlock" style="margin-bottom: 0.8rem; width: 100%;">
                    <div id="profileBioText" style="color: var(--text-main); font-style: italic; line-height: 1.7; white-space: pre-wrap; width: 100%;"></div>
                    <button id="editBioBtn" onclick="showEditBio()" style="display: none; margin-top: 0.75rem;" class="btn btn-secondary btn-small">‚úèÔ∏è –†–µ–¥–∞–≥—É–≤–∞—Ç–∏ –±—ñ–æ–≥—Ä–∞—Ñ—ñ—é</button>
                </div>

                <!-- Bio Edit Form -->
                <div id="bioEditForm" style="display: none; margin-bottom: 1rem; width: 100%;">
                    <div class="form-group">
                        <label class="form-label">–§–æ—Ç–æ –ø—Ä–æ—Ñ—ñ–ª—é (–ø–æ—Å–∏–ª–∞–Ω–Ω—è –Ω–∞ –∑–æ–±—Ä–∞–∂–µ–Ω–Ω—è)</label>
                        <input type="url" id="avatarUrlInput" class="form-input" placeholder="https://example.com/photo.jpg" style="margin-bottom: 0.5rem;">
                    </div>
                    <div class="form-group">
                        <label class="form-label">–ë—ñ–æ–≥—Ä–∞—Ñ—ñ—è</label>
                        <textarea id="bioInput" class="form-input" rows="4" placeholder="–†–æ–∑–∫–∞–∂—ñ—Ç—å –ø—Ä–æ —Å–µ–±–µ... –í–∞—à —Ç–≤–æ—Ä—á–∏–π —à–ª—è—Ö, –Ω–∞—Ç—Ö–Ω–µ–Ω–Ω—è, –∑–∞—Ö–æ–ø–ª–µ–Ω–Ω—è." style="width: 100%; margin-bottom: 0.5rem; resize: vertical;"></textarea>
                    </div>
                    <div style="display: flex; gap: 0.5rem;">
                        <button class="btn btn-primary btn-small" onclick="saveBio()">üíæ –ó–±–µ—Ä–µ–≥—Ç–∏</button>
                        <button class="btn btn-secondary btn-small" onclick="cancelEditBio()">‚úï –°–∫–∞—Å—É–≤–∞—Ç–∏</button>
                    </div>
                </div>

                <div id="profileStats" style="color: var(--text-light);"></div>
            </div>

            <!-- Search results banner for profile -->
            <div class="search-results-banner" id="profileSearchResultsBanner" style="border-radius: 8px; margin-bottom: 1rem;"></div>

            <!-- Posts Grid -->
            <div id="profilePosts"></div>
            <div id="profilePagination" class="pagination-bar"></div>
        </div>
    </div>

    <!-- All Posts Page -->
    <div id="allPostsPage" style="display: none;">
        <div style="max-width: 1200px; margin: 0 auto; padding: 0 1rem;">
            <h2 class="card-title" style="padding: 1.5rem 0 0.5rem;">üìö –í—Å—ñ –ø—É–±–ª—ñ–∫–∞—Ü—ñ—ó</h2>
            <div class="search-results-banner" id="allPostsSearchResultsBanner" style="border-radius: 8px; margin-bottom: 1rem;"></div>
            <div id="allPostsContainer"></div>
            <div id="allPostsPagination" class="pagination-bar"></div>
        </div>
    </div>

    <!-- All Poets Page -->
    <div id="poetsPage" style="display: none;">
        <div class="card" style="max-width: 1200px; margin: 0 auto;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                <h2 class="card-title" style="margin-bottom: 0;">üë• –í—Å—ñ –ø–æ–µ—Ç–∏</h2>
                <button class="search-toggle-btn" id="poetsSearchToggleBtn" onclick="togglePoetsSearch()" title="–ü–æ—à—É–∫">üîç</button>
            </div>
            <!-- Poets Search (collapsed by default) -->
            <div class="search-filter-bar" id="poetsSearchFilterBar" style="border-radius: 10px; margin-bottom: 1rem; border: 1px solid var(--border-light); box-shadow: none;">
                <div class="search-filter-inner">
                    <div class="search-box-row">
                        <input type="text" class="search-input-main" id="poetsSearchInput" autocomplete="off" placeholder="–ü–æ—à—É–∫ –∑–∞ —ñ–º–µ–Ω–µ–º –∞–±–æ –±—ñ–æ–≥—Ä–∞—Ñ—ñ—î—é..." onkeypress="if(event.key==='Enter') runPoetsSearch()">
                        <button class="search-btn-main" onclick="runPoetsSearch()">üîç –ó–Ω–∞–π—Ç–∏</button>
                        <button class="search-clear-btn" id="poetsClearBtn" onclick="clearPoetsSearch()">‚úï –°–∫–∏–Ω—É—Ç–∏</button>
                    </div>
                </div>
            </div>
            <div class="search-results-banner" id="poetsSearchResultsBanner" style="border-radius: 8px; margin-bottom: 1rem;"></div>
            <div id="allPoetsContainer">
                <div class="loading">–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...</div>
            </div>
        </div>
    </div>


    <!-- Single Post Page -->
    <div id="postPage" style="display: none;">
        <div class="container" style="max-width: 800px;">
            <div class="card" style="margin-bottom: 2rem;">
                <!-- Back navigation -->
                <div id="postPageBack" style="margin-bottom: 1.5rem;">
                    <button class="btn btn-secondary btn-small" onclick="history.back()">‚Üê –ù–∞–∑–∞–¥</button>
                </div>
                <span class="post-type-badge" id="postPageBadge"></span>
                <h1 id="postPageTitle" style="font-family: 'Philosopher', sans-serif; font-size: 2.4rem; color: var(--primary); margin: 0.8rem 0; line-height: 1.3;"></h1>
                <div id="postPageDate" style="color: var(--text-light); font-size: 0.95rem; margin-bottom: 1.5rem; font-style: italic;"></div>
                <div id="postPageContent" style="white-space: pre-wrap; line-height: 2; font-size: 1.25rem; margin-bottom: 1.5rem;"></div>
                <div id="postPageHashtags" style="margin-bottom: 1.5rem;"></div>
                <!-- Action buttons -->
                <div style="display: flex; gap: 0.5rem; margin-bottom: 1rem; flex-wrap: wrap;">
                    <button class="btn btn-primary btn-small" id="postPageDownloadBtn" onclick="downloadPostAsImage(window.currentPostId)">üì• –ó–±–µ—Ä–µ–≥—Ç–∏ —è–∫ —Ñ–æ—Ç–æ</button>
                    <button class="btn btn-secondary btn-small" id="postPageShareBtn" onclick="sharePost(window.currentPostId)">üîó –ü–æ–¥—ñ–ª–∏—Ç–∏—Å—è</button>
                </div>
                <div style="padding-top: 1rem; border-top: 1px solid var(--border);">
                    <div id="postPageAuthorLink" style="display: flex; align-items: center; gap: 0.75rem; cursor: pointer; width: fit-content;">
                        <div id="postPageAuthorAvatar" style="width: 42px; height: 42px; border-radius: 50%; background: var(--accent-light); display: flex; align-items: center; justify-content: center; color: white; font-weight: 700; font-size: 1.1rem; flex-shrink: 0;"></div>
                        <div>
                            <div style="font-size: 0.8rem; color: var(--text-lighter);">–ê–≤—Ç–æ—Ä</div>
                            <div id="postPageAuthorName" style="font-weight: 700; color: var(--accent); font-family: 'Philosopher', sans-serif; font-size: 1.05rem;"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- New Post Modal -->
    <div id="newPostModal" class="modal">
        <div class="modal-content" style="max-width: 600px;">
            <h2 class="card-title">‚ûï –ù–æ–≤–∞ –ø—É–±–ª—ñ–∫–∞—Ü—ñ—è</h2>
            
            <div class="form-group">
                <label class="form-label">–¢–∏–ø</label>
                <select class="form-input" id="newPostType">
                    <option value="poetry">–ü–æ–µ–∑—ñ—è</option>
                    <option value="thought">–î—É–º–∫–∞</option>
                </select>
            </div>

            <div class="form-group">
                <label class="form-label">–ù–∞–∑–≤–∞</label>
                <input type="text" class="form-input" id="newPostTitle">
            </div>

            <div class="form-group">
                <label class="form-label">–¢–µ–∫—Å—Ç</label>
                <textarea class="form-input" id="newPostContent" rows="10"></textarea>
            </div>

            <div class="form-group">
                <label class="form-label">–•–µ—à—Ç–µ–≥–∏ (—á–µ—Ä–µ–∑ –ø—Ä–æ–±—ñ–ª, –Ω–∞–ø—Ä–∏–∫–ª–∞–¥: #–∫–æ—Ö–∞–Ω–Ω—è #–ø—Ä–∏—Ä–æ–¥–∞)</label>
                <input type="text" class="form-input" id="newPostHashtags">
            </div>

            <button class="btn btn-primary" style="width: 100%; margin-bottom: 1rem;" onclick="handleCreatePost()">–û–ø—É–±–ª—ñ–∫—É–≤–∞—Ç–∏</button>
            <button class="btn btn-secondary" style="width: 100%;" onclick="closeNewPostModal()">–°–∫–∞—Å—É–≤–∞—Ç–∏</button>
        </div>
    </div>

    <!-- Admin Panel Page -->
    <div id="adminPage" style="display: none;">
        <div class="card" style="max-width: 1200px; margin: 0 auto;">
            <h2 class="card-title">‚öôÔ∏è –ê–¥–º—ñ–Ω –ø–∞–Ω–µ–ª—å</h2>
            
            <!-- Admin Tabs -->
            <div style="display: flex; gap: 1rem; margin-bottom: 2rem; border-bottom: 2px solid var(--border);">
                <button class="admin-tab-btn active" onclick="showAdminTab('stats')">üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</button>
                <button class="admin-tab-btn" onclick="showAdminTab('posts')">üìù –ü—É–±–ª—ñ–∫–∞—Ü—ñ—ó</button>
                <button class="admin-tab-btn" onclick="showAdminTab('theme')">üé® –¢–µ–º–∞ —Å–∞–π—Ç—É</button>
            </div>

            <!-- Stats Tab -->
            <div id="adminTabStats" class="admin-tab-content">
                <h3 style="font-family: 'Philosopher', sans-serif; color: var(--primary); margin-bottom: 1.5rem;">–ó–∞–≥–∞–ª—å–Ω–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–ª–∞—Ç—Ñ–æ—Ä–º–∏</h3>
                <div id="adminStatsGrid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); gap: 1.5rem; margin-bottom: 2.5rem;">
                    <!-- stat cards injected by JS -->
                </div>
                <h3 style="font-family: 'Philosopher', sans-serif; color: var(--primary); margin-bottom: 1rem;">–ê–∫—Ç–∏–≤–Ω—ñ—Å—Ç—å –∑–∞ –æ—Å—Ç–∞–Ω–Ω—ñ 7 –¥–Ω—ñ–≤</h3>
                <div id="adminActivityChart" style="background: var(--bg-secondary); border-radius: 12px; padding: 1.5rem; border: 1px solid var(--border-light);">
                    <!-- chart injected by JS -->
                </div>
                <h3 style="font-family: 'Philosopher', sans-serif; color: var(--primary); margin: 2rem 0 1rem;">–ù–æ–≤—ñ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ (–æ—Å—Ç–∞–Ω–Ω—ñ 7 –¥–Ω—ñ–≤)</h3>
                <div id="adminNewUsersList" style="background: var(--bg-secondary); border-radius: 12px; padding: 1rem; border: 1px solid var(--border-light);">
                    <!-- list injected by JS -->
                </div>
            </div>

            <!-- Posts Tab -->
            <div id="adminTabPosts" class="admin-tab-content" style="display:none;">
                <div style="margin-bottom: 2rem;">
                    <h3 style="font-family: 'Philosopher', sans-serif; color: var(--primary); margin-bottom: 1rem;">–ö–µ—Ä—É–≤–∞–Ω–Ω—è –ø—É–±–ª—ñ–∫–∞—Ü—ñ—è–º–∏</h3>
                    <p style="color: var(--text-light); margin-bottom: 1rem;">–ü–æ–∑–Ω–∞—á–∞–π—Ç–µ –Ω–∞–π–∫—Ä–∞—â—ñ –ø—É–±–ª—ñ–∫–∞—Ü—ñ—ó —è–∫ "–æ–±—Ä–∞–Ω—ñ" - –≤–æ–Ω–∏ –∑'—è–≤–ª—è—Ç—å—Å—è –Ω–∞ –≥–æ–ª–æ–≤–Ω—ñ–π —Å—Ç–æ—Ä—ñ–Ω—Ü—ñ</p>
                </div>
                <div id="adminPostsList">
                    <div class="loading">–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...</div>
                </div>
            </div>

            <!-- Theme Tab -->
            <div id="adminTabTheme" class="admin-tab-content" style="display: none;">
                <p style="color: var(--text-light); margin-bottom: 2rem;">–û–±–µ—Ä—ñ—Ç—å –∫–æ–ª—ñ—Ä–Ω—É —Å—Ö–µ–º—É –¥–ª—è –≤–∞—à–æ–≥–æ —Å–∞–π—Ç—É. –ó–º—ñ–Ω–∏ –∑–∞—Å—Ç–æ—Å–æ–≤—É—é—Ç—å—Å—è –¥–ª—è –≤—Å—ñ—Ö –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ–≤ –ø–ª–∞—Ç—Ñ–æ—Ä–º–∏.</p>
                
                <div id="themeCardsContainer" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 1.5rem;">
                    <!-- Theme cards will be inserted here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Migration Tool (hidden, only for initial setup) -->
    <div id="migrationTool" style="display: none;">
        <div class="card" style="max-width: 800px; margin: 2rem auto;">
            <h2 class="card-title">üì¶ –ú—ñ–≥—Ä–∞—Ü—ñ—è –¥–∞–Ω–∏—Ö –∑—ñ —Å—Ç–∞—Ä–æ–≥–æ –±–ª–æ–≥—É</h2>
            <p style="color: var(--text-light); margin-bottom: 1rem;">
                –¶—è —Ñ—É–Ω–∫—Ü—ñ—è –¥–æ–∑–≤–æ–ª—è—î –ø–µ—Ä–µ–Ω–µ—Å—Ç–∏ –≤—Å—ñ –≤–∞—à—ñ —ñ—Å–Ω—É—é—á—ñ –ø—É–±–ª—ñ–∫–∞—Ü—ñ—ó –∑—ñ —Å—Ç–∞—Ä–æ–≥–æ –±–ª–æ–≥—É –Ω–∞ –Ω–æ–≤—É –ø–ª–∞—Ç—Ñ–æ—Ä–º—É.
            </p>
            <button class="btn btn-primary" onclick="migrateOldPosts()">–ü–æ—á–∞—Ç–∏ –º—ñ–≥—Ä–∞—Ü—ñ—é</button>
        </div>
    </div>

    </div><!-- /pagesWrapper -->

    <script type="module">
        // Firebase imports
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getDatabase, ref, set, get, push, onValue, remove } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js';
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';

        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyAFV8kimd0f2dLw3yyQNj3fIyY4_5zCQB0",
            authDomain: "poetry-blog-ff72f.firebaseapp.com",
            databaseURL: "https://poetry-blog-ff72f-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "poetry-blog-ff72f",
            storageBucket: "poetry-blog-ff72f.firebasestorage.app",
            messagingSenderId: "331598419628",
            appId: "1:331598419628:web:d1093b30ab867d3d40b109"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const database = getDatabase(app);
        const auth = getAuth(app);

        // Global variables
        window.currentUser = null;
        window.allPosts = [];
        window.allUsers = [];

        // Auto-create admin account on first load
        async function initializeAdminAccount() {
            const adminEmail = 'krasovsky.oleg.seo@gmail.com';
            const adminName = 'KonVi';
            
            // Check if admin user exists
            const usersSnapshot = await get(ref(database, 'users'));
            let adminExists = false;
            
            if (usersSnapshot.exists()) {
                usersSnapshot.forEach((childSnapshot) => {
                    const userData = childSnapshot.val();
                    if (userData.email === adminEmail) {
                        adminExists = true;
                    }
                });
            }

            // If admin doesn't exist, create a placeholder
            if (!adminExists) {
                console.log('üîß –ü—ñ–¥–≥–æ—Ç–æ–≤–∫–∞ –¥–æ —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è –∞–¥–º—ñ–Ω –∞–∫–∞—É–Ω—Ç—É...');
                console.log('üìß Email:', adminEmail);
                console.log('üë§ –ù—ñ–∫–Ω–µ–π–º:', adminName);
                console.log('‚ÑπÔ∏è –ó–∞—Ä–µ—î—Å—Ç—Ä—É–π—Ç–µ—Å—è –∑ —Ü–∏–º–∏ –¥–∞–Ω–∏–º–∏ –¥–ª—è –æ—Ç—Ä–∏–º–∞–Ω–Ω—è –∞–¥–º—ñ–Ω –ø—Ä–∞–≤');
            }
        }

        // Initialize admin check
        initializeAdminAccount();

        // Auth Modal Functions
        window.showAuthModal = function(type) {
            const modal = document.getElementById('authModal');
            const title = document.getElementById('authTitle');
            const loginForm = document.getElementById('loginForm');
            const registerForm = document.getElementById('registerForm');

            if (type === 'login') {
                title.textContent = '–í—Ö—ñ–¥';
                loginForm.style.display = 'block';
                registerForm.style.display = 'none';
            } else {
                title.textContent = '–†–µ—î—Å—Ç—Ä–∞—Ü—ñ—è';
                loginForm.style.display = 'none';
                registerForm.style.display = 'block';
            }

            modal.classList.add('active');
        };

        window.closeAuthModal = function() {
            document.getElementById('authModal').classList.remove('active');
        };

        // Authentication Functions
        window.handleRegister = async function() {
            const name = document.getElementById('registerName').value.trim();
            const email = document.getElementById('registerEmail').value.trim();
            const password = document.getElementById('registerPassword').value;

            if (!name || !email || !password) {
                alert('–ó–∞–ø–æ–≤–Ω—ñ—Ç—å –≤—Å—ñ –ø–æ–ª—è');
                return;
            }

            try {
                const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                const user = userCredential.user;

                // Check if this is the admin email
                const isAdminEmail = email === 'krasovsky.oleg.seo@gmail.com';

                // Create user profile in database
                await set(ref(database, `users/${user.uid}`), {
                    name: name,
                    email: email,
                    createdAt: Date.now(),
                    postsCount: 0,
                    poetryCount: 0,
                    thoughtsCount: 0,
                    isAdmin: isAdminEmail
                });

                if (isAdminEmail) {
                    alert('‚úÖ –†–µ—î—Å—Ç—Ä–∞—Ü—ñ—è —É—Å–ø—ñ—à–Ω–∞! –í–∏ –æ—Ç—Ä–∏–º–∞–ª–∏ –ø—Ä–∞–≤–∞ –∞–¥–º—ñ–Ω—ñ—Å—Ç—Ä–∞—Ç–æ—Ä–∞.');
                } else {
                    alert('‚úÖ –†–µ—î—Å—Ç—Ä–∞—Ü—ñ—è —É—Å–ø—ñ—à–Ω–∞!');
                }
                closeAuthModal();
            } catch (error) {
                console.error('Registration error:', error);
                alert('‚ùå –ü–æ–º–∏–ª–∫–∞ —Ä–µ—î—Å—Ç—Ä–∞—Ü—ñ—ó: ' + error.message);
            }
        };

        window.handleLogin = async function() {
            const email = document.getElementById('loginEmail').value.trim();
            const password = document.getElementById('loginPassword').value;

            if (!email || !password) {
                alert('–ó–∞–ø–æ–≤–Ω—ñ—Ç—å –≤—Å—ñ –ø–æ–ª—è');
                return;
            }

            try {
                await signInWithEmailAndPassword(auth, email, password);
                closeAuthModal();
            } catch (error) {
                console.error('Login error:', error);
                alert('‚ùå –ü–æ–º–∏–ª–∫–∞ –≤—Ö–æ–¥—É: ' + error.message);
            }
        };

        window.handleLogout = async function() {
            try {
                await signOut(auth);
                alert('–í–∏ –≤–∏–π—à–ª–∏ –∑ —Å–∏—Å—Ç–µ–º–∏');
            } catch (error) {
                console.error('Logout error:', error);
            }
        };

        // Auth State Observer
        onAuthStateChanged(auth, async (user) => {
            const userMenu = document.getElementById('userMenu');
            
            if (user) {
                // User is signed in
                window.currentUser = user;
                
                // Get user profile
                const userSnapshot = await get(ref(database, `users/${user.uid}`));
                const userData = userSnapshot.val();
                
                // Check if user is admin
                window.isAdmin = userData?.isAdmin || false;
                
                userMenu.innerHTML = `
                    <span style="color: var(--accent); font-weight: 600;">üë§ ${userData?.name || '–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á'}</span>
                    ${window.isAdmin ? '<button class="btn btn-secondary" onclick="showAdminPanel()">‚öôÔ∏è –ê–¥–º—ñ–Ω</button>' : ''}
                    <button class="btn btn-secondary" onclick="showMyProfile()">–ú—ñ–π –ø—Ä–æ—Ñ—ñ–ª—å</button>
                    <button class="btn btn-primary" onclick="handleLogout()">–í–∏–π—Ç–∏</button>
                `;
                setTimeout(syncMobileUserMenu, 0);
            } else {
                // User is signed out
                window.currentUser = null;
                userMenu.innerHTML = `
                    <button class="btn btn-secondary" onclick="showAuthModal('login')">–£–≤—ñ–π—Ç–∏</button>
                    <button class="btn btn-primary" onclick="showAuthModal('register')">–†–µ—î—Å—Ç—Ä–∞—Ü—ñ—è</button>
                `;
                setTimeout(syncMobileUserMenu, 0);
            }
        });

        // –ü—Ä–∞–ø–æ—Ä—Ü—ñ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç—ñ –¥–∞–Ω–∏—Ö
        window._postsReady = false;
        window._usersReady = false;

        // –ü–µ—Ä–µ—Ä–µ–Ω–¥–µ—Ä–∏—Ç–∏ –≥–æ–ª–æ–≤–Ω—É –ø—ñ—Å–ª—è —Ç–æ–≥–æ, —è–∫ –∑–∞–≤–∞–Ω—Ç–∞–∂–∏–ª–∏—Å—å –æ–±–∏–¥–≤–∞ –º–∞—Å–∏–≤–∏
        function refreshHomeIfReady() {
            if (window._postsReady && window._usersReady) {
                loadFeaturedPosts();
                loadRandomPoetry();
                loadRandomThoughts();
                loadUsersList();
                loadHashtagCloud();
                buildHomeHashtagChips(); // bar is open by default
            }
        }

        // Load all posts
        onValue(ref(database, 'posts'), (snapshot) => {
            window.allPosts = [];
            snapshot.forEach((childSnapshot) => {
                const post = childSnapshot.val();
                const firebaseKey = childSnapshot.key;
                
                // –§—ñ–ª—å—Ç—Ä—É—î–º–æ –ø–æ—Ä–æ–∂–Ω—ñ/–Ω–µ–ø–æ–≤–Ω—ñ –ø–æ—Å—Ç–∏
                if (post && post.title && post.content && post.date && post.userId) {
                    // –í–ê–ñ–õ–ò–í–û: –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ Firebase key —è–∫ ID, –Ω–∞–≤—ñ—Ç—å —è–∫—â–æ –≤ post —î —Å–≤–æ—î –ø–æ–ª–µ id
                    window.allPosts.push({
                        ...post,
                        id: firebaseKey  // –ó–∞–≤–∂–¥–∏ –ø–µ—Ä–µ–∑–∞–ø–∏—Å—É—î–º–æ –ø—Ä–∞–≤–∏–ª—å–Ω–∏–º Firebase ID
                    });
                }
            });
            
            console.log('Loaded posts:', window.allPosts.length);
            console.log('Sample post IDs:', window.allPosts.slice(0, 3).map(p => p.id));
            
            window._postsReady = true;
            refreshHomeIfReady();
        });

        // Load all users
        onValue(ref(database, 'users'), (snapshot) => {
            window.allUsers = [];
            snapshot.forEach((childSnapshot) => {
                window.allUsers.push({
                    id: childSnapshot.key,
                    ...childSnapshot.val()
                });
            });
            
            window._usersReady = true;
            refreshHomeIfReady();
        });

        // Load Featured Posts (posts marked by admin)
        function loadFeaturedPosts() {
            const featured = window.allPosts.filter(p => p.featured).slice(0, 8);
            const container = document.getElementById('featuredPosts');
            if (featured.length === 0) {
                container.className = '';
                container.innerHTML = '<p style="color: var(--text-light);">–ù–µ–º–∞—î –æ–±—Ä–∞–Ω–∏—Ö –ø—É–±–ª—ñ–∫–∞—Ü—ñ–π</p>';
                return;
            }
            container.className = 'thoughts-scroll-row';
            container.innerHTML = featured.map(post => {
                const content = post.content || '';
                const isPoetry = post.type === 'poetry';
                const preview = content.length > 200 ? content.substring(0, 200) + '...' : content;
                const ws = isPoetry ? 'pre-wrap' : 'normal';
                return `<div class="random-card" onclick="showPost('${post.id}')">
                        <div class="random-card-title">${post.title || '–ë–µ–∑ –Ω–∞–∑–≤–∏'}</div>
                        <div class="random-card-author" onclick="event.stopPropagation(); showUserProfile('${post.userId}')" style="cursor:pointer;">&#9997;&#65039; ${getUserName(post.userId)}</div>
                        <div class="random-card-content" style="white-space:${ws};">${preview}</div>
                    </div>`;
            }).join('');
        }

        // Load Random Poetry
        function loadRandomPoetry() {
            const poetry = window.allPosts.filter(p => p.type === 'poetry');
            const random = [...poetry].sort(() => 0.5 - Math.random()).slice(0, 8);
            const container = document.getElementById('randomPoetry');
            if (random.length === 0) {
                container.className = '';
                container.innerHTML = '<p style="color: var(--text-light);">–ù–µ–º–∞—î –≤—ñ—Ä—à—ñ–≤</p>';
                return;
            }
            container.className = 'thoughts-scroll-row';
            container.innerHTML = random.map(post => {
                const content = post.content || '';
                const preview = content.length > 200 ? content.substring(0, 200) + '...' : content;
                return `<div class="random-card" onclick="showPost('${post.id}')">
                        <div class="random-card-title">${post.title || '–ë–µ–∑ –Ω–∞–∑–≤–∏'}</div>
                        <div class="random-card-author" onclick="event.stopPropagation(); showUserProfile('${post.userId}')" style="cursor:pointer;">‚úçÔ∏è ${getUserName(post.userId)}</div>
                        <div class="random-card-content" style="white-space:pre-wrap;">${preview}</div>
                    </div>`;
            }).join('');
        }

        // Load Random Thoughts
        function loadRandomThoughts() {
            const thoughts = window.allPosts.filter(p => p.type === 'thought');
            const random = [...thoughts].sort(() => 0.5 - Math.random()).slice(0, 8);
            const container = document.getElementById('randomThoughts');
            
            if (random.length === 0) {
                container.innerHTML = '<p style="color: var(--text-light);">–ù–µ–º–∞—î –¥—É–º–æ–∫</p>';
                return;
            }

            container.className = 'thoughts-scroll-row';
            container.innerHTML = random.map(post => {
                const content = post.content || '';
                const preview = content.length > 200 ? content.substring(0, 200) + '...' : content;
                
                return `
                    <div class="random-card" onclick="showPost('${post.id}')">
                        <div class="random-card-title">${post.title || '–ë–µ–∑ –Ω–∞–∑–≤–∏'}</div>
                        <div class="random-card-author" onclick="event.stopPropagation(); showUserProfile('${post.userId}')" style="cursor:pointer;">‚úçÔ∏è ${getUserName(post.userId)}</div>
                        <div class="random-card-content" style="white-space: normal;">${preview}</div>
                    </div>
                `;
            }).join('');
        }

        // Load Users List
        function renderRandomPoets() {
            const container = document.getElementById('usersList');
            if (!container || window.allUsers.length === 0) return;

            const shuffled = [...window.allUsers].sort(() => 0.5 - Math.random()).slice(0, 2);

            container.style.transition = 'opacity 0.4s ease';
            container.style.opacity = '0';

            setTimeout(() => {
                container.innerHTML = shuffled.map(user => `
                    <div class="user-item" style="cursor: pointer;" onclick="showUserProfile('${user.id}')">
                        ${user.avatarUrl
                            ? `<img src="${user.avatarUrl}" alt="${user.name}" style="width:38px;height:38px;border-radius:50%;object-fit:cover;flex-shrink:0;border:2px solid var(--accent);">`
                            : `<div class="user-avatar">${user.name.charAt(0).toUpperCase()}</div>`
                        }
                        <div class="user-info">
                            <div class="user-name">${user.name}</div>
                            <div class="user-stats">üìù ${user.postsCount || 0} –ø—É–±–ª—ñ–∫–∞—Ü—ñ–π</div>
                            ${user.bio ? `<div style="font-size: 0.82rem; color: var(--text-lighter); font-style: italic; margin-top: 0.2rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 200px;">${user.bio}</div>` : ''}
                        </div>
                    </div>
                `).join('');
                container.style.opacity = '1';
            }, 400);
        }

        function loadUsersList() {
            const container = document.getElementById('usersList');
            if (window.allUsers.length === 0) {
                container.innerHTML = '<p style="color: var(--text-light);">–ù–µ–º–∞—î –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ–≤</p>';
                return;
            }

            renderRandomPoets();

            // –û—á–∏—â—É—î–º–æ –ø–æ–ø–µ—Ä–µ–¥–Ω—ñ–π —ñ–Ω—Ç–µ—Ä–≤–∞–ª —è–∫—â–æ —î
            if (window._poetsInterval) clearInterval(window._poetsInterval);
            window._poetsInterval = setInterval(() => {
                // –ú—ñ–Ω—è—î–º–æ —Ç—ñ–ª—å–∫–∏ —è–∫—â–æ –±–ª–æ–∫ –≤–∏–¥–∏–º–∏–π
                if (document.getElementById('usersList')?.offsetParent !== null) {
                    renderRandomPoets();
                }
            }, 6000);
        }

        // Helper function
        function getUserName(userId) {
            const user = window.allUsers.find(u => u.id === userId);
            return user ? user.name : '–ù–µ–≤—ñ–¥–æ–º–∏–π –∞–≤—Ç–æ—Ä';
        }

        // Navigation Functions
        function hideAllPages() {
            ['homePage','profilePage','allPostsPage','poetsPage','adminPage','postPage'].forEach(id => {
                const el = document.getElementById(id);
                if (el) el.style.display = 'none';
            });
            setHomeSearchVisible(false);
        }

        window.showHome = function() {
            hideAllPages();
            document.getElementById('homePage').style.display = 'block';
            setHomeSearchVisible(true);
        };

        window.showPoets = function() {
            hideAllPages();
            document.getElementById('poetsPage').style.display = 'block';
            loadAllPoets();
        };

        window.showAllPosts = function() {
            hideAllPages();
            document.getElementById('allPostsPage').style.display = 'block';
            loadAllPostsPage();
        };

        window.showMyProfile = function() {
            if (!window.currentUser) {
                alert('–°–ø–æ—á–∞—Ç–∫—É —É–≤—ñ–π–¥—ñ—Ç—å –≤ —Å–∏—Å—Ç–µ–º—É');
                return;
            }
            hideAllPages();
            document.getElementById('profilePage').style.display = 'block';
            loadMyProfile();
        };

        window.showUserProfile = async function(userId) {
            hideAllPages();
            document.getElementById('profilePage').style.display = 'block';
            loadUserProfile(userId);
        };

        window.showAdminPanel = function() {
            if (!window.isAdmin) {
                alert('–î–æ—Å—Ç—É–ø –∑–∞–±–æ—Ä–æ–Ω–µ–Ω–æ');
                return;
            }
            hideAllPages();
            document.getElementById('adminPage').style.display = 'block';

            // Activate stats tab by default
            document.querySelectorAll('.admin-tab-btn').forEach((btn, i) => btn.classList.toggle('active', i === 0));
            document.getElementById('adminTabStats').style.display = 'block';
            document.getElementById('adminTabPosts').style.display = 'none';
            document.getElementById('adminTabTheme').style.display = 'none';

            loadAdminPanel();
        };

        // New Post Modal
        window.showNewPostModal = function() {
            document.getElementById('newPostModal').classList.add('active');
        };

        window.closeNewPostModal = function() {
            document.getElementById('newPostModal').classList.remove('active');
            document.getElementById('newPostTitle').value = '';
            document.getElementById('newPostContent').value = '';
            document.getElementById('newPostHashtags').value = '';
        };

        // Create Post
        window.handleCreatePost = async function() {
            if (!window.currentUser) {
                alert('–°–ø–æ—á–∞—Ç–∫—É —É–≤—ñ–π–¥—ñ—Ç—å –≤ —Å–∏—Å—Ç–µ–º—É');
                return;
            }

            const type = document.getElementById('newPostType').value;
            const title = document.getElementById('newPostTitle').value.trim();
            const content = document.getElementById('newPostContent').value.trim();
            const hashtags = document.getElementById('newPostHashtags').value.trim();

            if (!title || !content) {
                alert('–ó–∞–ø–æ–≤–Ω—ñ—Ç—å –Ω–∞–∑–≤—É —Ç–∞ —Ç–µ–∫—Å—Ç');
                return;
            }

            try {
                const newPostRef = push(ref(database, 'posts'));
                await set(newPostRef, {
                    userId: window.currentUser.uid,
                    type: type,
                    title: title,
                    content: content,
                    hashtags: hashtags,
                    date: Date.now(),
                    featured: false
                });

                // Update user stats
                const userSnapshot = await get(ref(database, `users/${window.currentUser.uid}`));
                const userData = userSnapshot.val();
                await set(ref(database, `users/${window.currentUser.uid}`), {
                    ...userData,
                    postsCount: (userData.postsCount || 0) + 1,
                    poetryCount: type === 'poetry' ? (userData.poetryCount || 0) + 1 : userData.poetryCount,
                    thoughtsCount: type === 'thought' ? (userData.thoughtsCount || 0) + 1 : userData.thoughtsCount
                });

                alert('‚úÖ –ü—É–±–ª—ñ–∫–∞—Ü—ñ—è –¥–æ–¥–∞–Ω–∞!');
                closeNewPostModal();
                showMyProfile();
            } catch (error) {
                console.error('Error creating post:', error);
                alert('‚ùå –ü–æ–º–∏–ª–∫–∞ —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è –ø—É–±–ª—ñ–∫–∞—Ü—ñ—ó');
            }
        };

        // Load My Profile
        async function loadMyProfile() {
            if (!window.currentUser) return;

            window.currentProfileUserId = window.currentUser.uid;
            window.profileCurrentFilter = 'all';
            window.profileSearchQuery = '';
            window.profileSearchType = 'all';
            window.profileHashtagFilter = null;
            document.getElementById('profileSearchResultsBanner').style.display = 'none';

            const userSnapshot = await get(ref(database, `users/${window.currentUser.uid}`));
            const userData = userSnapshot.val();

            document.getElementById('profileName').textContent = userData.name || '–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á';
            document.getElementById('profileStats').innerHTML = `
                üìù –í—Å—å–æ–≥–æ –ø—É–±–ª—ñ–∫–∞—Ü—ñ–π: ${userData.postsCount || 0} | 
                üìú –í—ñ—Ä—à—ñ–≤: ${userData.poetryCount || 0} | 
                üí≠ –î—É–º–æ–∫: ${userData.thoughtsCount || 0}
            `;

            // Bio - —Å–≤–æ—è —Å—Ç–æ—Ä—ñ–Ω–∫–∞: –ø–æ–∫–∞–∑—É—î–º–æ –∫–Ω–æ–ø–∫—É —Ä–µ–¥–∞–≥—É–≤–∞–Ω–Ω—è
            const bioText = document.getElementById('profileBioText');
            const editBioBtn = document.getElementById('editBioBtn');
            if (userData.bio) {
                bioText.textContent = userData.bio;
                bioText.style.color = 'var(--text-main)';
            } else {
                bioText.textContent = '–ë—ñ–æ–≥—Ä–∞—Ñ—ñ—è –Ω–µ –¥–æ–¥–∞–Ω–∞. –†–æ–∑–∫–∞–∂—ñ—Ç—å –ø—Ä–æ —Å–µ–±–µ!';
                bioText.style.color = 'var(--text-lighter)';
            }
            setProfileAvatar(userData.avatarUrl || '');
            editBioBtn.style.display = 'inline-block';
            document.getElementById('bioEditForm').style.display = 'none';

            document.getElementById('newPostBtn').style.display = 'block';
            document.getElementById('shareProfileBtn').style.display = 'block';
            document.getElementById('profileBtnsRow').style.display = 'flex';
            // filter is now in header ‚Äî just reset state
            document.querySelectorAll('#headerFilterTabs .filter-tab').forEach(tab => tab.classList.remove('active'));
            const allHeaderTab = document.querySelector('#headerFilterTabs .filter-tab');
            if (allHeaderTab) allHeaderTab.classList.add('active');

            renderProfilePosts();
        }

        // Load User Profile
        async function loadUserProfile(userId) {
            window.currentProfileUserId = userId;
            window.profileCurrentFilter = 'all';
            window.profileSearchQuery = '';
            window.profileSearchType = 'all';
            window.profileHashtagFilter = null;
            document.getElementById('profileSearchResultsBanner').style.display = 'none';

            const userSnapshot = await get(ref(database, `users/${userId}`));
            const userData = userSnapshot.val();

            document.getElementById('profileName').textContent = userData.name || '–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á';
            document.getElementById('profileStats').innerHTML = `
                üìù –í—Å—å–æ–≥–æ –ø—É–±–ª—ñ–∫–∞—Ü—ñ–π: ${userData.postsCount || 0} | 
                üìú –í—ñ—Ä—à—ñ–≤: ${userData.poetryCount || 0} | 
                üí≠ –î—É–º–æ–∫: ${userData.thoughtsCount || 0}
            `;

            // Bio - —á—É–∂–∞ —Å—Ç–æ—Ä—ñ–Ω–∫–∞: –±–µ–∑ –∫–Ω–æ–ø–∫–∏ —Ä–µ–¥–∞–≥—É–≤–∞–Ω–Ω—è
            const bioText = document.getElementById('profileBioText');
            const editBioBtn = document.getElementById('editBioBtn');
            if (userData.bio) {
                bioText.textContent = userData.bio;
                bioText.style.color = 'var(--text-main)';
            } else {
                bioText.textContent = '';
            }
            setProfileAvatar(userData.avatarUrl || '');
            editBioBtn.style.display = 'none';
            document.getElementById('bioEditForm').style.display = 'none';

            // SEO
            updateMeta({
                title: userData.name || '–ü—Ä–æ—Ñ—ñ–ª—å –∞–≤—Ç–æ—Ä–∞',
                description: userData.bio ? userData.bio.substring(0, 160) : `–ü—Ä–æ—Ñ—ñ–ª—å –∞–≤—Ç–æ—Ä–∞ ${userData.name || ''} –Ω–∞ –ø–ª–∞—Ç—Ñ–æ—Ä–º—ñ KonVi`,
                url: '/profile/' + userId,
                image: userData.avatarUrl || undefined
            });

            document.getElementById('newPostBtn').style.display = 'none';
            document.getElementById('shareProfileBtn').style.display = 'block';
            document.getElementById('profileBtnsRow').style.display = 'flex';
            // filter is now in header ‚Äî just reset state
            document.querySelectorAll('#headerFilterTabs .filter-tab').forEach(tab => tab.classList.remove('active'));
            const allHeaderTab2 = document.querySelector('#headerFilterTabs .filter-tab');
            if (allHeaderTab2) allHeaderTab2.classList.add('active');

            renderProfilePosts();
        }

        // Share Profile Function
        window.shareProfile = function() {
            if (!window.currentProfileUserId) return;
            copyProfileLink(window.currentProfileUserId);
        };

        // Avatar display helper
        function setProfileAvatar(url) {
            const img = document.getElementById('profileAvatarImg');
            const placeholder = document.getElementById('profileAvatarPlaceholder');
            if (url) {
                img.src = url;
                img.style.display = 'block';
                placeholder.style.display = 'none';
            } else {
                img.src = '';
                img.style.display = 'none';
                placeholder.style.display = 'flex';
            }
        }

        // Bio Edit Functions
        window.showEditBio = function() {
            const currentBio = document.getElementById('profileBioText').textContent;
            const textarea = document.getElementById('bioInput');
            const isPlaceholder = currentBio === '–ë—ñ–æ–≥—Ä–∞—Ñ—ñ—è –Ω–µ –¥–æ–¥–∞–Ω–∞. –†–æ–∑–∫–∞–∂—ñ—Ç—å –ø—Ä–æ —Å–µ–±–µ!';
            textarea.value = isPlaceholder ? '' : currentBio;
            // Fill avatar URL field
            const avatarInput = document.getElementById('avatarUrlInput');
            const img = document.getElementById('profileAvatarImg');
            avatarInput.value = img.style.display !== 'none' ? img.src : '';
            document.getElementById('bioEditForm').style.display = 'block';
            document.getElementById('editBioBtn').style.display = 'none';
            textarea.focus();
        };

        window.cancelEditBio = function() {
            document.getElementById('bioEditForm').style.display = 'none';
            document.getElementById('editBioBtn').style.display = 'inline-block';
        };

        window.saveBio = async function() {
            if (!window.currentUser) return;

            const bio = document.getElementById('bioInput').value.trim();
            const avatarUrl = document.getElementById('avatarUrlInput').value.trim();

            try {
                const userRef = ref(database, `users/${window.currentUser.uid}`);
                const userSnapshot = await get(userRef);
                const userData = userSnapshot.val();

                await set(userRef, { ...userData, bio, avatarUrl });

                // –û–Ω–æ–≤–ª—é—î–º–æ –≤—ñ–¥–æ–±—Ä–∞–∂–µ–Ω–Ω—è
                const bioText = document.getElementById('profileBioText');
                if (bio) {
                    bioText.textContent = bio;
                    bioText.style.color = 'var(--text-main)';
                } else {
                    bioText.textContent = '–ë—ñ–æ–≥—Ä–∞—Ñ—ñ—è –Ω–µ –¥–æ–¥–∞–Ω–∞. –†–æ–∑–∫–∞–∂—ñ—Ç—å –ø—Ä–æ —Å–µ–±–µ!';
                    bioText.style.color = 'var(--text-lighter)';
                }

                setProfileAvatar(avatarUrl);

                document.getElementById('bioEditForm').style.display = 'none';
                document.getElementById('editBioBtn').style.display = 'inline-block';
            } catch (error) {
                console.error('Error saving bio:', error);
                alert('‚ùå –ü–æ–º–∏–ª–∫–∞ –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è: ' + error.message);
            }
        };

        // Delete Post
        window.deletePost = async function(postId) {
            if (!confirm('–í–∏ –≤–ø–µ–≤–Ω–µ–Ω—ñ, —â–æ —Ö–æ—á–µ—Ç–µ –≤–∏–¥–∞–ª–∏—Ç–∏ —Ü—é –ø—É–±–ª—ñ–∫–∞—Ü—ñ—é?')) return;

            try {
                const postSnapshot = await get(ref(database, `posts/${postId}`));
                const post = postSnapshot.val();

                await remove(ref(database, `posts/${postId}`));

                // Update user stats
                const userSnapshot = await get(ref(database, `users/${window.currentUser.uid}`));
                const userData = userSnapshot.val();
                await set(ref(database, `users/${window.currentUser.uid}`), {
                    ...userData,
                    postsCount: Math.max(0, (userData.postsCount || 0) - 1),
                    poetryCount: post.type === 'poetry' ? Math.max(0, (userData.poetryCount || 0) - 1) : userData.poetryCount,
                    thoughtsCount: post.type === 'thought' ? Math.max(0, (userData.thoughtsCount || 0) - 1) : userData.thoughtsCount
                });

                alert('‚úÖ –ü—É–±–ª—ñ–∫–∞—Ü—ñ—é –≤–∏–¥–∞–ª–µ–Ω–æ');
                loadMyProfile();
            } catch (error) {
                console.error('Error deleting post:', error);
                alert('‚ùå –ü–æ–º–∏–ª–∫–∞ –≤–∏–¥–∞–ª–µ–Ω–Ω—è');
            }
        };

        // ===== HEADER FILTER BAR SYSTEM =====
        // mode: 'allPosts' | 'profile' | null
        window.headerFilterMode = null;

        function getHeader() { return document.querySelector('.platform-header'); }

        function showHeaderFilter(mode) {
            window.headerFilterMode = mode;
            const header = getHeader();
            const tabs = document.getElementById('headerFilterTabs');
            const inp = document.getElementById('headerSearchInput');
            const clearBtn = document.getElementById('headerClearBtn');
            const toggle = document.getElementById('headerFilterToggle');
            if (!header) return;

            // Mark header as having active filter (shows toggle button)
            header.classList.add('filter-active');
            // Keep panel CLOSED by default ‚Äî user opens with arrow
            header.classList.remove('filter-open');
            if (toggle) toggle.textContent = '‚ñº';

            if (mode === 'allPosts') {
                inp.placeholder = '–ü–æ—à—É–∫ –ø—É–±–ª—ñ–∫–∞—Ü—ñ–π...';
                inp.value = window.allPostsSearchQuery || '';
                clearBtn.style.display = window.allPostsSearchQuery ? 'block' : 'none';
                const st = window.allPostsSearchType || 'all';
                const r = document.querySelector(`input[name="headerSType"][value="${st}"]`);
                if (r) r.checked = true;
                tabs.innerHTML = `
                    <div class="filter-tab ${window.allPostsTypeFilter==='all'?'active':''}" onclick="headerFilterAllPostsType('all')">–£—Å—ñ</div>
                    <div class="filter-tab ${window.allPostsTypeFilter==='poetry'?'active':''}" onclick="headerFilterAllPostsType('poetry')">–ü–æ–µ–∑—ñ—è</div>
                    <div class="filter-tab ${window.allPostsTypeFilter==='thought'?'active':''}" onclick="headerFilterAllPostsType('thought')">–î—É–º–∫–∏</div>
                `;
                document.getElementById('headerSearchBtn').onclick = () => {
                    window.allPostsSearchQuery = inp.value.trim();
                    const stype = document.querySelector('input[name="headerSType"]:checked');
                    window.allPostsSearchType = stype ? stype.value : 'all';
                    clearBtn.style.display = window.allPostsSearchQuery ? 'block' : 'none';
                    window.allPostsCurrentPage = 1;
                    renderAllPostsPage();
                };
                inp.onkeypress = (e) => { if (e.key === 'Enter') document.getElementById('headerSearchBtn').onclick(); };
                // Show hashtags, hide TOC
                document.getElementById('headerHashtagSection').style.display = 'block';
                document.getElementById('headerTocSection').style.display = 'none';
                buildAllPostsHashtagChips();
            } else if (mode === 'profile') {
                inp.placeholder = '–ü–æ—à—É–∫ –ø—É–±–ª—ñ–∫–∞—Ü—ñ–π...';
                inp.value = window.profileSearchQuery || '';
                clearBtn.style.display = window.profileSearchQuery ? 'block' : 'none';
                const st = window.profileSearchType || 'all';
                const r = document.querySelector(`input[name="headerSType"][value="${st}"]`);
                if (r) r.checked = true;
                const cf = window.profileCurrentFilter || 'all';
                tabs.innerHTML = `
                    <div class="filter-tab ${cf==='all'?'active':''}" onclick="headerFilterProfileType('all')">–£—Å—ñ</div>
                    <div class="filter-tab ${cf==='poetry'?'active':''}" onclick="headerFilterProfileType('poetry')">–ü–æ–µ–∑—ñ—è</div>
                    <div class="filter-tab ${cf==='thought'?'active':''}" onclick="headerFilterProfileType('thought')">–î—É–º–∫–∏</div>
                    <div class="filter-tab ${cf==='favorites'?'active':''}" id="headerFavoritesTab" onclick="headerFilterProfileType('favorites')">‚≠ê –û–±—Ä–∞–Ω–µ</div>
                `;
                document.getElementById('headerSearchBtn').onclick = () => {
                    window.profileSearchQuery = inp.value.trim();
                    const stype = document.querySelector('input[name="headerSType"]:checked');
                    window.profileSearchType = stype ? stype.value : 'all';
                    clearBtn.style.display = window.profileSearchQuery ? 'block' : 'none';
                    window.profileCurrentPage = 1;
                    renderProfilePosts();
                };
                inp.onkeypress = (e) => { if (e.key === 'Enter') document.getElementById('headerSearchBtn').onclick(); };
                // Show TOC, hide hashtags
                document.getElementById('headerTocSection').style.display = 'block';
                document.getElementById('headerHashtagSection').style.display = 'none';
            }
        }

        window.hideHeaderFilter = function() {
            window.headerFilterMode = null;
            const header = getHeader();
            if (!header) return;
            header.classList.remove('filter-active', 'filter-open');
            const toggle = document.getElementById('headerFilterToggle');
            if (toggle) toggle.textContent = '‚ñº';
            document.getElementById('headerTocSection').style.display = 'none';
            document.getElementById('headerHashtagSection').style.display = 'none';
        };

        // Toggle open/close (arrow button)
        window.toggleHeaderFilter = function() {
            const header = getHeader();
            if (!header) return;
            const isOpen = header.classList.toggle('filter-open');
            const toggle = document.getElementById('headerFilterToggle');
            if (toggle) toggle.textContent = isOpen ? '‚ñ≤' : '‚ñº';
        };

        window.clearHeaderSearch = function() {
            const inp = document.getElementById('headerSearchInput');
            const clearBtn = document.getElementById('headerClearBtn');
            if (inp) inp.value = '';
            if (clearBtn) clearBtn.style.display = 'none';
            if (window.headerFilterMode === 'allPosts') {
                window.allPostsSearchQuery = '';
                window.allPostsCurrentPage = 1;
                renderAllPostsPage();
            } else if (window.headerFilterMode === 'profile') {
                window.profileSearchQuery = '';
                window.profileCurrentPage = 1;
                renderProfilePosts();
            }
        };

        window.headerFilterAllPostsType = function(type) {
            window.allPostsTypeFilter = type;
            window.allPostsCurrentPage = 1;
            document.querySelectorAll('#headerFilterTabs .filter-tab').forEach(t => t.classList.remove('active'));
            event.target.classList.add('active');
            renderAllPostsPage();
        };

        window.headerFilterProfileType = function(type) {
            window.profileCurrentFilter = type;
            window.profileCurrentPage = 1;
            document.querySelectorAll('#headerFilterTabs .filter-tab').forEach(t => t.classList.remove('active'));
            event.target.classList.add('active');
            renderProfilePosts();
        };

        // ===== PAGINATION HELPER =====
        function renderPagination(el, current, total, onPage) {
            if (!el || total <= 1) { if (el) el.innerHTML = ''; return; }
            const pages = [];
            // always show first, last, current ¬±2
            const shown = new Set();
            [1, total].forEach(p => shown.add(p));
            for (let p = Math.max(1, current - 2); p <= Math.min(total, current + 2); p++) shown.add(p);
            const sorted = [...shown].sort((a,b) => a-b);
            let html = `<button class="page-btn" onclick="(${onPage.toString()})(${current-1})" ${current===1?'disabled':''}>‚Äπ</button>`;
            let prev = 0;
            for (const p of sorted) {
                if (p - prev > 1) html += `<span style="padding:0 4px; color:var(--text-lighter)">‚Ä¶</span>`;
                html += `<button class="page-btn ${p===current?'active':''}" onclick="(${onPage.toString()})(${p})">${p}</button>`;
                prev = p;
            }
            html += `<button class="page-btn" onclick="(${onPage.toString()})(${current+1})" ${current===total?'disabled':''}>‚Ä∫</button>`;
            el.innerHTML = html;
        }

        // Keep old toggle functions as no-ops for safety
        window.toggleAllPostsSearchBar = function() {};
        window.toggleProfileSearchBar = function() {};

        // All Posts Page state
        window.allPostsTypeFilter = 'all';
        window.allPostsSearchQuery = '';
        window.allPostsSearchType = 'all';
        window.allPostsHashtagFilter = null;

        // Load All Posts Page
        function loadAllPostsPage() {
            window.allPostsTypeFilter = 'all';
            window.allPostsSearchQuery = '';
            window.allPostsSearchType = 'all';
            window.allPostsHashtagFilter = null;

            const inp = document.getElementById('allPostsSearchInput');
            const clearBtn = document.getElementById('clearAllPostsSearchBtn');
            const banner = document.getElementById('allPostsSearchResultsBanner');
            const bar = document.getElementById('allPostsSearchFilterBar');
            const toggleBtn = document.getElementById('allPostsSearchToggleBtn');
            if (inp) inp.value = '';
            if (clearBtn) clearBtn.style.display = 'none';
            if (banner) banner.style.display = 'none';
            if (bar) bar.classList.remove('active');
            if (toggleBtn) toggleBtn.classList.remove('active');

            // Reset filter tabs
            document.querySelectorAll('#allPostsPage .filter-tab').forEach(t => t.classList.remove('active'));
            const allTab = document.querySelector('#allPostsPage .filter-tab[data-filter="all"]');
            if (allTab) allTab.classList.add('active');

            buildAllPostsHashtagChips();
            renderAllPostsPage();
        }

        function buildAllPostsHashtagChips() {
            const allHashtags = {};
            window.allPosts.forEach(post => {
                if (post.hashtags) {
                    const tags = typeof post.hashtags === 'string'
                        ? post.hashtags.split(' ').map(t => t.trim()).filter(Boolean)
                        : post.hashtags;
                    tags.forEach(t => { allHashtags[t] = (allHashtags[t] || 0) + 1; });
                }
            });
            const sorted = Object.entries(allHashtags).sort((a, b) => b[1] - a[1]).slice(0, 25);
            const listEl = document.getElementById('allPostsHashtagChipsList');
            const containerEl = document.getElementById('allPostsHashtagChips');
            if (!listEl || !containerEl) return;
            if (sorted.length === 0) { containerEl.style.display = 'none'; return; }
            containerEl.style.display = 'flex';
            listEl.innerHTML = sorted.map(([tag, count]) =>
                `<span class="home-hashtag-chip ${window.allPostsHashtagFilter === tag ? 'active' : ''}"
                       data-tag="${tag}"
                       onclick="toggleAllPostsHashtag('${tag}')">${tag} (${count})</span>`
            ).join('');
        }

        window.toggleAllPostsHashtag = function(tag) {
            window.allPostsHashtagFilter = window.allPostsHashtagFilter === tag ? null : tag;
            document.querySelectorAll('#allPostsHashtagChipsList .home-hashtag-chip').forEach(c => {
                c.classList.toggle('active', c.dataset.tag === window.allPostsHashtagFilter);
            });
            renderAllPostsPage();
        };

        window.filterAllPosts = function(type, event) {
            window.allPostsTypeFilter = type;
            document.querySelectorAll('#allPostsPage .filter-tab').forEach(t => t.classList.remove('active'));
            if (event && event.target) event.target.classList.add('active');
            renderAllPostsPage();
        };

        window.searchAllPosts = function() {
            const inp = document.getElementById('allPostsSearchInput');
            const clearBtn = document.getElementById('clearAllPostsSearchBtn');
            window.allPostsSearchQuery = inp ? inp.value.trim() : '';
            window.allPostsSearchType = document.querySelector('input[name="allPostsSearchType"]:checked')?.value || 'all';
            if (clearBtn) clearBtn.style.display = window.allPostsSearchQuery ? 'block' : 'none';
            renderAllPostsPage();
        };

        window.clearAllPostsSearch = function() {
            const inp = document.getElementById('allPostsSearchInput');
            const clearBtn = document.getElementById('clearAllPostsSearchBtn');
            if (inp) inp.value = '';
            if (clearBtn) clearBtn.style.display = 'none';
            window.allPostsSearchQuery = '';
            window.allPostsHashtagFilter = null;
            document.querySelectorAll('#allPostsHashtagChipsList .home-hashtag-chip').forEach(c => c.classList.remove('active'));
            renderAllPostsPage();
        };

        const POSTS_PER_PAGE = 20;

        function getFilteredAllPosts() {
            let posts = [...window.allPosts];
            if (window.allPostsTypeFilter !== 'all') posts = posts.filter(p => p.type === window.allPostsTypeFilter);
            if (window.allPostsHashtagFilter) posts = posts.filter(p => p.hashtags && (
                typeof p.hashtags === 'string' ? p.hashtags.includes(window.allPostsHashtagFilter) : p.hashtags.includes(window.allPostsHashtagFilter)
            ));
            if (window.allPostsSearchQuery) {
                const query = window.allPostsSearchQuery.toLowerCase();
                const st = window.allPostsSearchType || 'all';
                posts = posts.filter(p => {
                    const t = p.title && p.title.toLowerCase().includes(query);
                    const c = p.content && p.content.toLowerCase().includes(query);
                    const h = p.hashtags && (typeof p.hashtags === 'string' ? p.hashtags.toLowerCase().includes(query) : p.hashtags.some(x => x.toLowerCase().includes(query)));
                    return st === 'title' ? t : st === 'content' ? c : (t || c || h);
                });
            }
            return posts.sort((a, b) => b.date - a.date);
        }

        function renderAllPostsPage(page) {
            if (page !== undefined) window.allPostsCurrentPage = page;
            if (!window.allPostsCurrentPage) window.allPostsCurrentPage = 1;
            const container = document.getElementById('allPostsContainer');
            const banner = document.getElementById('allPostsSearchResultsBanner');
            const paginationEl = document.getElementById('allPostsPagination');
            const posts = getFilteredAllPosts();

            if (banner) {
                if (window.allPostsSearchQuery || window.allPostsHashtagFilter) {
                    banner.style.display = 'block';
                    const parts = [];
                    if (window.allPostsSearchQuery) parts.push(`"<strong>${window.allPostsSearchQuery}</strong>"`);
                    if (window.allPostsHashtagFilter) parts.push(`—Ö–µ—à—Ç–µ–≥ <strong>${window.allPostsHashtagFilter}</strong>`);
                    banner.innerHTML = `–ó–Ω–∞–π–¥–µ–Ω–æ <strong>${posts.length}</strong> –ø—É–±–ª—ñ–∫–∞—Ü—ñ–π –∑–∞ ${parts.join(' + ')}`;
                } else { banner.style.display = 'none'; }
            }

            if (posts.length === 0) {
                container.innerHTML = '<p style="color: var(--text-light); text-align: center; padding: 2rem;">–ù—ñ—á–æ–≥–æ –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ</p>';
                if (paginationEl) paginationEl.innerHTML = '';
                return;
            }

            const totalPages = Math.ceil(posts.length / POSTS_PER_PAGE);
            if (window.allPostsCurrentPage > totalPages) window.allPostsCurrentPage = totalPages;
            const start = (window.allPostsCurrentPage - 1) * POSTS_PER_PAGE;
            const pagePosts = posts.slice(start, start + POSTS_PER_PAGE);

            container.innerHTML = pagePosts.map(post => {
                const content = post.content || '';
                const preview = content.length > 300 ? content.substring(0, 300) + '...' : content;
                return `<div class="featured-post" style="cursor:pointer;" onclick="showPost('${post.id}')">
                        <span class="post-type-badge">${post.type === 'poetry' ? '–ü–û–ï–ó–Ü–Ø' : '–î–£–ú–ö–ê'}</span>
                        <h3 class="post-title">${post.title || '–ë–µ–∑ –Ω–∞–∑–≤–∏'}</h3>
                        <div class="post-author" style="cursor: pointer;" onclick="event.stopPropagation(); showUserProfile('${post.userId}')">‚úçÔ∏è ${getUserName(post.userId)}</div>
                        <div class="post-content" style="white-space: pre-wrap;">${preview}</div>
                        <div class="post-meta">
                            <span>üìÖ ${new Date(post.date).toLocaleDateString('uk-UA')}</span>
                            ${post.hashtags ? '<span>üè∑Ô∏è ' + post.hashtags + '</span>' : ''}
                        </div>
                    </div>`;
            }).join('');

            renderPagination(paginationEl, window.allPostsCurrentPage, totalPages, (p) => {
                renderAllPostsPage(p);
                document.getElementById('allPostsPage').scrollIntoView({ behavior: 'smooth', block: 'start' });
            });
        }

        // Legacy filterPosts (keep for safety, redirects to new)
        window.filterPosts = function(type) { window.filterAllPosts(type, window.event); };

        // Load All Poets
        function loadAllPoets() {
            // Reset search state
            window.poetsSearchQuery = '';
            const inp = document.getElementById('poetsSearchInput');
            const btn = document.getElementById('poetsClearBtn');
            const banner = document.getElementById('poetsSearchResultsBanner');
            const bar = document.getElementById('poetsSearchFilterBar');
            const toggleBtn = document.getElementById('poetsSearchToggleBtn');
            if (inp) inp.value = '';
            if (btn) btn.style.display = 'none';
            if (banner) banner.style.display = 'none';
            // ensure bar is closed by default
            if (bar) bar.classList.remove('active');
            if (toggleBtn) toggleBtn.classList.remove('active');
            renderPoetsList();
        }

        // Load hashtag cloud
        function loadHashtagCloud() {
            const allHashtags = {};
            
            window.allPosts.forEach(post => {
                if (post.hashtags) {
                    let tags = [];
                    
                    // –ü—ñ–¥—Ç—Ä–∏–º–∫–∞ —ñ —Å—Ç—Ä–æ–∫ —ñ –º–∞—Å–∏–≤—ñ–≤
                    if (typeof post.hashtags === 'string') {
                        tags = post.hashtags.split(' ').map(t => t.trim()).filter(t => t);
                    } else if (Array.isArray(post.hashtags)) {
                        tags = post.hashtags.map(t => t.trim()).filter(t => t);
                    }
                    
                    tags.forEach(tag => {
                        allHashtags[tag] = (allHashtags[tag] || 0) + 1;
                    });
                }
            });

            const sorted = Object.entries(allHashtags)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 10);

            const container = document.getElementById('hashtagCloud');
            
            if (sorted.length === 0) {
                container.innerHTML = '<p style="color: var(--text-light);">–ù–µ–º–∞—î —Ö–µ—à—Ç–µ–≥—ñ–≤</p>';
                return;
            }

            container.innerHTML = sorted.map(([tag, count]) => `
                <a href="#" class="hashtag-item">${tag} (${count})</a>
            `).join('');
        }

        // –•–µ—à—Ç–µ–≥–∏ –∑–∞–≤–∞–Ω—Ç–∞–∂—É—é—Ç—å—Å—è —á–µ—Ä–µ–∑ refreshHomeIfReady()

        // Admin Panel Functions
        function loadAdminPanel() {
            loadAdminStats();
            loadAdminPostsList();
        }

        function loadAdminStats() {
            const now = Date.now();
            const sevenDaysAgo = now - 7 * 24 * 60 * 60 * 1000;
            const oneDayAgo = now - 24 * 60 * 60 * 1000;

            const totalPosts = window.allPosts.length;
            const totalPoetry = window.allPosts.filter(p => p.type === 'poetry').length;
            const totalThoughts = window.allPosts.filter(p => p.type === 'thought').length;
            const totalUsers = window.allUsers.length;
            const newUsers7d = window.allUsers.filter(u => u.createdAt && u.createdAt >= sevenDaysAgo).length;
            const newPosts7d = window.allPosts.filter(p => p.date && p.date >= sevenDaysAgo).length;
            const newPosts24h = window.allPosts.filter(p => p.date && p.date >= oneDayAgo).length;
            const featuredCount = window.allPosts.filter(p => p.featured).length;

            const grid = document.getElementById('adminStatsGrid');
            if (!grid) return;

            const statCard = (emoji, label, value, sub) => `
                <div style="background: var(--bg-card); border-radius: 12px; padding: 1.5rem; border: 1px solid var(--border-light); box-shadow: 0 2px 8px var(--shadow); text-align: center;">
                    <div style="font-size: 2rem; margin-bottom: 0.5rem;">${emoji}</div>
                    <div style="font-family: 'Philosopher', sans-serif; font-size: 2rem; font-weight: 700; color: var(--accent); line-height: 1;">${value}</div>
                    <div style="font-family: 'Philosopher', sans-serif; font-weight: 600; color: var(--primary); margin-top: 0.3rem;">${label}</div>
                    ${sub ? `<div style="font-size: 0.82rem; color: var(--text-lighter); margin-top: 0.3rem;">${sub}</div>` : ''}
                </div>
            `;

            grid.innerHTML =
                statCard('üìù', '–ü—É–±–ª—ñ–∫–∞—Ü—ñ–π', totalPosts, `${totalPoetry} –≤—ñ—Ä—à—ñ–≤ ¬∑ ${totalThoughts} –¥—É–º–æ–∫`) +
                statCard('üë•', '–ü–æ–µ—Ç—ñ–≤', totalUsers, `+${newUsers7d} –∑–∞ 7 –¥–Ω—ñ–≤`) +
                statCard('üìú', '–ù–æ–≤–∏—Ö –ø—É–±–ª—ñ–∫–∞—Ü—ñ–π (7 –¥–Ω—ñ–≤)', newPosts7d, `${newPosts24h} –∑–∞ –æ—Å—Ç–∞–Ω–Ω—é –¥–æ–±—É`) +
                statCard('‚≠ê', '–û–±—Ä–∞–Ω–∏—Ö –ø—É–±–ª—ñ–∫–∞—Ü—ñ–π', featuredCount, '–≤—ñ–¥–æ–±—Ä–∞–∂–∞—é—Ç—å—Å—è –Ω–∞ –≥–æ–ª–æ–≤–Ω—ñ–π');

            // Activity chart (posts per day for last 7 days)
            const days = [];
            for (let i = 6; i >= 0; i--) {
                const dayStart = new Date(); dayStart.setHours(0,0,0,0); dayStart.setDate(dayStart.getDate() - i);
                const dayEnd = new Date(dayStart); dayEnd.setHours(23,59,59,999);
                const count = window.allPosts.filter(p => p.date >= dayStart.getTime() && p.date <= dayEnd.getTime()).length;
                const label = dayStart.toLocaleDateString('uk-UA', { day: 'numeric', month: 'short' });
                days.push({ label, count });
            }
            const maxCount = Math.max(...days.map(d => d.count), 1);
            const chartEl = document.getElementById('adminActivityChart');
            if (chartEl) {
                chartEl.innerHTML = `
                    <div style="display: flex; align-items: flex-end; gap: 0.75rem; height: 120px; padding-bottom: 2rem; position: relative;">
                        ${days.map(d => {
                            const h = Math.max(4, Math.round((d.count / maxCount) * 100));
                            return `
                                <div style="flex: 1; display: flex; flex-direction: column; align-items: center; gap: 0.3rem; height: 100%;">
                                    <div style="flex: 1; display: flex; align-items: flex-end; width: 100%;">
                                        <div style="width: 100%; height: ${h}%; background: linear-gradient(to top, var(--accent), var(--accent-light)); border-radius: 6px 6px 0 0; position: relative;" title="${d.count} –ø—É–±–ª—ñ–∫–∞—Ü—ñ–π">
                                            ${d.count > 0 ? `<span style="position:absolute;top:-20px;left:50%;transform:translateX(-50%);font-size:0.75rem;font-weight:700;color:var(--accent);">${d.count}</span>` : ''}
                                        </div>
                                    </div>
                                    <span style="font-size: 0.75rem; color: var(--text-lighter); white-space: nowrap;">${d.label}</span>
                                </div>
                            `;
                        }).join('')}
                    </div>
                `;
            }

            // New users list
            const newUsersEl = document.getElementById('adminNewUsersList');
            if (newUsersEl) {
                const recent = window.allUsers.filter(u => u.createdAt && u.createdAt >= sevenDaysAgo)
                    .sort((a, b) => (b.createdAt || 0) - (a.createdAt || 0));
                if (recent.length === 0) {
                    newUsersEl.innerHTML = '<p style="color: var(--text-lighter); text-align: center; padding: 1rem;">–ù–æ–≤–∏—Ö –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ–≤ –∑–∞ 7 –¥–Ω—ñ–≤ –Ω–µ–º–∞—î</p>';
                } else {
                    newUsersEl.innerHTML = recent.map(u => `
                        <div style="display:flex; justify-content:space-between; align-items:center; padding: 0.6rem 0.5rem; border-bottom: 1px solid var(--border-light);">
                            <span style="font-weight:600; color: var(--primary);">üë§ ${u.name || '–ë–µ–∑ —ñ–º–µ–Ω—ñ'}</span>
                            <span style="font-size:0.85rem; color: var(--text-lighter);">${new Date(u.createdAt).toLocaleDateString('uk-UA')}</span>
                        </div>
                    `).join('');
                }
            }
        }

        function loadAdminPostsList() {
            const container = document.getElementById('adminPostsList');
            
            if (window.allPosts.length === 0) {
                container.innerHTML = '<p style="color: var(--text-light); text-align: center;">–ù–µ–º–∞—î –ø—É–±–ª—ñ–∫–∞—Ü—ñ–π</p>';
                return;
            }

            const sorted = [...window.allPosts].sort((a, b) => b.date - a.date);

            container.innerHTML = sorted.map(post => {
                const content = post.content || '';
                const preview = content.length > 200 ? content.substring(0, 200) + '...' : content;
                const postId = post.id;
                const isFeatured = post.featured || false;
                
                console.log('Rendering post:', postId, 'featured:', isFeatured);
                
                return `
                    <div class="featured-post" style="border-left: 4px solid ${isFeatured ? '#d4a645' : 'transparent'};">
                        <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                            <div style="flex: 1;">
                                <span class="post-type-badge">${post.type === 'poetry' ? '–ü–û–ï–ó–Ü–Ø' : '–î–£–ú–ö–ê'}</span>
                                ${isFeatured ? '<span class="post-type-badge" style="background: #d4a645; margin-left: 0.5rem;">‚≠ê –û–ë–†–ê–ù–ï</span>' : ''}
                                <h3 class="post-title">${post.title || '–ë–µ–∑ –Ω–∞–∑–≤–∏'}</h3>
                                <div class="post-author">‚úçÔ∏è ${getUserName(post.userId)}</div>
                                <div class="post-content" style="white-space: pre-wrap;">${preview}</div>
                                <div class="post-meta">
                                    <span>üìÖ ${new Date(post.date).toLocaleDateString('uk-UA')}</span>
                                    ${post.hashtags ? '<span>üè∑Ô∏è ' + post.hashtags + '</span>' : ''}
                                </div>
                            </div>
                            <div class="post-actions" style="margin-left: 1rem;">
                                <button class="btn ${isFeatured ? 'btn-secondary' : 'btn-primary'} btn-small" 
                                        onclick="toggleFeatured('${postId}', ${!isFeatured})">
                                    ${isFeatured ? '‚≠ê –ü—Ä–∏–±—Ä–∞—Ç–∏ –∑ –æ–±—Ä–∞–Ω–∏—Ö' : '‚≠ê –î–æ–¥–∞—Ç–∏ –≤ –æ–±—Ä–∞–Ω—ñ'}
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        window.toggleFeatured = async function(postId, featured) {
            if (!window.isAdmin) {
                alert('‚ùå –¢—ñ–ª—å–∫–∏ –∞–¥–º—ñ–Ω—ñ—Å—Ç—Ä–∞—Ç–æ—Ä –º–æ–∂–µ –∫–µ—Ä—É–≤–∞—Ç–∏ –æ–±—Ä–∞–Ω–∏–º–∏ –ø–æ—Å—Ç–∞–º–∏');
                return;
            }

            console.log('toggleFeatured called with:', postId, featured);

            try {
                const postRef = ref(database, `posts/${postId}`);
                const postSnapshot = await get(postRef);
                
                if (!postSnapshot.exists()) {
                    console.error('Post not found in Firebase:', postId);
                    alert('‚ùå –ü–æ—Å—Ç –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ –≤ –±–∞–∑—ñ –¥–∞–Ω–∏—Ö. ID: ' + postId);
                    return;
                }

                const post = postSnapshot.val();
                console.log('Found post:', post);
                
                // Update the post with featured status
                await set(postRef, {
                    ...post,
                    featured: featured
                });

                alert(featured ? '‚úÖ –î–æ–¥–∞–Ω–æ –≤ –æ–±—Ä–∞–Ω—ñ!' : '‚úÖ –ü—Ä–∏–±—Ä–∞–Ω–æ –∑ –æ–±—Ä–∞–Ω–∏—Ö!');
                loadAdminPanel();
            } catch (error) {
                console.error('Error toggling featured:', error);
                alert('‚ùå –ü–æ–º–∏–ª–∫–∞: ' + error.message + '\n\n–ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ –ø—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø—É –≤ Firebase Rules');
            }
        };

        // Profile Page Functions
        window.profileCurrentFilter = 'all';
        window.profileSearchQuery = '';
        window.profileSearchType = 'all';
        window.profileHashtagFilter = null;
        window.profileFavorites = new Set(JSON.parse(localStorage.getItem('profileFavorites') || '[]'));

        window.filterProfilePosts = function(filter, event) {
            if (event) {
                document.querySelectorAll('#profilePage .filter-tab').forEach(tab => tab.classList.remove('active'));
                event.target.classList.add('active');
            }
            window.profileCurrentFilter = filter;
            renderProfilePosts();
        };

        window.searchProfilePosts = function() {
            // input is now in header
            const inp = document.getElementById('headerSearchInput');
            window.profileSearchQuery = inp ? inp.value.trim() : '';
            const stype = document.querySelector('input[name="headerSType"]:checked');
            window.profileSearchType = stype ? stype.value : 'all';
            renderProfilePosts();
        };

        window.clearProfileSearch = function() {
            const inp = document.getElementById('headerSearchInput');
            if (inp) inp.value = '';
            window.profileSearchQuery = '';
            window.profileSearchType = 'all';
            window.profileHashtagFilter = null;
            const clearBtn = document.getElementById('headerClearBtn');
            if (clearBtn) clearBtn.style.display = 'none';
            const banner = document.getElementById('profileSearchResultsBanner');
            if (banner) banner.style.display = 'none';
            renderProfilePosts();
        };

        window.toggleProfileHashtag = function(tag) {
            window.profileHashtagFilter = window.profileHashtagFilter === tag ? null : tag;
            // chips removed from DOM ‚Äî no-op
            renderProfilePosts();
        };

        function buildProfileHashtagChips(posts) {
            const allHashtags = {};
            posts.forEach(post => {
                if (post.hashtags) {
                    const tags = typeof post.hashtags === 'string'
                        ? post.hashtags.split(' ').map(t => t.trim()).filter(Boolean)
                        : post.hashtags;
                    tags.forEach(t => { allHashtags[t] = (allHashtags[t] || 0) + 1; });
                }
            });

            const sorted = Object.entries(allHashtags).sort((a, b) => b[1] - a[1]).slice(0, 20);
            // hashtag chips were in old filter bar (removed) ‚Äî skip rendering
            return;
        }

        window.toggleProfileFavorite = function(postId) {
            console.log('Toggling favorite for:', postId);
            console.log('Current favorites:', [...window.profileFavorites]);
            
            if (window.profileFavorites.has(postId)) {
                window.profileFavorites.delete(postId);
                console.log('Removed from favorites');
            } else {
                window.profileFavorites.add(postId);
                console.log('Added to favorites');
            }
            
            localStorage.setItem('profileFavorites', JSON.stringify([...window.profileFavorites]));
            console.log('Updated favorites:', [...window.profileFavorites]);
            
            renderProfilePosts();
        };

        window.toggleProfileSearchBar = function() {
            const bar = document.getElementById('profileSearchFilterBar');
            const btn = document.getElementById('profileSearchToggleBtn');
            if (!bar) return;
            bar.classList.toggle('active');
            btn.classList.toggle('active', bar.classList.contains('active'));
        };

        window.scrollToPost = function(postId) {
            const el = document.getElementById('post-' + postId);
            if (el) {
                el.scrollIntoView({ behavior: 'smooth', block: 'start' });
                el.style.transition = 'box-shadow 0.3s';
                el.style.boxShadow = '0 0 0 3px var(--accent)';
                setTimeout(() => { el.style.boxShadow = ''; }, 1500);
            }
        };

        window.scrollToTOC = function() {
            // –í—ñ–¥–∫—Ä–∏—Ç–∏ –ø–∞–Ω–µ–ª—å —Ñ—ñ–ª—å—Ç—Ä—ñ–≤ —è–∫—â–æ –∑–∞–∫—Ä–∏—Ç–∞
            const header = getHeader();
            if (header && !header.classList.contains('filter-open')) {
                header.classList.add('filter-open');
                const toggle = document.getElementById('headerFilterToggle');
                if (toggle) toggle.textContent = '‚ñ≤';
            }
            // –ü—Ä–æ–∫—Ä—É—Ç–∏—Ç–∏ –¥–æ —à–∞–ø–∫–∏
            window.scrollTo({ top: 0, behavior: 'smooth' });
        };

        function renderProfilePosts() {
            const userId = window.currentProfileUserId;
            if (!userId) return;

            // All user posts ‚Äî used for building hashtag chips
            const allUserPosts = window.allPosts.filter(p => p.userId === userId);

            let posts = [...allUserPosts];

            // Apply type filter
            if (window.profileCurrentFilter === 'poetry') {
                posts = posts.filter(p => p.type === 'poetry');
            } else if (window.profileCurrentFilter === 'thought') {
                posts = posts.filter(p => p.type === 'thought');
            } else if (window.profileCurrentFilter === 'favorites') {
                posts = posts.filter(p => window.profileFavorites.has(p.id));
            }

            // Apply hashtag filter
            if (window.profileHashtagFilter) {
                posts = posts.filter(p => p.hashtags && (
                    typeof p.hashtags === 'string'
                        ? p.hashtags.includes(window.profileHashtagFilter)
                        : p.hashtags.includes(window.profileHashtagFilter)
                ));
            }

            // Apply search
            if (window.profileSearchQuery) {
                const query = window.profileSearchQuery.toLowerCase();
                const searchType = window.profileSearchType || 'all';
                posts = posts.filter(p => {
                    const titleMatch = p.title && p.title.toLowerCase().includes(query);
                    const contentMatch = p.content && p.content.toLowerCase().includes(query);
                    const hashMatch = p.hashtags && (
                        typeof p.hashtags === 'string'
                            ? p.hashtags.toLowerCase().includes(query)
                            : p.hashtags.some(t => t.toLowerCase().includes(query))
                    );
                    if (searchType === 'title') return titleMatch;
                    if (searchType === 'content') return contentMatch;
                    return titleMatch || contentMatch || hashMatch;
                });
            }

            // Update search results banner
            const banner = document.getElementById('profileSearchResultsBanner');
            if (window.profileSearchQuery || window.profileHashtagFilter) {
                banner.style.display = 'block';
                const parts = [];
                if (window.profileSearchQuery) parts.push(`"<strong>${window.profileSearchQuery}</strong>"`);
                if (window.profileHashtagFilter) parts.push(`—Ö–µ—à—Ç–µ–≥ <strong>${window.profileHashtagFilter}</strong>`);
                banner.innerHTML = `–ó–Ω–∞–π–¥–µ–Ω–æ <strong>${posts.length}</strong> –ø—É–±–ª—ñ–∫–∞—Ü—ñ–π –∑–∞ ${parts.join(' + ')}`;
            } else {
                banner.style.display = 'none';
            }

            // Build hashtag chips from ALL user posts
            buildProfileHashtagChips(allUserPosts);

            // Sort by date
            posts.sort((a, b) => b.date - a.date);

            const container = document.getElementById('profilePosts');
            const isOwnProfile = window.currentUser && window.currentUser.uid === userId;

            if (posts.length === 0) {
                container.innerHTML = '<p style="color: var(--text-light); text-align: center;">–ù–µ–º–∞—î –ø—É–±–ª—ñ–∫–∞—Ü—ñ–π</p>';
                return;
            }

            // Pagination
            if (!window.profileCurrentPage) window.profileCurrentPage = 1;
            const totalPages = Math.ceil(posts.length / POSTS_PER_PAGE);
            if (window.profileCurrentPage > totalPages) window.profileCurrentPage = Math.max(1, totalPages);
            const start = (window.profileCurrentPage - 1) * POSTS_PER_PAGE;
            const pagePosts = posts.slice(start, start + POSTS_PER_PAGE);

            container.innerHTML = pagePosts.map(post => {
                const content = post.content || '';
                const isFavorite = window.profileFavorites.has(post.id);
                return `<div class="card" style="margin-bottom: 2rem;" id="post-${post.id}">
                        <span class="post-type-badge">${post.type === 'poetry' ? '–ü–û–ï–ó–Ü–Ø' : '–î–£–ú–ö–ê'}</span>
                        <h2 style="font-family: 'Philosopher', sans-serif; font-size: 1.8rem; color: var(--primary); margin: 0.8rem 0; cursor:pointer;" onclick="showPost('${post.id}')">${post.title || '–ë–µ–∑ –Ω–∞–∑–≤–∏'}</h2>
                        <div style="color: var(--text-light); font-size: 0.95rem; margin-bottom: 1.2rem; font-style: italic;">üìÖ ${new Date(post.date).toLocaleDateString('uk-UA')}</div>
                        <div style="white-space: pre-wrap; line-height: 1.8; margin-bottom: 1rem;">${content}</div>
                        ${post.hashtags ? '<div style="margin: 1rem 0; color: var(--accent); font-weight: 600;">' + post.hashtags + '</div>' : ''}
                        <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                            <button class="btn ${isFavorite ? 'btn-primary' : 'btn-secondary'} btn-small" onclick="toggleProfileFavorite('${post.id}')">
                                ${isFavorite ? '‚ù§Ô∏è –í –æ–±—Ä–∞–Ω–æ–º—É' : 'ü§ç –í –æ–±—Ä–∞–Ω–µ'}
                            </button>
                            <button class="btn btn-secondary btn-small" onclick="scrollToTOC()">üìë –î–æ –∑–º—ñ—Å—Ç—É</button>
                            <button class="btn btn-primary btn-small" onclick="downloadPostAsImage('${post.id}')">üì• –ó–±–µ—Ä–µ–≥—Ç–∏ —è–∫ —Ñ–æ—Ç–æ</button>
                            ${isOwnProfile ? `<button class="btn btn-secondary btn-small" onclick="deletePost('${post.id}')">üóëÔ∏è –í–∏–¥–∞–ª–∏—Ç–∏</button>` : ''}
                        </div>
                    </div>`;
            }).join('');

            const paginationEl = document.getElementById('profilePagination');
            renderPagination(paginationEl, window.profileCurrentPage, totalPages, (p) => {
                window.profileCurrentPage = p;
                renderProfilePosts();
                document.getElementById('profilePage').scrollIntoView({ behavior: 'smooth', block: 'start' });
            });

            // Update TOC with ALL filtered posts (not just current page)
            updateProfileTOC(posts);
        }

        function updateProfileTOC(posts) {
            const list = document.getElementById('headerTocList');
            const section = document.getElementById('headerTocSection');
            if (!list || !section) return;

            if (posts.length === 0) {
                section.style.display = 'none';
                return;
            }

            section.style.display = 'block';
            list.innerHTML = posts.map((post, idx) => `
                <li>
                    <a href="javascript:void(0)" onclick="tocGoToPost('${post.id}', ${idx})"
                       style="text-decoration:none; color:var(--text-main); font-size:0.9rem; display:flex; gap:0.5rem; align-items:baseline; padding:0.15rem 0;">
                        <span style="color:var(--text-lighter); flex-shrink:0; min-width:1.5rem; font-size:0.78rem;">${idx + 1}.</span>
                        <span style="color:var(--accent); flex-shrink:0;">${post.type === 'poetry' ? 'üìú' : 'üí≠'}</span>
                        <span style="overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">${post.title || '–ë–µ–∑ –Ω–∞–∑–≤–∏'}</span>
                    </a>
                </li>
            `).join('');
        }

        // TOC navigation: jump to correct page then scroll to post
        window.tocGoToPost = function(postId, postIndex) {
            const page = Math.floor(postIndex / POSTS_PER_PAGE) + 1;
            if (window.profileCurrentPage !== page) {
                window.profileCurrentPage = page;
                renderProfilePosts();
                // Wait for render then scroll
                setTimeout(() => window.scrollToPost(postId), 80);
            } else {
                window.scrollToPost(postId);
            }
        };

        // Migration tool (–¥–ª—è –ø–µ—Ä—à–æ–≥–æ –∑–∞–ø—É—Å–∫—É)
        window.migrateOldPosts = async function() {
            if (!window.currentUser) {
                alert('–°–ø–æ—á–∞—Ç–∫—É —É–≤—ñ–π–¥—ñ—Ç—å —è–∫ –∞–¥–º—ñ–Ω—ñ—Å—Ç—Ä–∞—Ç–æ—Ä');
                return;
            }

            if (!confirm('–í–∏ –≤–ø–µ–≤–Ω–µ–Ω—ñ? –¶–µ –ø–µ—Ä–µ–Ω–µ—Å–µ –≤—Å—ñ —Å—Ç–∞—Ä—ñ –ø–æ—Å—Ç–∏ —Ç–∞ –ø—Ä–∏–≤\'—è–∂–µ —ó—Ö –¥–æ –≤–∞—à–æ–≥–æ –∞–∫–∞—É–Ω—Ç—É.')) {
                return;
            }

            try {
                // –û—Ç—Ä–∏–º—É—î–º–æ —Å—Ç–∞—Ä—ñ –ø–æ—Å—Ç–∏
                const oldPostsSnapshot = await get(ref(database, 'posts'));
                let migrated = 0;

                oldPostsSnapshot.forEach((childSnapshot) => {
                    const post = childSnapshot.val();
                    
                    // –Ø–∫—â–æ —É –ø–æ—Å—Ç–∞ –Ω–µ–º–∞—î userId, –¥–æ–¥–∞—î–º–æ –ø–æ—Ç–æ—á–Ω–æ–≥–æ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞
                    if (!post.userId) {
                        set(ref(database, `posts/${childSnapshot.key}`), {
                            ...post,
                            userId: window.currentUser.uid
                        });
                        migrated++;
                    }
                });

                // –û–Ω–æ–≤–ª—é—î–º–æ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞
                if (migrated > 0) {
                    const userSnapshot = await get(ref(database, `users/${window.currentUser.uid}`));
                    const userData = userSnapshot.val();
                    
                    const poetryCount = window.allPosts.filter(p => p.userId === window.currentUser.uid && p.type === 'poetry').length;
                    const thoughtsCount = window.allPosts.filter(p => p.userId === window.currentUser.uid && p.type === 'thought').length;

                    await set(ref(database, `users/${window.currentUser.uid}`), {
                        ...userData,
                        postsCount: migrated,
                        poetryCount: poetryCount,
                        thoughtsCount: thoughtsCount
                    });
                }

                alert(`‚úÖ –ú—ñ–≥—Ä–∞—Ü—ñ—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞! –ü–µ—Ä–µ–Ω–µ—Å–µ–Ω–æ ${migrated} –ø—É–±–ª—ñ–∫–∞—Ü—ñ–π.`);
                showHome();
            } catch (error) {
                console.error('Migration error:', error);
                alert('‚ùå –ü–æ–º–∏–ª–∫–∞ –º—ñ–≥—Ä–∞—Ü—ñ—ó');
            }
        };

        // Clean empty posts (–¥–ª—è –∞–¥–º—ñ–Ω–∞, –≤–∏–∫–ª–∏–∫–∞—Ç–∏ –≤ –∫–æ–Ω—Å–æ–ª—ñ)
        window.cleanEmptyPosts = async function() {
            if (!window.isAdmin) {
                alert('–¢—ñ–ª—å–∫–∏ –¥–ª—è –∞–¥–º—ñ–Ω–∞');
                return;
            }

            if (!confirm('–í–∏–¥–∞–ª–∏—Ç–∏ –≤—Å—ñ –ø–æ—Ä–æ–∂–Ω—ñ –ø–æ—Å—Ç–∏?')) return;

            try {
                const postsSnapshot = await get(ref(database, 'posts'));
                let deleted = 0;

                for (const [key, post] of Object.entries(postsSnapshot.val() || {})) {
                    if (!post.title || !post.content || !post.date || !post.userId) {
                        await remove(ref(database, `posts/${key}`));
                        deleted++;
                    }
                }

                alert(`‚úÖ –í–∏–¥–∞–ª–µ–Ω–æ ${deleted} –ø–æ—Ä–æ–∂–Ω—ñ—Ö –ø–æ—Å—Ç—ñ–≤`);
                showHome();
            } catch (error) {
                console.error('Clean error:', error);
                alert('‚ùå –ü–æ–º–∏–ª–∫–∞ –æ—á–∏—â–µ–Ω–Ω—è');
            }
        };



        // ===== POETS PAGE SEARCH =====
        window.poetsSearchQuery = '';

        window.togglePoetsSearch = function() {
            const bar = document.getElementById('poetsSearchFilterBar');
            const btn = document.getElementById('poetsSearchToggleBtn');
            if (!bar) return;
            const isOpen = bar.classList.contains('active');
            bar.classList.toggle('active', !isOpen);
            if (btn) btn.classList.toggle('active', !isOpen);
        };

        window.runPoetsSearch = function() {
            window.poetsSearchQuery = document.getElementById('poetsSearchInput').value.trim();
            document.getElementById('poetsClearBtn').style.display = window.poetsSearchQuery ? 'block' : 'none';
            renderPoetsList();
        };

        window.clearPoetsSearch = function() {
            document.getElementById('poetsSearchInput').value = '';
            window.poetsSearchQuery = '';
            document.getElementById('poetsClearBtn').style.display = 'none';
            document.getElementById('poetsSearchResultsBanner').style.display = 'none';
            renderPoetsList();
        };

        function renderPoetsList() {
            const container = document.getElementById('allPoetsContainer');
            const banner = document.getElementById('poetsSearchResultsBanner');

            let users = [...window.allUsers];

            if (window.poetsSearchQuery) {
                const q = window.poetsSearchQuery.toLowerCase();
                users = users.filter(u =>
                    (u.name && u.name.toLowerCase().includes(q)) ||
                    (u.bio && u.bio.toLowerCase().includes(q))
                );
                banner.style.display = 'block';
                banner.innerHTML = `–ó–Ω–∞–π–¥–µ–Ω–æ <strong>${users.length}</strong> ${users.length === 1 ? '–ø–æ–µ—Ç–∞' : '–ø–æ–µ—Ç—ñ–≤'} –∑–∞ "<strong>${window.poetsSearchQuery}</strong>"`;
            } else {
                banner.style.display = 'none';
            }

            if (users.length === 0) {
                container.innerHTML = '<p style="color: var(--text-light); text-align: center; padding: 2rem;">–ù—ñ–∫–æ–≥–æ –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ</p>';
                return;
            }

            const sorted = users.sort((a, b) => (b.postsCount || 0) - (a.postsCount || 0));

            container.innerHTML = sorted.map(user => `
                <div class="user-item" style="cursor: pointer; align-items: flex-start; padding: 1.2rem;" onclick="showUserProfile('${user.id}')">
                    ${user.avatarUrl
                        ? `<img src="${user.avatarUrl}" alt="${user.name}" style="width:50px;height:50px;border-radius:50%;object-fit:cover;flex-shrink:0;margin-top:0.2rem;border:2px solid var(--accent);">`
                        : `<div class="user-avatar" style="width:50px;height:50px;font-size:1.3rem;flex-shrink:0;margin-top:0.2rem;">${user.name.charAt(0).toUpperCase()}</div>`
                    }
                    <div class="user-info">
                        <div class="user-name" style="font-size: 1.1rem;">${user.name}</div>
                        <div class="user-stats" style="margin: 0.3rem 0;">
                            üìù ${user.postsCount || 0} –ø—É–±–ª—ñ–∫–∞—Ü—ñ–π |
                            üìú ${user.poetryCount || 0} –≤—ñ—Ä—à—ñ–≤ |
                            üí≠ ${user.thoughtsCount || 0} –¥—É–º–æ–∫
                        </div>
                        ${user.bio ? `<div style="color: var(--text-light); font-style: italic; font-size: 0.95rem; margin-top: 0.3rem; line-height: 1.5;">${user.bio.length > 120 ? user.bio.substring(0, 120) + '...' : user.bio}</div>` : ''}
                    </div>
                </div>
            `).join('');
        }


        // ===== SINGLE POST PAGE =====
        function navigateToPost(postId) {
            const post = window.allPosts.find(p => p.id === postId);
            if (!post) {
                // Post not loaded yet ‚Äî wait and retry
                setTimeout(() => navigateToPost(postId), 300);
                return;
            }

            window.currentPostId = postId; // Store for download button

            // Hide all pages
            document.getElementById('homePage').style.display = 'none';
            document.getElementById('profilePage').style.display = 'none';
            document.getElementById('allPostsPage').style.display = 'none';
            document.getElementById('poetsPage').style.display = 'none';
            document.getElementById('adminPage').style.display = 'none';
            document.getElementById('postPage').style.display = 'block';
            setHomeSearchVisible(false);

            // Fill content
            const badge = document.getElementById('postPageBadge');
            badge.textContent = post.type === 'poetry' ? '–ü–û–ï–ó–Ü–Ø' : '–î–£–ú–ö–ê';

            document.getElementById('postPageTitle').textContent = post.title || '–ë–µ–∑ –Ω–∞–∑–≤–∏';
            document.getElementById('postPageDate').textContent = 'üìÖ ' + new Date(post.date).toLocaleDateString('uk-UA', { day: 'numeric', month: 'long', year: 'numeric' });
            document.getElementById('postPageContent').textContent = post.content || '';

            // Hashtags
            const hashEl = document.getElementById('postPageHashtags');
            if (post.hashtags) {
                const tags = typeof post.hashtags === 'string'
                    ? post.hashtags.split(' ').map(t => t.trim()).filter(Boolean)
                    : post.hashtags;
                hashEl.innerHTML = tags.map(t =>
                    `<span style="display:inline-block; padding:4px 12px; background:var(--bg-secondary); color:var(--accent); border-radius:15px; font-size:0.85rem; font-weight:600; margin:0.25rem 0.25rem 0.25rem 0;">${t}</span>`
                ).join('');
            } else {
                hashEl.innerHTML = '';
            }

            // Author block ‚Äî click goes to profile
            const author = window.allUsers.find(u => u.id === post.userId);
            const authorName = author ? author.name : '–ù–µ–≤—ñ–¥–æ–º–∏–π –∞–≤—Ç–æ—Ä';
            const authorInitial = authorName.charAt(0).toUpperCase();

            document.getElementById('postPageAuthorAvatar').textContent = authorInitial;
            document.getElementById('postPageAuthorName').textContent = authorName;

            const authorLink = document.getElementById('postPageAuthorLink');
            authorLink.onclick = () => {
                updateURL('profile/' + post.userId, true);
                navigateToUserProfile(post.userId);
            };

            // Update SEO meta tags
            const preview = (post.content || '').substring(0, 160).replace(/\n/g, ' ');
            updateMeta({
                title: post.title || '–ü—É–±–ª—ñ–∫–∞—Ü—ñ—è',
                description: preview,
                url: '/post/' + postId,
                image: author?.avatarUrl || undefined
            });

            // Scroll to top
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        window.showPost = function(postId) {
            updateURL('post/' + postId, true);
            navigateToPost(postId);
        };

        window.sharePost = async function(postId) {
            const post = window.allPosts.find(p => p.id === postId);
            if (!post) return;

            const url = location.origin + '/post/' + postId;
            const title = post.title || '–ü—É–±–ª—ñ–∫–∞—Ü—ñ—è';
            const text = (post.content || '').substring(0, 120) + (post.content && post.content.length > 120 ? '‚Ä¶' : '');

            // Try Web Share API (mobile/modern browsers)
            if (navigator.share) {
                try {
                    await navigator.share({ title, text, url });
                    return;
                } catch (e) {
                    if (e.name === 'AbortError') return; // user cancelled
                }
            }

            // Fallback ‚Äî copy link to clipboard
            try {
                await navigator.clipboard.writeText(url);
                showShareToast('üîó –ü–æ—Å–∏–ª–∞–Ω–Ω—è —Å–∫–æ–ø—ñ–π–æ–≤–∞–Ω–æ!');
            } catch (e) {
                // Last resort ‚Äî prompt
                prompt('–°–∫–æ–ø—ñ—é–π—Ç–µ –ø–æ—Å–∏–ª–∞–Ω–Ω—è:', url);
            }
        };

        function showShareToast(msg) {
            let toast = document.getElementById('shareToast');
            if (!toast) {
                toast = document.createElement('div');
                toast.id = 'shareToast';
                toast.style.cssText = `
                    position: fixed; bottom: 2rem; left: 50%; transform: translateX(-50%);
                    background: var(--accent); color: white;
                    padding: 0.65rem 1.4rem; border-radius: 24px;
                    font-family: 'Philosopher', sans-serif; font-size: 1rem; font-weight: 600;
                    box-shadow: 0 4px 16px rgba(0,0,0,0.2);
                    z-index: 9999; opacity: 0; transition: opacity 0.25s;
                    pointer-events: none;
                `;
                document.body.appendChild(toast);
            }
            toast.textContent = msg;
            toast.style.opacity = '1';
            clearTimeout(toast._timer);
            toast._timer = setTimeout(() => { toast.style.opacity = '0'; }, 2500);
        }

        // ===== HOME SEARCH & FILTER BAR =====
        window.homeSearchQuery = '';
        window.homeSearchType = 'all';
        window.homeHashtagFilter = null;

        window.toggleSearchBar = function() {
            const bar = document.getElementById('searchFilterBar');
            const toggle = document.getElementById('searchBarToggle');
            const isActive = bar.classList.toggle('active');
            if (toggle) toggle.textContent = isActive ? '‚ñ≤' : '‚ñº';
            if (isActive) {
                document.getElementById('homeSearchInput').focus();
                buildHomeHashtagChips();
            }
        };

        window.runHomeSearch = function() {
            const input = document.getElementById('homeSearchInput');
            window.homeSearchQuery = input.value.trim();
            window.homeSearchType = document.querySelector('input[name="homeSearchType"]:checked')?.value || 'all';
            const clearBtn = document.getElementById('homeClearBtn');
            clearBtn.style.display = window.homeSearchQuery ? 'block' : 'none';
            applyHomeSearch();
        };

        window.clearHomeSearch = function() {
            document.getElementById('homeSearchInput').value = '';
            window.homeSearchQuery = '';
            window.homeHashtagFilter = null;
            document.getElementById('homeClearBtn').style.display = 'none';
            document.getElementById('homeSearchResultsBanner').style.display = 'none';
            // reset hashtag chips
            document.querySelectorAll('.home-hashtag-chip').forEach(c => c.classList.remove('active'));
            applyHomeSearch();
        };

        window.toggleHomeHashtag = function(tag) {
            window.homeHashtagFilter = window.homeHashtagFilter === tag ? null : tag;
            document.querySelectorAll('.home-hashtag-chip').forEach(c => {
                c.classList.toggle('active', c.dataset.tag === window.homeHashtagFilter);
            });
            applyHomeSearch();
        };

        function buildHomeHashtagChips() {
            const allHashtags = {};
            window.allPosts.forEach(post => {
                if (post.hashtags) {
                    const tags = typeof post.hashtags === 'string'
                        ? post.hashtags.split(' ').map(t => t.trim()).filter(Boolean)
                        : post.hashtags;
                    tags.forEach(t => { allHashtags[t] = (allHashtags[t] || 0) + 1; });
                }
            });

            const sorted = Object.entries(allHashtags).sort((a, b) => b[1] - a[1]).slice(0, 15);
            const listEl = document.getElementById('homeHashtagChipsList');
            const containerEl = document.getElementById('homeHashtagChips');

            if (sorted.length === 0) {
                containerEl.style.display = 'none';
                return;
            }

            containerEl.style.display = 'flex';
            listEl.innerHTML = sorted.map(([tag, count]) =>
                `<span class="home-hashtag-chip ${window.homeHashtagFilter === tag ? 'active' : ''}"
                       data-tag="${tag}"
                       onclick="toggleHomeHashtag('${tag}')">${tag} (${count})</span>`
            ).join('');
        }

        function applyHomeSearch() {
            const query = window.homeSearchQuery.toLowerCase();
            const type = window.homeSearchType;
            const hashTag = window.homeHashtagFilter;

            let filtered = window.allPosts;

            // Hashtag filter
            if (hashTag) {
                filtered = filtered.filter(p => p.hashtags && (
                    typeof p.hashtags === 'string'
                        ? p.hashtags.includes(hashTag)
                        : p.hashtags.includes(hashTag)
                ));
            }

            // Text search
            if (query) {
                filtered = filtered.filter(p => {
                    const titleMatch = p.title && p.title.toLowerCase().includes(query);
                    const contentMatch = p.content && p.content.toLowerCase().includes(query);
                    const hashMatch = p.hashtags && (
                        typeof p.hashtags === 'string'
                            ? p.hashtags.toLowerCase().includes(query)
                            : p.hashtags.some(t => t.toLowerCase().includes(query))
                    );
                    if (type === 'title') return titleMatch;
                    if (type === 'content') return contentMatch;
                    return titleMatch || contentMatch || hashMatch;
                });
            }

            // Show/hide results banner
            const banner = document.getElementById('homeSearchResultsBanner');
            if (query || hashTag) {
                banner.style.display = 'block';
                const parts = [];
                if (query) parts.push(`"<strong>${query}</strong>"`);
                if (hashTag) parts.push(`—Ö–µ—à—Ç–µ–≥ <strong>${hashTag}</strong>`);
                banner.innerHTML = `–ó–Ω–∞–π–¥–µ–Ω–æ <strong>${filtered.length}</strong> –ø—É–±–ª—ñ–∫–∞—Ü—ñ–π –∑–∞ ${parts.join(' + ')}`;
            } else {
                banner.style.display = 'none';
            }

            // Re-render home sections with filtered data
            renderHomeWithFilter(filtered);
        }

        function renderHomeWithFilter(filtered) {
            // Featured
            const featuredFiltered = filtered.filter(p => p.featured).slice(0, 8);
            const featuredContainer = document.getElementById('featuredPosts');
            if (featuredFiltered.length === 0) {
                featuredContainer.className = '';
                featuredContainer.innerHTML = '<p style="color: var(--text-light);">–ù–µ–º–∞—î –æ–±—Ä–∞–Ω–∏—Ö –ø—É–±–ª—ñ–∫–∞—Ü—ñ–π</p>';
            } else {
                featuredContainer.className = 'thoughts-scroll-row';
                featuredContainer.innerHTML = featuredFiltered.map(post => {
                    const preview = (post.content || '').length > 200 ? post.content.substring(0, 200) + '...' : (post.content || '');
                    const ws = post.type === 'poetry' ? 'pre-wrap' : 'normal';
                    return `<div class="random-card" onclick="showPost('${post.id}')">
                        <div class="random-card-title">${post.title || '–ë–µ–∑ –Ω–∞–∑–≤–∏'}</div>
                        <div class="random-card-author" onclick="event.stopPropagation(); showUserProfile('${post.userId}')" style="cursor:pointer;">&#9997;&#65039; ${getUserName(post.userId)}</div>
                        <div class="random-card-content" style="white-space:${ws};">${preview}</div>
                    </div>`;
                }).join('');
            }

            // Random Poetry
            const poetryFiltered = filtered.filter(p => p.type === 'poetry');
            const randomPoetry = [...poetryFiltered].sort(() => 0.5 - Math.random()).slice(0, 8);
            const poetryContainer = document.getElementById('randomPoetry');
            if (randomPoetry.length === 0) {
                poetryContainer.className = '';
                poetryContainer.innerHTML = '<p style="color: var(--text-light);">–ù–µ–º–∞—î –≤—ñ—Ä—à—ñ–≤</p>';
            } else {
                poetryContainer.className = 'thoughts-scroll-row';
                poetryContainer.innerHTML = randomPoetry.map(post => {
                    const preview = (post.content || '').length > 200 ? post.content.substring(0, 200) + '...' : (post.content || '');
                    return `<div class="random-card" onclick="showPost('${post.id}')">
                        <div class="random-card-title">${post.title || '–ë–µ–∑ –Ω–∞–∑–≤–∏'}</div>
                        <div class="random-card-author" onclick="event.stopPropagation(); showUserProfile('${post.userId}')" style="cursor:pointer;">&#9997;&#65039; ${getUserName(post.userId)}</div>
                        <div class="random-card-content" style="white-space:pre-wrap;">${preview}</div>
                    </div>`;
                }).join('');
            }

            // Random Thoughts
            const thoughtsFiltered = filtered.filter(p => p.type === 'thought');
            const randomThoughts = [...thoughtsFiltered].sort(() => 0.5 - Math.random()).slice(0, 8);
            const thoughtsContainer = document.getElementById('randomThoughts');
            if (randomThoughts.length === 0) {
                thoughtsContainer.className = '';
                thoughtsContainer.innerHTML = '<p style="color: var(--text-light);">–ù–µ–º–∞—î –¥—É–º–æ–∫</p>';
            } else {
                thoughtsContainer.className = 'thoughts-scroll-row';
                thoughtsContainer.innerHTML = randomThoughts.map(post => {
                    const preview = (post.content || '').length > 200
                        ? post.content.substring(0, 200) + '...'
                        : post.content;
                    return `<div class="random-card" onclick="showPost('${post.id}')">
                        <div class="random-card-title">${post.title || '–ë–µ–∑ –Ω–∞–∑–≤–∏'}</div>
                        <div class="random-card-author" onclick="event.stopPropagation(); showUserProfile('${post.userId}')" style="cursor:pointer;">&#9997;&#65039; ${getUserName(post.userId)}</div>
                        <div class="random-card-content" style="white-space:normal;">${preview}</div>
                    </div>`;
                }).join('');
            }
        }

        // Close search bar when switching pages (home only)
        function closeSearchBar() {
            // intentionally left open ‚Äî bar is persistent on home page
        }

        // ===== MOBILE BURGER MENU =====
        window.toggleMobileMenu = function() {
            const menu = document.getElementById('mobileMenu');
            const btn = document.getElementById('burgerBtn');
            menu.classList.toggle('open');
            btn.classList.toggle('open');
        };

        window.closeMobileMenu = function() {
            document.getElementById('mobileMenu').classList.remove('open');
            document.getElementById('burgerBtn').classList.remove('open');
        };

        // Sync mobile user menu with desktop user menu
        function syncMobileUserMenu() {
            const desktop = document.getElementById('userMenu');
            const mobile = document.getElementById('mobileUserMenu');
            if (!desktop || !mobile) return;
            // Clone content but adapt for mobile
            const user = window.currentUser;
            const userData = window.allUsers.find(u => u.id === (user && user.uid));
            if (user && userData) {
                mobile.innerHTML = `
                    <div class="mobile-user-name">üë§ ${userData.name || '–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á'}</div>
                    ${window.isAdmin ? '<button class="btn btn-secondary" onclick="showAdminPanel(); closeMobileMenu()">‚öôÔ∏è –ê–¥–º—ñ–Ω</button>' : ''}
                    <button class="btn btn-secondary" onclick="showMyProfile(); closeMobileMenu()">–ú—ñ–π –ø—Ä–æ—Ñ—ñ–ª—å</button>
                    <button class="btn btn-primary" onclick="handleLogout(); closeMobileMenu()">–í–∏–π—Ç–∏</button>
                `;
            } else {
                mobile.innerHTML = `
                    <button class="btn btn-secondary" onclick="showAuthModal('login'); closeMobileMenu()">–£–≤—ñ–π—Ç–∏</button>
                    <button class="btn btn-primary" onclick="showAuthModal('register'); closeMobileMenu()">–†–µ—î—Å—Ç—Ä–∞—Ü—ñ—è</button>
                `;
            }
        }

        // ========== URL ROUTING SYSTEM ==========
        
        // –ü—Ä–∞–ø–æ—Ä–µ—Ü—å –¥–ª—è –∑–∞–ø–æ–±—ñ–≥–∞–Ω–Ω—è —Ü–∏–∫–ª—ñ–≤
        let isNavigating = false;
        
        // –§—É–Ω–∫—Ü—ñ—è –¥–ª—è –æ–Ω–æ–≤–ª–µ–Ω–Ω—è URL –±–µ–∑ –≤–∏–∫–ª–∏–∫—É —Ä–æ—É—Ç–µ—Ä–∞
        function updateURL(path, skipNavigation = false) {
            const newPath = path === 'home' ? '/' : '/' + path;
            if (window.location.pathname === newPath) return;
            if (skipNavigation) isNavigating = true;
            window.history.pushState({}, '', newPath);
            if (skipNavigation) setTimeout(() => { isNavigating = false; }, 10);
        }

        // –ü–∞—Ä—Å–∏–Ω–≥ –ø–æ—Ç–æ—á–Ω–æ–≥–æ URL
        function getCurrentRoute() {
            const path = window.location.pathname.replace(/^\//, '') || 'home';
            return path;
        }

        // –û–Ω–æ–≤–ª–µ–Ω–Ω—è –º–µ—Ç–∞-—Ç–µ–≥—ñ–≤ –¥–ª—è SEO
        function updateMeta({ title, description, url, image } = {}) {
            const base = 'https://konvi.space';
            const fullTitle = title ? title + ' ‚Äî KonVi' : '–ü–æ–µ—Ç–∏—á–Ω–∞ –ø–ª–∞—Ç—Ñ–æ—Ä–º–∞ - –°–ø—ñ–ª—å–Ω–æ—Ç–∞ –ø–æ–µ—Ç—ñ–≤';
            const fullUrl = url ? base + url : base + window.location.pathname;
            const fullDesc = description || '–°–ø—ñ–ª—å–Ω–æ—Ç–∞ —É–∫—Ä–∞—ó–Ω—Å—å–∫–∏—Ö –ø–æ–µ—Ç—ñ–≤. –ß–∏—Ç–∞–π—Ç–µ –≤—ñ—Ä—à—ñ —Ç–∞ –¥—É–º–∫–∏ –∞–≤—Ç–æ—Ä—ñ–≤.';
            const fullImg = image || base + '/logo.webp';

            document.title = fullTitle;
            document.getElementById('ogTitle').content = fullTitle;
            document.getElementById('ogDescription').content = fullDesc;
            document.getElementById('ogUrl').content = fullUrl;
            document.getElementById('ogImage').content = fullImg;
            document.getElementById('twitterTitle').content = fullTitle;
            document.getElementById('twitterDescription').content = fullDesc;
            document.getElementById('twitterImage').content = fullImg;
            document.getElementById('canonicalTag').href = fullUrl;
            const metaDesc = document.querySelector('meta[name="description"]');
            if (metaDesc) metaDesc.content = fullDesc;
        }

        // –í–Ω—É—Ç—Ä—ñ—à–Ω—ñ –≤–µ—Ä—Å—ñ—ó —Ñ—É–Ω–∫—Ü—ñ–π –Ω–∞–≤—ñ–≥–∞—Ü—ñ—ó (–±–µ–∑ –æ–Ω–æ–≤–ª–µ–Ω–Ω—è URL)
        function setHomeSearchVisible(visible) {
            document.getElementById('searchFilterBar').style.display = visible ? '' : 'none';
            document.getElementById('searchBarToggleWrap').style.display = visible ? '' : 'none';
            document.getElementById('homeSearchResultsBanner').style.display = visible ? (window.homeSearchQuery || window.homeHashtagFilter ? 'block' : 'none') : 'none';
        }

        function hideAllPagesInternal() {
            ['homePage','profilePage','allPostsPage','poetsPage','adminPage','postPage'].forEach(id => {
                const el = document.getElementById(id);
                if (el) el.style.display = 'none';
            });
        }

        function navigateToHome() {
            hideAllPagesInternal();
            hideHeaderFilter();
            document.getElementById('homePage').style.display = 'grid';
            setHomeSearchVisible(true);
            updateMeta({ url: '/' });
        }

        function navigateToPoets() {
            hideAllPagesInternal();
            hideHeaderFilter();
            document.getElementById('poetsPage').style.display = 'block';
            setHomeSearchVisible(false);
            loadAllPoets();
            updateMeta({ title: '–ü–æ–µ—Ç–∏', description: '–í—Å—ñ –ø–æ–µ—Ç–∏ —Å–ø—ñ–ª—å–Ω–æ—Ç–∏ KonVi', url: '/poets' });
        }

        function navigateToPosts() {
            hideAllPagesInternal();
            document.getElementById('allPostsPage').style.display = 'block';
            setHomeSearchVisible(false);
            loadAllPostsPage();
            showHeaderFilter('allPosts');
            updateMeta({ title: '–í—Å—ñ –ø—É–±–ª—ñ–∫–∞—Ü—ñ—ó', description: '–í—Å—ñ –≤—ñ—Ä—à—ñ —Ç–∞ –¥—É–º–∫–∏ —Å–ø—ñ–ª—å–Ω–æ—Ç–∏ KonVi', url: '/posts' });
        }

        function navigateToMyProfile() {
            if (!window.currentUser) {
                alert('–°–ø–æ—á–∞—Ç–∫—É —É–≤—ñ–π–¥—ñ—Ç—å –≤ —Å–∏—Å—Ç–µ–º—É');
                updateURL('home', true);
                navigateToHome();
                return;
            }
            hideAllPagesInternal();
            document.getElementById('profilePage').style.display = 'block';
            setHomeSearchVisible(false);
            loadMyProfile();
            showHeaderFilter('profile');
            updateMeta({ title: '–ú—ñ–π –ø—Ä–æ—Ñ—ñ–ª—å', url: '/profile' });
        }

        function navigateToUserProfile(userId) {
            hideAllPagesInternal();
            document.getElementById('profilePage').style.display = 'block';
            setHomeSearchVisible(false);
            loadUserProfile(userId);
            showHeaderFilter('profile');
            // Meta –±—É–¥–µ –æ–Ω–æ–≤–ª–µ–Ω–æ –ø—ñ—Å–ª—è –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –¥–∞–Ω–∏—Ö –ø—Ä–æ—Ñ—ñ–ª—é –≤ loadUserProfile
        }

        function navigateToAdmin() {
            if (!window.isAdmin) {
                updateURL('home', true);
                navigateToHome();
                return;
            }
            hideAllPagesInternal();
            hideHeaderFilter();
            document.getElementById('adminPage').style.display = 'block';
            setHomeSearchVisible(false);
            document.querySelectorAll('.admin-tab-btn').forEach((btn, i) => btn.classList.toggle('active', i === 0));
            document.getElementById('adminTabStats').style.display = 'block';
            document.getElementById('adminTabPosts').style.display = 'none';
            document.getElementById('adminTabTheme').style.display = 'none';
            loadAdminPanel();
            updateMeta({ title: '–ê–¥–º—ñ–Ω –ø–∞–Ω–µ–ª—å', url: '/admin' });
        }

        // –†–æ—É—Ç–µ—Ä - –æ–±—Ä–æ–±–ª—è—î –∑–º—ñ–Ω–∏ URL
        function handleRoute() {
            if (isNavigating) return; // –Ü–≥–Ω–æ—Ä—É—î–º–æ —è–∫—â–æ –º–∏ —Å–∞–º—ñ –∑–º—ñ–Ω—é—î–º–æ URL
            
            const route = getCurrentRoute();
            const parts = route.split('/');
            const page = parts[0];

            console.log('Routing to:', route);

            switch(page) {
                case 'home':
                    navigateToHome();
                    break;
                
                case 'poets':
                    navigateToPoets();
                    break;
                
                case 'posts':
                    navigateToPosts();
                    break;
                
                case 'post':
                    if (parts[1]) {
                        navigateToPost(parts[1]);
                    } else {
                        navigateToHome();
                    }
                    break;

                case 'profile':
                    if (parts[1]) {
                        navigateToUserProfile(parts[1]);
                    } else {
                        navigateToMyProfile();
                    }
                    break;
                
                case 'admin':
                    navigateToAdmin();
                    break;
                
                default:
                    navigateToHome();
            }
        }

        // –°–ª—É—Ö–∞—î–º–æ –∑–º—ñ–Ω–∏ URL (–∫–Ω–æ–ø–∫–∏ –Ω–∞–∑–∞–¥/–≤–ø–µ—Ä–µ–¥)
        window.addEventListener('popstate', handleRoute);

        // –ó–∞–≤–∞–Ω—Ç–∞–∂—É—î–º–æ –ø—Ä–∞–≤–∏–ª—å–Ω—É —Å—Ç–æ—Ä—ñ–Ω–∫—É –ø—Ä–∏ —Å—Ç–∞—Ä—Ç—ñ
        window.addEventListener('load', () => {
            handleRoute();
        });

        // –û–Ω–æ–≤–ª—é—î–º–æ –ø—É–±–ª—ñ—á–Ω—ñ –Ω–∞–≤—ñ–≥–∞—Ü—ñ–π–Ω—ñ —Ñ—É–Ω–∫—Ü—ñ—ó - —Ç–µ–ø–µ—Ä –≤–æ–Ω–∏ –ø—Ä–æ—Å—Ç–æ –∑–º—ñ–Ω—é—é—Ç—å URL
        window.showHome = function() {
            closeSearchBar();
            updateURL('home', true);
            navigateToHome();
        };

        window.showPoets = function() {
            updateURL('poets', true);
            navigateToPoets();
        };

        window.showAllPosts = function() {
            updateURL('posts', true);
            navigateToPosts();
        };

        window.showMyProfile = function() {
            updateURL('profile', true);
            navigateToMyProfile();
        };

        window.showUserProfile = async function(userId) {
            updateURL('profile/' + userId, true);
            navigateToUserProfile(userId);
        };

        window.showAdminPanel = function() {
            if (!window.isAdmin) return; // —Ç–∏—Ö–æ —ñ–≥–Ω–æ—Ä—É—î–º–æ —è–∫—â–æ isAdmin —â–µ –Ω–µ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–æ
            updateURL('admin', true);
            hideAllPagesInternal();
            document.getElementById('adminPage').style.display = 'block';
            setHomeSearchVisible(false);
            document.querySelectorAll('.admin-tab-btn').forEach((btn, i) => btn.classList.toggle('active', i === 0));
            document.getElementById('adminTabStats').style.display = 'block';
            document.getElementById('adminTabPosts').style.display = 'none';
            document.getElementById('adminTabTheme').style.display = 'none';
            loadAdminPanel();
        };

        // –§—É–Ω–∫—Ü—ñ—è –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü—ñ—ó –ø–æ—Å–∏–ª–∞–Ω–Ω—è –Ω–∞ –ø—Ä–æ—Ñ—ñ–ª—å
        window.getProfileLink = function(userId) {
            return window.location.origin + window.location.pathname + '#profile/' + userId;
        };

        // –§—É–Ω–∫—Ü—ñ—è –¥–ª—è –∫–æ–ø—ñ—é–≤–∞–Ω–Ω—è –ø–æ—Å–∏–ª–∞–Ω–Ω—è
        window.copyProfileLink = function(userId) {
            const link = getProfileLink(userId);
            navigator.clipboard.writeText(link).then(() => {
                alert('‚úÖ –ü–æ—Å–∏–ª–∞–Ω–Ω—è —Å–∫–æ–ø—ñ–π–æ–≤–∞–Ω–æ!');
            }).catch(err => {
                prompt('–°–∫–æ–ø—ñ—é–π—Ç–µ —Ü–µ –ø–æ—Å–∏–ª–∞–Ω–Ω—è:', link);
            });
        };



        // ===== ADMIN PANEL TABS & THEME SETTINGS =====
        window.showAdminTab = function(tabName) {
            // Update tab buttons
            document.querySelectorAll('.admin-tab-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');

            // Show/hide tab content
            document.getElementById('adminTabStats').style.display = tabName === 'stats' ? 'block' : 'none';
            document.getElementById('adminTabPosts').style.display = tabName === 'posts' ? 'block' : 'none';
            document.getElementById('adminTabTheme').style.display = tabName === 'theme' ? 'block' : 'none';

            if (tabName === 'theme') {
                loadThemeCards();
            } else if (tabName === 'stats') {
                loadAdminStats();
            }
        };

        function loadThemeCards() {
            const themes = [
                { id: 'default', name: '–ö–ª–∞—Å–∏—á–Ω–∞ –±–µ–∂–µ–≤–∞', colors: ['#faf8f3', '#8b6f47', '#2c3e50'] },
                { id: 'green', name: '–¢—Ä–∞–≤—è–Ω–∏—Å—Ç–æ-–∑–µ–ª–µ–Ω–∞', colors: ['#f5f9f0', '#6b8e23', '#2d5016'] },
                { id: 'ocean', name: '–ú–æ—Ä—Å—å–∫–∞ —Å–∏–Ω—è', colors: ['#f0f7fb', '#5fa8d3', '#1b4965'] },
                { id: 'lavender', name: '–§—ñ–æ–ª–µ—Ç–æ–≤–æ-–ª–∞–≤–∞–Ω–¥–æ–≤–∞', colors: ['#f8f5fb', '#8b5fb0', '#4a2c62'] },
                { id: 'terracotta', name: '–¢–µ—Ä–∞–∫–æ—Ç–æ–≤–æ-—Ä–æ–∂–µ–≤–∞', colors: ['#fdf7f4', '#d2691e', '#8b4513'] },
                { id: 'dark', name: '–¢–µ–º–Ω–∞', colors: ['#1a1a1a', '#c9a961', '#e8e6e3'] },
                { id: 'coffee', name: '–ö–∞–≤–æ–≤–∞ –µ–ª–µ–≥–∞–Ω—Ç–Ω—ñ—Å—Ç—å', colors: ['#234545', '#c9a961', '#f5f0e8'] },
                { id: 'earth-light', name: '–ú–∞—Ç–∏-–ó–µ–º–ª—è —Å–≤—ñ—Ç–ª–∞', colors: ['#f5f3ed', '#8b7355', '#4a5f3d'] },
                { id: 'earth-dark', name: '–ú–∞—Ç–∏-–ó–µ–º–ª—è —Ç–µ–º–Ω–∞', colors: ['#2d3a26', '#a89078', '#e8e4d5'] },
                { id: 'forest-light', name: '–õ—ñ—Å–æ–≤–∞ –∫–∞–≤–∞ —Å–≤—ñ—Ç–ª–∞', colors: ['#f0ede3', '#8b7355', '#2d5045'] },
                { id: 'forest-dark', name: '–õ—ñ—Å–æ–≤–∞ –∫–∞–≤–∞ —Ç–µ–º–Ω–∞', colors: ['#1f3a32', '#a89078', '#e5e0d0'] },
                { id: 'green-brown-light', name: '–ó–µ–ª–µ–Ω–æ-–∫–æ—Ä–∏—á–Ω–µ–≤–∞ —Å–≤—ñ—Ç–ª–∞', colors: ['#fafaf8', '#6d5a3a', '#2a4a2d'] },
                { id: 'green-brown-vibrant', name: '–°–æ–∫–æ–≤–∏—Ç–∞ –∑–µ–ª–µ–Ω–æ-–∫–æ—Ä–∏—á–Ω–µ–≤–∞', colors: ['#fdfdfb', '#b8862e', '#1d5c2e'] },
                { id: 'nature-contrast', name: '–ü—Ä–∏—Ä–æ–¥–Ω–∏–π –∫–æ–Ω—Ç—Ä–∞—Å—Ç', colors: ['#f9f5e8', '#6d4e2a', '#2a3f2a'] },
                { id: 'nature-soft-contrast', name: "–ú'—è–∫–∏–π –ø—Ä–∏—Ä–æ–¥–Ω–∏–π –∫–æ–Ω—Ç—Ä–∞—Å—Ç", colors: ['#faf7ed', '#7a5a2d', '#2d4a2d'] },
                { id: 'forest-palette', name: '–õ—ñ—Å–æ–≤–∞ –ø–∞–ª—ñ—Ç—Ä–∞', colors: ['#daf1de', '#397654', '#051f20'] },
                { id: 'fresh-rose', name: '–°–≤—ñ–∂–∞ —Ç—Ä–æ—è–Ω–¥–∞', colors: ['#fde8e8', '#c73e3e', '#2d0a0a'] },
                { id: 'golden-baroque', name: '–ó–æ–ª–æ—Ç–µ –±–∞—Ä–æ–∫–∫–æ', colors: ['#fdfaf5', '#d4a645', '#1a1410'] }
            ];

            const container = document.getElementById('themeCardsContainer');
            const currentTheme = document.documentElement.getAttribute('data-theme') || 'default';

            container.innerHTML = themes.map(theme => `
                <div class="theme-card ${theme.id === currentTheme ? 'active' : ''}" data-theme="${theme.id}" onclick="applyTheme('${theme.id}')">
                    <div class="theme-preview">
                        ${theme.colors.map(color => `<div class="theme-color" style="background: ${color};"></div>`).join('')}
                    </div>
                    <div class="theme-name">${theme.name}</div>
                    <div class="theme-check">‚úì</div>
                </div>
            `).join('');
        }

        window.applyTheme = async function(themeName) {
            console.log('üé® –ó–∞—Å—Ç–æ—Å–æ–≤—É—é —Ç–µ–º—É:', themeName);
            
            // Apply theme locally instantly
            if (themeName === 'default') {
                document.documentElement.removeAttribute('data-theme');
            } else {
                document.documentElement.setAttribute('data-theme', themeName);
            }
            
            // Update UI
            document.querySelectorAll('.theme-card').forEach(card => {
                card.classList.toggle('active', card.dataset.theme === themeName);
            });

            // Save to Firebase (global for all users)
            try {
                await set(ref(database, 'settings/theme'), themeName);
                const themeNames = {
                    'default': '–ö–ª–∞—Å–∏—á–Ω–∞ –±–µ–∂–µ–≤–∞',
                    'green': '–¢—Ä–∞–≤—è–Ω–∏—Å—Ç–æ-–∑–µ–ª–µ–Ω–∞',
                    'ocean': '–ú–æ—Ä—Å—å–∫–∞ —Å–∏–Ω—è',
                    'lavender': '–§—ñ–æ–ª–µ—Ç–æ–≤–æ-–ª–∞–≤–∞–Ω–¥–æ–≤–∞',
                    'terracotta': '–¢–µ—Ä–∞–∫–æ—Ç–æ–≤–æ-—Ä–æ–∂–µ–≤–∞',
                    'dark': '–¢–µ–º–Ω–∞',
                    'coffee': '–ö–∞–≤–æ–≤–∞ –µ–ª–µ–≥–∞–Ω—Ç–Ω—ñ—Å—Ç—å',
                    'earth-light': '–ú–∞—Ç–∏-–ó–µ–º–ª—è —Å–≤—ñ—Ç–ª–∞',
                    'earth-dark': '–ú–∞—Ç–∏-–ó–µ–º–ª—è —Ç–µ–º–Ω–∞',
                    'forest-light': '–õ—ñ—Å–æ–≤–∞ –∫–∞–≤–∞ —Å–≤—ñ—Ç–ª–∞',
                    'forest-dark': '–õ—ñ—Å–æ–≤–∞ –∫–∞–≤–∞ —Ç–µ–º–Ω–∞',
                    'green-brown-light': '–ó–µ–ª–µ–Ω–æ-–∫–æ—Ä–∏—á–Ω–µ–≤–∞ —Å–≤—ñ—Ç–ª–∞',
                    'green-brown-vibrant': '–°–æ–∫–æ–≤–∏—Ç–∞ –∑–µ–ª–µ–Ω–æ-–∫–æ—Ä–∏—á–Ω–µ–≤–∞',
                    'nature-contrast': '–ü—Ä–∏—Ä–æ–¥–Ω–∏–π –∫–æ–Ω—Ç—Ä–∞—Å—Ç',
                    'nature-soft-contrast': "–ú'—è–∫–∏–π –ø—Ä–∏—Ä–æ–¥–Ω–∏–π –∫–æ–Ω—Ç—Ä–∞—Å—Ç",
                    'forest-palette': '–õ—ñ—Å–æ–≤–∞ –ø–∞–ª—ñ—Ç—Ä–∞',
                    'fresh-rose': '–°–≤—ñ–∂–∞ —Ç—Ä–æ—è–Ω–¥–∞',
                    'golden-baroque': '–ó–æ–ª–æ—Ç–µ –±–∞—Ä–æ–∫–∫–æ'
                };
                alert(`‚úÖ –¢–µ–º–∞ "${themeNames[themeName]}" –∑–∞—Å—Ç–æ—Å–æ–≤–∞–Ω–∞ –¥–ª—è –≤—Å—ñ—Ö –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ–≤!`);
            } catch (error) {
                console.error('‚ùå –ü–æ–º–∏–ª–∫–∞ –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è —Ç–µ–º–∏:', error);
                alert('‚ö†Ô∏è –¢–µ–º–∞ –∑–∞—Å—Ç–æ—Å–æ–≤–∞–Ω–∞ –ª–æ–∫–∞–ª—å–Ω–æ. –ü–µ—Ä–µ–∫–æ–Ω–∞–π—Ç–µ—Å—å —â–æ Firebase Rules –¥–æ–∑–≤–æ–ª—è—é—Ç—å –∑–∞–ø–∏—Å —É /settings/theme');
            }
        };

        // Load theme on startup
        async function loadGlobalTheme() {
            try {
                const themeRef = ref(database, 'settings/theme');
                const snapshot = await get(themeRef);
                if (snapshot.exists()) {
                    const themeName = snapshot.val();
                    if (themeName && themeName !== 'default') {
                        document.documentElement.setAttribute('data-theme', themeName);
                    }
                    console.log(`‚úì –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–æ –≥–ª–æ–±–∞–ª—å–Ω—É —Ç–µ–º—É: ${themeName}`);
                }
            } catch (error) {
                console.error('–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —Ç–µ–º–∏:', error);
            }
        }

        // Call on page load
        loadGlobalTheme();

        // ===== EXPORT POST AS IMAGE =====
        window.downloadPostAsImage = async function(postId) {
    const post = window.allPosts.find(p => p.id === postId);
    if (!post) return;

    const button = event.target;
    button.disabled = true;
    button.textContent = '‚è≥ –°—Ç–≤–æ—Ä—é—é –∑–æ–±—Ä–∞–∂–µ–Ω–Ω—è...';

    try {
        const blob = await exportPostAsImage(post);
        const filename = `${post.title.substring(0, 30).replace(/[^a-z–∞-—è—ó—ñ—î“ë0-9]/gi, '_')}.png`;
        downloadImage(blob, filename);
        button.textContent = '‚úÖ –ó–±–µ—Ä–µ–∂–µ–Ω–æ!';
        setTimeout(() => {
            button.textContent = 'üì• –ó–±–µ—Ä–µ–≥—Ç–∏ —è–∫ —Ñ–æ—Ç–æ';
            button.disabled = false;
        }, 2000);
    } catch (error) {
        console.error('Error creating image:', error);
        button.textContent = '‚ùå –ü–æ–º–∏–ª–∫–∞';
        setTimeout(() => {
            button.textContent = 'üì• –ó–±–µ—Ä–µ–≥—Ç–∏ —è–∫ —Ñ–æ—Ç–æ';
            button.disabled = false;
        }, 2000);
    }
};

async function exportPostAsImage(post) {
    const canvas = document.createElement('canvas');
    const ctx = canvas.getContext('2d');
    
    const width = 1080;
    const height = 1080;
    canvas.width = width;
    canvas.height = height;
    
    // –û—Ç—Ä–∏–º—É—î–º–æ –ø–æ—Ç–æ—á–Ω–∏–π —Ä–æ–∑–º—ñ—Ä —à—Ä–∏—Ñ—Ç—É –∑ –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω—å
    let savedFontSize = localStorage.getItem('fontSize');
    let fontSizeMultiplier = 1.0; // –ë–∞–∑–æ–≤–∏–π –º–Ω–æ–∂–Ω–∏–∫
    
    if (savedFontSize) {
        const sizeNum = parseInt(savedFontSize);
        // –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ —á–∏ —Ü–µ —Å—Ç–∞—Ä–∏–π —Ñ–æ—Ä–º–∞—Ç (85-200)
        if (sizeNum > 100) {
            // –°—Ç–∞—Ä–∏–π —Ñ–æ—Ä–º–∞—Ç, –∫–æ–Ω–≤–µ—Ä—Ç—É—î–º–æ –≤ –Ω–æ–≤–∏–π
            const newValue = Math.round(((sizeNum - 85) / (200 - 85)) * 100);
            fontSizeMultiplier = 0.5 + (newValue / 100) * 2.0;
        } else {
            // –ù–æ–≤–∏–π —Ñ–æ—Ä–º–∞—Ç (0-100)
            fontSizeMultiplier = 0.5 + (sizeNum / 100) * 2.0;
        }
    }
    
    // –û—Ç—Ä–∏–º—É—î–º–æ –∫–æ–ª—å–æ—Ä–∏ –∑ –ø–æ—Ç–æ—á–Ω–æ—ó —Ç–µ–º–∏
    const rootStyles = getComputedStyle(document.documentElement);
    
    // –§—É–Ω–∫—Ü—ñ—è –¥–ª—è –æ—Ç—Ä–∏–º–∞–Ω–Ω—è –∫–æ–ª—å–æ—Ä—É –∑ fallback
    const getColor = (varName, fallback) => {
        const value = rootStyles.getPropertyValue(varName).trim();
        return value || fallback;
    };
    
    const colors = {
        bgMain: getColor('--bg-main', '#faf8f3'),
        bgCard: getColor('--bg-card', '#ffffff'),
        primary: getColor('--primary', '#2c3e50'),
        accent: getColor('--accent', '#8b6f47'),
        accentLight: getColor('--accent-light', '#b8956a'),
        textMain: getColor('--text-main', '#1a1a1a'),
        textLight: getColor('--text-light', '#666666')
    };
    
    // –õ–æ–≥—É—î–º–æ –¥–ª—è –¥—ñ–∞–≥–Ω–æ—Å—Ç–∏–∫–∏
    console.log('üé® –ï–∫—Å–ø–æ—Ä—Ç –∑ –∫–æ–ª—å–æ—Ä–∞–º–∏ —Ç–µ–º–∏:', colors);
    
    // –§–æ–Ω
    ctx.fillStyle = colors.bgMain;
    ctx.fillRect(0, 0, width, height);
    
    // –ì—Ä–∞–¥—ñ—î–Ω—Ç –∑ –∞–∫—Ü–µ–Ω—Ç–Ω–∏–º –∫–æ–ª—å–æ—Ä–æ–º —Ç–µ–º–∏
    const gradient = ctx.createRadialGradient(width * 0.2, height * 0.8, 0, width * 0.2, height * 0.8, width * 0.5);
    // –í–∏—Ç—è–≥—É—î–º–æ RGB –∑–Ω–∞—á–µ–Ω–Ω—è –∑ hex –∞–±–æ rgb —Ñ–æ—Ä–º–∞—Ç—É
    const accentRGB = hexToRgb(colors.accentLight) || {r: 139, g: 111, b: 71};
    gradient.addColorStop(0, `rgba(${accentRGB.r}, ${accentRGB.g}, ${accentRGB.b}, 0.03)`);
    gradient.addColorStop(1, 'transparent');
    ctx.fillStyle = gradient;
    ctx.fillRect(0, 0, width, height);
    
    // –ö–∞—Ä—Ç–∫–∞
    const padding = 60;
    const cardX = padding;
    const cardY = padding;
    const cardWidth = width - padding * 2;
    const cardHeight = height - padding * 2;
    
    ctx.shadowColor = 'rgba(0, 0, 0, 0.08)';
    ctx.shadowBlur = 20;
    ctx.shadowOffsetY = 4;
    
    ctx.fillStyle = colors.bgCard;
    roundRect(ctx, cardX, cardY, cardWidth, cardHeight, 12);
    ctx.fill();
    
    ctx.shadowColor = 'transparent';
    ctx.shadowBlur = 0;
    ctx.shadowOffsetY = 0;
    
    // –ê–∫—Ü–µ–Ω—Ç–Ω–∞ –ª—ñ–Ω—ñ—è –∑–ª—ñ–≤–∞
    ctx.fillStyle = colors.accent;
    ctx.fillRect(cardX, cardY, 4, cardHeight);
    
    let currentY = cardY + 60;
    
    // –†–Ü–ó–ù–Ü –®–ê–ë–õ–û–ù–ò –î–õ–Ø –ü–û–ï–ó–Ü–á –¢–ê –î–£–ú–û–ö
    if (post.type === 'poetry') {
        // ============ –®–ê–ë–õ–û–ù –î–õ–Ø –ü–û–ï–ó–Ü–á (–∫–æ–º–ø–∞–∫—Ç–Ω–∏–π, –≤—ñ–¥—Ü–µ–Ω—Ç—Ä–æ–≤–∞–Ω–∏–π) ============
        
        // –°–ø–æ—á–∞—Ç–∫—É —Ä–∞—Ö—É—î–º–æ –≤–∏—Å–æ—Ç—É –∫–æ–Ω—Ç–µ–Ω—Ç—É –¥–ª—è —Ü–µ–Ω—Ç—Ä—É–≤–∞–Ω–Ω—è
        ctx.font = `bold ${Math.round(38 * fontSizeMultiplier)}px "Philosopher", Arial, sans-serif`;
        const titleHeight = measureTextHeight(ctx, post.title, cardWidth - 80, Math.round(48 * fontSizeMultiplier));
        
        ctx.font = `italic ${Math.round(26 * fontSizeMultiplier)}px Georgia, serif`;
        const contentHeight = measureTextHeight(ctx, post.content, cardWidth - 160, Math.round(26 * fontSizeMultiplier) * 1.75);
        
        const spaceBetween = 40; // –í—ñ–¥—Å—Ç–∞–Ω—å –º—ñ–∂ –∑–∞–≥–æ–ª–æ–≤–∫–æ–º —ñ –≤—ñ—Ä—à–µ–º
        
        // –ù–µ –≤—Ä–∞—Ö–æ–≤—É—î–º–æ —Ñ—É—Ç–µ—Ä –≤ —Ü–µ–Ω—Ç—Ä—É–≤–∞–Ω–Ω—ñ - –≤—ñ–Ω –±—É–¥–µ –æ–∫—Ä–µ–º–æ –≤–Ω–∏–∑—É
        const totalContentHeight = titleHeight + spaceBetween + contentHeight;
        
        // –¶–µ–Ω—Ç—Ä—É—î–º–æ –≤–µ—Ä—Ç–∏–∫–∞–ª—å–Ω–æ (–∑ —É—Ä–∞—Ö—É–≤–∞–Ω–Ω—è–º –ø—Ä–æ—Å—Ç–æ—Ä—É –¥–ª—è —Ñ—É—Ç–µ—Ä–∞ –≤–Ω–∏–∑—É)
        const footerSpace = 40; // –†–µ–∑–µ—Ä–≤—É—î–º–æ –º—ñ—Å—Ü–µ –¥–ª—è —Ñ—É—Ç–µ—Ä–∞
        currentY = cardY + (cardHeight - totalContentHeight - footerSpace) / 2;
        
        // –ó–∞–≥–æ–ª–æ–≤–æ–∫ (–≤—ñ–¥—Ü–µ–Ω—Ç—Ä–æ–≤–∞–Ω–∏–π)
        ctx.fillStyle = colors.primary;
        const titleFontSize = Math.round(38 * fontSizeMultiplier);
        ctx.font = `bold ${titleFontSize}px "Philosopher", Arial, sans-serif`;
        ctx.textAlign = 'center';
        ctx.textBaseline = 'top';
        currentY = drawWrappedText(ctx, post.title, width / 2, currentY, cardWidth - 80, Math.round(48 * fontSizeMultiplier));
        
        currentY += spaceBetween; // –ù–µ–≤–µ–ª–∏–∫–∞ –≤—ñ–¥—Å—Ç–∞–Ω—å –º—ñ–∂ –∑–∞–≥–æ–ª–æ–≤–∫–æ–º —ñ –≤—ñ—Ä—à–µ–º
        
        // –¢–µ–∫—Å—Ç –≤—ñ—Ä—à–∞ (–ø–æ —Ü–µ–Ω—Ç—Ä—É, –∫—É—Ä—Å–∏–≤–æ–º)
        ctx.fillStyle = colors.textMain;
        const fontSize = Math.round(26 * fontSizeMultiplier);
        const lineHeight = fontSize * 1.75;
        
        ctx.font = `italic ${fontSize}px Georgia, serif`;
        ctx.textAlign = 'center';
        ctx.textBaseline = 'top';
        currentY = drawWrappedText(ctx, post.content, width / 2, currentY, cardWidth - 160, lineHeight);
        
        // –§—É—Ç–µ—Ä "–ü–æ–µ–∑—ñ—è KonVi" - –≤–Ω–∏–∑—É –∑ –≤—ñ–¥—Å—Ç—É–ø–æ–º 8px
        const footerY = cardY + cardHeight - 8; // 8px –≤—ñ–¥ –Ω–∏–∂–Ω—å–æ–≥–æ –∫—Ä–∞—é
        ctx.fillStyle = colors.textLight;
        ctx.font = 'italic 22px Georgia, serif';
        ctx.textAlign = 'center';
        ctx.textBaseline = 'bottom'; // –ù–∏–∑ —Ç–µ–∫—Å—Ç—É –Ω–∞ —Ü—ñ–π –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ñ
        ctx.fillText('–ü–æ–µ–∑—ñ—è KonVi', width / 2, footerY);
        
    } else {
        // ============ –®–ê–ë–õ–û–ù –î–õ–Ø –î–£–ú–û–ö (–∫–æ–º–ø–∞–∫—Ç–Ω–∏–π) ============
        
        // –ó–∞–≥–æ–ª–æ–≤–æ–∫
        ctx.fillStyle = colors.primary;
        const titleFontSize = Math.round(52 * fontSizeMultiplier);
        ctx.font = `bold ${titleFontSize}px "Philosopher", Arial, sans-serif`;
        ctx.textAlign = 'left';
        ctx.textBaseline = 'top';
        currentY = drawWrappedText(ctx, post.title, cardX + 40, currentY, cardWidth - 80, Math.round(65 * fontSizeMultiplier));
        
        currentY += 50; // –í—ñ–¥—Å—Ç—É–ø –ø—ñ—Å–ª—è –∑–∞–≥–æ–ª–æ–≤–∫–∞
        
        // –¢–µ–∫—Å—Ç –¥—É–º–∫–∏ (–≤–ª—ñ–≤–æ)
        ctx.fillStyle = colors.textMain;
        const fontSize = Math.round(26 * fontSizeMultiplier);
        const lineHeight = fontSize * 1.75;
        
        ctx.font = `${fontSize}px Georgia, serif`;
        ctx.textAlign = 'left';
        ctx.textBaseline = 'top';
        currentY = drawWrappedText(ctx, post.content, cardX + 40, currentY, cardWidth - 80, lineHeight);
        
        currentY += 50;
        
        // –§—É—Ç–µ—Ä "–ü–æ–µ–∑—ñ—è KonVi" - –≤–Ω–∏–∑—É –∑ –≤—ñ–¥—Å—Ç—É–ø–æ–º 8px
        const footerY = cardY + cardHeight - 8; // 8px –≤—ñ–¥ –Ω–∏–∂–Ω—å–æ–≥–æ –∫—Ä–∞—é
        ctx.fillStyle = colors.textLight;
        ctx.font = 'italic 22px Georgia, serif';
        ctx.textAlign = 'center';
        ctx.textBaseline = 'bottom'; // –ù–∏–∑ —Ç–µ–∫—Å—Ç—É –Ω–∞ —Ü—ñ–π –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ñ
        ctx.fillText('–ü–æ–µ–∑—ñ—è KonVi', width / 2, footerY);
    }
    
    return new Promise((resolve) => {
        canvas.toBlob((blob) => resolve(blob), 'image/png', 1.0);
    });
}

function roundRect(ctx, x, y, width, height, radius) {
    ctx.beginPath();
    ctx.moveTo(x + radius, y);
    ctx.lineTo(x + width - radius, y);
    ctx.quadraticCurveTo(x + width, y, x + width, y + radius);
    ctx.lineTo(x + width, y + height - radius);
    ctx.quadraticCurveTo(x + width, y + height, x + width - radius, y + height);
    ctx.lineTo(x + radius, y + height);
    ctx.quadraticCurveTo(x, y + height, x, y + height - radius);
    ctx.lineTo(x, y + radius);
    ctx.quadraticCurveTo(x, y, x + radius, y);
    ctx.closePath();
}

function measureTextHeight(ctx, text, maxWidth, lineHeight) {
    const normalizedText = text.replace(/\r\n/g, '\n').replace(/\r/g, '\n');
    const lines = normalizedText.split('\n');
    let totalHeight = 0;
    let linesCount = 0;
    const maxLines = 15;
    
    for (const line of lines) {
        if (linesCount >= maxLines) break;
        
        if (line.trim() === '') {
            totalHeight += lineHeight * 0.6;
            linesCount++;
            continue;
        }
        
        const words = line.split(/\s+/);
        let currentLine = '';
        
        for (let i = 0; i < words.length; i++) {
            const testLine = currentLine + words[i] + ' ';
            const metrics = ctx.measureText(testLine);
            
            if (metrics.width > maxWidth && i > 0) {
                totalHeight += lineHeight;
                currentLine = words[i] + ' ';
                linesCount++;
                
                if (linesCount >= maxLines) break;
            } else {
                currentLine = testLine;
            }
        }
        
        if (currentLine.trim()) {
            totalHeight += lineHeight;
            linesCount++;
        }
    }
    
    return totalHeight;
}

function drawWrappedText(ctx, text, x, y, maxWidth, lineHeight) {
    // –ù–æ—Ä–º–∞–ª—ñ–∑—É—î–º–æ –ø–µ—Ä–µ–Ω–æ—Å–∏ —Ä—è–¥–∫—ñ–≤ (—Ä—ñ–∑–Ω—ñ —Ñ–æ—Ä–º–∞—Ç–∏)
    const normalizedText = text.replace(/\r\n/g, '\n').replace(/\r/g, '\n');
    const lines = normalizedText.split('\n');
    let currentY = y;
    let linesDrawn = 0;
    const maxLines = 15;
    
    for (const line of lines) {
        if (linesDrawn >= maxLines) {
            ctx.fillText('...', x, currentY);
            return currentY + lineHeight;
        }
        
        // –ü–æ—Ä–æ–∂–Ω—ñ–π —Ä—è–¥–æ–∫ - –∑–±–µ—Ä—ñ–≥–∞—î–º–æ (–¥–ª—è —Å—Ç—Ä–æ—Ñ)
        if (line.trim() === '') {
            currentY += lineHeight * 0.6; // –ú–µ–Ω—à–∏–π –≤—ñ–¥—Å—Ç—É–ø –¥–ª—è –ø–æ—Ä–æ–∂–Ω—ñ—Ö —Ä—è–¥–∫—ñ–≤
            linesDrawn++;
            continue;
        }
        
        // –†–æ–∑–±–∏–≤–∞—î–º–æ –¥–æ–≤–≥—ñ —Ä—è–¥–∫–∏ –ø–æ —Å–ª–æ–≤–∞—Ö
        const words = line.split(/\s+/);
        let currentLine = '';
        
        for (let i = 0; i < words.length; i++) {
            const testLine = currentLine + words[i] + ' ';
            const metrics = ctx.measureText(testLine);
            
            if (metrics.width > maxWidth && i > 0) {
                ctx.fillText(currentLine.trim(), x, currentY);
                currentLine = words[i] + ' ';
                currentY += lineHeight;
                linesDrawn++;
                
                if (linesDrawn >= maxLines) {
                    ctx.fillText('...', x, currentY);
                    return currentY + lineHeight;
                }
            } else {
                currentLine = testLine;
            }
        }
        
        // –ú–∞–ª—é—î–º–æ –∑–∞–ª–∏—à–æ–∫ —Ä—è–¥–∫–∞
        if (currentLine.trim()) {
            ctx.fillText(currentLine.trim(), x, currentY);
            currentY += lineHeight;
            linesDrawn++;
        }
    }
    
    return currentY;
}

function formatDateForImage(dateString) {
    const date = new Date(dateString);
    const months = ['—Å—ñ—á–Ω—è', '–ª—é—Ç–æ–≥–æ', '–±–µ—Ä–µ–∑–Ω—è', '–∫–≤—ñ—Ç–Ω—è', '—Ç—Ä–∞–≤–Ω—è', '—á–µ—Ä–≤–Ω—è',
        '–ª–∏–ø–Ω—è', '—Å–µ—Ä–ø–Ω—è', '–≤–µ—Ä–µ—Å–Ω—è', '–∂–æ–≤—Ç–Ω—è', '–ª–∏—Å—Ç–æ–ø–∞–¥–∞', '–≥—Ä—É–¥–Ω—è'];
    return `${date.getDate()} ${months[date.getMonth()]} ${date.getFullYear()}`;
}

function hexToRgb(hex) {
    if (!hex) return {r: 139, g: 111, b: 71}; // Fallback
    
    // –û—á–∏—â–∞—î–º–æ –ø—Ä–æ–±—ñ–ª–∏
    hex = hex.trim();
    
    // –Ø–∫—â–æ —Ü–µ –≤–∂–µ rgb/rgba —Ñ–æ—Ä–º–∞—Ç
    if (hex.startsWith('rgb')) {
        const match = hex.match(/\d+/g);
        if (match && match.length >= 3) {
            return {
                r: parseInt(match[0]),
                g: parseInt(match[1]),
                b: parseInt(match[2])
            };
        }
    }
    
    // –Ø–∫—â–æ hex —Ñ–æ—Ä–º–∞—Ç
    hex = hex.replace('#', '');
    
    // –Ø–∫—â–æ –∫–æ—Ä–æ—Ç–∫–∏–π —Ñ–æ—Ä–º–∞—Ç (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥ #fff)
    if (hex.length === 3) {
        hex = hex[0] + hex[0] + hex[1] + hex[1] + hex[2] + hex[2];
    }
    
    // –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ –≤–∞–ª—ñ–¥–Ω—ñ—Å—Ç—å hex
    if (!/^[0-9A-Fa-f]{6}$/.test(hex)) {
        console.warn('Invalid color format:', hex);
        return {r: 139, g: 111, b: 71}; // Fallback
    }
    
    const bigint = parseInt(hex, 16);
    return {
        r: (bigint >> 16) & 255,
        g: (bigint >> 8) & 255,
        b: bigint & 255
    };
}

function downloadImage(blob, filename) {
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
}
			
</script>

    <!-- Footer -->
    <footer style="
        margin-top: auto;
        padding: 1.5rem 2rem;
        background: var(--bg-card);
        border-top: 2px solid var(--border);
        text-align: center;
        font-family: 'Philosopher', sans-serif;
        color: var(--text-lighter);
        font-size: 0.95rem;
        letter-spacing: 0.03em;
    ">
        –†–æ–∑—Ä–æ–±–Ω–∏–∫ by <span style="color: var(--accent); font-weight: 700;">Krasovsky</span>
    </footer>
</body>
</html>
