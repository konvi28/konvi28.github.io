<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" type="image/webp" href="logo.webp">
    <link rel="shortcut icon" type="image/webp" href="logo.webp">
    <link rel="apple-touch-icon" href="logo.webp">
    <title>...Спільнота поетів</title>

    <!-- GitHub Pages SPA: відновлюємо URL після редиректу через 404.html -->
    <script>
        (function() {
            var redirect = sessionStorage.getItem('spa_redirect');
            if (redirect) {
                sessionStorage.removeItem('spa_redirect');
                // Відновлюємо шлях без замінення в history
                window.history.replaceState(null, '', redirect);
            }
        })();
    </script>

    <!-- SEO -->
    <meta name="description" content="Поетична платформа KonVi — спільнота українських поетів. Читайте вірші та думки авторів.">
    <meta name="robots" content="index, follow">
    <link rel="canonical" id="canonicalTag" href="https://poetssociety.pages.dev/">

    <!-- Open Graph -->
    <meta property="og:type" content="website">
    <meta property="og:site_name" content="Поетична платформа KonVi">
    <meta property="og:title" id="ogTitle" content="Поетична платформа KonVi">
    <meta property="og:description" id="ogDescription" content="Спільнота українських поетів. Читайте вірші та думки авторів.">
    <meta property="og:url" id="ogUrl" content="https://poetssociety.pages.dev/">
    <meta property="og:image" id="ogImage" content="https://poetssociety.pages.dev/logo.webp">

    <!-- Twitter Card -->
    <meta name="twitter:card" content="summary">
    <meta name="twitter:title" id="twitterTitle" content="Поетична платформа KonVi">
    <meta name="twitter:description" id="twitterDescription" content="Спільнота українських поетів.">
    <meta name="twitter:image" id="twitterImage" content="https://poetssociety.pages.dev/logo.webp">
    <link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:ital,wght@0,300;0,400;0,500;0,600;1,300;1,400&family=Philosopher:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #2c3e50;
            --secondary: #34495e;
            --accent: #8b6f47;
            --accent-light: #b8956a;
            --accent-dark: #6d5638;
            --bg-main: #faf8f3;
            --bg-card: #ffffff;
            --bg-secondary: #f0ebe3;
            --text-main: #111111;
            --text-light: #444444;
            --text-lighter: #777777;
            --border: #e8e4dc;
            --border-light: #f5f0e8;
            --shadow: rgba(0, 0, 0, 0.08);
        }

        /* Травянисто-зелена тема */
        [data-theme="green"] {
            --primary: #2d5016;
            --secondary: #3d6b1f;
            --accent: #6b8e23;
            --accent-light: #9acd32;
            --accent-dark: #4a5f1a;
            --bg-main: #f5f9f0;
            --bg-card: #ffffff;
            --bg-secondary: #e8f3e0;
            --text-main: #111111;
            --text-light: #3a4f2e;
            --text-lighter: #5a6b4a;
            --border: #d4e7c5;
            --border-light: #e8f3e0;
            --shadow: rgba(107, 142, 35, 0.1);
        }

        /* Морська синя тема */
        [data-theme="ocean"] {
            --primary: #1b4965;
            --secondary: #2c6b8f;
            --accent: #5fa8d3;
            --accent-light: #90c2e7;
            --accent-dark: #3d7a9f;
            --bg-main: #f0f7fb;
            --bg-card: #ffffff;
            --bg-secondary: #e3f1f7;
            --text-main: #111111;
            --text-light: #2d5a72;
            --text-lighter: #567a92;
            --border: #d4e8f5;
            --border-light: #e8f4fa;
            --shadow: rgba(95, 168, 211, 0.1);
        }

        /* Фіолетово-лавандова тема */
        [data-theme="lavender"] {
            --primary: #4a2c62;
            --secondary: #5e3a7d;
            --accent: #8b5fb0;
            --accent-light: #b794cc;
            --accent-dark: #6d4a89;
            --bg-main: #f8f5fb;
            --bg-card: #ffffff;
            --bg-secondary: #f0e9f7;
            --text-main: #111111;
            --text-light: #4a3358;
            --text-lighter: #6d5578;
            --border: #e6dced;
            --border-light: #f2ebf5;
            --shadow: rgba(139, 95, 176, 0.1);
        }

        /* Теракотово-рожева тема */
        [data-theme="terracotta"] {
            --primary: #8b4513;
            --secondary: #a0522d;
            --accent: #d2691e;
            --accent-light: #e9967a;
            --accent-dark: #b35a15;
            --bg-main: #fdf7f4;
            --bg-card: #ffffff;
            --bg-secondary: #f8ede7;
            --text-main: #111111;
            --text-light: #5c3520;
            --text-lighter: #8b6854;
            --border: #f0dfce;
            --border-light: #f8ede7;
            --shadow: rgba(210, 105, 30, 0.1);
        }

        /* Темна тема */
        [data-theme="dark"] {
            --primary: #e8e6e3;
            --secondary: #d0cec9;
            --accent: #c9a961;
            --accent-light: #e0c78a;
            --accent-dark: #b08f4a;
            --bg-main: #1a1a1a;
            --bg-card: #2d2d2d;
            --bg-secondary: #242424;
            --text-main: #f0eee9;
            --text-light: #c8c8c8;
            --text-lighter: #aaaaaa;
            --border: #404040;
            --border-light: #353535;
            --shadow: rgba(0, 0, 0, 0.3);
        }

        /* Кавова темно-зелена тема з золотими акцентами */
        [data-theme="coffee"] {
            --primary: #1a3a3a;
            --secondary: #234545;
            --accent: #c9a961;
            --accent-light: #e0c78a;
            --accent-dark: #a08840;
            --bg-main: #234545;
            --bg-card: #2d5555;
            --bg-secondary: #1f4040;
            --text-main: #faf5ec;
            --text-light: #e0c070;
            --text-lighter: #c9a961;
            --border: #3d6565;
            --border-light: #2d5555;
            --shadow: rgba(0, 0, 0, 0.4);
        }

        /* Природна земна тема (Mother Earthed - світла) */
        [data-theme="earth-light"] {
            --primary: #4a5f3d;
            --secondary: #6b7c5e;
            --accent: #8b7355;
            --accent-light: #a89078;
            --accent-dark: #6d5638;
            --bg-main: #f5f3ed;
            --bg-card: #ffffff;
            --bg-secondary: #ebe8df;
            --text-main: #1a2414;
            --text-light: #3f5234;
            --text-lighter: #6b7c5e;
            --border: #d4cfbb;
            --border-light: #e8e4d5;
            --shadow: rgba(107, 124, 94, 0.1);
        }

        /* Природна земна тема (Mother Earthed - темна) */
        [data-theme="earth-dark"] {
            --primary: #e8e4d5;
            --secondary: #d4cfbb;
            --accent: #a89078;
            --accent-light: #c9b89a;
            --accent-dark: #8b7355;
            --bg-main: #2d3a26;
            --bg-card: #3d4a36;
            --bg-secondary: #374435;
            --text-main: #faf8f0;
            --text-light: #c9b89a;
            --text-lighter: #a89078;
            --border: #4a5f3d;
            --border-light: #3d4a36;
            --shadow: rgba(0, 0, 0, 0.3);
        }

        /* Лісова кава тема (Ravo Kafe - світла) */
        [data-theme="forest-light"] {
            --primary: #2d5045;
            --secondary: #3d6555;
            --accent: #8b7355;
            --accent-light: #a89078;
            --accent-dark: #6d5638;
            --bg-main: #f0ede3;
            --bg-card: #ffffff;
            --bg-secondary: #e5e0d0;
            --text-main: #0f1e17;
            --text-light: #254535;
            --text-lighter: #3d6555;
            --border: #d4cfbb;
            --border-light: #e5e0d0;
            --shadow: rgba(45, 80, 69, 0.1);
        }

        /* Лісова кава тема (Ravo Kafe - темна) */
        [data-theme="forest-dark"] {
            --primary: #e5e0d0;
            --secondary: #d4cfbb;
            --accent: #a89078;
            --accent-light: #c9b89a;
            --accent-dark: #8b7355;
            --bg-main: #1f3a32;
            --bg-card: #2d5045;
            --bg-secondary: #27453d;
            --text-main: #f5f2e8;
            --text-light: #d4c9a8;
            --text-lighter: #c9b89a;
            --border: #3d6555;
            --border-light: #2d5045;
            --shadow: rgba(0, 0, 0, 0.4);
        }

        /* Світла тема з зелено-коричневими елементами */
        [data-theme="green-brown-light"] {
            --primary: #2a4a2d;
            --secondary: #3a5a3d;
            --accent: #6d5a3a;
            --accent-light: #8d7a5a;
            --accent-dark: #4d3a1a;
            --bg-main: #fafaf8;
            --bg-card: #ffffff;
            --bg-secondary: #f5f5f0;
            --text-main: #0e1f11;
            --text-light: #2a3a2d;
            --text-lighter: #4a5a4d;
            --border: #c5d0c5;
            --border-light: #e0e8e0;
            --shadow: rgba(42, 74, 45, 0.12);
        }

        /* Соковита зелено-коричнева тема */
        [data-theme="green-brown-vibrant"] {
            --primary: #1d5c2e;
            --secondary: #2d7c3e;
            --accent: #b8862e;
            --accent-light: #d4a54e;
            --accent-dark: #8a5e1a;
            --bg-main: #fdfdfb;
            --bg-card: #ffffff;
            --bg-secondary: #f9f8f4;
            --text-main: #071f0e;
            --text-light: #1d5c2e;
            --text-lighter: #2d7c3e;
            --border: #b8d4b8;
            --border-light: #dceadc;
            --shadow: rgba(29, 92, 46, 0.15);
        }

        /* Контрастна природна тема (зебра/шахи) */
        [data-theme="nature-contrast"] {
            --primary: #2a3f2a;
            --secondary: #3d5a3d;
            --accent: #6d4e2a;
            --accent-light: #8d6e4a;
            --accent-dark: #4d2e0a;
            --bg-main: #f9f5e8;
            --bg-card: #fdfdfb;
            --bg-secondary: #2a3f2a;
            --text-main: #0e0e0c;
            --text-light: #2a2a26;
            --text-lighter: #4a4a45;
            --border: #3d5a3d;
            --border-light: #d4d0bb;
            --shadow: rgba(42, 63, 42, 0.2);
        }

        /* М'який природний контраст (зебра з делікатною обводкою) */
        [data-theme="nature-soft-contrast"] {
            --primary: #2d4a2d;
            --secondary: #3d5a3d;
            --accent: #7a5a2d;
            --accent-light: #9a7a4d;
            --accent-dark: #5a3a1d;
            --bg-main: #faf7ed;
            --bg-card: #fefefc;
            --bg-secondary: #2d4a2d;
            --text-main: #0e0e0b;
            --text-light: #2d2d28;
            --text-lighter: #4d4d48;
            --border: #e8e5d8;
            --border-light: #f2f0e8;
            --shadow: rgba(45, 74, 45, 0.15);
        }

        /* Лісова палітра (60% світла, контрастні темні елементи) */
        [data-theme="forest-palette"] {
            --primary: #051f20;
            --secondary: #0b2b26;
            --accent: #397654;
            --accent-light: #397654;
            --accent-dark: #235a3d;
            --bg-main: #daf1de;
            --bg-card: #ffffff;
            --bg-secondary: #c9e8d0;
            --text-main: #030f10;
            --text-light: #0b2b26;
            --text-lighter: #163832;
            --border: #6b9d7d;
            --border-light: #c9e8d0;
            --shadow: rgba(5, 31, 32, 0.15);
        }

        /* Свіжа троянда (60% світла, соковиті червоні відтінки) */
        [data-theme="fresh-rose"] {
            --primary: #2d0a0a;
            --secondary: #3d1515;
            --accent: #c73e3e;
            --accent-light: #c73e3e;
            --accent-dark: #8a2828;
            --bg-main: #fde8e8;
            --bg-card: #ffffff;
            --bg-secondary: #f8d5d5;
            --text-main: #1a0505;
            --text-light: #3d1010;
            --text-lighter: #5d2020;
            --border: #e8a8a8;
            --border-light: #f8d5d5;
            --shadow: rgba(45, 10, 10, 0.15);
        }

        /* Золоте барокко (розкішна літературна тема) */
        [data-theme="golden-baroque"] {
            --primary: #1a1410;
            --secondary: #2d241d;
            --accent: #d4a645;
            --accent-light: #e8c875;
            --accent-dark: #b8882a;
            --bg-main: #fdfaf5;
            --bg-card: #fffef9;
            --bg-secondary: #f5eee0;
            --text-main: #0d0b08;
            --text-light: #3a2d20;
            --text-lighter: #5d4a3a;
            --border: #e8d8b8;
            --border-light: #f5eee0;
            --shadow: rgba(212, 166, 69, 0.2);
        }

        * {



        /* Admin Tabs */
        .admin-tab-btn {
            padding: 0.65rem 1rem;
            background: transparent;
            border: none;
            border-bottom: 3px solid transparent;
            font-family: 'Philosopher', sans-serif;
            font-size: 1rem;
            font-weight: 600;
            color: var(--text-light);
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .admin-tab-btn:hover {
            color: var(--accent);
        }

        .admin-tab-btn.active {
            color: var(--accent);
            border-bottom-color: var(--accent);
        }

        /* Theme Cards */
        .theme-card {
            border: 2px solid var(--border);
            border-radius: 8px;
            padding: 1rem;
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
            background: var(--bg-card);
        }

        .theme-card:hover {
            border-color: var(--accent);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px var(--shadow);
        }

        .theme-card.active {
            border-color: var(--accent);
            background: var(--accent-light);
            background: linear-gradient(135deg, var(--bg-card) 0%, var(--bg-secondary) 100%);
        }

        .theme-preview {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1rem;
            height: 60px;
        }

        .theme-color {
            flex: 1;
            border-radius: 6px;
            border: 1px solid rgba(0, 0, 0, 0.1);
        }

        .theme-name {
            font-weight: 600;
            color: var(--text-main);
            text-align: center;
            font-size: 0.95rem;
            font-family: 'Philosopher', sans-serif;
        }

        .theme-check {
            position: absolute;
            top: -8px;
            right: -8px;
            width: 28px;
            height: 28px;
            background: var(--accent);
            color: white;
            border-radius: 50%;
            display: none;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            box-shadow: 0 2px 8px var(--shadow);
        }

        .theme-card.active .theme-check {
            display: flex;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Cormorant Garamond', serif;
            background: var(--bg-main);
            color: var(--text-main);
            line-height: 1.9;
            font-size: 1.125rem;
            display: flex;
            flex-direction: column;
            min-height: 100dvh;
            overflow-x: hidden;
        }

        /* Header */
        .platform-header {
            background: var(--bg-card);
            border-bottom: 2px solid var(--border);
            padding: 1rem 2rem;
            box-shadow: 0 2px 8px var(--shadow);
            position: sticky;
            top: 0;
            z-index: 200;
        }

        .header-content {
            max-width: 1400px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        /* Filter panel — collapsed by default */
        .header-filter-bar {
            background: var(--bg-card);
            border-top: 1px solid var(--border);
            max-height: 0;
            overflow: hidden;
            opacity: 0;
            transition: max-height 0.35s ease, opacity 0.35s ease, padding 0.35s ease;
            padding: 0;
        }

        .platform-header.filter-open .header-filter-bar {
            max-height: 500px;
            opacity: 1;
            padding: 0.75rem 0;
        }

        /* Toggle arrow button */
        .header-filter-toggle {
            position: absolute;
            bottom: -14px;
            left: 50%;
            transform: translateX(-50%);
            width: 28px;
            height: 28px;
            border-radius: 50%;
            background: var(--accent);
            color: white;
            border: none;
            cursor: pointer;
            font-size: 0.75rem;
            display: none; /* shown only when filter is active */
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 8px var(--shadow);
            transition: all 0.3s ease;
            z-index: 10;
        }
        .header-filter-toggle:hover {
            background: var(--accent-dark);
            transform: translateX(-50%) scale(1.1);
        }
        .platform-header.filter-active .header-filter-toggle {
            display: flex;
        }

        .logo {
            font-family: 'Philosopher', sans-serif;
            font-size: 2rem;
            font-weight: 700;
            color: var(--primary);
        }

        .header-nav {
            display: flex;
            gap: 2rem;
            align-items: center;
        }

        .nav-link {
            font-family: 'Philosopher', sans-serif;
            color: var(--text-main);
            text-decoration: none;
            font-weight: 600;
            transition: color 0.3s ease;
        }

        .nav-link:hover {
            color: var(--accent);
        }

        .user-menu {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .btn {
            padding: 0.5rem 1.5rem;
            border-radius: 8px;
            border: none;
            font-family: 'Philosopher', sans-serif;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-primary {
            background: var(--accent);
            color: white;
        }

        .btn-primary:hover {
            background: var(--accent-dark);
        }

        .btn-secondary {
            background: transparent;
            border: 2px solid var(--accent);
            color: var(--accent);
        }

        .btn-secondary:hover {
            background: var(--accent);
            color: white;
        }

        /* Main Content */
        .container {
            max-width: 1400px;
            margin: 2rem auto;
            padding: 0 2rem;
        }

        .home-grid {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 2rem;
        }

        .main-content {
            display: flex;
            flex-direction: column;
            gap: 2rem;
        }

        .sidebar {
            display: flex;
            flex-direction: column;
            gap: 2rem;
        }

        /* Cards */
        .card {
            background: var(--bg-card);
            padding: 1.5rem;
            border-radius: 12px;
            border: 1px solid var(--border-light);
            box-shadow: 0 2px 8px var(--shadow);
        }

        .card-title {
            font-family: 'Philosopher', sans-serif;
            font-size: 1.45rem;
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 1rem;
        }

        /* Featured Posts */
        .featured-post {
            background: var(--bg-card);
            padding: 2rem;
            border-radius: 12px;
            border: 1px solid var(--border-light);
            box-shadow: 0 4px 20px var(--shadow);
            margin-bottom: 1.5rem;
            transition: transform 0.3s ease;
        }

        .featured-post:hover {
            transform: translateY(-3px);
        }

        .post-type-badge {
            display: inline-block;
            padding: 4px 12px;
            background: var(--accent-light);
            color: white;
            border-radius: 15px;
            font-size: 0.85rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
        }

        .post-title {
            font-family: 'Philosopher', sans-serif;
            font-size: 1.75rem;
            color: var(--primary);
            margin-bottom: 0.8rem;
        }

        .post-author {
            color: var(--accent);
            font-weight: 600;
            margin-bottom: 0.5rem;
        }

        .post-content {
            color: var(--text-main);
            line-height: 1.95;
            font-size: 1.15rem;
        }

        .font-size-control {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }
        .font-size-label {
            font-family: 'Philosopher', sans-serif;
            font-size: 0.85rem;
            color: var(--text-light);
            font-weight: 600;
            white-space: nowrap;
        }
        .font-size-slider {
            flex: 1;
            -webkit-appearance: none;
            appearance: none;
            height: 6px;
            background: var(--border);
            border-radius: 5px;
            outline: none;
            cursor: pointer;
        }
        .font-size-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 18px;
            height: 18px;
            background: var(--accent);
            border-radius: 50%;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .font-size-slider::-webkit-slider-thumb:hover {
            background: var(--accent-light);
            transform: scale(1.2);
        }
        .font-size-slider::-moz-range-thumb {
            width: 18px;
            height: 18px;
            background: var(--accent);
            border-radius: 50%;
            cursor: pointer;
            border: none;
            transition: all 0.2s ease;
        }
        .font-size-value {
            font-family: 'Philosopher', sans-serif;
            font-size: 0.85rem;
            color: var(--accent);
            font-weight: 700;
            min-width: 38px;
            text-align: center;
        }

        .post-meta {
            display: flex;
            gap: 1rem;
            color: var(--text-light);
            font-size: 1rem;
        }

        /* Random Blocks */
        .random-item {
            padding: 1rem;
            border-bottom: 1px solid var(--border-light);
        }

        .random-item:last-child {
            border-bottom: none;
        }

        .random-title {
            font-weight: 600;
            color: var(--primary);
            margin-bottom: 0.3rem;
        }

        .random-text {
            font-size: 0.95rem;
            color: var(--text-main);
        }

        /* Users List */
        .user-item {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 0.8rem;
            border-bottom: 1px solid var(--border-light);
            transition: background 0.3s ease;
        }

        .user-item:hover {
            background: var(--bg-secondary);
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--accent-light);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 700;
        }

        .user-info {
            flex: 1;
        }

        .user-name {
            font-weight: 600;
            color: var(--primary);
        }

        .user-stats {
            font-size: 0.95rem;
            color: var(--text-light);
        }

        /* Hashtag Cloud */
        .hashtag-cloud {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
        }

        .hashtag-item {
            padding: 0.4rem 1rem;
            background: var(--bg-secondary);
            border-radius: 20px;
            color: var(--accent);
            font-weight: 600;
            text-decoration: none;
            transition: all 0.3s ease;
            font-size: 1rem;
        }

        .hashtag-item:hover {
            background: var(--accent);
            color: white;
        }

        .hashtag-item.active {
            background: var(--accent);
            color: white;
        }

        /* Auth Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: var(--bg-card);
            padding: 2rem;
            border-radius: 12px;
            max-width: 400px;
            width: 90%;
        }

        .form-group {
            margin-bottom: 1rem;
        }

        .form-label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: var(--text-main);
        }

        .form-input {
            width: 100%;
            padding: 0.8rem;
            border: 2px solid var(--border);
            border-radius: 8px;
            font-family: 'Cormorant Garamond', serif;
            font-size: 1rem;
        }

        .form-input:focus {
            outline: none;
            border-color: var(--accent);
        }

        textarea.form-input {
            resize: vertical;
            min-height: 100px;
            font-family: 'Cormorant Garamond', serif;
        }

        .filter-btn {
            padding: 0.5rem 1.5rem;
        }

        .filter-btn.active {
            background: var(--accent);
            color: white;
            border-color: var(--accent);
        }

        .filter-tab {
            padding: 10px 24px;
            background: var(--bg-card);
            border: 2px solid var(--border-light);
            border-radius: 25px;
            font-family: 'Philosopher', sans-serif;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
            color: var(--text-light);
        }

        .filter-tab:hover,
        .filter-tab.active {
            background: var(--accent);
            color: white;
            border-color: var(--accent);
            transform: translateY(-2px);
        }

        .search-container {
            margin: 0;
            padding-top: 0;
        }

        .search-box {
            display: flex;
            gap: 0.5rem;
        }

        .post-actions {
            display: flex;
            gap: 0.5rem;
            margin-top: 1rem;
        }

        .btn-small {
            padding: 0.4rem 1rem;
            font-size: 0.9rem;
        }

        /* Random posts grid */
        .random-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 1rem;
        }

        .random-card {
            background: var(--bg-secondary);
            border-radius: 10px;
            padding: 1rem;
            border: 1px solid var(--border-light);
            cursor: pointer;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .random-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 20px var(--shadow);
        }

        .random-card-title {
            font-family: 'Philosopher', sans-serif;
            font-size: 1.1rem;
            font-weight: 700;
            color: var(--primary);
            line-height: 1.3;
        }

        .random-card-author {
            font-size: 0.85rem;
            color: var(--accent);
            font-weight: 600;
        }

        .random-card-content {
            font-size: 1rem;
            color: var(--text-main);
            white-space: pre-wrap;
            line-height: 1.6;
            flex: 1;
            display: -webkit-box;
            -webkit-line-clamp: 6;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        @media (max-width: 1200px) {
            .random-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (max-width: 768px) {
            .random-grid {
                grid-template-columns: 1fr;
            }
        }

        .loading {
            text-align: center;
            padding: 2rem;
            color: var(--text-light);
        }

        /* ===== HOME SEARCH BAR ===== */
        .search-filter-bar {
            background: var(--bg-card);
            max-height: 0;
            overflow: hidden;
            opacity: 0;
            transition: max-height 0.35s ease, opacity 0.35s ease;
        }
        .search-filter-bar.active {
            max-height: 400px;
            opacity: 1;
            padding: 1rem 0;
        }
        /* Toggle button strip — always visible, sits right below search bar */
        .search-bar-toggle-wrap {
            background: var(--bg-card);
            border-bottom: 1px solid var(--border);
            text-align: center;
            padding: 0px 0 4px;
        }
        .search-bar-toggle {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 28px;
            height: 28px;
            border-radius: 50%;
            background: var(--accent);
            color: white;
            border: none;
            cursor: pointer;
            font-size: 0.75rem;
            box-shadow: 0 2px 8px var(--shadow);
            transition: background 0.3s ease, transform 0.3s ease;
        }
        .search-bar-toggle:hover {
            background: var(--accent-dark);
            transform: scale(1.1);
        }

        .search-filter-inner {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 2rem;
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .search-box-row {
            display: flex;
            gap: 0.5rem;
            align-items: center;
        }

        .search-input-main {
            flex: 1;
            padding: 9px 14px;
            border: 2px solid var(--border);
            border-radius: 8px;
            font-family: 'Cormorant Garamond', serif;
            font-size: 1.05rem;
            color: var(--text-main);
            transition: all 0.3s ease;
        }

        .search-input-main:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 3px rgba(139, 111, 71, 0.1);
            background: var(--bg-card);
        }

        .search-input-main::placeholder { color: var(--text-lighter); }

        .search-btn-main {
            padding: 9px 18px;
            background: linear-gradient(135deg, var(--accent) 0%, var(--accent-light) 100%);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-family: 'Philosopher', sans-serif;
            font-weight: 600;
            font-size: 0.9rem;
            transition: all 0.3s ease;
            white-space: nowrap;
        }

        .search-btn-main:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(139, 111, 71, 0.35);
        }

        .search-clear-btn {
            padding: 9px 14px;
            background: var(--bg-secondary);
            color: var(--text-main);
            border: 2px solid var(--border);
            border-radius: 8px;
            cursor: pointer;
            font-family: 'Philosopher', sans-serif;
            font-weight: 600;
            font-size: 0.9rem;
            transition: all 0.3s ease;
            display: none;
        }

        .search-clear-btn:hover { border-color: var(--accent); color: var(--accent); }

        .search-options-row {
            display: flex;
            gap: 1.5rem;
            justify-content: center;
        }

        .search-option-label {
            display: flex;
            align-items: center;
            gap: 0.4rem;
            cursor: pointer;
            font-family: 'Philosopher', sans-serif;
            font-size: 0.85rem;
            color: var(--text-light);
            transition: color 0.2s;
        }

        .search-option-label:hover { color: var(--accent); }
        .search-option-label input[type="radio"] { cursor: pointer; accent-color: var(--accent); }

        .home-hashtag-chips {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
            align-items: center;
        }

        .home-hashtag-filter-label {
            font-family: 'Philosopher', sans-serif;
            font-size: 0.85rem;
            color: var(--text-light);
            font-weight: 600;
            white-space: nowrap;
        }

        .home-hashtag-chip {
            padding: 4px 12px;
            background: var(--bg-secondary);
            border: 2px solid var(--border);
            color: var(--text-light);
            border-radius: 15px;
            font-size: 0.82rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .home-hashtag-chip:hover { border-color: var(--accent); color: var(--accent); }
        .home-hashtag-chip.active { background: var(--accent); color: white; border-color: var(--accent); }

        /* Profile hashtag chips — single scrollable row */
        .profile-hashtag-scroll {
            display: flex;
            gap: 0.5rem;
            align-items: center;
            overflow-x: auto;
            overflow-y: hidden;
            flex-wrap: nowrap;
            padding-bottom: 4px;
            scrollbar-width: thin;
            scrollbar-color: var(--accent) var(--border);
        }

        .profile-hashtag-scroll::-webkit-scrollbar {
            height: 4px;
        }

        .profile-hashtag-scroll::-webkit-scrollbar-track {
            background: var(--border-light);
            border-radius: 2px;
        }

        .profile-hashtag-scroll::-webkit-scrollbar-thumb {
            background: var(--accent);
            border-radius: 2px;
        }

        .profile-hashtag-scroll .home-hashtag-filter-label {
            flex-shrink: 0;
        }

        .profile-hashtag-scroll .home-hashtag-chip {
            flex-shrink: 0;
        }

        /* Thoughts horizontal scroll row */
        .thoughts-scroll-row {
            display: flex;
            gap: 1rem;
            overflow-x: auto;
            overflow-y: hidden;
            flex-wrap: nowrap;
            padding-bottom: 8px;
            scrollbar-width: thin;
            scrollbar-color: var(--accent) var(--border-light);
        }

        .thoughts-scroll-row::-webkit-scrollbar {
            height: 5px;
        }

        .thoughts-scroll-row::-webkit-scrollbar-track {
            background: var(--border-light);
            border-radius: 3px;
        }

        .thoughts-scroll-row::-webkit-scrollbar-thumb {
            background: var(--accent);
            border-radius: 3px;
        }

        .thoughts-scroll-row .random-card {
            flex: 0 0 300px;
            min-width: 300px;
            max-width: 300px;
        }

        .search-toggle-btn {
            background: none;
            border: none;
            color: var(--text-main);
            cursor: pointer;
            font-size: 1.2rem;
            padding: 0.3rem 0.6rem;
            border-radius: 6px;
            transition: all 0.2s ease;
            line-height: 1;
        }

        .search-toggle-btn:hover { color: var(--accent); background: var(--bg-secondary); }
        .search-toggle-btn.active { color: var(--accent); }

        .search-results-banner {
            text-align: center;
            padding: 0.5rem 2rem;
            font-size: 0.9rem;
            color: var(--text-light);
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border);
            display: none;
        }

        .search-results-banner strong { color: var(--accent); }

        @media (max-width: 768px) {
            .search-filter-bar.active { max-height: 480px; }
            .search-filter-inner { padding: 0 1rem; }
            .search-box-row { flex-wrap: wrap; }
            .search-options-row { gap: 0.75rem; justify-content: flex-start; }
        }

        /* Home bottom grid */
        .home-bottom-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
            margin-bottom: 2rem;
        }

        .home-section-card {
            margin-bottom: 2rem;
            width: 100%;
            box-sizing: border-box;
            overflow: hidden;
        }

        .home-section-card .thoughts-scroll-row {
            overflow-x: auto;
        }

        /* ===== HEADER FILTER BAR ===== */
        .header-filter-inner {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0.6rem 2rem;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .header-filter-tabs {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }

        .header-search-row {
            display: flex;
            gap: 0.5rem;
            align-items: center;
        }

        .header-search-row input {
            flex: 1;
            padding: 8px 14px;
            border: 2px solid var(--border);
            border-radius: 8px;
            font-family: 'Cormorant Garamond', serif;
            font-size: 1rem;
            color: var(--text-main);
            background: var(--bg-main);
            transition: border-color 0.2s;
        }
        .header-search-row input:focus {
            outline: none;
            border-color: var(--accent);
            background: var(--bg-card);
        }
        .header-search-row input::placeholder { color: var(--text-lighter); }

        .header-search-type {
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
        }

        /* ===== PAGINATION ===== */
        .pagination-bar {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 0.35rem;
            padding: 1.5rem 0 0.5rem;
            flex-wrap: wrap;
        }

        .page-btn {
            min-width: 36px;
            height: 36px;
            padding: 0 10px;
            border: 2px solid var(--border);
            border-radius: 8px;
            background: var(--bg-card);
            color: var(--text-main);
            font-family: 'Philosopher', sans-serif;
            font-size: 0.95rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }
        .page-btn:hover:not(:disabled) {
            border-color: var(--accent);
            color: var(--accent);
            background: var(--bg-secondary);
        }
        .page-btn.active {
            background: var(--accent);
            border-color: var(--accent);
            color: white;
        }
        .page-btn:disabled {
            opacity: 0.35;
            cursor: default;
        }

        @media (max-width: 768px) {
            .header-filter-inner { padding: 0.5rem 0.75rem; }
            .header-search-type { gap: 0.5rem; }
        }

        /* ===== BURGER / MOBILE MENU ===== */
        .burger-btn {
            display: none;
            flex-direction: column;
            justify-content: center;
            gap: 5px;
            width: 36px;
            height: 36px;
            background: none;
            border: none;
            cursor: pointer;
            padding: 4px;
            border-radius: 6px;
            transition: background 0.2s;
        }
        .burger-btn:hover { background: var(--bg-secondary); }
        .burger-btn span {
            display: block;
            height: 2px;
            width: 100%;
            background: var(--text-main);
            border-radius: 2px;
            transition: all 0.3s ease;
        }
        .burger-btn.open span:nth-child(1) { transform: translateY(7px) rotate(45deg); }
        .burger-btn.open span:nth-child(2) { opacity: 0; }
        .burger-btn.open span:nth-child(3) { transform: translateY(-7px) rotate(-45deg); }

        .mobile-menu {
            display: none;
            flex-direction: column;
            background: var(--bg-card);
            border-top: 1px solid var(--border);
            padding: 0.5rem 0 1rem;
        }
        .mobile-menu.open { display: flex; }
        .mobile-nav-link {
            padding: 0.85rem 1.5rem;
            font-family: 'Philosopher', sans-serif;
            font-size: 1.05rem;
            font-weight: 600;
            color: var(--text-main);
            text-decoration: none;
            border-bottom: 1px solid var(--border-light);
            transition: background 0.2s, color 0.2s;
        }
        .mobile-nav-link:hover { background: var(--bg-secondary); color: var(--accent); }
        .mobile-menu-divider { height: 1px; background: var(--border); margin: 0.5rem 0; }
        #mobileUserMenu { padding: 0.5rem 1.5rem; display: flex; flex-direction: column; gap: 0.5rem; }
        #mobileUserMenu .btn { width: 100%; text-align: center; }
        #mobileUserMenu .mobile-user-name {
            font-family: 'Philosopher', sans-serif;
            font-weight: 600;
            color: var(--accent);
            padding: 0.5rem 0;
        }

        /* ===== COMPREHENSIVE MOBILE STYLES ===== */
        @media (max-width: 768px) {

            /* Header */
            .platform-header { padding: 0.75rem 1rem; }
            .header-nav { display: none; }
            .user-menu { display: none; }
            .burger-btn { display: flex; }
            .logo { font-size: 1.3rem; }

            /* Container */
            .container { padding: 0 0.75rem; margin: 1rem auto; }

            /* Home page inner container */
            #homePage > .container { padding: 0; }

            /* Home cards — less padding, less margin */
            .home-section-card { padding: 0.85rem; margin-bottom: 1rem; }
            .home-section-card .card-title { font-size: 1.05rem; margin-bottom: 0.75rem; }
            .home-bottom-grid { grid-template-columns: 1fr; gap: 1rem; }

            /* Scroll cards — full-width snapping on mobile */
            .thoughts-scroll-row {
                gap: 0.75rem !important;
                padding-bottom: 8px !important;
                scroll-snap-type: x mandatory !important;
                padding-left: 0.25rem !important;
            }
            .thoughts-scroll-row .random-card {
                flex: 0 0 78vw !important;
                min-width: 0 !important;
                max-width: 78vw !important;
                width: 78vw !important;
                scroll-snap-align: start !important;
            }

            /* Home grid — single column */
            .home-grid { grid-template-columns: 1fr; }

            /* Cards */
            .card { padding: 1rem; border-radius: 10px; }
            .card-title { font-size: 1.15rem; }

            /* Post cards */
            .featured-post { padding: 1rem; }
            .post-title { font-size: 1.25rem; }

            /* Profile page */
            #profilePage .container { padding: 0 0.75rem; }

            /* Sticky filter replaced by header — no top offset needed */

            /* Filter tabs wrap */
            .filter-tab { padding: 7px 14px; font-size: 0.9rem; }

            /* Search bar */
            .search-filter-bar.active { max-height: 520px; }
            .search-input-main { font-size: 1rem; }
            .search-btn-main { font-size: 0.85rem; padding: 9px 12px; }
            .search-clear-btn { font-size: 0.85rem; padding: 9px 10px; }

            /* Profile header buttons */
            #newPostBtn, #shareProfileBtn { padding: 0.4rem 0.9rem; font-size: 0.85rem; }

            /* Buttons */
            .btn { padding: 0.45rem 1rem; font-size: 0.95rem; }
            .btn-small { padding: 0.35rem 0.7rem; font-size: 0.82rem; }

            /* User items */
            .user-item { padding: 0.6rem; }
            .user-avatar { width: 34px; height: 34px; font-size: 0.9rem; }

            /* Modal */
            .modal-content { padding: 1.25rem; margin: 0 1rem; }

            /* Admin grid */
            #adminStatsGrid { grid-template-columns: repeat(2, 1fr); gap: 0.75rem; }

            /* All posts / poets / admin pages */
            #allPostsPage .card,
            #poetsPage .card,
            #adminPage .card { padding: 1rem 0.75rem; }

            /* Post page */
            #postPage .container { padding: 0 0.75rem; }
            #postPageTitle { font-size: 1.6rem !important; }
            #postPageContent { font-size: 1.05rem; }

            /* TOC */
            /* ── TOC ── */

            /* Footer */
            footer { padding: 1rem; font-size: 0.85rem; }

            /* Hashtag cloud wraps on mobile */
            .hashtag-cloud { flex-wrap: wrap; gap: 0.5rem; }
        }

        @media (max-width: 480px) {
            .logo { font-size: 1.1rem; }
            .thoughts-scroll-row .random-card { flex: 0 0 88vw !important; max-width: 88vw !important; width: 88vw !important; }
            #adminStatsGrid { grid-template-columns: 1fr; }
            .search-options-row { flex-direction: column; gap: 0.5rem; }
            .admin-tab-btn { padding: 0.45rem 0.6rem; font-size: 0.78rem; }
            .home-section-card .card-title { font-size: 1rem; }
        }

        /* ===== MESSAGES & CHAT ===== */
        .dialog-item {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.75rem;
            border-radius: 10px;
            cursor: pointer;
            transition: background 0.2s;
            border-bottom: 1px solid var(--border);
        }
        .dialog-item:hover { background: var(--bg-secondary); }
        .dialog-item:last-child { border-bottom: none; }
        .dialog-avatar {
            width: 44px; height: 44px; border-radius: 50%;
            background: var(--bg-secondary); display: flex;
            align-items: center; justify-content: center;
            font-size: 1.2rem; flex-shrink: 0;
            border: 2px solid var(--accent); overflow: hidden;
        }
        .dialog-name { font-weight: 600; color: var(--text-main); font-size: 0.95rem; }
        .dialog-preview { color: var(--text-lighter); font-size: 0.82rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 240px; }
        .dialog-unread {
            margin-left: auto; background: var(--accent); color: white;
            border-radius: 50%; min-width: 20px; height: 20px; padding: 0 4px;
            font-size: 0.7rem; display: flex; align-items: center;
            justify-content: center; font-weight: 700; flex-shrink: 0;
        }

        /* ---- Telegram-style chat ---- */
        .chat-wrap {
            display: flex;
            flex-direction: column;
            gap: 3px;
            padding: 0.75rem 1rem;
        }
        .msg-row {
            display: flex;
            flex-direction: column;
            max-width: 72%;
        }
        .msg-row.mine { align-self: flex-end; align-items: flex-end; }
        .msg-row.theirs { align-self: flex-start; align-items: flex-start; }

        /* Групування — зменшуємо відступ між повідомленнями одного автора */
        .msg-row + .msg-row.mine,
        .msg-row + .msg-row.theirs { margin-top: 1px; }
        .msg-row.mine + .msg-row.theirs,
        .msg-row.theirs + .msg-row.mine { margin-top: 8px; }

        .msg-bubble {
            padding: 0.45rem 0.75rem 0.45rem 0.75rem;
            border-radius: 18px;
            font-size: 0.92rem;
            line-height: 1.45;
            word-break: break-word;
            position: relative;
        }
        .msg-bubble.mine {
            background: var(--accent);
            color: white;
            border-bottom-right-radius: 5px;
        }
        .msg-bubble.theirs {
            background: var(--bg-secondary);
            color: var(--text-main);
            border-bottom-left-radius: 5px;
        }

        /* Час + галочки в одному рядку */
        .msg-meta {
            display: flex;
            align-items: center;
            gap: 3px;
            margin-top: 2px;
            font-size: 0.68rem;
            color: var(--text-lighter);
            padding: 0 2px;
        }
        .msg-row.mine .msg-meta { justify-content: flex-end; }
        .msg-row.theirs .msg-meta { justify-content: flex-start; }

        /* Галочки */
        .tick { font-size: 0.75rem; line-height: 1; }
        .tick.sent { color: var(--text-lighter); }
        .tick.read { color: #4fc3f7; } /* блакитні як в Telegram */
        .msg-row.mine .tick.read { color: white; opacity: 0.9; }

        /* Дата-роздільник */
        .msg-date-sep {
            text-align: center;
            font-size: 0.75rem;
            color: var(--text-lighter);
            margin: 8px 0 4px;
            position: relative;
        }
        .msg-date-sep span {
            background: var(--bg-card);
            padding: 2px 10px;
            border-radius: 10px;
            border: 1px solid var(--border);
        }

        #msgBadge { display: none; }
        #msgBadge.visible { display: inline-flex !important; }

    </style>
</head>
<body>
    <!-- Header -->
    <header class="platform-header">
        <div class="header-content">
            <div href="#" class="nav-link" onclick="showHome()" class="logo">🌟 Поетична Платформа</div>
            <nav class="header-nav">
                <a href="#" class="nav-link" onclick="showHome()">Головна</a>
                <a href="#" class="nav-link" onclick="showPoets()">Поети</a>
                <a href="#" class="nav-link" onclick="showAllPosts()">Всі публікації</a>
                <a href="#" class="nav-link" onclick="showGroups()">Групи</a>
            </nav>
            <div class="user-menu" id="userMenu">
                <button class="btn btn-secondary" onclick="showAuthModal('login')">Увійти</button>
                <button class="btn btn-primary" onclick="showAuthModal('register')">Реєстрація</button>
            </div>
            <!-- Mobile burger -->
            <button class="burger-btn" id="burgerBtn" onclick="toggleMobileMenu()" aria-label="Меню">
                <span></span><span></span><span></span>
            </button>
        </div>
        <!-- Mobile menu dropdown -->
        <div class="mobile-menu" id="mobileMenu">
            <a href="#" class="mobile-nav-link" onclick="showHome(); closeMobileMenu()">🏠 Головна</a>
            <a href="#" class="mobile-nav-link" onclick="showPoets(); closeMobileMenu()">👥 Поети</a>
            <a href="#" class="mobile-nav-link" onclick="showAllPosts(); closeMobileMenu()">📚 Всі публікації</a>
            <a href="#" class="mobile-nav-link" onclick="showGroups(); closeMobileMenu()">🫂 Групи</a>
            <div class="mobile-menu-divider"></div>
            <div id="mobileUserMenu"></div>
        </div>

        <!-- Contextual filter bar (shown on profile/allPosts pages, inside sticky header) -->
        <div class="header-filter-bar" id="headerFilterBar">
            <div class="header-filter-inner">
                <div style="display:flex; align-items:center; gap:0.5rem;">
                    <div class="header-filter-tabs" id="headerFilterTabs" style="flex:1;"></div>
                </div>
                <div class="header-search-row">
                    <input type="text" id="headerSearchInput" autocomplete="off" placeholder="Пошук...">
                    <button class="search-btn-main" id="headerSearchBtn" style="padding:6px 14px; font-size:0.9rem;">🔍</button>
                    <button class="search-clear-btn" id="headerClearBtn" onclick="clearHeaderSearch()" style="display:none; padding:6px 10px;">✕</button>
                </div>
                <div class="header-search-type" id="headerSearchType">
                    <label class="search-option-label"><input type="radio" name="headerSType" value="all" checked> Всюди</label>
                    <label class="search-option-label"><input type="radio" name="headerSType" value="title"> За назвою</label>
                    <label class="search-option-label"><input type="radio" name="headerSType" value="content"> За текстом</label>
                </div>
                <!-- Hashtag chips (shown on allPosts page) -->
                <div id="headerHashtagSection" style="display:none;">
                    <div class="profile-hashtag-scroll" id="allPostsHashtagChips">
                        <span class="home-hashtag-filter-label">#️⃣ Хештеги:</span>
                        <div id="allPostsHashtagChipsList" style="display:flex; gap:0.5rem; flex-wrap:nowrap;"></div>
                    </div>
                </div>
                <!-- TOC (shown on profile pages) -->
                <div id="headerTocSection" style="display:none;">
                    <div style="border-top: 1px solid var(--border-light); padding-top: 0.5rem; margin-top: 0.25rem;">
                        <div style="font-family:'Philosopher',sans-serif; font-size:0.85rem; color:var(--text-lighter); margin-bottom:0.4rem;">📑 Зміст</div>
                        <ul id="headerTocList" style="list-style:none; margin:0; padding:0; max-height:200px; overflow-y:auto; display:flex; flex-direction:column; gap:0.15rem;"></ul>
                    </div>
                </div>
                <div class="font-size-control" style="border-top: 1px solid var(--border-light); padding-top: 0.5rem; margin-top: 0.25rem;">
                    <span class="font-size-label">🔡 Розмір тексту:</span>
                    <input type="range" class="font-size-slider" id="fontSizeSlider2" min="0" max="100" value="50" step="5">
                    <span class="font-size-value" id="fontSizeValue2">100%</span>
                </div>

            </div>
        </div>
        <!-- Filter toggle arrow -->
        <button class="header-filter-toggle" id="headerFilterToggle" onclick="toggleHeaderFilter()">▼</button>
    </header>

    <!-- Search & Filter Bar (home only) — inside sticky zone -->
    <div id="homeSearchSticky" style="position:sticky; top: var(--header-height, 60px); z-index:199; background:var(--bg-card);">
        <div class="search-filter-bar" id="searchFilterBar">
            <div class="search-filter-inner">
                <div class="search-box-row">
                    <input type="text" class="search-input-main" id="homeSearchInput" autocomplete="off" placeholder="Пошук за назвою, текстом або хештегом..." onkeypress="if(event.key==='Enter') runHomeSearch()">
                    <button class="search-btn-main" onclick="runHomeSearch()">🔍 Знайти</button>
                    <button class="search-clear-btn" id="homeClearBtn" onclick="clearHomeSearch()">✕ Скинути</button>
                </div>
                <div class="search-options-row">
                    <label class="search-option-label">
                        <input type="radio" name="homeSearchType" value="all" checked> Всюди
                    </label>
                    <label class="search-option-label">
                        <input type="radio" name="homeSearchType" value="title"> За назвою
                    </label>
                    <label class="search-option-label">
                        <input type="radio" name="homeSearchType" value="content"> За текстом
                    </label>
                </div>
                <div class="profile-hashtag-scroll" id="homeHashtagChips" style="display:none;">
                    <span class="home-hashtag-filter-label">#️⃣ Хештеги:</span>
                    <div id="homeHashtagChipsList" style="display:flex; gap:0.5rem; flex-wrap:nowrap;"></div>
                </div>
                <div class="font-size-control" style="border-top: 1px solid var(--border-light); padding-top: 0.5rem; margin-top: 0.25rem;">
                    <span class="font-size-label">🔡 Розмір тексту:</span>
                    <input type="range" class="font-size-slider" id="fontSizeSlider" min="0" max="100" value="50" step="5">
                    <span class="font-size-value" id="fontSizeValue">100%</span>
                </div>
            </div>
        </div>
        <!-- Toggle arrow -->
        <div class="search-bar-toggle-wrap" id="searchBarToggleWrap">
            <button class="search-bar-toggle" id="searchBarToggle" onclick="toggleSearchBar()">▼</button>
        </div>
    </div>
    <!-- Search results banner -->
    <div class="search-results-banner" id="homeSearchResultsBanner"></div>

    <!-- All Pages Wrapper -->
    <div id="pagesWrapper" style="flex: 1; width: 100%; max-width: 100%; padding: 1.5rem 1rem; box-sizing: border-box; overflow-x: hidden;">

    <!-- Home Page -->
    <div id="homePage" style="display: block; max-width: 1200px; margin: 0 auto;">
                <!-- Featured Posts -->
                <div class="card home-section-card">
                    <h2 class="card-title">⭐ Обрані публікації</h2>
                    <div id="featuredPosts">
                        <div class="loading">Завантаження...</div>
                    </div>
                </div>

                <!-- Random Poetry -->
                <div class="card home-section-card">
                    <h2 class="card-title">📜 Випадкові вірші</h2>
                    <div id="randomPoetry" class="random-grid">
                        <div class="loading">Завантаження...</div>
                    </div>
                </div>

                <!-- Random Thoughts -->
                <div class="card home-section-card">
                    <h2 class="card-title">💭 Випадкові думки</h2>
                    <div id="randomThoughts">
                        <div class="loading">Завантаження...</div>
                    </div>
                </div>

                <!-- Groups Block -->
                <div class="card home-section-card">
                    <div style="display:flex; align-items:center; justify-content:space-between; margin-bottom:1rem; flex-wrap:wrap; gap:0.5rem;">
                        <h2 class="card-title" style="margin:0;">🫂 Групи</h2>
                        <button class="btn btn-secondary btn-small" onclick="showGroups()">Всі групи →</button>
                    </div>
                    <div id="homeGroupsPreview" style="display:grid; grid-template-columns:repeat(auto-fill, minmax(260px, 1fr)); gap:1rem;">
                        <div class="loading">Завантаження...</div>
                    </div>
                </div>

                <!-- Bottom Grid -->
                <div class="home-bottom-grid">
                    <!-- Users List -->
                    <div class="card">
                        <h3 class="card-title">👥 Поети</h3>
                        <div id="usersList">
                            <div class="loading">Завантаження...</div>
                        </div>
                    </div>

                    <!-- Hashtag Cloud -->
                    <div class="card">
                        <h3 class="card-title">#️⃣ Популярні теми</h3>
                        <div id="hashtagCloud" class="hashtag-cloud">
                            <div class="loading">Завантаження...</div>
                        </div>
                    </div>
                </div>
    </div><!-- /homePage -->

    <!-- Auth Modal -->
    <div id="authModal" class="modal">
        <div class="modal-content">
            <h2 class="card-title" id="authTitle">Вхід</h2>
            
            <!-- Login Form -->
            <div id="loginForm">
                <div class="form-group">
                    <label class="form-label">Email</label>
                    <input type="email" class="form-input" id="loginEmail">
                </div>
                <div class="form-group">
                    <label class="form-label">Пароль</label>
                    <input type="password" class="form-input" id="loginPassword">
                </div>
                <button class="btn btn-primary" style="width: 100%; margin-bottom: 1rem;" onclick="handleLogin()">Увійти</button>
                <button class="btn btn-secondary" style="width: 100%;" onclick="closeAuthModal()">Скасувати</button>
            </div>

            <!-- Register Form -->
            <div id="registerForm" style="display: none;">
                <div class="form-group">
                    <label class="form-label">Ім'я (псевдонім)</label>
                    <input type="text" class="form-input" id="registerName">
                </div>
                <div class="form-group">
                    <label class="form-label">Email</label>
                    <input type="email" class="form-input" id="registerEmail">
                </div>
                <div class="form-group">
                    <label class="form-label">Пароль</label>
                    <input type="password" class="form-input" id="registerPassword">
                </div>
                <button class="btn btn-primary" style="width: 100%; margin-bottom: 1rem;" onclick="handleRegister()">Зареєструватися</button>
                <button class="btn btn-secondary" style="width: 100%;" onclick="closeAuthModal()">Скасувати</button>
            </div>
        </div>
    </div>

    <!-- User Profile Page -->
    <div id="profilePage" style="display: none;">
        <div class="container" style="max-width: 900px;">
            <!-- Profile Header -->
            <div class="card" style="margin-bottom: 2rem;">
                <!-- Buttons row (top right) -->
                <div id="profileBtnsRow" style="display: none; justify-content: flex-end; gap: 0.5rem; margin-bottom: 0.75rem; flex-wrap: wrap;">
                    <button class="btn btn-secondary" onclick="shareProfile()" id="shareProfileBtn" style="display: none;">🔗 Поділитися</button>
                    <button class="btn btn-secondary" id="myFriendsBtn" style="display: none;" onclick="showFriendsModal()">👥 Мої друзі</button>
                    <button class="btn btn-secondary" id="friendBtn" style="display: none;" onclick="handleFriendAction()">👥 Додати в друзі</button>
                    <button class="btn btn-primary" id="messageBtn" style="display: none;" onclick="openChat(window.currentProfileUserId)">💬 Написати</button>
                    <button class="btn btn-primary" onclick="showNewPostModal()" id="newPostBtn" style="display: none;">➕ Нова публікація</button>
                </div>

                <!-- Avatar + Name row -->
                <div style="display: flex; align-items: center; gap: 1.25rem; margin-bottom: 0.75rem;">
                    <div id="profileAvatarWrap" style="flex-shrink: 0;">
                        <img id="profileAvatarImg" src="" alt="" style="display:none; width:80px; height:80px; border-radius:50%; object-fit:cover; border:3px solid var(--accent); box-shadow:0 2px 8px var(--shadow);">
                        <div id="profileAvatarPlaceholder" style="width:80px; height:80px; border-radius:50%; background:var(--bg-secondary); border:3px solid var(--border); display:flex; align-items:center; justify-content:center; font-size:2rem; color:var(--text-lighter);">👤</div>
                    </div>
                    <h2 class="card-title" id="profileName" style="margin:0;">Завантаження...</h2>
                </div>

                <!-- Bio Block -->
                <div id="profileBioBlock" style="margin-bottom: 0.8rem; width: 100%;">
                    <div id="profileBioText" style="color: var(--text-main); font-style: italic; line-height: 1.7; white-space: pre-wrap; width: 100%;"></div>
                    <button id="editBioBtn" onclick="showEditBio()" style="display: none; margin-top: 0.75rem;" class="btn btn-secondary btn-small">✏️ Редагувати біографію</button>
                </div>

                <!-- Bio Edit Form -->
                <div id="bioEditForm" style="display: none; margin-bottom: 1rem; width: 100%;">
                    <div class="form-group">
                        <label class="form-label">Фото профілю (посилання на зображення)</label>
                        <input type="url" id="avatarUrlInput" class="form-input" placeholder="https://example.com/photo.jpg" style="margin-bottom: 0.5rem;">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Біографія</label>
                        <textarea id="bioInput" class="form-input" rows="4" placeholder="Розкажіть про себе... Ваш творчий шлях, натхнення, захоплення." style="width: 100%; margin-bottom: 0.5rem; resize: vertical;"></textarea>
                    </div>
                    <div style="display: flex; gap: 0.5rem;">
                        <button class="btn btn-primary btn-small" onclick="saveBio()">💾 Зберегти</button>
                        <button class="btn btn-secondary btn-small" onclick="cancelEditBio()">✕ Скасувати</button>
                    </div>
                </div>

                <div id="profileStats" style="color: var(--text-light);"></div>
                <div id="profileGroupsSection" style="margin-top:0.75rem; display:none;">
                    <div style="font-size:0.85rem; color:var(--text-lighter); margin-bottom:0.4rem; font-family:'Philosopher',sans-serif;">🫂 Групи:</div>
                    <div id="profileGroupsList" style="display:flex; flex-wrap:wrap; gap:0.4rem;"></div>
                </div>
            </div>

            <!-- Search results banner for profile -->
            <div class="search-results-banner" id="profileSearchResultsBanner" style="border-radius: 8px; margin-bottom: 1rem;"></div>

            <!-- Posts Grid -->
            <div id="profilePosts"></div>
            <div id="profilePagination" class="pagination-bar"></div>
        </div>
    </div>

    <!-- All Posts Page -->
    <div id="allPostsPage" style="display: none;">
        <div style="max-width: 1200px; margin: 0 auto; padding: 0 1rem;">
            <h2 class="card-title" style="padding: 1.5rem 0 0.5rem;">📚 Всі публікації</h2>
            <div class="search-results-banner" id="allPostsSearchResultsBanner" style="border-radius: 8px; margin-bottom: 1rem;"></div>
            <div id="allPostsContainer"></div>
            <div id="allPostsPagination" class="pagination-bar"></div>
        </div>
    </div>

    <!-- All Poets Page -->
    <div id="poetsPage" style="display: none;">
        <div class="card" style="max-width: 1200px; margin: 0 auto;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                <h2 class="card-title" style="margin-bottom: 0;">👥 Всі поети</h2>
                <button class="search-toggle-btn" id="poetsSearchToggleBtn" onclick="togglePoetsSearch()" title="Пошук">🔍</button>
            </div>
            <!-- Poets Search (collapsed by default) -->
            <div class="search-filter-bar" id="poetsSearchFilterBar" style="border-radius: 10px; margin-bottom: 1rem; border: 1px solid var(--border-light); box-shadow: none;">
                <div class="search-filter-inner">
                    <div class="search-box-row">
                        <input type="text" class="search-input-main" id="poetsSearchInput" autocomplete="off" placeholder="Пошук за іменем або біографією..." onkeypress="if(event.key==='Enter') runPoetsSearch()">
                        <button class="search-btn-main" onclick="runPoetsSearch()">🔍 Знайти</button>
                        <button class="search-clear-btn" id="poetsClearBtn" onclick="clearPoetsSearch()">✕ Скинути</button>
                    </div>
                </div>
            </div>
            <div class="search-results-banner" id="poetsSearchResultsBanner" style="border-radius: 8px; margin-bottom: 1rem;"></div>
            <div id="allPoetsContainer">
                <div class="loading">Завантаження...</div>
            </div>
        </div>
    </div>


    <!-- Single Post Page -->
    <div id="postPage" style="display: none;">
        <div class="container" style="max-width: 800px;">
            <div class="card" style="margin-bottom: 2rem;">
                <!-- Back navigation -->
                <div id="postPageBack" style="margin-bottom: 1.5rem;">
                    <button class="btn btn-secondary btn-small" onclick="history.back()">← Назад</button>
                </div>
                <span class="post-type-badge" id="postPageBadge"></span>
                <h1 id="postPageTitle" style="font-family: 'Philosopher', sans-serif; font-size: 2.4rem; color: var(--primary); margin: 0.8rem 0; line-height: 1.3;"></h1>
                <div id="postPageDate" style="color: var(--text-light); font-size: 0.95rem; margin-bottom: 1.5rem; font-style: italic;"></div>
                <div id="postPageContent" class="post-content" style="white-space: pre-wrap; line-height: 2; font-size: 1.25rem; margin-bottom: 1.5rem;"></div>
                <div id="postPageHashtags" style="margin-bottom: 1.5rem;"></div>
                <!-- Action buttons -->
                <div style="display: flex; gap: 0.5rem; margin-bottom: 1rem; flex-wrap: wrap;">
                    <button class="btn btn-primary btn-small" id="postPageDownloadBtn" onclick="downloadPostAsImage(window.currentPostId)">📥 Зберегти як фото</button>
                    <button class="btn btn-secondary btn-small" id="postPageShareBtn" onclick="sharePost(window.currentPostId)">🔗 Поділитися</button>
                </div>
                <div style="padding-top: 1rem; border-top: 1px solid var(--border);">
                    <div id="postPageAuthorLink" style="display: flex; align-items: center; gap: 0.75rem; cursor: pointer; width: fit-content;">
                        <div id="postPageAuthorAvatar" style="width: 42px; height: 42px; border-radius: 50%; background: var(--accent-light); display: flex; align-items: center; justify-content: center; color: white; font-weight: 700; font-size: 1.1rem; flex-shrink: 0;"></div>
                        <div>
                            <div style="font-size: 0.8rem; color: var(--text-lighter);">Автор</div>
                            <div id="postPageAuthorName" style="font-weight: 700; color: var(--accent); font-family: 'Philosopher', sans-serif; font-size: 1.05rem;"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- New Post Modal -->
    <div id="newPostModal" class="modal">
        <div class="modal-content" style="max-width: 600px;">
            <h2 class="card-title">➕ Нова публікація</h2>
            
            <div class="form-group">
                <label class="form-label">Тип</label>
                <select class="form-input" id="newPostType">
                    <option value="poetry">Поезія</option>
                    <option value="thought">Думка</option>
                </select>
            </div>

            <div class="form-group">
                <label class="form-label">Назва</label>
                <input type="text" class="form-input" id="newPostTitle">
            </div>

            <div class="form-group">
                <label class="form-label">Текст</label>
                <textarea class="form-input" id="newPostContent" rows="10"></textarea>
            </div>

            <div class="form-group">
                <label class="form-label">Хештеги (через пробіл, наприклад: #кохання #природа)</label>
                <input type="text" class="form-input" id="newPostHashtags">
            </div>

            <button class="btn btn-primary" style="width: 100%; margin-bottom: 1rem;" onclick="handleCreatePost()">Опублікувати</button>
            <button class="btn btn-secondary" style="width: 100%;" onclick="closeNewPostModal()">Скасувати</button>
        </div>
    </div>

    <!-- Edit Post Modal -->
    <div id="editPostModal" class="modal">
        <div class="modal-content" style="max-width: 600px;">
            <h2 class="card-title">✏️ Редагувати публікацію</h2>
            <div class="form-group">
                <label class="form-label">Тип</label>
                <select class="form-input" id="editPostType">
                    <option value="poetry">Поезія</option>
                    <option value="thought">Думка</option>
                </select>
            </div>
            <div class="form-group">
                <label class="form-label">Назва</label>
                <input type="text" class="form-input" id="editPostTitle">
            </div>
            <div class="form-group">
                <label class="form-label">Текст</label>
                <textarea class="form-input" id="editPostContent" rows="10"></textarea>
            </div>
            <div class="form-group">
                <label class="form-label">Хештеги (через пробіл, наприклад: #кохання #природа)</label>
                <input type="text" class="form-input" id="editPostHashtags">
            </div>
            <input type="hidden" id="editPostId">
            <button class="btn btn-primary" style="width: 100%; margin-bottom: 1rem;" onclick="handleSavePost()">💾 Зберегти</button>
            <button class="btn btn-secondary" style="width: 100%;" onclick="closeEditPostModal()">Скасувати</button>
        </div>
    </div>

    <!-- Admin Panel Page -->
    <div id="adminPage" style="display: none;">
        <div class="card" style="max-width: 1200px; margin: 0 auto;">
            <h2 class="card-title">⚙️ Адмін панель</h2>
            
            <!-- Admin Tabs -->
            <div style="display: flex; flex-wrap: wrap; gap: 0.25rem; margin-bottom: 2rem; border-bottom: 2px solid var(--border); overflow-x: auto;">
                <button class="admin-tab-btn active" onclick="showAdminTab('stats')">📊 Статистика</button>
                <button class="admin-tab-btn" onclick="showAdminTab('posts')">📝 Публікації</button>
                <button class="admin-tab-btn" onclick="showAdminTab('users')">👥 Користувачі</button>
                <button class="admin-tab-btn" onclick="showAdminTab('theme')">🎨 Тема сайту</button>
            </div>

            <!-- Stats Tab -->
            <div id="adminTabStats" class="admin-tab-content">
                <h3 style="font-family: 'Philosopher', sans-serif; color: var(--primary); margin-bottom: 1.5rem;">Загальна статистика платформи</h3>
                <div id="adminStatsGrid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); gap: 1.5rem; margin-bottom: 2.5rem;">
                    <!-- stat cards injected by JS -->
                </div>
                <h3 style="font-family: 'Philosopher', sans-serif; color: var(--primary); margin-bottom: 1rem;">Активність за останні 7 днів</h3>
                <div id="adminActivityChart" style="background: var(--bg-secondary); border-radius: 12px; padding: 1.5rem; border: 1px solid var(--border-light);">
                    <!-- chart injected by JS -->
                </div>
                <h3 style="font-family: 'Philosopher', sans-serif; color: var(--primary); margin: 2rem 0 1rem;">Нові користувачі (останні 7 днів)</h3>
                <div id="adminNewUsersList" style="background: var(--bg-secondary); border-radius: 12px; padding: 1rem; border: 1px solid var(--border-light);">
                    <!-- list injected by JS -->
                </div>
            </div>

            <!-- Posts Tab -->
            <div id="adminTabPosts" class="admin-tab-content" style="display:none;">
                <div style="margin-bottom: 2rem;">
                    <h3 style="font-family: 'Philosopher', sans-serif; color: var(--primary); margin-bottom: 1rem;">Керування публікаціями</h3>
                    <p style="color: var(--text-light); margin-bottom: 1rem;">Позначайте найкращі публікації як "обрані" - вони з'являться на головній сторінці</p>
                </div>
                <div id="adminPostsList">
                    <div class="loading">Завантаження...</div>
                </div>
            </div>

            <!-- Users Tab -->
            <div id="adminTabUsers" class="admin-tab-content" style="display:none;">
                <div style="display:flex; align-items:center; justify-content:space-between; margin-bottom:1.25rem; flex-wrap:wrap; gap:0.75rem;">
                    <h3 style="font-family:'Philosopher',sans-serif; color:var(--primary); margin:0;">Керування користувачами</h3>
                    <input type="text" id="adminUserSearch" class="form-input" placeholder="Пошук за іменем або email..." oninput="filterAdminUsers(this.value)" style="max-width:280px;">
                </div>
                <div id="adminUsersList" style="display:flex; flex-direction:column; gap:0.75rem;">
                    <div class="loading">Завантаження...</div>
                </div>
            </div>

            <!-- Theme Tab -->
            <div id="adminTabTheme" class="admin-tab-content" style="display: none;">
                <p style="color: var(--text-light); margin-bottom: 2rem;">Оберіть колірну схему для вашого сайту. Зміни застосовуються для всіх користувачів платформи.</p>
                
                <div id="themeCardsContainer" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 1.5rem;">
                    <!-- Theme cards will be inserted here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Migration Tool (hidden, only for initial setup) -->
    <div id="migrationTool" style="display: none;">
        <div class="card" style="max-width: 800px; margin: 2rem auto;">
            <h2 class="card-title">📦 Міграція даних зі старого блогу</h2>
            <p style="color: var(--text-light); margin-bottom: 1rem;">
                Ця функція дозволяє перенести всі ваші існуючі публікації зі старого блогу на нову платформу.
            </p>
            <button class="btn btn-primary" onclick="migrateOldPosts()">Почати міграцію</button>
        </div>
    </div>

    <!-- Messages Page -->
    <!-- Groups Page -->
    <div id="groupsPage" style="display:none; max-width:1100px; margin:0 auto; padding:1.5rem 1rem;">
        <div style="display:flex; align-items:center; justify-content:space-between; margin-bottom:1.5rem; flex-wrap:wrap; gap:1rem;">
            <h2 class="card-title" style="margin:0;">🫂 Групи за інтересами</h2>
            <button class="btn btn-primary" id="createGroupBtn" style="display:none;" onclick="showCreateGroupModal()">➕ Створити групу</button>
        </div>
        <div id="groupsList" style="display:grid; grid-template-columns:repeat(auto-fill, minmax(300px, 1fr)); gap:1.5rem;">
            <div class="loading">Завантаження...</div>
        </div>
    </div>

    <!-- Single Group Page -->
    <div id="groupPage" style="display:none; max-width:900px; margin:0 auto; padding:1.5rem 1rem;">
        <div class="card" style="margin-bottom:1.5rem;">
            <button class="btn btn-secondary btn-small" onclick="showGroups()" style="margin-bottom:1rem;">← Всі групи</button>
            <div style="display:flex; align-items:center; gap:1.25rem; margin-bottom:1rem; flex-wrap:wrap;">
                <div id="groupPageAvatar" style="width:72px;height:72px;border-radius:50%;background:var(--accent-light);display:flex;align-items:center;justify-content:center;font-size:2rem;flex-shrink:0;overflow:hidden;"></div>
                <div style="flex:1; min-width:0;">
                    <h2 id="groupPageName" style="font-family:'Philosopher',sans-serif; color:var(--primary); margin:0 0 0.25rem;"></h2>
                    <div id="groupPageDesc" style="color:var(--text-light); font-size:0.95rem; margin-bottom:0.5rem;"></div>
                    <div id="groupPageMeta" style="color:var(--text-lighter); font-size:0.85rem;"></div>
                </div>
            </div>
            <div id="groupPageBtns" style="display:flex; gap:0.5rem; flex-wrap:wrap;"></div>
        </div>
        <div id="groupPagePosts">
            <div class="loading">Завантаження...</div>
        </div>
    </div>

    <div id="messagesPage" style="display:none; max-width:700px; margin:0 auto; padding:1.5rem 1rem;">
        <div class="card">
            <h2 class="card-title">💬 Повідомлення</h2>
            <div id="dialogsList" style="margin-top:1rem;">
                <p style="color:var(--text-lighter); text-align:center;">Завантаження...</p>
            </div>
        </div>
    </div>


    </div><!-- /pagesWrapper -->

    <!-- Chat Modal -->
    <div id="chatModal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.55); z-index:1000; align-items:center; justify-content:center;">
        <div style="background:var(--bg-card); border-radius:14px; width:100%; max-width:520px; height:min(600px, 88vh); display:flex; flex-direction:column; margin:1rem; box-shadow:0 12px 40px rgba(0,0,0,0.25); overflow:hidden;">
            <!-- Chat header — telegram style -->
            <div style="display:flex; align-items:center; gap:0.75rem; padding:0.75rem 1rem; background:var(--accent); color:white;">
                <div id="chatAvatar" style="width:38px;height:38px;border-radius:50%;background:rgba(255,255,255,0.25);display:flex;align-items:center;justify-content:center;font-size:1.1rem;overflow:hidden;flex-shrink:0;font-weight:700;"></div>
                <div style="flex:1; min-width:0;">
                    <div id="chatPartnerName" style="font-weight:700; font-size:0.97rem; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">...</div>
                    <div id="chatPartnerStatus" style="font-size:0.72rem; opacity:0.8;">в мережі</div>
                </div>
                <button onclick="closeChatModal()" style="background:none;border:none;font-size:1.3rem;cursor:pointer;color:white;opacity:0.85;padding:4px;">✕</button>
            </div>
            <!-- Messages area -->
            <div id="chatMessages" style="flex:1; overflow-y:auto; display:flex; flex-direction:column; background:var(--bg-main); padding:0.5rem 0;"></div>
            <!-- Input area -->
            <div style="padding:0.6rem 0.75rem; border-top:1px solid var(--border); display:flex; gap:0.5rem; align-items:center; background:var(--bg-card);">
                <input id="chatInput" type="text" placeholder="Повідомлення..." style="flex:1; padding:0.55rem 0.9rem; border:1px solid var(--border); border-radius:20px; font-size:0.93rem; background:var(--bg-main); color:var(--text-main); outline:none;" onkeypress="if(event.key==='Enter') sendMessage()">
                <button onclick="sendMessage()" style="width:38px;height:38px;border-radius:50%;background:var(--accent);color:white;border:none;cursor:pointer;font-size:1.1rem;display:flex;align-items:center;justify-content:center;flex-shrink:0;">➤</button>
            </div>
        </div>
    </div>

    <script type="module">
        // Firebase imports
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getDatabase, ref, set, get, push, onValue, remove, goOffline, goOnline } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js';
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';

        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyAFV8kimd0f2dLw3yyQNj3fIyY4_5zCQB0",
            authDomain: "poetry-blog-ff72f.firebaseapp.com",
            databaseURL: "https://poetry-blog-ff72f-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "poetry-blog-ff72f",
            storageBucket: "poetry-blog-ff72f.firebasestorage.app",
            messagingSenderId: "331598419628",
            appId: "1:331598419628:web:d1093b30ab867d3d40b109"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const database = getDatabase(app);
        const auth = getAuth(app);

        // Global variables
        window.currentUser = null;
        window.allPosts = [];
        window.allUsers = [];

        // Auto-create admin account on first load
        async function initializeAdminAccount() {
            const adminEmail = 'krasovsky.oleg.seo@gmail.com';
            const adminName = 'KonVi';
            
            // Check if admin user exists
            const usersSnapshot = await get(ref(database, 'users'));
            let adminExists = false;
            
            if (usersSnapshot.exists()) {
                usersSnapshot.forEach((childSnapshot) => {
                    const userData = childSnapshot.val();
                    if (userData.email === adminEmail) {
                        adminExists = true;
                    }
                });
            }

            // If admin doesn't exist, create a placeholder
            if (!adminExists) {
                console.log('🔧 Підготовка до створення адмін акаунту...');
                console.log('📧 Email:', adminEmail);
                console.log('👤 Нікнейм:', adminName);
                console.log('ℹ️ Зареєструйтеся з цими даними для отримання адмін прав');
            }
        }

        // Initialize admin check
        initializeAdminAccount();

        // Auth Modal Functions
        window.showAuthModal = function(type) {
            const modal = document.getElementById('authModal');
            const title = document.getElementById('authTitle');
            const loginForm = document.getElementById('loginForm');
            const registerForm = document.getElementById('registerForm');

            if (type === 'login') {
                title.textContent = 'Вхід';
                loginForm.style.display = 'block';
                registerForm.style.display = 'none';
            } else {
                title.textContent = 'Реєстрація';
                loginForm.style.display = 'none';
                registerForm.style.display = 'block';
            }

            modal.classList.add('active');
        };

        window.closeAuthModal = function() {
            document.getElementById('authModal').classList.remove('active');
        };

        // Authentication Functions
        window.handleRegister = async function() {
            const name = document.getElementById('registerName').value.trim();
            const email = document.getElementById('registerEmail').value.trim();
            const password = document.getElementById('registerPassword').value;

            if (!name || !email || !password) {
                alert('Заповніть всі поля');
                return;
            }

            try {
                const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                const user = userCredential.user;

                // Check if this is the admin email
                const isAdminEmail = email === 'krasovsky.oleg.seo@gmail.com';

                // Create user profile in database
                await set(ref(database, `users/${user.uid}`), {
                    name: name,
                    email: email,
                    createdAt: Date.now(),
                    postsCount: 0,
                    poetryCount: 0,
                    thoughtsCount: 0,
                    isAdmin: isAdminEmail
                });

                if (isAdminEmail) {
                    alert('✅ Реєстрація успішна! Ви отримали права адміністратора.');
                } else {
                    alert('✅ Реєстрація успішна!');
                }
                closeAuthModal();
            } catch (error) {
                console.error('Registration error:', error);
                alert('❌ Помилка реєстрації: ' + error.message);
            }
        };

        window.handleLogin = async function() {
            const email = document.getElementById('loginEmail').value.trim();
            const password = document.getElementById('loginPassword').value;

            if (!email || !password) {
                alert('Заповніть всі поля');
                return;
            }

            try {
                await signInWithEmailAndPassword(auth, email, password);
                closeAuthModal();
            } catch (error) {
                console.error('Login error:', error);
                alert('❌ Помилка входу: ' + error.message);
            }
        };

        window.handleLogout = async function() {
            try {
                await signOut(auth);
                alert('Ви вийшли з системи');
            } catch (error) {
                console.error('Logout error:', error);
            }
        };

        // Auth State Observer
        onAuthStateChanged(auth, async (user) => {
            const userMenu = document.getElementById('userMenu');
            
            if (user) {
                // User is signed in
                window.currentUser = user;
                
                // Get user profile
                const userSnapshot = await get(ref(database, `users/${user.uid}`));
                const userData = userSnapshot.val();
                
                // Check if user is admin
                window.isAdmin = userData?.isAdmin || false;
                
                userMenu.innerHTML = `
                    <span style="color: var(--accent); font-weight: 600;">👤 ${userData?.name || 'Користувач'}</span>
                    <button class="btn btn-secondary" onclick="showMessages()" id="messagesBtn" style="position:relative; padding: 0.4rem 0.75rem;">
                        💬 <span id="msgBadge" style="display:none; position:absolute; top:-6px; right:-6px; background:#e74c3c; color:white; border-radius:50%; width:18px; height:18px; font-size:0.7rem; align-items:center; justify-content:center; font-weight:700; line-height:1;"></span>
                    </button>
                    ${window.isAdmin ? '<button class="btn btn-secondary" onclick="showAdminPanel()">⚙️ Адмін</button>' : ''}
                    <button class="btn btn-secondary" onclick="showMyProfile()">Мій профіль</button>
                    <button class="btn btn-primary" onclick="handleLogout()">Вийти</button>
                `;
                setTimeout(() => startMsgListener(), 0);
                setTimeout(() => deleteOldMessages(), 3000); // чистимо старі повідомлення через 3с
                setTimeout(() => initFontSizeSlider(), 0);
                setTimeout(syncMobileUserMenu, 0);
            } else {
                // User is signed out
                window.currentUser = null;
                userMenu.innerHTML = `
                    <button class="btn btn-secondary" onclick="showAuthModal('login')">Увійти</button>
                    <button class="btn btn-primary" onclick="showAuthModal('register')">Реєстрація</button>
                `;
                setTimeout(syncMobileUserMenu, 0);
            }
        });

        // Прапорці готовності даних
        window._postsReady = false;
        window._usersReady = false;

        // Перерендерити головну після того, як завантажились обидва масиви
        function refreshHomeIfReady() {
            loadHomeGroupsPreview();
            if (window._postsReady && window._usersReady) {
                const route = getCurrentRoute();
                const page = route.split('/')[0];

                // Якщо на головній — оновлюємо блоки
                if (!page || page === 'home' || page === '') {
                    loadFeaturedPosts();
                    loadRandomPoetry();
                    loadRandomThoughts();
                    loadUsersList();
                    loadHashtagCloud();
                    buildHomeHashtagChips();
                } else {
                    // Для інших сторінок — перезапускаємо роутер з даними
                    handleRoute();
                }
            }
        }

        // Load all posts
        onValue(ref(database, 'posts'), (snapshot) => {
            window.allPosts = [];
            snapshot.forEach((childSnapshot) => {
                const post = childSnapshot.val();
                const firebaseKey = childSnapshot.key;
                
                // Фільтруємо порожні/неповні пости
                if (post && post.title && post.content && post.date && post.userId) {
                    // ВАЖЛИВО: використовуємо Firebase key як ID, навіть якщо в post є своє поле id
                    window.allPosts.push({
                        ...post,
                        id: firebaseKey  // Завжди перезаписуємо правильним Firebase ID
                    });
                }
            });
            
            console.log('Loaded posts:', window.allPosts.length);
            console.log('Sample post IDs:', window.allPosts.slice(0, 3).map(p => p.id));
            
            window._postsReady = true;
            refreshHomeIfReady();
        });

        // Load all users
        onValue(ref(database, 'users'), (snapshot) => {
            window.allUsers = [];
            snapshot.forEach((childSnapshot) => {
                window.allUsers.push({
                    id: childSnapshot.key,
                    ...childSnapshot.val()
                });
            });
            
            window._usersReady = true;
            refreshHomeIfReady();
        });

        // Load Featured Posts (posts marked by admin)
        function loadFeaturedPosts() {
            const featured = window.allPosts.filter(p => p.featured).slice(0, 8);
            const container = document.getElementById('featuredPosts');
            if (featured.length === 0) {
                container.className = '';
                container.innerHTML = '<p style="color: var(--text-light);">Немає обраних публікацій</p>';
                return;
            }
            container.className = 'thoughts-scroll-row';
            container.innerHTML = featured.map(post => {
                const content = post.content || '';
                const isPoetry = post.type === 'poetry';
                const preview = content.length > 200 ? content.substring(0, 200) + '...' : content;
                const ws = isPoetry ? 'pre-wrap' : 'normal';
                return `<div class="random-card" onclick="showPost('${post.id}')">
                        <div class="random-card-title">${post.title || 'Без назви'}</div>
                        <div class="random-card-author" onclick="event.stopPropagation(); showUserProfile('${post.userId}')" style="cursor:pointer;">&#9997;&#65039; ${getUserName(post.userId)}</div>
                        <div class="random-card-content post-content" style="white-space:${ws};">${preview}</div>
                    </div>`;
            }).join('');
        }

        // Load Random Poetry
        function loadRandomPoetry() {
            const poetry = window.allPosts.filter(p => p.type === 'poetry');
            const random = [...poetry].sort(() => 0.5 - Math.random()).slice(0, 8);
            const container = document.getElementById('randomPoetry');
            if (random.length === 0) {
                container.className = '';
                container.innerHTML = '<p style="color: var(--text-light);">Немає віршів</p>';
                return;
            }
            container.className = 'thoughts-scroll-row';
            container.innerHTML = random.map(post => {
                const content = post.content || '';
                const preview = content.length > 200 ? content.substring(0, 200) + '...' : content;
                return `<div class="random-card" onclick="showPost('${post.id}')">
                        <div class="random-card-title">${post.title || 'Без назви'}</div>
                        <div class="random-card-author" onclick="event.stopPropagation(); showUserProfile('${post.userId}')" style="cursor:pointer;">✍️ ${getUserName(post.userId)}</div>
                        <div class="random-card-content post-content" style="white-space:pre-wrap;">${preview}</div>
                    </div>`;
            }).join('');
        }

        // Load Random Thoughts
        function loadRandomThoughts() {
            const thoughts = window.allPosts.filter(p => p.type === 'thought');
            const random = [...thoughts].sort(() => 0.5 - Math.random()).slice(0, 8);
            const container = document.getElementById('randomThoughts');
            
            if (random.length === 0) {
                container.innerHTML = '<p style="color: var(--text-light);">Немає думок</p>';
                return;
            }

            container.className = 'thoughts-scroll-row';
            container.innerHTML = random.map(post => {
                const content = post.content || '';
                const preview = content.length > 200 ? content.substring(0, 200) + '...' : content;
                
                return `
                    <div class="random-card" onclick="showPost('${post.id}')">
                        <div class="random-card-title">${post.title || 'Без назви'}</div>
                        <div class="random-card-author" onclick="event.stopPropagation(); showUserProfile('${post.userId}')" style="cursor:pointer;">✍️ ${getUserName(post.userId)}</div>
                        <div class="random-card-content" style="white-space: normal;">${preview}</div>
                    </div>
                `;
            }).join('');
        }

        // Load Users List
        function renderRandomPoets() {
            const container = document.getElementById('usersList');
            if (!container || window.allUsers.length === 0) return;

            const shuffled = [...window.allUsers].sort(() => 0.5 - Math.random()).slice(0, 2);

            container.style.transition = 'opacity 0.4s ease';
            container.style.opacity = '0';

            setTimeout(() => {
                container.innerHTML = shuffled.map(user => `
                    <div class="user-item" style="cursor: pointer;" onclick="showUserProfile('${user.id}')">
                        ${user.avatarUrl
                            ? `<img src="${user.avatarUrl}" alt="${user.name}" style="width:38px;height:38px;border-radius:50%;object-fit:cover;flex-shrink:0;border:2px solid var(--accent);">`
                            : `<div class="user-avatar">${user.name.charAt(0).toUpperCase()}</div>`
                        }
                        <div class="user-info">
                            <div class="user-name">${user.name}</div>
                            <div class="user-stats">📝 ${user.postsCount || 0} публікацій</div>
                            ${user.bio ? `<div style="font-size: 0.82rem; color: var(--text-lighter); font-style: italic; margin-top: 0.2rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 200px;">${user.bio}</div>` : ''}
                        </div>
                    </div>
                `).join('');
                container.style.opacity = '1';
            }, 400);
        }

        function loadUsersList() {
            const container = document.getElementById('usersList');
            if (window.allUsers.length === 0) {
                container.innerHTML = '<p style="color: var(--text-light);">Немає користувачів</p>';
                return;
            }

            renderRandomPoets();

            // Очищуємо попередній інтервал якщо є
            if (window._poetsInterval) clearInterval(window._poetsInterval);
            window._poetsInterval = setInterval(() => {
                // Міняємо тільки якщо блок видимий
                if (document.getElementById('usersList')?.offsetParent !== null) {
                    renderRandomPoets();
                }
            }, 6000);
        }

        // Helper function
        function getUserName(userId) {
            const user = window.allUsers.find(u => u.id === userId);
            return user ? user.name : 'Невідомий автор';
        }

        // Navigation Functions
        function hideAllPages() {
            ['homePage','profilePage','allPostsPage','poetsPage','adminPage','postPage','groupsPage','groupPage','messagesPage'].forEach(id => {
                const el = document.getElementById(id);
                if (el) el.style.display = 'none';
            });
            setHomeSearchVisible(false);
        }

        window.showHome = function() {
            hideAllPages();
            document.getElementById('homePage').style.display = 'block';
            setHomeSearchVisible(true);
        };

        window.showPoets = function() {
            hideAllPages();
            document.getElementById('poetsPage').style.display = 'block';
            loadAllPoets();
        };

        window.showAllPosts = function() {
            hideAllPages();
            document.getElementById('allPostsPage').style.display = 'block';
            loadAllPostsPage();
        };

        window.showGroups = function() {
            if (typeof updateURL === 'function') updateURL('groups', true);
            hideAllPagesInternal ? hideAllPagesInternal() : hideAllPages();
            if (typeof hideHeaderFilter === 'function') hideHeaderFilter();
            if (typeof setHomeSearchVisible === 'function') setHomeSearchVisible(false);
            document.getElementById('groupsPage').style.display = 'block';
            const btn = document.getElementById('createGroupBtn');
            if (btn) btn.style.display = window.currentUser ? 'block' : 'none';
            loadGroupsList();
        };

        window.showGroupPage = function(groupId) {
            if (typeof updateURL === 'function') updateURL('group/' + groupId, true);
            hideAllPagesInternal ? hideAllPagesInternal() : hideAllPages();
            if (typeof hideHeaderFilter === 'function') hideHeaderFilter();
            if (typeof setHomeSearchVisible === 'function') setHomeSearchVisible(false);
            document.getElementById('groupPage').style.display = 'block';
            loadGroupPage(groupId);
        };

        window.showMyProfile = function() {
            if (!window.currentUser) {
                alert('Спочатку увійдіть в систему');
                return;
            }
            hideAllPages();
            document.getElementById('profilePage').style.display = 'block';
            loadMyProfile();
        };

        window.showUserProfile = async function(userId) {
            hideAllPages();
            document.getElementById('profilePage').style.display = 'block';
            loadUserProfile(userId);
        };

        window.showAdminPanel = function() {
            if (!window.isAdmin) {
                alert('Доступ заборонено');
                return;
            }
            hideAllPages();
            document.getElementById('adminPage').style.display = 'block';

            // Activate stats tab by default
            document.querySelectorAll('.admin-tab-btn').forEach((btn, i) => btn.classList.toggle('active', i === 0));
            document.getElementById('adminTabStats').style.display = 'block';
            document.getElementById('adminTabPosts').style.display = 'none';
            document.getElementById('adminTabUsers').style.display = 'none';
            document.getElementById('adminTabTheme').style.display = 'none';

            loadAdminPanel();
        };

        // New Post Modal
        window.showNewPostModal = function() {
            document.getElementById('newPostModal').classList.add('active');
        };

        window.closeNewPostModal = function() {
            document.getElementById('newPostModal').classList.remove('active');
            document.getElementById('newPostTitle').value = '';
            document.getElementById('newPostContent').value = '';
            document.getElementById('newPostHashtags').value = '';
        };

        // Create Post
        window.handleCreatePost = async function() {
            if (!window.currentUser) {
                alert('Спочатку увійдіть в систему');
                return;
            }

            const type = document.getElementById('newPostType').value;
            const title = document.getElementById('newPostTitle').value.trim();
            const content = document.getElementById('newPostContent').value.trim();
            const hashtags = document.getElementById('newPostHashtags').value.trim();

            if (!title || !content) {
                alert('Заповніть назву та текст');
                return;
            }

            try {
                const newPostRef = push(ref(database, 'posts'));
                await set(newPostRef, {
                    userId: window.currentUser.uid,
                    type: type,
                    title: title,
                    content: content,
                    hashtags: hashtags,
                    date: Date.now(),
                    featured: false
                });

                // Update user stats
                const userSnapshot = await get(ref(database, `users/${window.currentUser.uid}`));
                const userData = userSnapshot.val();
                await set(ref(database, `users/${window.currentUser.uid}`), {
                    ...userData,
                    postsCount: (userData.postsCount || 0) + 1,
                    poetryCount: type === 'poetry' ? (userData.poetryCount || 0) + 1 : userData.poetryCount,
                    thoughtsCount: type === 'thought' ? (userData.thoughtsCount || 0) + 1 : userData.thoughtsCount
                });

                alert('✅ Публікація додана!');
                closeNewPostModal();
                showMyProfile();
            } catch (error) {
                console.error('Error creating post:', error);
                alert('❌ Помилка створення публікації');
            }
        };

        // Load My Profile
        async function loadMyProfile() {
            if (!window.currentUser) return;

            window.currentProfileUserId = window.currentUser.uid;
            window.profileCurrentFilter = 'all';
            window.profileSearchQuery = '';
            window.profileSearchType = 'all';
            window.profileHashtagFilter = null;
            document.getElementById('profileSearchResultsBanner').style.display = 'none';

            const userSnapshot = await get(ref(database, `users/${window.currentUser.uid}`));
            const userData = userSnapshot.val();

            document.getElementById('profileName').textContent = userData.name || 'Користувач';
            document.getElementById('profileStats').innerHTML = `
                📝 Всього публікацій: ${userData.postsCount || 0} | 
                📜 Віршів: ${userData.poetryCount || 0} | 
                💭 Думок: ${userData.thoughtsCount || 0}
            `;
            loadProfileGroups(window.currentUser.uid);

            // Bio - своя сторінка: показуємо кнопку редагування
            const bioText = document.getElementById('profileBioText');
            const editBioBtn = document.getElementById('editBioBtn');
            if (userData.bio) {
                bioText.textContent = userData.bio;
                bioText.style.color = 'var(--text-main)';
            } else {
                bioText.textContent = 'Біографія не додана. Розкажіть про себе!';
                bioText.style.color = 'var(--text-lighter)';
            }
            setProfileAvatar(userData.avatarUrl || '');
            editBioBtn.style.display = 'inline-block';
            document.getElementById('bioEditForm').style.display = 'none';

            document.getElementById('newPostBtn').style.display = 'block';
            document.getElementById('shareProfileBtn').style.display = 'block';
            document.getElementById('myFriendsBtn').style.display = 'block';
            document.getElementById('profileBtnsRow').style.display = 'flex';
            // filter is now in header — just reset state
            document.querySelectorAll('#headerFilterTabs .filter-tab').forEach(tab => tab.classList.remove('active'));
            const allHeaderTab = document.querySelector('#headerFilterTabs .filter-tab');
            if (allHeaderTab) allHeaderTab.classList.add('active');

            renderProfilePosts();
        }

        // Load User Profile
        async function loadUserProfile(userId) {
            window.currentProfileUserId = userId;
            window.profileCurrentFilter = 'all';
            window.profileSearchQuery = '';
            window.profileSearchType = 'all';
            window.profileHashtagFilter = null;
            document.getElementById('profileSearchResultsBanner').style.display = 'none';

            const userSnapshot = await get(ref(database, `users/${userId}`));
            const userData = userSnapshot.val();

            document.getElementById('profileName').textContent = userData.name || 'Користувач';
            document.getElementById('profileStats').innerHTML = `
                📝 Всього публікацій: ${userData.postsCount || 0} | 
                📜 Віршів: ${userData.poetryCount || 0} | 
                💭 Думок: ${userData.thoughtsCount || 0}
            `;
            loadProfileGroups(userId);

            // Bio - чужа сторінка: без кнопки редагування
            const bioText = document.getElementById('profileBioText');
            const editBioBtn = document.getElementById('editBioBtn');
            if (userData.bio) {
                bioText.textContent = userData.bio;
                bioText.style.color = 'var(--text-main)';
            } else {
                bioText.textContent = '';
            }
            setProfileAvatar(userData.avatarUrl || '');
            editBioBtn.style.display = 'none';
            document.getElementById('bioEditForm').style.display = 'none';

            // SEO
            updateMeta({
                title: userData.name || 'Профіль автора',
                description: userData.bio ? userData.bio.substring(0, 160) : `Профіль автора ${userData.name || ''} на платформі KonVi`,
                url: '/profile/' + userId,
                image: userData.avatarUrl || undefined
            });

            // Кнопки друзів/повідомлень
            await updateFriendBtn(userId);

            document.getElementById('newPostBtn').style.display = 'none';
            document.getElementById('myFriendsBtn').style.display = 'none';
            document.getElementById('shareProfileBtn').style.display = 'block';
            document.getElementById('profileBtnsRow').style.display = 'flex';
            // filter is now in header — just reset state
            document.querySelectorAll('#headerFilterTabs .filter-tab').forEach(tab => tab.classList.remove('active'));
            const allHeaderTab2 = document.querySelector('#headerFilterTabs .filter-tab');
            if (allHeaderTab2) allHeaderTab2.classList.add('active');

            renderProfilePosts();
        }

        // Share Profile Function
        window.shareProfile = function() {
            if (!window.currentProfileUserId) return;
            copyProfileLink(window.currentProfileUserId);
        };

        // Avatar display helper
        function setProfileAvatar(url) {
            const img = document.getElementById('profileAvatarImg');
            const placeholder = document.getElementById('profileAvatarPlaceholder');
            if (url) {
                img.src = url;
                img.style.display = 'block';
                placeholder.style.display = 'none';
            } else {
                img.src = '';
                img.style.display = 'none';
                placeholder.style.display = 'flex';
            }
        }

        // Bio Edit Functions
        window.showEditBio = function() {
            const currentBio = document.getElementById('profileBioText').textContent;
            const textarea = document.getElementById('bioInput');
            const isPlaceholder = currentBio === 'Біографія не додана. Розкажіть про себе!';
            textarea.value = isPlaceholder ? '' : currentBio;
            // Fill avatar URL field
            const avatarInput = document.getElementById('avatarUrlInput');
            const img = document.getElementById('profileAvatarImg');
            avatarInput.value = img.style.display !== 'none' ? img.src : '';
            document.getElementById('bioEditForm').style.display = 'block';
            document.getElementById('editBioBtn').style.display = 'none';
            textarea.focus();
        };

        window.cancelEditBio = function() {
            document.getElementById('bioEditForm').style.display = 'none';
            document.getElementById('editBioBtn').style.display = 'inline-block';
        };

        window.saveBio = async function() {
            if (!window.currentUser) return;

            const bio = document.getElementById('bioInput').value.trim();
            const avatarUrl = document.getElementById('avatarUrlInput').value.trim();

            try {
                const userRef = ref(database, `users/${window.currentUser.uid}`);
                const userSnapshot = await get(userRef);
                const userData = userSnapshot.val();

                await set(userRef, { ...userData, bio, avatarUrl });

                // Оновлюємо відображення
                const bioText = document.getElementById('profileBioText');
                if (bio) {
                    bioText.textContent = bio;
                    bioText.style.color = 'var(--text-main)';
                } else {
                    bioText.textContent = 'Біографія не додана. Розкажіть про себе!';
                    bioText.style.color = 'var(--text-lighter)';
                }

                setProfileAvatar(avatarUrl);

                document.getElementById('bioEditForm').style.display = 'none';
                document.getElementById('editBioBtn').style.display = 'inline-block';
            } catch (error) {
                console.error('Error saving bio:', error);
                alert('❌ Помилка збереження: ' + error.message);
            }
        };

        // Delete Post
        window.deletePost = async function(postId) {
            if (!confirm('Ви впевнені, що хочете видалити цю публікацію?')) return;

            try {
                const postSnapshot = await get(ref(database, `posts/${postId}`));
                const post = postSnapshot.val();

                await remove(ref(database, `posts/${postId}`));

                // Update user stats
                const userSnapshot = await get(ref(database, `users/${window.currentUser.uid}`));
                const userData = userSnapshot.val();
                await set(ref(database, `users/${window.currentUser.uid}`), {
                    ...userData,
                    postsCount: Math.max(0, (userData.postsCount || 0) - 1),
                    poetryCount: post.type === 'poetry' ? Math.max(0, (userData.poetryCount || 0) - 1) : userData.poetryCount,
                    thoughtsCount: post.type === 'thought' ? Math.max(0, (userData.thoughtsCount || 0) - 1) : userData.thoughtsCount
                });

                alert('✅ Публікацію видалено');
                loadMyProfile();
            } catch (error) {
                console.error('Error deleting post:', error);
                alert('❌ Помилка видалення');
            }
        };


        window.editPost = async function(postId) {
            const snap = await get(ref(database, `posts/${postId}`));
            if (!snap.exists()) { alert('Публікацію не знайдено'); return; }
            const post = snap.val();
            document.getElementById('editPostId').value = postId;
            document.getElementById('editPostType').value = post.type || 'poetry';
            document.getElementById('editPostTitle').value = post.title || '';
            document.getElementById('editPostContent').value = post.content || '';
            document.getElementById('editPostHashtags').value = post.hashtags || '';
            document.getElementById('editPostModal').classList.add('active');
        };

        window.closeEditPostModal = function() {
            document.getElementById('editPostModal').classList.remove('active');
        };

        window.handleSavePost = async function() {
            const postId = document.getElementById('editPostId').value;
            const type = document.getElementById('editPostType').value;
            const title = document.getElementById('editPostTitle').value.trim();
            const content = document.getElementById('editPostContent').value.trim();
            const hashtags = document.getElementById('editPostHashtags').value.trim();
            if (!title || !content) { alert('Заповніть назву та текст'); return; }
            try {
                const snap = await get(ref(database, `posts/${postId}`));
                const existing = snap.val();
                await set(ref(database, `posts/${postId}`), { ...existing, type, title, content, hashtags });
                closeEditPostModal();
                alert('✅ Публікацію збережено');
                loadMyProfile();
            } catch(e) {
                console.error('Edit post error:', e);
                alert('❌ Помилка збереження');
            }
        };

        // ===== HEADER FILTER BAR SYSTEM =====
        // mode: 'allPosts' | 'profile' | null
        window.headerFilterMode = null;

        function getHeader() { return document.querySelector('.platform-header'); }

        function showHeaderFilter(mode) {
            window.headerFilterMode = mode;
            const header = getHeader();
            const tabs = document.getElementById('headerFilterTabs');
            const inp = document.getElementById('headerSearchInput');
            const clearBtn = document.getElementById('headerClearBtn');
            const toggle = document.getElementById('headerFilterToggle');
            if (!header) return;

            // Mark header as having active filter (shows toggle button)
            header.classList.add('filter-active');
            // Keep panel CLOSED by default — user opens with arrow
            header.classList.remove('filter-open');
            if (toggle) toggle.textContent = '▼';

            if (mode === 'allPosts') {
                inp.placeholder = 'Пошук публікацій...';
                inp.value = window.allPostsSearchQuery || '';
                clearBtn.style.display = window.allPostsSearchQuery ? 'block' : 'none';
                const st = window.allPostsSearchType || 'all';
                const r = document.querySelector(`input[name="headerSType"][value="${st}"]`);
                if (r) r.checked = true;
                tabs.innerHTML = `
                    <div class="filter-tab ${window.allPostsTypeFilter==='all'?'active':''}" onclick="headerFilterAllPostsType('all')">Усі</div>
                    <div class="filter-tab ${window.allPostsTypeFilter==='poetry'?'active':''}" onclick="headerFilterAllPostsType('poetry')">Поезія</div>
                    <div class="filter-tab ${window.allPostsTypeFilter==='thought'?'active':''}" onclick="headerFilterAllPostsType('thought')">Думки</div>
                `;
                document.getElementById('headerSearchBtn').onclick = () => {
                    window.allPostsSearchQuery = inp.value.trim();
                    const stype = document.querySelector('input[name="headerSType"]:checked');
                    window.allPostsSearchType = stype ? stype.value : 'all';
                    clearBtn.style.display = window.allPostsSearchQuery ? 'block' : 'none';
                    window.allPostsCurrentPage = 1;
                    renderAllPostsPage();
                };
                inp.onkeypress = (e) => { if (e.key === 'Enter') document.getElementById('headerSearchBtn').onclick(); };
                // Show hashtags, hide TOC
                document.getElementById('headerHashtagSection').style.display = 'block';
                document.getElementById('headerTocSection').style.display = 'none';
                buildAllPostsHashtagChips();
            } else if (mode === 'profile') {
                inp.placeholder = 'Пошук публікацій...';
                inp.value = window.profileSearchQuery || '';
                clearBtn.style.display = window.profileSearchQuery ? 'block' : 'none';
                const st = window.profileSearchType || 'all';
                const r = document.querySelector(`input[name="headerSType"][value="${st}"]`);
                if (r) r.checked = true;
                const cf = window.profileCurrentFilter || 'all';
                tabs.innerHTML = `
                    <div class="filter-tab ${cf==='all'?'active':''}" onclick="headerFilterProfileType('all')">Усі</div>
                    <div class="filter-tab ${cf==='poetry'?'active':''}" onclick="headerFilterProfileType('poetry')">Поезія</div>
                    <div class="filter-tab ${cf==='thought'?'active':''}" onclick="headerFilterProfileType('thought')">Думки</div>
                    <div class="filter-tab ${cf==='favorites'?'active':''}" id="headerFavoritesTab" onclick="headerFilterProfileType('favorites')">⭐ Обране</div>
                `;
                document.getElementById('headerSearchBtn').onclick = () => {
                    window.profileSearchQuery = inp.value.trim();
                    const stype = document.querySelector('input[name="headerSType"]:checked');
                    window.profileSearchType = stype ? stype.value : 'all';
                    clearBtn.style.display = window.profileSearchQuery ? 'block' : 'none';
                    window.profileCurrentPage = 1;
                    renderProfilePosts();
                };
                inp.onkeypress = (e) => { if (e.key === 'Enter') document.getElementById('headerSearchBtn').onclick(); };
                // Show TOC, hide hashtags
                document.getElementById('headerTocSection').style.display = 'block';
                document.getElementById('headerHashtagSection').style.display = 'none';
            }
        }

        window.hideHeaderFilter = function() {
            window.headerFilterMode = null;
            const header = getHeader();
            if (!header) return;
            header.classList.remove('filter-active', 'filter-open');
            const toggle = document.getElementById('headerFilterToggle');
            if (toggle) toggle.textContent = '▼';
            document.getElementById('headerTocSection').style.display = 'none';
            document.getElementById('headerHashtagSection').style.display = 'none';
        };

        // Toggle open/close (arrow button)
        window.toggleHeaderFilter = function() {
            const header = getHeader();
            if (!header) return;
            const isOpen = header.classList.toggle('filter-open');
            const toggle = document.getElementById('headerFilterToggle');
            if (toggle) toggle.textContent = isOpen ? '▲' : '▼';
        };

        window.clearHeaderSearch = function() {
            const inp = document.getElementById('headerSearchInput');
            const clearBtn = document.getElementById('headerClearBtn');
            if (inp) inp.value = '';
            if (clearBtn) clearBtn.style.display = 'none';
            if (window.headerFilterMode === 'allPosts') {
                window.allPostsSearchQuery = '';
                window.allPostsCurrentPage = 1;
                renderAllPostsPage();
            } else if (window.headerFilterMode === 'profile') {
                window.profileSearchQuery = '';
                window.profileCurrentPage = 1;
                renderProfilePosts();
            }
        };

        window.headerFilterAllPostsType = function(type) {
            window.allPostsTypeFilter = type;
            window.allPostsCurrentPage = 1;
            document.querySelectorAll('#headerFilterTabs .filter-tab').forEach(t => t.classList.remove('active'));
            event.target.classList.add('active');
            renderAllPostsPage();
        };

        window.headerFilterProfileType = function(type) {
            window.profileCurrentFilter = type;
            window.profileCurrentPage = 1;
            document.querySelectorAll('#headerFilterTabs .filter-tab').forEach(t => t.classList.remove('active'));
            event.target.classList.add('active');
            renderProfilePosts();
        };

        // ===== PAGINATION HELPER =====
        function renderPagination(el, current, total, onPage) {
            if (!el || total <= 1) { if (el) el.innerHTML = ''; return; }
            const pages = [];
            // always show first, last, current ±2
            const shown = new Set();
            [1, total].forEach(p => shown.add(p));
            for (let p = Math.max(1, current - 2); p <= Math.min(total, current + 2); p++) shown.add(p);
            const sorted = [...shown].sort((a,b) => a-b);
            let html = `<button class="page-btn" onclick="(${onPage.toString()})(${current-1})" ${current===1?'disabled':''}>‹</button>`;
            let prev = 0;
            for (const p of sorted) {
                if (p - prev > 1) html += `<span style="padding:0 4px; color:var(--text-lighter)">…</span>`;
                html += `<button class="page-btn ${p===current?'active':''}" onclick="(${onPage.toString()})(${p})">${p}</button>`;
                prev = p;
            }
            html += `<button class="page-btn" onclick="(${onPage.toString()})(${current+1})" ${current===total?'disabled':''}>›</button>`;
            el.innerHTML = html;
        }

        // Keep old toggle functions as no-ops for safety
        window.toggleAllPostsSearchBar = function() {};
        window.toggleProfileSearchBar = function() {};

        // All Posts Page state
        window.allPostsTypeFilter = 'all';
        window.allPostsSearchQuery = '';
        window.allPostsSearchType = 'all';
        window.allPostsHashtagFilter = null;

        // Load All Posts Page
        function loadAllPostsPage() {
            window.allPostsTypeFilter = 'all';
            window.allPostsSearchQuery = '';
            window.allPostsSearchType = 'all';
            window.allPostsHashtagFilter = null;

            const inp = document.getElementById('allPostsSearchInput');
            const clearBtn = document.getElementById('clearAllPostsSearchBtn');
            const banner = document.getElementById('allPostsSearchResultsBanner');
            const bar = document.getElementById('allPostsSearchFilterBar');
            const toggleBtn = document.getElementById('allPostsSearchToggleBtn');
            if (inp) inp.value = '';
            if (clearBtn) clearBtn.style.display = 'none';
            if (banner) banner.style.display = 'none';
            if (bar) bar.classList.remove('active');
            if (toggleBtn) toggleBtn.classList.remove('active');

            // Reset filter tabs
            document.querySelectorAll('#allPostsPage .filter-tab').forEach(t => t.classList.remove('active'));
            const allTab = document.querySelector('#allPostsPage .filter-tab[data-filter="all"]');
            if (allTab) allTab.classList.add('active');

            buildAllPostsHashtagChips();
            renderAllPostsPage();
        }

        function buildAllPostsHashtagChips() {
            const allHashtags = {};
            window.allPosts.forEach(post => {
                if (post.hashtags) {
                    const tags = typeof post.hashtags === 'string'
                        ? post.hashtags.split(' ').map(t => t.trim()).filter(Boolean)
                        : post.hashtags;
                    tags.forEach(t => { allHashtags[t] = (allHashtags[t] || 0) + 1; });
                }
            });
            const sorted = Object.entries(allHashtags).sort((a, b) => b[1] - a[1]).slice(0, 25);
            const listEl = document.getElementById('allPostsHashtagChipsList');
            const containerEl = document.getElementById('allPostsHashtagChips');
            if (!listEl || !containerEl) return;
            if (sorted.length === 0) { containerEl.style.display = 'none'; return; }
            containerEl.style.display = 'flex';
            listEl.innerHTML = sorted.map(([tag, count]) =>
                `<span class="home-hashtag-chip ${window.allPostsHashtagFilter === tag ? 'active' : ''}"
                       data-tag="${tag}"
                       onclick="toggleAllPostsHashtag('${tag}')">${tag} (${count})</span>`
            ).join('');
        }

        window.toggleAllPostsHashtag = function(tag) {
            window.allPostsHashtagFilter = window.allPostsHashtagFilter === tag ? null : tag;
            document.querySelectorAll('#allPostsHashtagChipsList .home-hashtag-chip').forEach(c => {
                c.classList.toggle('active', c.dataset.tag === window.allPostsHashtagFilter);
            });
            renderAllPostsPage();
        };

        window.filterAllPosts = function(type, event) {
            window.allPostsTypeFilter = type;
            document.querySelectorAll('#allPostsPage .filter-tab').forEach(t => t.classList.remove('active'));
            if (event && event.target) event.target.classList.add('active');
            renderAllPostsPage();
        };

        window.searchAllPosts = function() {
            const inp = document.getElementById('allPostsSearchInput');
            const clearBtn = document.getElementById('clearAllPostsSearchBtn');
            window.allPostsSearchQuery = inp ? inp.value.trim() : '';
            window.allPostsSearchType = document.querySelector('input[name="allPostsSearchType"]:checked')?.value || 'all';
            if (clearBtn) clearBtn.style.display = window.allPostsSearchQuery ? 'block' : 'none';
            renderAllPostsPage();
        };

        window.clearAllPostsSearch = function() {
            const inp = document.getElementById('allPostsSearchInput');
            const clearBtn = document.getElementById('clearAllPostsSearchBtn');
            if (inp) inp.value = '';
            if (clearBtn) clearBtn.style.display = 'none';
            window.allPostsSearchQuery = '';
            window.allPostsHashtagFilter = null;
            document.querySelectorAll('#allPostsHashtagChipsList .home-hashtag-chip').forEach(c => c.classList.remove('active'));
            renderAllPostsPage();
        };

        const POSTS_PER_PAGE = 20;

        function getFilteredAllPosts() {
            let posts = [...window.allPosts];
            if (window.allPostsTypeFilter !== 'all') posts = posts.filter(p => p.type === window.allPostsTypeFilter);
            if (window.allPostsHashtagFilter) posts = posts.filter(p => p.hashtags && (
                typeof p.hashtags === 'string' ? p.hashtags.includes(window.allPostsHashtagFilter) : p.hashtags.includes(window.allPostsHashtagFilter)
            ));
            if (window.allPostsSearchQuery) {
                const query = window.allPostsSearchQuery.toLowerCase();
                const st = window.allPostsSearchType || 'all';
                posts = posts.filter(p => {
                    const t = p.title && p.title.toLowerCase().includes(query);
                    const c = p.content && p.content.toLowerCase().includes(query);
                    const h = p.hashtags && (typeof p.hashtags === 'string' ? p.hashtags.toLowerCase().includes(query) : p.hashtags.some(x => x.toLowerCase().includes(query)));
                    return st === 'title' ? t : st === 'content' ? c : (t || c || h);
                });
            }
            return posts.sort((a, b) => b.date - a.date);
        }

        function renderAllPostsPage(page) {
            if (page !== undefined) window.allPostsCurrentPage = page;
            if (!window.allPostsCurrentPage) window.allPostsCurrentPage = 1;
            const container = document.getElementById('allPostsContainer');
            const banner = document.getElementById('allPostsSearchResultsBanner');
            const paginationEl = document.getElementById('allPostsPagination');
            const posts = getFilteredAllPosts();

            if (banner) {
                if (window.allPostsSearchQuery || window.allPostsHashtagFilter) {
                    banner.style.display = 'block';
                    const parts = [];
                    if (window.allPostsSearchQuery) parts.push(`"<strong>${window.allPostsSearchQuery}</strong>"`);
                    if (window.allPostsHashtagFilter) parts.push(`хештег <strong>${window.allPostsHashtagFilter}</strong>`);
                    banner.innerHTML = `Знайдено <strong>${posts.length}</strong> публікацій за ${parts.join(' + ')}`;
                } else { banner.style.display = 'none'; }
            }

            if (posts.length === 0) {
                container.innerHTML = '<p style="color: var(--text-light); text-align: center; padding: 2rem;">Нічого не знайдено</p>';
                if (paginationEl) paginationEl.innerHTML = '';
                return;
            }

            const totalPages = Math.ceil(posts.length / POSTS_PER_PAGE);
            if (window.allPostsCurrentPage > totalPages) window.allPostsCurrentPage = totalPages;
            const start = (window.allPostsCurrentPage - 1) * POSTS_PER_PAGE;
            const pagePosts = posts.slice(start, start + POSTS_PER_PAGE);

            container.innerHTML = pagePosts.map(post => {
                const content = post.content || '';
                const preview = content.length > 300 ? content.substring(0, 300) + '...' : content;
                return `<div class="featured-post" style="cursor:pointer;" onclick="showPost('${post.id}')">
                        <span class="post-type-badge">${post.type === 'poetry' ? 'ПОЕЗІЯ' : 'ДУМКА'}</span>
                        <h3 class="post-title">${post.title || 'Без назви'}</h3>
                        <div class="post-author" style="cursor: pointer;" onclick="event.stopPropagation(); showUserProfile('${post.userId}')">✍️ ${getUserName(post.userId)}</div>
                        <div class="post-content" style="white-space: pre-wrap;">${preview}</div>
                        <div class="post-meta">
                            <span>📅 ${new Date(post.date).toLocaleDateString('uk-UA')}</span>
                            ${post.hashtags ? '<span>🏷️ ' + post.hashtags + '</span>' : ''}
                        </div>
                    </div>`;
            }).join('');

            renderPagination(paginationEl, window.allPostsCurrentPage, totalPages, (p) => {
                renderAllPostsPage(p);
                document.getElementById('allPostsPage').scrollIntoView({ behavior: 'smooth', block: 'start' });
            });
        }

        // Legacy filterPosts (keep for safety, redirects to new)
        window.filterPosts = function(type) { window.filterAllPosts(type, window.event); };

        // Load All Poets
        function loadAllPoets() {
            // Reset search state
            window.poetsSearchQuery = '';
            const inp = document.getElementById('poetsSearchInput');
            const btn = document.getElementById('poetsClearBtn');
            const banner = document.getElementById('poetsSearchResultsBanner');
            const bar = document.getElementById('poetsSearchFilterBar');
            const toggleBtn = document.getElementById('poetsSearchToggleBtn');
            if (inp) inp.value = '';
            if (btn) btn.style.display = 'none';
            if (banner) banner.style.display = 'none';
            // ensure bar is closed by default
            if (bar) bar.classList.remove('active');
            if (toggleBtn) toggleBtn.classList.remove('active');
            renderPoetsList();
        }

        // Load hashtag cloud
        function loadHashtagCloud() {
            const allHashtags = {};
            
            window.allPosts.forEach(post => {
                if (post.hashtags) {
                    let tags = [];
                    
                    // Підтримка і строк і масивів
                    if (typeof post.hashtags === 'string') {
                        tags = post.hashtags.split(' ').map(t => t.trim()).filter(t => t);
                    } else if (Array.isArray(post.hashtags)) {
                        tags = post.hashtags.map(t => t.trim()).filter(t => t);
                    }
                    
                    tags.forEach(tag => {
                        allHashtags[tag] = (allHashtags[tag] || 0) + 1;
                    });
                }
            });

            const sorted = Object.entries(allHashtags)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 10);

            const container = document.getElementById('hashtagCloud');
            
            if (sorted.length === 0) {
                container.innerHTML = '<p style="color: var(--text-light);">Немає хештегів</p>';
                return;
            }

            container.innerHTML = sorted.map(([tag, count]) => `
                <a href="#" class="hashtag-item">${tag} (${count})</a>
            `).join('');
        }

        // Хештеги завантажуються через refreshHomeIfReady()

        // Admin Panel Functions
        function loadAdminPanel() {
            loadAdminStats();
            loadAdminPostsList();
        }

        function loadAdminStats() {
            const now = Date.now();
            const sevenDaysAgo = now - 7 * 24 * 60 * 60 * 1000;
            const oneDayAgo = now - 24 * 60 * 60 * 1000;

            const totalPosts = window.allPosts.length;
            const totalPoetry = window.allPosts.filter(p => p.type === 'poetry').length;
            const totalThoughts = window.allPosts.filter(p => p.type === 'thought').length;
            const totalUsers = window.allUsers.length;
            const newUsers7d = window.allUsers.filter(u => u.createdAt && u.createdAt >= sevenDaysAgo).length;
            const newPosts7d = window.allPosts.filter(p => p.date && p.date >= sevenDaysAgo).length;
            const newPosts24h = window.allPosts.filter(p => p.date && p.date >= oneDayAgo).length;
            const featuredCount = window.allPosts.filter(p => p.featured).length;

            const grid = document.getElementById('adminStatsGrid');
            if (!grid) return;

            const statCard = (emoji, label, value, sub) => `
                <div style="background: var(--bg-card); border-radius: 12px; padding: 1.5rem; border: 1px solid var(--border-light); box-shadow: 0 2px 8px var(--shadow); text-align: center;">
                    <div style="font-size: 2rem; margin-bottom: 0.5rem;">${emoji}</div>
                    <div style="font-family: 'Philosopher', sans-serif; font-size: 2rem; font-weight: 700; color: var(--accent); line-height: 1;">${value}</div>
                    <div style="font-family: 'Philosopher', sans-serif; font-weight: 600; color: var(--primary); margin-top: 0.3rem;">${label}</div>
                    ${sub ? `<div style="font-size: 0.82rem; color: var(--text-lighter); margin-top: 0.3rem;">${sub}</div>` : ''}
                </div>
            `;

            grid.innerHTML =
                statCard('📝', 'Публікацій', totalPosts, `${totalPoetry} віршів · ${totalThoughts} думок`) +
                statCard('👥', 'Поетів', totalUsers, `+${newUsers7d} за 7 днів`) +
                statCard('📜', 'Нових публікацій (7 днів)', newPosts7d, `${newPosts24h} за останню добу`) +
                statCard('⭐', 'Обраних публікацій', featuredCount, 'відображаються на головній');

            // Activity chart (posts per day for last 7 days)
            const days = [];
            for (let i = 6; i >= 0; i--) {
                const dayStart = new Date(); dayStart.setHours(0,0,0,0); dayStart.setDate(dayStart.getDate() - i);
                const dayEnd = new Date(dayStart); dayEnd.setHours(23,59,59,999);
                const count = window.allPosts.filter(p => p.date >= dayStart.getTime() && p.date <= dayEnd.getTime()).length;
                const label = dayStart.toLocaleDateString('uk-UA', { day: 'numeric', month: 'short' });
                days.push({ label, count });
            }
            const maxCount = Math.max(...days.map(d => d.count), 1);
            const chartEl = document.getElementById('adminActivityChart');
            if (chartEl) {
                chartEl.innerHTML = `
                    <div style="display: flex; align-items: flex-end; gap: 0.75rem; height: 120px; padding-bottom: 2rem; position: relative;">
                        ${days.map(d => {
                            const h = Math.max(4, Math.round((d.count / maxCount) * 100));
                            return `
                                <div style="flex: 1; display: flex; flex-direction: column; align-items: center; gap: 0.3rem; height: 100%;">
                                    <div style="flex: 1; display: flex; align-items: flex-end; width: 100%;">
                                        <div style="width: 100%; height: ${h}%; background: linear-gradient(to top, var(--accent), var(--accent-light)); border-radius: 6px 6px 0 0; position: relative;" title="${d.count} публікацій">
                                            ${d.count > 0 ? `<span style="position:absolute;top:-20px;left:50%;transform:translateX(-50%);font-size:0.75rem;font-weight:700;color:var(--accent);">${d.count}</span>` : ''}
                                        </div>
                                    </div>
                                    <span style="font-size: 0.75rem; color: var(--text-lighter); white-space: nowrap;">${d.label}</span>
                                </div>
                            `;
                        }).join('')}
                    </div>
                `;
            }

            // New users list
            const newUsersEl = document.getElementById('adminNewUsersList');
            if (newUsersEl) {
                const recent = window.allUsers.filter(u => u.createdAt && u.createdAt >= sevenDaysAgo)
                    .sort((a, b) => (b.createdAt || 0) - (a.createdAt || 0));
                if (recent.length === 0) {
                    newUsersEl.innerHTML = '<p style="color: var(--text-lighter); text-align: center; padding: 1rem;">Нових користувачів за 7 днів немає</p>';
                } else {
                    newUsersEl.innerHTML = recent.map(u => `
                        <div style="display:flex; justify-content:space-between; align-items:center; padding: 0.6rem 0.5rem; border-bottom: 1px solid var(--border-light);">
                            <span style="font-weight:600; color: var(--primary);">👤 ${u.name || 'Без імені'}</span>
                            <span style="font-size:0.85rem; color: var(--text-lighter);">${new Date(u.createdAt).toLocaleDateString('uk-UA')}</span>
                        </div>
                    `).join('');
                }
            }
        }

        function loadAdminPostsList() {
            const container = document.getElementById('adminPostsList');
            
            if (window.allPosts.length === 0) {
                container.innerHTML = '<p style="color: var(--text-light); text-align: center;">Немає публікацій</p>';
                return;
            }

            const sorted = [...window.allPosts].sort((a, b) => b.date - a.date);

            container.innerHTML = sorted.map(post => {
                const content = post.content || '';
                const preview = content.length > 200 ? content.substring(0, 200) + '...' : content;
                const postId = post.id;
                const isFeatured = post.featured || false;
                
                console.log('Rendering post:', postId, 'featured:', isFeatured);
                
                return `
                    <div class="featured-post" style="border-left: 4px solid ${isFeatured ? '#d4a645' : 'transparent'};">
                        <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                            <div style="flex: 1;">
                                <span class="post-type-badge">${post.type === 'poetry' ? 'ПОЕЗІЯ' : 'ДУМКА'}</span>
                                ${isFeatured ? '<span class="post-type-badge" style="background: #d4a645; margin-left: 0.5rem;">⭐ ОБРАНЕ</span>' : ''}
                                <h3 class="post-title">${post.title || 'Без назви'}</h3>
                                <div class="post-author">✍️ ${getUserName(post.userId)}</div>
                                <div class="post-content" style="white-space: pre-wrap;">${preview}</div>
                                <div class="post-meta">
                                    <span>📅 ${new Date(post.date).toLocaleDateString('uk-UA')}</span>
                                    ${post.hashtags ? '<span>🏷️ ' + post.hashtags + '</span>' : ''}
                                </div>
                            </div>
                            <div class="post-actions" style="margin-left: 1rem;">
                                <button class="btn ${isFeatured ? 'btn-secondary' : 'btn-primary'} btn-small" 
                                        onclick="toggleFeatured('${postId}', ${!isFeatured})">
                                    ${isFeatured ? '⭐ Прибрати з обраних' : '⭐ Додати в обрані'}
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        window.toggleFeatured = async function(postId, featured) {
            if (!window.isAdmin) {
                alert('❌ Тільки адміністратор може керувати обраними постами');
                return;
            }

            console.log('toggleFeatured called with:', postId, featured);

            try {
                const postRef = ref(database, `posts/${postId}`);
                const postSnapshot = await get(postRef);
                
                if (!postSnapshot.exists()) {
                    console.error('Post not found in Firebase:', postId);
                    alert('❌ Пост не знайдено в базі даних. ID: ' + postId);
                    return;
                }

                const post = postSnapshot.val();
                console.log('Found post:', post);
                
                // Update the post with featured status
                await set(postRef, {
                    ...post,
                    featured: featured
                });

                alert(featured ? '✅ Додано в обрані!' : '✅ Прибрано з обраних!');
                loadAdminPanel();
            } catch (error) {
                console.error('Error toggling featured:', error);
                alert('❌ Помилка: ' + error.message + '\n\nПеревірте права доступу в Firebase Rules');
            }
        };

        // Profile Page Functions
        window.profileCurrentFilter = 'all';
        window.profileSearchQuery = '';
        window.profileSearchType = 'all';
        window.profileHashtagFilter = null;
        window.profileFavorites = new Set(JSON.parse(localStorage.getItem('profileFavorites') || '[]'));

        window.filterProfilePosts = function(filter, event) {
            if (event) {
                document.querySelectorAll('#profilePage .filter-tab').forEach(tab => tab.classList.remove('active'));
                event.target.classList.add('active');
            }
            window.profileCurrentFilter = filter;
            renderProfilePosts();
        };

        window.searchProfilePosts = function() {
            // input is now in header
            const inp = document.getElementById('headerSearchInput');
            window.profileSearchQuery = inp ? inp.value.trim() : '';
            const stype = document.querySelector('input[name="headerSType"]:checked');
            window.profileSearchType = stype ? stype.value : 'all';
            renderProfilePosts();
        };

        window.clearProfileSearch = function() {
            const inp = document.getElementById('headerSearchInput');
            if (inp) inp.value = '';
            window.profileSearchQuery = '';
            window.profileSearchType = 'all';
            window.profileHashtagFilter = null;
            const clearBtn = document.getElementById('headerClearBtn');
            if (clearBtn) clearBtn.style.display = 'none';
            const banner = document.getElementById('profileSearchResultsBanner');
            if (banner) banner.style.display = 'none';
            renderProfilePosts();
        };

        window.toggleProfileHashtag = function(tag) {
            window.profileHashtagFilter = window.profileHashtagFilter === tag ? null : tag;
            // chips removed from DOM — no-op
            renderProfilePosts();
        };

        function buildProfileHashtagChips(posts) {
            const allHashtags = {};
            posts.forEach(post => {
                if (post.hashtags) {
                    const tags = typeof post.hashtags === 'string'
                        ? post.hashtags.split(' ').map(t => t.trim()).filter(Boolean)
                        : post.hashtags;
                    tags.forEach(t => { allHashtags[t] = (allHashtags[t] || 0) + 1; });
                }
            });

            const sorted = Object.entries(allHashtags).sort((a, b) => b[1] - a[1]).slice(0, 20);
            // hashtag chips were in old filter bar (removed) — skip rendering
            return;
        }

        window.toggleProfileFavorite = function(postId) {
            console.log('Toggling favorite for:', postId);
            console.log('Current favorites:', [...window.profileFavorites]);
            
            if (window.profileFavorites.has(postId)) {
                window.profileFavorites.delete(postId);
                console.log('Removed from favorites');
            } else {
                window.profileFavorites.add(postId);
                console.log('Added to favorites');
            }
            
            localStorage.setItem('profileFavorites', JSON.stringify([...window.profileFavorites]));
            console.log('Updated favorites:', [...window.profileFavorites]);
            
            renderProfilePosts();
        };

        window.toggleProfileSearchBar = function() {
            const bar = document.getElementById('profileSearchFilterBar');
            const btn = document.getElementById('profileSearchToggleBtn');
            if (!bar) return;
            bar.classList.toggle('active');
            btn.classList.toggle('active', bar.classList.contains('active'));
        };

        window.scrollToPost = function(postId) {
            const el = document.getElementById('post-' + postId);
            if (el) {
                el.scrollIntoView({ behavior: 'smooth', block: 'start' });
                el.style.transition = 'box-shadow 0.3s';
                el.style.boxShadow = '0 0 0 3px var(--accent)';
                setTimeout(() => { el.style.boxShadow = ''; }, 1500);
            }
        };

        window.scrollToTOC = function() {
            // Відкрити панель фільтрів якщо закрита
            const header = getHeader();
            if (header && !header.classList.contains('filter-open')) {
                header.classList.add('filter-open');
                const toggle = document.getElementById('headerFilterToggle');
                if (toggle) toggle.textContent = '▲';
            }
            // Прокрутити до шапки
            window.scrollTo({ top: 0, behavior: 'smooth' });
        };

        function renderProfilePosts() {
            const userId = window.currentProfileUserId;
            if (!userId) return;

            // All user posts — used for building hashtag chips
            const allUserPosts = window.allPosts.filter(p => p.userId === userId);

            let posts = [...allUserPosts];

            // Apply type filter
            if (window.profileCurrentFilter === 'poetry') {
                posts = posts.filter(p => p.type === 'poetry');
            } else if (window.profileCurrentFilter === 'thought') {
                posts = posts.filter(p => p.type === 'thought');
            } else if (window.profileCurrentFilter === 'favorites') {
                posts = posts.filter(p => window.profileFavorites.has(p.id));
            }

            // Apply hashtag filter
            if (window.profileHashtagFilter) {
                posts = posts.filter(p => p.hashtags && (
                    typeof p.hashtags === 'string'
                        ? p.hashtags.includes(window.profileHashtagFilter)
                        : p.hashtags.includes(window.profileHashtagFilter)
                ));
            }

            // Apply search
            if (window.profileSearchQuery) {
                const query = window.profileSearchQuery.toLowerCase();
                const searchType = window.profileSearchType || 'all';
                posts = posts.filter(p => {
                    const titleMatch = p.title && p.title.toLowerCase().includes(query);
                    const contentMatch = p.content && p.content.toLowerCase().includes(query);
                    const hashMatch = p.hashtags && (
                        typeof p.hashtags === 'string'
                            ? p.hashtags.toLowerCase().includes(query)
                            : p.hashtags.some(t => t.toLowerCase().includes(query))
                    );
                    if (searchType === 'title') return titleMatch;
                    if (searchType === 'content') return contentMatch;
                    return titleMatch || contentMatch || hashMatch;
                });
            }

            // Update search results banner
            const banner = document.getElementById('profileSearchResultsBanner');
            if (window.profileSearchQuery || window.profileHashtagFilter) {
                banner.style.display = 'block';
                const parts = [];
                if (window.profileSearchQuery) parts.push(`"<strong>${window.profileSearchQuery}</strong>"`);
                if (window.profileHashtagFilter) parts.push(`хештег <strong>${window.profileHashtagFilter}</strong>`);
                banner.innerHTML = `Знайдено <strong>${posts.length}</strong> публікацій за ${parts.join(' + ')}`;
            } else {
                banner.style.display = 'none';
            }

            // Build hashtag chips from ALL user posts
            buildProfileHashtagChips(allUserPosts);

            // Sort by date — newest first (handle both timestamp and string)
            posts.sort((a, b) => new Date(b.date) - new Date(a.date));

            const container = document.getElementById('profilePosts');
            const isOwnProfile = window.currentUser && window.currentUser.uid === userId;

            if (posts.length === 0) {
                container.innerHTML = '<p style="color: var(--text-light); text-align: center;">Немає публікацій</p>';
                return;
            }

            // Pagination
            if (!window.profileCurrentPage) window.profileCurrentPage = 1;
            const totalPages = Math.ceil(posts.length / POSTS_PER_PAGE);
            if (window.profileCurrentPage > totalPages) window.profileCurrentPage = Math.max(1, totalPages);
            const start = (window.profileCurrentPage - 1) * POSTS_PER_PAGE;
            const pagePosts = posts.slice(start, start + POSTS_PER_PAGE);

            container.innerHTML = pagePosts.map(post => {
                const content = post.content || '';
                const isFavorite = window.profileFavorites.has(post.id);
                return `<div class="card" style="margin-bottom: 2rem;" id="post-${post.id}">
                        <span class="post-type-badge">${post.type === 'poetry' ? 'ПОЕЗІЯ' : 'ДУМКА'}</span>
                        <h2 style="font-family: 'Philosopher', sans-serif; font-size: 1.8rem; color: var(--primary); margin: 0.8rem 0; cursor:pointer;" onclick="showPost('${post.id}')">${post.title || 'Без назви'}</h2>
                        <div style="color: var(--text-light); font-size: 0.95rem; margin-bottom: 1.2rem; font-style: italic;">📅 ${new Date(post.date).toLocaleDateString('uk-UA')}</div>
                        <div class="post-content" style="white-space: pre-wrap; line-height: 1.8; margin-bottom: 1rem;">${content}</div>
                        ${post.hashtags ? '<div style="margin: 1rem 0; color: var(--accent); font-weight: 600;">' + post.hashtags + '</div>' : ''}
                        <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                            <button class="btn ${isFavorite ? 'btn-primary' : 'btn-secondary'} btn-small" onclick="toggleProfileFavorite('${post.id}')">
                                ${isFavorite ? '❤️ В обраному' : '🤍 В обране'}
                            </button>
                            <button class="btn btn-secondary btn-small" onclick="scrollToTOC()">📑 До змісту</button>
                            <button class="btn btn-primary btn-small" onclick="downloadPostAsImage('${post.id}')">📥 Зберегти як фото</button>
                            ${isOwnProfile ? `<button class="btn btn-secondary btn-small" onclick="editPost('${post.id}')">✏️ Редагувати</button>` : ''}
                            ${isOwnProfile ? `<button class="btn btn-secondary btn-small" onclick="deletePost('${post.id}')">🗑️ Видалити</button>` : ''}
                        </div>
                    </div>`;
            }).join('');

            const paginationEl = document.getElementById('profilePagination');
            renderPagination(paginationEl, window.profileCurrentPage, totalPages, (p) => {
                window.profileCurrentPage = p;
                renderProfilePosts();
                document.getElementById('profilePage').scrollIntoView({ behavior: 'smooth', block: 'start' });
            });

            // Update TOC with ALL filtered posts (not just current page)
            updateProfileTOC(posts);
        }

        function updateProfileTOC(posts) {
            const list = document.getElementById('headerTocList');
            const section = document.getElementById('headerTocSection');
            if (!list || !section) return;

            if (posts.length === 0) {
                section.style.display = 'none';
                return;
            }

            section.style.display = 'block';
            list.innerHTML = posts.map((post, idx) => `
                <li>
                    <a href="javascript:void(0)" onclick="tocGoToPost('${post.id}', ${idx})"
                       style="text-decoration:none; color:var(--text-main); font-size:0.9rem; display:flex; gap:0.5rem; align-items:baseline; padding:0.15rem 0;">
                        <span style="color:var(--text-lighter); flex-shrink:0; min-width:1.5rem; font-size:0.78rem;">${idx + 1}.</span>
                        <span style="color:var(--accent); flex-shrink:0;">${post.type === 'poetry' ? '📜' : '💭'}</span>
                        <span style="overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">${post.title || 'Без назви'}</span>
                    </a>
                </li>
            `).join('');
        }

        // TOC navigation: jump to correct page then scroll to post
        window.tocGoToPost = function(postId, postIndex) {
            const page = Math.floor(postIndex / POSTS_PER_PAGE) + 1;
            if (window.profileCurrentPage !== page) {
                window.profileCurrentPage = page;
                renderProfilePosts();
                // Wait for render then scroll
                setTimeout(() => window.scrollToPost(postId), 80);
            } else {
                window.scrollToPost(postId);
            }
        };

        // Migration tool (для першого запуску)
        window.migrateOldPosts = async function() {
            if (!window.currentUser) {
                alert('Спочатку увійдіть як адміністратор');
                return;
            }

            if (!confirm('Ви впевнені? Це перенесе всі старі пости та прив\'яже їх до вашого акаунту.')) {
                return;
            }

            try {
                // Отримуємо старі пости
                const oldPostsSnapshot = await get(ref(database, 'posts'));
                let migrated = 0;

                oldPostsSnapshot.forEach((childSnapshot) => {
                    const post = childSnapshot.val();
                    
                    // Якщо у поста немає userId, додаємо поточного користувача
                    if (!post.userId) {
                        set(ref(database, `posts/${childSnapshot.key}`), {
                            ...post,
                            userId: window.currentUser.uid
                        });
                        migrated++;
                    }
                });

                // Оновлюємо статистику користувача
                if (migrated > 0) {
                    const userSnapshot = await get(ref(database, `users/${window.currentUser.uid}`));
                    const userData = userSnapshot.val();
                    
                    const poetryCount = window.allPosts.filter(p => p.userId === window.currentUser.uid && p.type === 'poetry').length;
                    const thoughtsCount = window.allPosts.filter(p => p.userId === window.currentUser.uid && p.type === 'thought').length;

                    await set(ref(database, `users/${window.currentUser.uid}`), {
                        ...userData,
                        postsCount: migrated,
                        poetryCount: poetryCount,
                        thoughtsCount: thoughtsCount
                    });
                }

                alert(`✅ Міграція завершена! Перенесено ${migrated} публікацій.`);
                showHome();
            } catch (error) {
                console.error('Migration error:', error);
                alert('❌ Помилка міграції');
            }
        };

        // Clean empty posts (для адміна, викликати в консолі)
        window.cleanEmptyPosts = async function() {
            if (!window.isAdmin) {
                alert('Тільки для адміна');
                return;
            }

            if (!confirm('Видалити всі порожні пости?')) return;

            try {
                const postsSnapshot = await get(ref(database, 'posts'));
                let deleted = 0;

                for (const [key, post] of Object.entries(postsSnapshot.val() || {})) {
                    if (!post.title || !post.content || !post.date || !post.userId) {
                        await remove(ref(database, `posts/${key}`));
                        deleted++;
                    }
                }

                alert(`✅ Видалено ${deleted} порожніх постів`);
                showHome();
            } catch (error) {
                console.error('Clean error:', error);
                alert('❌ Помилка очищення');
            }
        };



        // ===== POETS PAGE SEARCH =====
        window.poetsSearchQuery = '';

        window.togglePoetsSearch = function() {
            const bar = document.getElementById('poetsSearchFilterBar');
            const btn = document.getElementById('poetsSearchToggleBtn');
            if (!bar) return;
            const isOpen = bar.classList.contains('active');
            bar.classList.toggle('active', !isOpen);
            if (btn) btn.classList.toggle('active', !isOpen);
        };

        window.runPoetsSearch = function() {
            window.poetsSearchQuery = document.getElementById('poetsSearchInput').value.trim();
            document.getElementById('poetsClearBtn').style.display = window.poetsSearchQuery ? 'block' : 'none';
            renderPoetsList();
        };

        window.clearPoetsSearch = function() {
            document.getElementById('poetsSearchInput').value = '';
            window.poetsSearchQuery = '';
            document.getElementById('poetsClearBtn').style.display = 'none';
            document.getElementById('poetsSearchResultsBanner').style.display = 'none';
            renderPoetsList();
        };

        function renderPoetsList() {
            const container = document.getElementById('allPoetsContainer');
            const banner = document.getElementById('poetsSearchResultsBanner');

            let users = [...window.allUsers];

            if (window.poetsSearchQuery) {
                const q = window.poetsSearchQuery.toLowerCase();
                users = users.filter(u =>
                    (u.name && u.name.toLowerCase().includes(q)) ||
                    (u.bio && u.bio.toLowerCase().includes(q))
                );
                banner.style.display = 'block';
                banner.innerHTML = `Знайдено <strong>${users.length}</strong> ${users.length === 1 ? 'поета' : 'поетів'} за "<strong>${window.poetsSearchQuery}</strong>"`;
            } else {
                banner.style.display = 'none';
            }

            if (users.length === 0) {
                container.innerHTML = '<p style="color: var(--text-light); text-align: center; padding: 2rem;">Нікого не знайдено</p>';
                return;
            }

            const sorted = users.sort((a, b) => (b.postsCount || 0) - (a.postsCount || 0));

            container.innerHTML = sorted.map(user => `
                <div class="user-item" style="cursor: pointer; align-items: flex-start; padding: 1.2rem;" onclick="showUserProfile('${user.id}')">
                    ${user.avatarUrl
                        ? `<img src="${user.avatarUrl}" alt="${user.name}" style="width:50px;height:50px;border-radius:50%;object-fit:cover;flex-shrink:0;margin-top:0.2rem;border:2px solid var(--accent);">`
                        : `<div class="user-avatar" style="width:50px;height:50px;font-size:1.3rem;flex-shrink:0;margin-top:0.2rem;">${user.name.charAt(0).toUpperCase()}</div>`
                    }
                    <div class="user-info">
                        <div class="user-name" style="font-size: 1.1rem;">${user.name}</div>
                        <div class="user-stats" style="margin: 0.3rem 0;">
                            📝 ${user.postsCount || 0} публікацій |
                            📜 ${user.poetryCount || 0} віршів |
                            💭 ${user.thoughtsCount || 0} думок
                        </div>
                        ${user.bio ? `<div style="color: var(--text-light); font-style: italic; font-size: 0.95rem; margin-top: 0.3rem; line-height: 1.5;">${user.bio.length > 120 ? user.bio.substring(0, 120) + '...' : user.bio}</div>` : ''}
                    </div>
                </div>
            `).join('');
        }


        // ===== SINGLE POST PAGE =====
        function navigateToPost(postId) {
            const post = window.allPosts.find(p => p.id === postId);
            if (!post) {
                // Post not loaded yet — wait and retry
                setTimeout(() => navigateToPost(postId), 300);
                return;
            }

            window.currentPostId = postId; // Store for download button

            // Hide all pages
            document.getElementById('homePage').style.display = 'none';
            document.getElementById('profilePage').style.display = 'none';
            document.getElementById('allPostsPage').style.display = 'none';
            document.getElementById('poetsPage').style.display = 'none';
            document.getElementById('adminPage').style.display = 'none';
            document.getElementById('postPage').style.display = 'block';
            setHomeSearchVisible(false);

            // Fill content
            const badge = document.getElementById('postPageBadge');
            badge.textContent = post.type === 'poetry' ? 'ПОЕЗІЯ' : 'ДУМКА';

            document.getElementById('postPageTitle').textContent = post.title || 'Без назви';
            document.getElementById('postPageDate').textContent = '📅 ' + new Date(post.date).toLocaleDateString('uk-UA', { day: 'numeric', month: 'long', year: 'numeric' });
            document.getElementById('postPageContent').textContent = post.content || '';

            // Hashtags
            const hashEl = document.getElementById('postPageHashtags');
            if (post.hashtags) {
                const tags = typeof post.hashtags === 'string'
                    ? post.hashtags.split(' ').map(t => t.trim()).filter(Boolean)
                    : post.hashtags;
                hashEl.innerHTML = tags.map(t =>
                    `<span style="display:inline-block; padding:4px 12px; background:var(--bg-secondary); color:var(--accent); border-radius:15px; font-size:0.85rem; font-weight:600; margin:0.25rem 0.25rem 0.25rem 0;">${t}</span>`
                ).join('');
            } else {
                hashEl.innerHTML = '';
            }

            // Author block — click goes to profile
            const author = window.allUsers.find(u => u.id === post.userId);
            const authorName = author ? author.name : 'Невідомий автор';
            const authorInitial = authorName.charAt(0).toUpperCase();

            document.getElementById('postPageAuthorAvatar').textContent = authorInitial;
            document.getElementById('postPageAuthorName').textContent = authorName;

            const authorLink = document.getElementById('postPageAuthorLink');
            authorLink.onclick = () => {
                updateURL('profile/' + post.userId, true);
                navigateToUserProfile(post.userId);
            };

            // Update SEO meta tags
            const preview = (post.content || '').substring(0, 160).replace(/\n/g, ' ');
            updateMeta({
                title: post.title || 'Публікація',
                description: preview,
                url: '/post/' + postId,
                image: author?.avatarUrl || undefined
            });

            // Scroll to top
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        window.showPost = function(postId) {
            updateURL('post/' + postId, true);
            navigateToPost(postId);
        };

        window.sharePost = async function(postId) {
            const post = window.allPosts.find(p => p.id === postId);
            if (!post) return;

            const url = location.origin + '/post/' + postId;
            const title = post.title || 'Публікація';
            const text = (post.content || '').substring(0, 120) + (post.content && post.content.length > 120 ? '…' : '');

            // Try Web Share API (mobile/modern browsers)
            if (navigator.share) {
                try {
                    await navigator.share({ title, text, url });
                    return;
                } catch (e) {
                    if (e.name === 'AbortError') return; // user cancelled
                }
            }

            // Fallback — copy link to clipboard
            try {
                await navigator.clipboard.writeText(url);
                showShareToast('🔗 Посилання скопійовано!');
            } catch (e) {
                // Last resort — prompt
                prompt('Скопіюйте посилання:', url);
            }
        };

        function showShareToast(msg) {
            let toast = document.getElementById('shareToast');
            if (!toast) {
                toast = document.createElement('div');
                toast.id = 'shareToast';
                toast.style.cssText = `
                    position: fixed; bottom: 2rem; left: 50%; transform: translateX(-50%);
                    background: var(--accent); color: white;
                    padding: 0.65rem 1.4rem; border-radius: 24px;
                    font-family: 'Philosopher', sans-serif; font-size: 1rem; font-weight: 600;
                    box-shadow: 0 4px 16px rgba(0,0,0,0.2);
                    z-index: 9999; opacity: 0; transition: opacity 0.25s;
                    pointer-events: none;
                `;
                document.body.appendChild(toast);
            }
            toast.textContent = msg;
            toast.style.opacity = '1';
            clearTimeout(toast._timer);
            toast._timer = setTimeout(() => { toast.style.opacity = '0'; }, 2500);
        }

        // ===== HOME SEARCH & FILTER BAR =====
        window.homeSearchQuery = '';
        window.homeSearchType = 'all';
        window.homeHashtagFilter = null;

        window.toggleSearchBar = function() {
            const bar = document.getElementById('searchFilterBar');
            const toggle = document.getElementById('searchBarToggle');
            const isActive = bar.classList.toggle('active');
            if (toggle) toggle.textContent = isActive ? '▲' : '▼';
            if (isActive) {
                document.getElementById('homeSearchInput').focus();
                buildHomeHashtagChips();
            }
        };

        window.runHomeSearch = function() {
            const input = document.getElementById('homeSearchInput');
            window.homeSearchQuery = input.value.trim();
            window.homeSearchType = document.querySelector('input[name="homeSearchType"]:checked')?.value || 'all';
            const clearBtn = document.getElementById('homeClearBtn');
            clearBtn.style.display = window.homeSearchQuery ? 'block' : 'none';
            applyHomeSearch();
        };

        window.clearHomeSearch = function() {
            document.getElementById('homeSearchInput').value = '';
            window.homeSearchQuery = '';
            window.homeHashtagFilter = null;
            document.getElementById('homeClearBtn').style.display = 'none';
            document.getElementById('homeSearchResultsBanner').style.display = 'none';
            // reset hashtag chips
            document.querySelectorAll('.home-hashtag-chip').forEach(c => c.classList.remove('active'));
            applyHomeSearch();
        };

        window.toggleHomeHashtag = function(tag) {
            window.homeHashtagFilter = window.homeHashtagFilter === tag ? null : tag;
            document.querySelectorAll('.home-hashtag-chip').forEach(c => {
                c.classList.toggle('active', c.dataset.tag === window.homeHashtagFilter);
            });
            applyHomeSearch();
        };

        function buildHomeHashtagChips() {
            const allHashtags = {};
            window.allPosts.forEach(post => {
                if (post.hashtags) {
                    const tags = typeof post.hashtags === 'string'
                        ? post.hashtags.split(' ').map(t => t.trim()).filter(Boolean)
                        : post.hashtags;
                    tags.forEach(t => { allHashtags[t] = (allHashtags[t] || 0) + 1; });
                }
            });

            const sorted = Object.entries(allHashtags).sort((a, b) => b[1] - a[1]).slice(0, 15);
            const listEl = document.getElementById('homeHashtagChipsList');
            const containerEl = document.getElementById('homeHashtagChips');

            if (sorted.length === 0) {
                containerEl.style.display = 'none';
                return;
            }

            containerEl.style.display = 'flex';
            listEl.innerHTML = sorted.map(([tag, count]) =>
                `<span class="home-hashtag-chip ${window.homeHashtagFilter === tag ? 'active' : ''}"
                       data-tag="${tag}"
                       onclick="toggleHomeHashtag('${tag}')">${tag} (${count})</span>`
            ).join('');
        }

        function applyHomeSearch() {
            const query = window.homeSearchQuery.toLowerCase();
            const type = window.homeSearchType;
            const hashTag = window.homeHashtagFilter;

            let filtered = window.allPosts;

            // Hashtag filter
            if (hashTag) {
                filtered = filtered.filter(p => p.hashtags && (
                    typeof p.hashtags === 'string'
                        ? p.hashtags.includes(hashTag)
                        : p.hashtags.includes(hashTag)
                ));
            }

            // Text search
            if (query) {
                filtered = filtered.filter(p => {
                    const titleMatch = p.title && p.title.toLowerCase().includes(query);
                    const contentMatch = p.content && p.content.toLowerCase().includes(query);
                    const hashMatch = p.hashtags && (
                        typeof p.hashtags === 'string'
                            ? p.hashtags.toLowerCase().includes(query)
                            : p.hashtags.some(t => t.toLowerCase().includes(query))
                    );
                    if (type === 'title') return titleMatch;
                    if (type === 'content') return contentMatch;
                    return titleMatch || contentMatch || hashMatch;
                });
            }

            // Show/hide results banner
            const banner = document.getElementById('homeSearchResultsBanner');
            if (query || hashTag) {
                banner.style.display = 'block';
                const parts = [];
                if (query) parts.push(`"<strong>${query}</strong>"`);
                if (hashTag) parts.push(`хештег <strong>${hashTag}</strong>`);
                banner.innerHTML = `Знайдено <strong>${filtered.length}</strong> публікацій за ${parts.join(' + ')}`;
            } else {
                banner.style.display = 'none';
            }

            // Re-render home sections with filtered data
            renderHomeWithFilter(filtered);
        }

        function renderHomeWithFilter(filtered) {
            // Featured
            const featuredFiltered = filtered.filter(p => p.featured).slice(0, 8);
            const featuredContainer = document.getElementById('featuredPosts');
            if (featuredFiltered.length === 0) {
                featuredContainer.className = '';
                featuredContainer.innerHTML = '<p style="color: var(--text-light);">Немає обраних публікацій</p>';
            } else {
                featuredContainer.className = 'thoughts-scroll-row';
                featuredContainer.innerHTML = featuredFiltered.map(post => {
                    const preview = (post.content || '').length > 200 ? post.content.substring(0, 200) + '...' : (post.content || '');
                    const ws = post.type === 'poetry' ? 'pre-wrap' : 'normal';
                    return `<div class="random-card" onclick="showPost('${post.id}')">
                        <div class="random-card-title">${post.title || 'Без назви'}</div>
                        <div class="random-card-author" onclick="event.stopPropagation(); showUserProfile('${post.userId}')" style="cursor:pointer;">&#9997;&#65039; ${getUserName(post.userId)}</div>
                        <div class="random-card-content" style="white-space:${ws};">${preview}</div>
                    </div>`;
                }).join('');
            }

            // Random Poetry
            const poetryFiltered = filtered.filter(p => p.type === 'poetry');
            const randomPoetry = [...poetryFiltered].sort(() => 0.5 - Math.random()).slice(0, 8);
            const poetryContainer = document.getElementById('randomPoetry');
            if (randomPoetry.length === 0) {
                poetryContainer.className = '';
                poetryContainer.innerHTML = '<p style="color: var(--text-light);">Немає віршів</p>';
            } else {
                poetryContainer.className = 'thoughts-scroll-row';
                poetryContainer.innerHTML = randomPoetry.map(post => {
                    const preview = (post.content || '').length > 200 ? post.content.substring(0, 200) + '...' : (post.content || '');
                    return `<div class="random-card" onclick="showPost('${post.id}')">
                        <div class="random-card-title">${post.title || 'Без назви'}</div>
                        <div class="random-card-author" onclick="event.stopPropagation(); showUserProfile('${post.userId}')" style="cursor:pointer;">&#9997;&#65039; ${getUserName(post.userId)}</div>
                        <div class="random-card-content post-content" style="white-space:pre-wrap;">${preview}</div>
                    </div>`;
                }).join('');
            }

            // Random Thoughts
            const thoughtsFiltered = filtered.filter(p => p.type === 'thought');
            const randomThoughts = [...thoughtsFiltered].sort(() => 0.5 - Math.random()).slice(0, 8);
            const thoughtsContainer = document.getElementById('randomThoughts');
            if (randomThoughts.length === 0) {
                thoughtsContainer.className = '';
                thoughtsContainer.innerHTML = '<p style="color: var(--text-light);">Немає думок</p>';
            } else {
                thoughtsContainer.className = 'thoughts-scroll-row';
                thoughtsContainer.innerHTML = randomThoughts.map(post => {
                    const preview = (post.content || '').length > 200
                        ? post.content.substring(0, 200) + '...'
                        : post.content;
                    return `<div class="random-card" onclick="showPost('${post.id}')">
                        <div class="random-card-title">${post.title || 'Без назви'}</div>
                        <div class="random-card-author" onclick="event.stopPropagation(); showUserProfile('${post.userId}')" style="cursor:pointer;">&#9997;&#65039; ${getUserName(post.userId)}</div>
                        <div class="random-card-content post-content" style="white-space:normal;">${preview}</div>
                    </div>`;
                }).join('');
            }
        }

        // Close search bar when switching pages (home only)
        function closeSearchBar() {
            // intentionally left open — bar is persistent on home page
        }

        // ===== MOBILE BURGER MENU =====
        window.toggleMobileMenu = function() {
            const menu = document.getElementById('mobileMenu');
            const btn = document.getElementById('burgerBtn');
            menu.classList.toggle('open');
            btn.classList.toggle('open');
        };

        window.closeMobileMenu = function() {
            document.getElementById('mobileMenu').classList.remove('open');
            document.getElementById('burgerBtn').classList.remove('open');
        };

        // Sync mobile user menu with desktop user menu
        function syncMobileUserMenu() {
            const desktop = document.getElementById('userMenu');
            const mobile = document.getElementById('mobileUserMenu');
            if (!desktop || !mobile) return;
            // Clone content but adapt for mobile
            const user = window.currentUser;
            const userData = window.allUsers.find(u => u.id === (user && user.uid));
            if (user && userData) {
                mobile.innerHTML = `
                    <div class="mobile-user-name">👤 ${userData.name || 'Користувач'}</div>
                    <button class="btn btn-secondary" onclick="showMessages(); closeMobileMenu()" style="position:relative;">
                        💬 Повідомлення
                        <span id="msgBadgeMobile" style="display:none; position:absolute; top:-6px; right:-6px; background:#e74c3c; color:white; border-radius:50%; width:18px; height:18px; font-size:0.7rem; align-items:center; justify-content:center; font-weight:700; line-height:1;"></span>
                    </button>
                    ${window.isAdmin ? '<button class="btn btn-secondary" onclick="showAdminPanel(); closeMobileMenu()">⚙️ Адмін</button>' : ''}
                    <button class="btn btn-secondary" onclick="showMyProfile(); closeMobileMenu()">Мій профіль</button>
                    <button class="btn btn-primary" onclick="handleLogout(); closeMobileMenu()">Вийти</button>
                `;
            } else {
                mobile.innerHTML = `
                    <button class="btn btn-secondary" onclick="showAuthModal('login'); closeMobileMenu()">Увійти</button>
                    <button class="btn btn-primary" onclick="showAuthModal('register'); closeMobileMenu()">Реєстрація</button>
                `;
            }
        }

        // ========== URL ROUTING SYSTEM ==========
        
        // Прапорець для запобігання циклів
        let isNavigating = false;
        
        // Функція для оновлення URL без виклику роутера
        function updateURL(path, skipNavigation = false) {
            const newPath = path === 'home' ? '/' : '/' + path;
            if (window.location.pathname === newPath) return;
            if (skipNavigation) isNavigating = true;
            window.history.pushState({}, '', newPath);
            if (skipNavigation) setTimeout(() => { isNavigating = false; }, 10);
        }

        // Парсинг поточного URL
        function getCurrentRoute() {
            const path = window.location.pathname.replace(/^\//, '') || 'home';
            return path;
        }

        // Оновлення мета-тегів для SEO
        function updateMeta({ title, description, url, image } = {}) {
            const base = 'https://poetssociety.pages.dev';
            const fullTitle = title ? title + ' — KonVi' : 'Поетична платформа - Спільнота поетів';
            const fullUrl = url ? base + url : base + window.location.pathname;
            const fullDesc = description || 'Спільнота українських поетів. Читайте вірші та думки авторів.';
            const fullImg = image || base + '/logo.webp';

            document.title = fullTitle;
            document.getElementById('ogTitle').content = fullTitle;
            document.getElementById('ogDescription').content = fullDesc;
            document.getElementById('ogUrl').content = fullUrl;
            document.getElementById('ogImage').content = fullImg;
            document.getElementById('twitterTitle').content = fullTitle;
            document.getElementById('twitterDescription').content = fullDesc;
            document.getElementById('twitterImage').content = fullImg;
            document.getElementById('canonicalTag').href = fullUrl;
            const metaDesc = document.querySelector('meta[name="description"]');
            if (metaDesc) metaDesc.content = fullDesc;
        }

        // Внутрішні версії функцій навігації (без оновлення URL)
        function setHomeSearchVisible(visible) {
            const sticky = document.getElementById('homeSearchSticky');
            if (sticky) sticky.style.display = visible ? '' : 'none';
            document.getElementById('homeSearchResultsBanner').style.display = visible ? (window.homeSearchQuery || window.homeHashtagFilter ? 'block' : 'none') : 'none';
        }

        function hideAllPagesInternal() {
            ['homePage','profilePage','allPostsPage','poetsPage','adminPage','postPage','groupsPage','groupPage','messagesPage'].forEach(id => {
                const el = document.getElementById(id);
                if (el) el.style.display = 'none';
            });
        }

        function navigateToHome() {
            hideAllPagesInternal();
            hideHeaderFilter();
            document.getElementById('homePage').style.display = 'grid';
            setHomeSearchVisible(true);
            updateMeta({ url: '/' });
        }

        function navigateToPoets() {
            hideAllPagesInternal();
            hideHeaderFilter();
            document.getElementById('poetsPage').style.display = 'block';
            setHomeSearchVisible(false);
            loadAllPoets();
            updateMeta({ title: 'Поети', description: 'Всі поети спільноти KonVi', url: '/poets' });
        }

        function navigateToPosts() {
            hideAllPagesInternal();
            document.getElementById('allPostsPage').style.display = 'block';
            setHomeSearchVisible(false);
            loadAllPostsPage();
            showHeaderFilter('allPosts');
            updateMeta({ title: 'Всі публікації', description: 'Всі вірші та думки спільноти KonVi', url: '/posts' });
        }

        function navigateToMyProfile() {
            if (!window.currentUser) {
                alert('Спочатку увійдіть в систему');
                updateURL('home', true);
                navigateToHome();
                return;
            }
            hideAllPagesInternal();
            document.getElementById('profilePage').style.display = 'block';
            setHomeSearchVisible(false);
            loadMyProfile();
            showHeaderFilter('profile');
            updateMeta({ title: 'Мій профіль', url: '/profile' });
        }

        function navigateToUserProfile(userId) {
            hideAllPagesInternal();
            document.getElementById('profilePage').style.display = 'block';
            setHomeSearchVisible(false);
            loadUserProfile(userId);
            showHeaderFilter('profile');
            // Meta буде оновлено після завантаження даних профілю в loadUserProfile
        }

        function navigateToAdmin() {
            if (!window.isAdmin) {
                updateURL('home', true);
                navigateToHome();
                return;
            }
            hideAllPagesInternal();
            hideHeaderFilter();
            document.getElementById('adminPage').style.display = 'block';
            setHomeSearchVisible(false);
            document.querySelectorAll('.admin-tab-btn').forEach((btn, i) => btn.classList.toggle('active', i === 0));
            document.getElementById('adminTabStats').style.display = 'block';
            document.getElementById('adminTabPosts').style.display = 'none';
            document.getElementById('adminTabUsers').style.display = 'none';
            document.getElementById('adminTabTheme').style.display = 'none';
            loadAdminPanel();
            updateMeta({ title: 'Адмін панель', url: '/admin' });
        }

        // Роутер - обробляє зміни URL
        function handleRoute() {
            if (isNavigating) return; // Ігноруємо якщо ми самі змінюємо URL
            
            const route = getCurrentRoute();
            const parts = route.split('/');
            const page = parts[0];

            console.log('Routing to:', route);

            switch(page) {
                case 'home':
                    navigateToHome();
                    break;
                
                case 'poets':
                    navigateToPoets();
                    break;
                
                case 'posts':
                    navigateToPosts();
                    break;
                
                case 'post':
                    if (parts[1]) {
                        navigateToPost(parts[1]);
                    } else {
                        navigateToHome();
                    }
                    break;

                case 'profile':
                    if (parts[1]) {
                        navigateToUserProfile(parts[1]);
                    } else {
                        navigateToMyProfile();
                    }
                    break;
                
                case 'admin':
                    navigateToAdmin();
                    break;
                
                default:
                    navigateToHome();
            }
        }

        // Слухаємо зміни URL (кнопки назад/вперед)
        window.addEventListener('popstate', handleRoute);

        // Завантажуємо правильну сторінку при старті
        window.addEventListener('load', () => {
            // Встановлюємо sticky top = висота шапки
            const header = document.querySelector('.platform-header');
            const sticky = document.getElementById('homeSearchSticky');
            if (header && sticky) {
                const h = header.offsetHeight;
                sticky.style.top = h + 'px';
            }
            handleRoute();
        });

        // Оновлюємо публічні навігаційні функції - тепер вони просто змінюють URL
        window.showHome = function() {
            closeSearchBar();
            updateURL('home', true);
            navigateToHome();
        };

        window.showPoets = function() {
            updateURL('poets', true);
            navigateToPoets();
        };

        window.showAllPosts = function() {
            updateURL('posts', true);
            navigateToPosts();
        };

        window.showMyProfile = function() {
            updateURL('profile', true);
            navigateToMyProfile();
        };

        window.showUserProfile = async function(userId) {
            updateURL('profile/' + userId, true);
            navigateToUserProfile(userId);
        };

        window.showAdminPanel = function() {
            if (!window.isAdmin) return; // тихо ігноруємо якщо isAdmin ще не завантажено
            updateURL('admin', true);
            hideAllPagesInternal();
            document.getElementById('adminPage').style.display = 'block';
            setHomeSearchVisible(false);
            document.querySelectorAll('.admin-tab-btn').forEach((btn, i) => btn.classList.toggle('active', i === 0));
            document.getElementById('adminTabStats').style.display = 'block';
            document.getElementById('adminTabPosts').style.display = 'none';
            document.getElementById('adminTabUsers').style.display = 'none';
            document.getElementById('adminTabTheme').style.display = 'none';
            loadAdminPanel();
        };

        // Функція для генерації посилання на профіль
        window.getProfileLink = function(userId) {
            return window.location.origin + '/profile/' + userId;
        };

        // Функція для копіювання посилання
        window.copyProfileLink = function(userId) {
            const link = getProfileLink(userId);
            navigator.clipboard.writeText(link).then(() => {
                alert('✅ Посилання скопійовано!');
            }).catch(err => {
                prompt('Скопіюйте це посилання:', link);
            });
        };



        // ===== ADMIN PANEL TABS & THEME SETTINGS =====
        window.showAdminTab = function(tabName) {
            document.querySelectorAll('.admin-tab-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');

            document.getElementById('adminTabStats').style.display = tabName === 'stats' ? 'block' : 'none';
            document.getElementById('adminTabPosts').style.display = tabName === 'posts' ? 'block' : 'none';
            document.getElementById('adminTabUsers').style.display = tabName === 'users' ? 'block' : 'none';
            document.getElementById('adminTabTheme').style.display = tabName === 'theme' ? 'block' : 'none';

            if (tabName === 'theme') loadThemeCards();
            else if (tabName === 'stats') loadAdminStats();
            else if (tabName === 'users') loadAdminUsers();
        };


        // ============================
        // ===== ADMIN USERS TAB ======
        // ============================
        window._adminAllUsers = [];

        async function loadAdminUsers() {
            const container = document.getElementById('adminUsersList');
            container.innerHTML = '<div class="loading">Завантаження...</div>';

            const token = await window.currentUser.getIdToken();

            // Завантажуємо юзерів
            const usersResp = await fetch(`https://poetry-blog-ff72f-default-rtdb.europe-west1.firebasedatabase.app/users.json?auth=${token}`);
            const usersData = await usersResp.json();
            if (!usersData) { container.innerHTML = '<p>Немає користувачів</p>'; return; }

            // Рахуємо пости на юзера
            const postCounts = {};
            window.allPosts.forEach(p => {
                postCounts[p.userId] = (postCounts[p.userId] || 0) + 1;
            });

            window._adminAllUsers = Object.entries(usersData).map(([id, u]) => ({
                id, ...u,
                postsReal: postCounts[id] || 0
            })).sort((a, b) => (b.createdAt || 0) - (a.createdAt || 0));

            renderAdminUsers(window._adminAllUsers);
        }

        window.filterAdminUsers = function(q) {
            const filtered = window._adminAllUsers.filter(u =>
                (u.name || '').toLowerCase().includes(q.toLowerCase()) ||
                (u.email || '').toLowerCase().includes(q.toLowerCase())
            );
            renderAdminUsers(filtered);
        };

        function renderAdminUsers(users) {
            const container = document.getElementById('adminUsersList');
            if (users.length === 0) {
                container.innerHTML = '<p style="color:var(--text-lighter); text-align:center; padding:2rem;">Нікого не знайдено</p>';
                return;
            }
            container.innerHTML = users.map(u => {
                const avatar = u.avatarUrl
                    ? `<img src="${u.avatarUrl}" style="width:44px;height:44px;border-radius:50%;object-fit:cover;flex-shrink:0;">`
                    : `<div style="width:44px;height:44px;border-radius:50%;background:var(--accent-light);color:white;display:flex;align-items:center;justify-content:center;font-weight:700;font-size:1.1rem;flex-shrink:0;">${(u.name||'?').charAt(0).toUpperCase()}</div>`;
                const regDate = u.createdAt ? new Date(u.createdAt).toLocaleDateString('uk-UA') : '—';
                const isAdmin = u.id === window.adminUid;
                return `<div style="display:flex;align-items:center;gap:1rem;padding:0.85rem 1rem;border-radius:10px;border:1px solid var(--border);background:var(--bg-card);flex-wrap:wrap;">
                    ${avatar}
                    <div style="flex:1;min-width:180px;">
                        <div style="font-weight:700;font-family:'Philosopher',sans-serif;color:var(--primary);font-size:0.95rem;">
                            ${u.name || 'Без імені'}
                            ${isAdmin ? '<span style="color:var(--accent);font-size:0.75rem;margin-left:0.4rem;">👑 адмін</span>' : ''}
                        </div>
                        <div style="font-size:0.8rem;color:var(--text-lighter);margin-top:0.15rem;">
                            📅 ${regDate} &nbsp;·&nbsp; 📝 ${u.postsReal} постів &nbsp;·&nbsp; 🆔 <span style="font-family:monospace;font-size:0.75rem;">${u.id.substring(0,12)}...</span>
                        </div>
                        ${u.bio ? `<div style="font-size:0.8rem;color:var(--text-light);margin-top:0.2rem;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:400px;">${u.bio.substring(0,80)}</div>` : ''}
                    </div>
                    <div style="display:flex;gap:0.4rem;flex-wrap:wrap;flex-shrink:0;">
                        <button class="btn btn-secondary btn-small" onclick="showUserProfile('${u.id}')">👁 Профіль</button>
                        ${!isAdmin ? `<button class="btn btn-small" style="background:#e74c3c;color:white;border:none;" onclick="adminDeleteUser('${u.id}', '${u.name || 'користувача'}')">🗑 Видалити</button>` : ''}
                    </div>
                </div>`;
            }).join('');
        }

        window.adminDeleteUser = async function(userId, userName) {
            if (!confirm(`Видалити акаунт "${userName}"?\n\nЦе видалить:\n• Акаунт користувача\n• Всі його пости\n• Його повідомлення\n\nДія незворотня!`)) return;

            const token = await window.currentUser.getIdToken();
            let deleted = 0;

            // 1. Видаляємо пости юзера
            const userPosts = window.allPosts.filter(p => p.userId === userId);
            for (const post of userPosts) {
                await fetch(`https://poetry-blog-ff72f-default-rtdb.europe-west1.firebasedatabase.app/posts/${post.id}.json?auth=${token}`, { method: 'DELETE' });
                deleted++;
            }

            // 2. Видаляємо повідомлення в чатах
            const msgsResp = await fetch(`https://poetry-blog-ff72f-default-rtdb.europe-west1.firebasedatabase.app/messages.json?auth=${token}&shallow=true`);
            const chats = await msgsResp.json();
            if (chats) {
                const userChats = Object.keys(chats).filter(id => id.includes(userId));
                for (const chatId of userChats) {
                    await fetch(`https://poetry-blog-ff72f-default-rtdb.europe-west1.firebasedatabase.app/messages/${chatId}.json?auth=${token}`, { method: 'DELETE' });
                }
            }

            // 3. Видаляємо друзів
            await fetch(`https://poetry-blog-ff72f-default-rtdb.europe-west1.firebasedatabase.app/friends/${userId}.json?auth=${token}`, { method: 'DELETE' });

            // 4. Видаляємо акаунт юзера
            await fetch(`https://poetry-blog-ff72f-default-rtdb.europe-west1.firebasedatabase.app/users/${userId}.json?auth=${token}`, { method: 'DELETE' });

            alert(`✅ Акаунт "${userName}" видалено. Постів видалено: ${deleted}`);
            loadAdminUsers();
        };

        function loadThemeCards() {
            const themes = [
                { id: 'default', name: 'Класична бежева', colors: ['#faf8f3', '#8b6f47', '#2c3e50'] },
                { id: 'green', name: 'Травянисто-зелена', colors: ['#f5f9f0', '#6b8e23', '#2d5016'] },
                { id: 'ocean', name: 'Морська синя', colors: ['#f0f7fb', '#5fa8d3', '#1b4965'] },
                { id: 'lavender', name: 'Фіолетово-лавандова', colors: ['#f8f5fb', '#8b5fb0', '#4a2c62'] },
                { id: 'terracotta', name: 'Теракотово-рожева', colors: ['#fdf7f4', '#d2691e', '#8b4513'] },
                { id: 'dark', name: 'Темна', colors: ['#1a1a1a', '#c9a961', '#e8e6e3'] },
                { id: 'coffee', name: 'Кавова елегантність', colors: ['#234545', '#c9a961', '#f5f0e8'] },
                { id: 'earth-light', name: 'Мати-Земля світла', colors: ['#f5f3ed', '#8b7355', '#4a5f3d'] },
                { id: 'earth-dark', name: 'Мати-Земля темна', colors: ['#2d3a26', '#a89078', '#e8e4d5'] },
                { id: 'forest-light', name: 'Лісова кава світла', colors: ['#f0ede3', '#8b7355', '#2d5045'] },
                { id: 'forest-dark', name: 'Лісова кава темна', colors: ['#1f3a32', '#a89078', '#e5e0d0'] },
                { id: 'green-brown-light', name: 'Зелено-коричнева світла', colors: ['#fafaf8', '#6d5a3a', '#2a4a2d'] },
                { id: 'green-brown-vibrant', name: 'Соковита зелено-коричнева', colors: ['#fdfdfb', '#b8862e', '#1d5c2e'] },
                { id: 'nature-contrast', name: 'Природний контраст', colors: ['#f9f5e8', '#6d4e2a', '#2a3f2a'] },
                { id: 'nature-soft-contrast', name: "М'який природний контраст", colors: ['#faf7ed', '#7a5a2d', '#2d4a2d'] },
                { id: 'forest-palette', name: 'Лісова палітра', colors: ['#daf1de', '#397654', '#051f20'] },
                { id: 'fresh-rose', name: 'Свіжа троянда', colors: ['#fde8e8', '#c73e3e', '#2d0a0a'] },
                { id: 'golden-baroque', name: 'Золоте барокко', colors: ['#fdfaf5', '#d4a645', '#1a1410'] }
            ];

            const container = document.getElementById('themeCardsContainer');
            const currentTheme = document.documentElement.getAttribute('data-theme') || 'default';

            container.innerHTML = themes.map(theme => `
                <div class="theme-card ${theme.id === currentTheme ? 'active' : ''}" data-theme="${theme.id}" onclick="applyTheme('${theme.id}')">
                    <div class="theme-preview">
                        ${theme.colors.map(color => `<div class="theme-color" style="background: ${color};"></div>`).join('')}
                    </div>
                    <div class="theme-name">${theme.name}</div>
                    <div class="theme-check">✓</div>
                </div>
            `).join('');
        }

        window.applyTheme = async function(themeName) {
            console.log('🎨 Застосовую тему:', themeName);
            
            // Apply theme locally instantly
            if (themeName === 'default') {
                document.documentElement.removeAttribute('data-theme');
            } else {
                document.documentElement.setAttribute('data-theme', themeName);
            }
            
            // Update UI
            document.querySelectorAll('.theme-card').forEach(card => {
                card.classList.toggle('active', card.dataset.theme === themeName);
            });

            // Save to Firebase (global for all users)
            try {
                await set(ref(database, 'settings/theme'), themeName);
                const themeNames = {
                    'default': 'Класична бежева',
                    'green': 'Травянисто-зелена',
                    'ocean': 'Морська синя',
                    'lavender': 'Фіолетово-лавандова',
                    'terracotta': 'Теракотово-рожева',
                    'dark': 'Темна',
                    'coffee': 'Кавова елегантність',
                    'earth-light': 'Мати-Земля світла',
                    'earth-dark': 'Мати-Земля темна',
                    'forest-light': 'Лісова кава світла',
                    'forest-dark': 'Лісова кава темна',
                    'green-brown-light': 'Зелено-коричнева світла',
                    'green-brown-vibrant': 'Соковита зелено-коричнева',
                    'nature-contrast': 'Природний контраст',
                    'nature-soft-contrast': "М'який природний контраст",
                    'forest-palette': 'Лісова палітра',
                    'fresh-rose': 'Свіжа троянда',
                    'golden-baroque': 'Золоте барокко'
                };
                alert(`✅ Тема "${themeNames[themeName]}" застосована для всіх користувачів!`);
            } catch (error) {
                console.error('❌ Помилка збереження теми:', error);
                alert('⚠️ Тема застосована локально. Переконайтесь що Firebase Rules дозволяють запис у /settings/theme');
            }
        };

        // Load theme on startup
        async function loadGlobalTheme() {
            try {
                const themeRef = ref(database, 'settings/theme');
                const snapshot = await get(themeRef);
                if (snapshot.exists()) {
                    const themeName = snapshot.val();
                    if (themeName && themeName !== 'default') {
                        document.documentElement.setAttribute('data-theme', themeName);
                    }
                    console.log(`✓ Завантажено глобальну тему: ${themeName}`);
                }
            } catch (error) {
                console.error('Помилка завантаження теми:', error);
            }
        }

        // Call on page load
        loadGlobalTheme();

        // ===== EXPORT POST AS IMAGE =====
        window.downloadPostAsImage = async function(postId) {
    const post = window.allPosts.find(p => p.id === postId);
    if (!post) return;

    const button = event.target;
    button.disabled = true;
    button.textContent = '⏳ Створюю зображення...';

    try {
        const blob = await exportPostAsImage(post);
        const filename = `${post.title.substring(0, 30).replace(/[^a-zа-яїієґ0-9]/gi, '_')}.png`;
        downloadImage(blob, filename);
        button.textContent = '✅ Збережено!';
        setTimeout(() => {
            button.textContent = '📥 Зберегти як фото';
            button.disabled = false;
        }, 2000);
    } catch (error) {
        console.error('Error creating image:', error);
        button.textContent = '❌ Помилка';
        setTimeout(() => {
            button.textContent = '📥 Зберегти як фото';
            button.disabled = false;
        }, 2000);
    }
};

async function exportPostAsImage(post) {
    const canvas = document.createElement('canvas');
    const ctx = canvas.getContext('2d');
    
    const width = 1080;
    const height = 1080;
    canvas.width = width;
    canvas.height = height;
    
    // Отримуємо поточний розмір шрифту з налаштувань
    let savedFontSize = localStorage.getItem('fontSize');
    let fontSizeMultiplier = 1.0; // Базовий множник
    
    if (savedFontSize) {
        const sizeNum = parseInt(savedFontSize);
        // Перевіряємо чи це старий формат (85-200)
        if (sizeNum > 100) {
            // Старий формат, конвертуємо в новий
            const newValue = Math.round(((sizeNum - 85) / (200 - 85)) * 100);
            fontSizeMultiplier = 0.5 + (newValue / 100) * 2.0;
        } else {
            // Новий формат (0-100)
            fontSizeMultiplier = 0.5 + (sizeNum / 100) * 2.0;
        }
    }
    
    // Отримуємо кольори з поточної теми
    const rootStyles = getComputedStyle(document.documentElement);
    
    // Функція для отримання кольору з fallback
    const getColor = (varName, fallback) => {
        const value = rootStyles.getPropertyValue(varName).trim();
        return value || fallback;
    };
    
    const colors = {
        bgMain: getColor('--bg-main', '#faf8f3'),
        bgCard: getColor('--bg-card', '#ffffff'),
        primary: getColor('--primary', '#2c3e50'),
        accent: getColor('--accent', '#8b6f47'),
        accentLight: getColor('--accent-light', '#b8956a'),
        textMain: getColor('--text-main', '#1a1a1a'),
        textLight: getColor('--text-light', '#666666')
    };
    
    // Логуємо для діагностики
    console.log('🎨 Експорт з кольорами теми:', colors);
    
    // Фон
    ctx.fillStyle = colors.bgMain;
    ctx.fillRect(0, 0, width, height);
    
    // Градієнт з акцентним кольором теми
    const gradient = ctx.createRadialGradient(width * 0.2, height * 0.8, 0, width * 0.2, height * 0.8, width * 0.5);
    // Витягуємо RGB значення з hex або rgb формату
    const accentRGB = hexToRgb(colors.accentLight) || {r: 139, g: 111, b: 71};
    gradient.addColorStop(0, `rgba(${accentRGB.r}, ${accentRGB.g}, ${accentRGB.b}, 0.03)`);
    gradient.addColorStop(1, 'transparent');
    ctx.fillStyle = gradient;
    ctx.fillRect(0, 0, width, height);
    
    // Картка
    const padding = 60;
    const cardX = padding;
    const cardY = padding;
    const cardWidth = width - padding * 2;
    const cardHeight = height - padding * 2;
    
    ctx.shadowColor = 'rgba(0, 0, 0, 0.08)';
    ctx.shadowBlur = 20;
    ctx.shadowOffsetY = 4;
    
    ctx.fillStyle = colors.bgCard;
    roundRect(ctx, cardX, cardY, cardWidth, cardHeight, 12);
    ctx.fill();
    
    ctx.shadowColor = 'transparent';
    ctx.shadowBlur = 0;
    ctx.shadowOffsetY = 0;
    
    // Акцентна лінія зліва
    ctx.fillStyle = colors.accent;
    ctx.fillRect(cardX, cardY, 4, cardHeight);
    
    let currentY = cardY + 60;
    
    // РІЗНІ ШАБЛОНИ ДЛЯ ПОЕЗІЇ ТА ДУМОК
    if (post.type === 'poetry') {
        // ============ ШАБЛОН ДЛЯ ПОЕЗІЇ (компактний, відцентрований) ============
        
        // Спочатку рахуємо висоту контенту для центрування
        ctx.font = `bold ${Math.round(38 * fontSizeMultiplier)}px "Philosopher", Arial, sans-serif`;
        const titleHeight = measureTextHeight(ctx, post.title, cardWidth - 80, Math.round(48 * fontSizeMultiplier));
        
        ctx.font = `italic ${Math.round(26 * fontSizeMultiplier)}px Georgia, serif`;
        const contentHeight = measureTextHeight(ctx, post.content, cardWidth - 160, Math.round(26 * fontSizeMultiplier) * 1.75);
        
        const spaceBetween = 40; // Відстань між заголовком і віршем
        
        // Не враховуємо футер в центруванні - він буде окремо внизу
        const totalContentHeight = titleHeight + spaceBetween + contentHeight;
        
        // Центруємо вертикально (з урахуванням простору для футера внизу)
        const footerSpace = 40; // Резервуємо місце для футера
        currentY = cardY + (cardHeight - totalContentHeight - footerSpace) / 2;
        
        // Заголовок (відцентрований)
        ctx.fillStyle = colors.primary;
        const titleFontSize = Math.round(38 * fontSizeMultiplier);
        ctx.font = `bold ${titleFontSize}px "Philosopher", Arial, sans-serif`;
        ctx.textAlign = 'center';
        ctx.textBaseline = 'top';
        currentY = drawWrappedText(ctx, post.title, width / 2, currentY, cardWidth - 80, Math.round(48 * fontSizeMultiplier));
        
        currentY += spaceBetween; // Невелика відстань між заголовком і віршем
        
        // Текст вірша (по центру, курсивом)
        ctx.fillStyle = colors.textMain;
        const fontSize = Math.round(26 * fontSizeMultiplier);
        const lineHeight = fontSize * 1.75;
        
        ctx.font = `italic ${fontSize}px Georgia, serif`;
        ctx.textAlign = 'center';
        ctx.textBaseline = 'top';
        currentY = drawWrappedText(ctx, post.content, width / 2, currentY, cardWidth - 160, lineHeight);
        
        // Футер "Поезія KonVi" - внизу з відступом 8px
        const footerY = cardY + cardHeight - 8; // 8px від нижнього краю
        ctx.fillStyle = colors.textLight;
        ctx.font = 'italic 22px Georgia, serif';
        ctx.textAlign = 'center';
        ctx.textBaseline = 'bottom'; // Низ тексту на цій координаті
        ctx.fillText('Поезія KonVi', width / 2, footerY);
        
    } else {
        // ============ ШАБЛОН ДЛЯ ДУМОК (компактний) ============
        
        // Заголовок
        ctx.fillStyle = colors.primary;
        const titleFontSize = Math.round(52 * fontSizeMultiplier);
        ctx.font = `bold ${titleFontSize}px "Philosopher", Arial, sans-serif`;
        ctx.textAlign = 'left';
        ctx.textBaseline = 'top';
        currentY = drawWrappedText(ctx, post.title, cardX + 40, currentY, cardWidth - 80, Math.round(65 * fontSizeMultiplier));
        
        currentY += 50; // Відступ після заголовка
        
        // Текст думки (вліво)
        ctx.fillStyle = colors.textMain;
        const fontSize = Math.round(26 * fontSizeMultiplier);
        const lineHeight = fontSize * 1.75;
        
        ctx.font = `${fontSize}px Georgia, serif`;
        ctx.textAlign = 'left';
        ctx.textBaseline = 'top';
        currentY = drawWrappedText(ctx, post.content, cardX + 40, currentY, cardWidth - 80, lineHeight);
        
        currentY += 50;
        
        // Футер "Поезія KonVi" - внизу з відступом 8px
        const footerY = cardY + cardHeight - 8; // 8px від нижнього краю
        ctx.fillStyle = colors.textLight;
        ctx.font = 'italic 22px Georgia, serif';
        ctx.textAlign = 'center';
        ctx.textBaseline = 'bottom'; // Низ тексту на цій координаті
        ctx.fillText('Поезія KonVi', width / 2, footerY);
    }
    
    return new Promise((resolve) => {
        canvas.toBlob((blob) => resolve(blob), 'image/png', 1.0);
    });
}

function roundRect(ctx, x, y, width, height, radius) {
    ctx.beginPath();
    ctx.moveTo(x + radius, y);
    ctx.lineTo(x + width - radius, y);
    ctx.quadraticCurveTo(x + width, y, x + width, y + radius);
    ctx.lineTo(x + width, y + height - radius);
    ctx.quadraticCurveTo(x + width, y + height, x + width - radius, y + height);
    ctx.lineTo(x + radius, y + height);
    ctx.quadraticCurveTo(x, y + height, x, y + height - radius);
    ctx.lineTo(x, y + radius);
    ctx.quadraticCurveTo(x, y, x + radius, y);
    ctx.closePath();
}

function measureTextHeight(ctx, text, maxWidth, lineHeight) {
    const normalizedText = text.replace(/\r\n/g, '\n').replace(/\r/g, '\n');
    const lines = normalizedText.split('\n');
    let totalHeight = 0;
    let linesCount = 0;
    const maxLines = 15;
    
    for (const line of lines) {
        if (linesCount >= maxLines) break;
        
        if (line.trim() === '') {
            totalHeight += lineHeight * 0.6;
            linesCount++;
            continue;
        }
        
        const words = line.split(/\s+/);
        let currentLine = '';
        
        for (let i = 0; i < words.length; i++) {
            const testLine = currentLine + words[i] + ' ';
            const metrics = ctx.measureText(testLine);
            
            if (metrics.width > maxWidth && i > 0) {
                totalHeight += lineHeight;
                currentLine = words[i] + ' ';
                linesCount++;
                
                if (linesCount >= maxLines) break;
            } else {
                currentLine = testLine;
            }
        }
        
        if (currentLine.trim()) {
            totalHeight += lineHeight;
            linesCount++;
        }
    }
    
    return totalHeight;
}

function drawWrappedText(ctx, text, x, y, maxWidth, lineHeight) {
    // Нормалізуємо переноси рядків (різні формати)
    const normalizedText = text.replace(/\r\n/g, '\n').replace(/\r/g, '\n');
    const lines = normalizedText.split('\n');
    let currentY = y;
    let linesDrawn = 0;
    const maxLines = 15;
    
    for (const line of lines) {
        if (linesDrawn >= maxLines) {
            ctx.fillText('...', x, currentY);
            return currentY + lineHeight;
        }
        
        // Порожній рядок - зберігаємо (для строф)
        if (line.trim() === '') {
            currentY += lineHeight * 0.6; // Менший відступ для порожніх рядків
            linesDrawn++;
            continue;
        }
        
        // Розбиваємо довгі рядки по словах
        const words = line.split(/\s+/);
        let currentLine = '';
        
        for (let i = 0; i < words.length; i++) {
            const testLine = currentLine + words[i] + ' ';
            const metrics = ctx.measureText(testLine);
            
            if (metrics.width > maxWidth && i > 0) {
                ctx.fillText(currentLine.trim(), x, currentY);
                currentLine = words[i] + ' ';
                currentY += lineHeight;
                linesDrawn++;
                
                if (linesDrawn >= maxLines) {
                    ctx.fillText('...', x, currentY);
                    return currentY + lineHeight;
                }
            } else {
                currentLine = testLine;
            }
        }
        
        // Малюємо залишок рядка
        if (currentLine.trim()) {
            ctx.fillText(currentLine.trim(), x, currentY);
            currentY += lineHeight;
            linesDrawn++;
        }
    }
    
    return currentY;
}

function formatDateForImage(dateString) {
    const date = new Date(dateString);
    const months = ['січня', 'лютого', 'березня', 'квітня', 'травня', 'червня',
        'липня', 'серпня', 'вересня', 'жовтня', 'листопада', 'грудня'];
    return `${date.getDate()} ${months[date.getMonth()]} ${date.getFullYear()}`;
}

function hexToRgb(hex) {
    if (!hex) return {r: 139, g: 111, b: 71}; // Fallback
    
    // Очищаємо пробіли
    hex = hex.trim();
    
    // Якщо це вже rgb/rgba формат
    if (hex.startsWith('rgb')) {
        const match = hex.match(/\d+/g);
        if (match && match.length >= 3) {
            return {
                r: parseInt(match[0]),
                g: parseInt(match[1]),
                b: parseInt(match[2])
            };
        }
    }
    
    // Якщо hex формат
    hex = hex.replace('#', '');
    
    // Якщо короткий формат (наприклад #fff)
    if (hex.length === 3) {
        hex = hex[0] + hex[0] + hex[1] + hex[1] + hex[2] + hex[2];
    }
    
    // Перевіряємо валідність hex
    if (!/^[0-9A-Fa-f]{6}$/.test(hex)) {
        console.warn('Invalid color format:', hex);
        return {r: 139, g: 111, b: 71}; // Fallback
    }
    
    const bigint = parseInt(hex, 16);
    return {
        r: (bigint >> 16) & 255,
        g: (bigint >> 8) & 255,
        b: bigint & 255
    };
}

function downloadImage(blob, filename) {
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
}

        // ===== FRIENDS & MESSAGES =====

        function getChatId(uid1, uid2) {
            return [uid1, uid2].sort().join('_');
        }

        async function getFriendStatus(targetUserId) {
            const me = window.currentUser?.uid;
            if (!me || me === targetUserId) return 'self';
            const [friendSnap, sentSnap, receivedSnap] = await Promise.all([
                get(ref(database, `friends/${me}/${targetUserId}`)),
                get(ref(database, `friendRequests/${targetUserId}/${me}`)),
                get(ref(database, `friendRequests/${me}/${targetUserId}`)),
            ]);
            if (friendSnap.exists()) return 'friends';
            if (sentSnap.exists()) return 'pending_sent';
            if (receivedSnap.exists()) return 'pending_received';
            return 'none';
        }

        async function updateFriendBtn(targetUserId) {
            const btn = document.getElementById('friendBtn');
            const msgBtn = document.getElementById('messageBtn');
            if (!btn) return;
            if (!window.currentUser || window.currentUser.uid === targetUserId) {
                btn.style.display = 'none';
                if (msgBtn) msgBtn.style.display = 'none';
                return;
            }
            btn.style.display = '';
            const status = await getFriendStatus(targetUserId);
            if (status === 'friends') {
                btn.textContent = '✅ Друзі';
                btn.className = 'btn btn-secondary';
                if (msgBtn) msgBtn.style.display = '';
            } else if (status === 'pending_sent') {
                btn.textContent = '⏳ Запит надіслано';
                btn.className = 'btn btn-secondary';
                if (msgBtn) msgBtn.style.display = 'none';
            } else if (status === 'pending_received') {
                btn.textContent = '✅ Прийняти запит';
                btn.className = 'btn btn-primary';
                if (msgBtn) msgBtn.style.display = 'none';
            } else {
                btn.textContent = '👥 Додати в друзі';
                btn.className = 'btn btn-secondary';
                if (msgBtn) msgBtn.style.display = 'none';
            }
        }

        window.handleFriendAction = async function() {
            const me = window.currentUser?.uid;
            const target = window.currentProfileUserId;
            if (!me || !target) return;
            const status = await getFriendStatus(target);
            if (status === 'none') {
                await set(ref(database, `friendRequests/${target}/${me}`), { from: me, date: Date.now() });
                alert('✅ Запит на дружбу надіслано!');
            } else if (status === 'pending_received') {
                await Promise.all([
                    set(ref(database, `friends/${me}/${target}`), { since: Date.now() }),
                    set(ref(database, `friends/${target}/${me}`), { since: Date.now() }),
                    remove(ref(database, `friendRequests/${me}/${target}`)),
                ]);
                alert('🎉 Тепер ви друзі!');
            } else if (status === 'pending_sent') {
                if (confirm('Скасувати запит на дружбу?')) {
                    await remove(ref(database, `friendRequests/${target}/${me}`));
                }
            } else if (status === 'friends') {
                if (confirm('Видалити з друзів?')) {
                    await Promise.all([
                        remove(ref(database, `friends/${me}/${target}`)),
                        remove(ref(database, `friends/${target}/${me}`)),
                    ]);
                }
            }
            await updateFriendBtn(target);
        };

        // ---- CHAT ----
        let chatUnsubscribe = null; // функція відписки onValue
        let currentChatId = null;

        window.openChat = async function(targetUserId) {
            const me = window.currentUser?.uid;
            if (!me) { console.warn('[Chat] no user'); return; }
            const status = await getFriendStatus(targetUserId);
            console.log('[Chat] status:', status, '| me:', me, '| target:', targetUserId);
            if (status !== 'friends') { alert('Писати можна тільки друзям'); return; }

            // Відписуємось від попереднього чату
            if (chatUnsubscribe) { chatUnsubscribe(); chatUnsubscribe = null; }

            currentChatId = getChatId(me, targetUserId);
            console.log('[Chat] chatId:', currentChatId);

            const partner = window.allUsers.find(u => u.id === targetUserId);
            const partnerName = partner?.name || 'Користувач';
            document.getElementById('chatPartnerName').textContent = partnerName;
            const avatarEl = document.getElementById('chatAvatar');
            if (partner?.avatarUrl) {
                avatarEl.innerHTML = `<img src="${partner.avatarUrl}" style="width:100%;height:100%;object-fit:cover;">`;
            } else {
                avatarEl.textContent = partnerName.charAt(0).toUpperCase();
            }
            document.getElementById('chatModal').style.display = 'flex';
            document.getElementById('chatInput').focus();

            // Polling з примусовим читанням з сервера (без кешу)
            console.log('[Chat] subscribing for chatId:', currentChatId);
            const thisChatId = currentChatId;

            const loadMessages = async () => {
                if (currentChatId !== thisChatId) return;
                try {
                    // REST API з токеном авторизації
                    const token = await window.currentUser.getIdToken();
                    const resp = await fetch(`https://poetry-blog-ff72f-default-rtdb.europe-west1.firebasedatabase.app/messages/${thisChatId}.json?auth=${token}`);
                    const data = await resp.json();
                    console.log('[Chat] poll done, msgs:', data ? Object.keys(data).length : 0);

                    if (currentChatId !== thisChatId) return;
                    const container = document.getElementById('chatMessages');
                    if (!container) return;

                    if (!data) {
                        container.innerHTML = '<p style="text-align:center;color:var(--text-lighter);font-size:0.85rem;padding:2rem;">Напишіть першим!</p>';
                        return;
                    }

                    const msgs = Object.entries(data).map(([id, val]) => ({ id, ...val }));
                    msgs.sort((a, b) => a.date - b.date);

                    const wasAtBottom = container.scrollHeight - container.scrollTop - container.clientHeight < 60;

                    let lastDateStr = '';
                    const html = msgs.map(m => {
                        const isMine = m.from === me;
                        const d = new Date(m.date);
                        const dateStr = d.toLocaleDateString('uk-UA', { day: 'numeric', month: 'long' });
                        const time = d.toLocaleTimeString('uk-UA', { hour: '2-digit', minute: '2-digit' });

                        let sep = '';
                        if (dateStr !== lastDateStr) {
                            sep = `<div class="msg-date-sep"><span>${dateStr}</span></div>`;
                            lastDateStr = dateStr;
                        }

                        const ticks = isMine
                            ? m.read
                                ? `<span class="tick read">✓✓</span>`
                                : `<span class="tick sent">✓</span>`
                            : '';

                        return `${sep}<div class="msg-row ${isMine ? 'mine' : 'theirs'}">
                            <div class="msg-bubble ${isMine ? 'mine' : 'theirs'}">${escapeHtmlMsg(m.text)}</div>
                            <div class="msg-meta">${time}${ticks}</div>
                        </div>`;
                    }).join('');

                    container.innerHTML = `<div class="chat-wrap">${html}</div>`;
                    if (wasAtBottom) container.scrollTop = container.scrollHeight;

                    const unread = msgs.filter(m => m.from !== me && !m.read);
                    unread.forEach(m => {
                        set(ref(database, `messages/${thisChatId}/${m.id}/read`), true);
                    });
                } catch(e) {
                    console.error('[Chat] loadMessages error:', e);
                }
            };

            let pollActive = true;
            chatUnsubscribe = () => { pollActive = false; };

            const poll = async () => {
                if (!pollActive) return;
                await loadMessages();
                if (pollActive) setTimeout(poll, 2000);
            };
            poll();
        };

        window.closeChatModal = function() {
            document.getElementById('chatModal').style.display = 'none';
            if (chatUnsubscribe) { chatUnsubscribe(); chatUnsubscribe = null; }
            currentChatId = null;
        };

        let isSending = false;
        window.sendMessage = async function() {
            const me = window.currentUser?.uid;
            const input = document.getElementById('chatInput');
            const text = input.value.trim();
            console.log('[Chat] sendMessage | text:', text, '| chatId:', currentChatId, '| me:', me, '| isSending:', isSending);
            if (!text || !currentChatId || !me || isSending) return;
            isSending = true;
            input.value = '';
            try {
                await push(ref(database, `messages/${currentChatId}`), { from: me, text, date: Date.now(), read: false });
                console.log('[Chat] message sent OK');
                // onValue автоматично оновить UI — нічого додаткового не потрібно
            } catch(e) {
                console.error('[Chat] send error:', e);
                input.value = text;
            } finally {
                isSending = false;
            }
        };

        function escapeHtmlMsg(str = '') {
            return String(str).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
        }

        // ---- MESSAGES PAGE ----
        window.showMessages = function() {
            hideAllPages();
            document.getElementById('messagesPage').style.display = 'block';
            loadDialogs();
        };

        async function loadDialogs() {
            const me = window.currentUser?.uid;
            const container = document.getElementById('dialogsList');
            if (!me) return;
            const friendsSnap = await get(ref(database, `friends/${me}`));
            if (!friendsSnap.exists()) {
                container.innerHTML = '<p style="text-align:center;color:var(--text-lighter);">У вас поки немає друзів</p>';
                return;
            }
            const friendIds = Object.keys(friendsSnap.val());
            container.innerHTML = '<p style="color:var(--text-lighter);text-align:center;">Завантаження...</p>';
            const dialogs = await Promise.all(friendIds.map(async fid => {
                const chatId = getChatId(me, fid);
                const msgsSnap = await get(ref(database, `messages/${chatId}`));
                const friend = window.allUsers.find(u => u.id === fid);
                let lastMsg = null; let unread = 0;
                if (msgsSnap.exists()) {
                    const msgs = [];
                    msgsSnap.forEach(c => msgs.push({ id: c.key, ...c.val() }));
                    msgs.sort((a, b) => b.date - a.date);
                    lastMsg = msgs[0];
                    unread = msgs.filter(m => m.from !== me && !m.read).length;
                }
                return { fid, friend, lastMsg, unread };
            }));
            dialogs.sort((a, b) => (b.lastMsg?.date || 0) - (a.lastMsg?.date || 0));
            container.innerHTML = dialogs.map(({ fid, friend, lastMsg, unread }) => {
                const name = friend?.name || 'Користувач';
                const avatarHtml = friend?.avatarUrl
                    ? `<img src="${friend.avatarUrl}" style="width:100%;height:100%;object-fit:cover;border-radius:50%;">`
                    : name.charAt(0).toUpperCase();
                const preview = lastMsg ? escapeHtmlMsg(lastMsg.text.substring(0, 40)) : 'Немає повідомлень';
                const unreadHtml = unread > 0 ? `<div class="dialog-unread">${unread}</div>` : '';
                return `<div class="dialog-item" onclick="openChat('${fid}')">
                    <div class="dialog-avatar">${avatarHtml}</div>
                    <div style="flex:1;min-width:0;">
                        <div class="dialog-name">${escapeHtmlMsg(name)}</div>
                        <div class="dialog-preview">${preview}</div>
                    </div>
                    ${unreadHtml}
                </div>`;
            }).join('');
        }

        // ---- FONT SIZE ----
        function initFontSizeSlider() {
            let savedSize = localStorage.getItem('fontSize');
            if (savedSize) {
                const oldValue = parseInt(savedSize);
                if (oldValue > 100) savedSize = String(Math.round(((oldValue - 85) / (200 - 85)) * 100));
            } else {
                savedSize = '50';
            }

            // Ініціалізуємо всі слайдери на сторінці
            ['fontSizeSlider', 'fontSizeSlider2'].forEach(id => {
                const slider = document.getElementById(id);
                if (!slider) return;
                slider.value = savedSize;
                slider.addEventListener('input', (e) => updateFontSize(e.target.value));
            });

            updateFontSize(savedSize);
        }

        function updateFontSize(size) {
            const sizeNum = parseInt(size);
            const multiplier = 0.5 + (sizeNum / 100) * 2.0;
            window._fontMultiplier = multiplier;

            // Синхронізуємо обидва слайдери і лейбли
            ['fontSizeSlider', 'fontSizeSlider2'].forEach(id => {
                const s = document.getElementById(id);
                if (s) s.value = sizeNum;
            });
            ['fontSizeValue', 'fontSizeValue2'].forEach(id => {
                const v = document.getElementById(id);
                if (v) v.textContent = sizeNum + '%';
            });

            localStorage.setItem('fontSize', size);
            applyFontSizeToAll();
        }

        function applyFontSizeToAll() {
            const multiplier = window._fontMultiplier || 1.0;
            document.querySelectorAll('.post-content').forEach(el => {
                el.style.fontSize = (1.15 * multiplier) + 'rem';
            });
            const postPageContent = document.getElementById('postPageContent');
            if (postPageContent) postPageContent.style.fontSize = (1.25 * multiplier) + 'rem';
        }

        // MutationObserver — автоматично застосовує розмір до нових постів після рендеру
        const _fontObserver = new MutationObserver(() => applyFontSizeToAll());
        _fontObserver.observe(document.body, { childList: true, subtree: true });


        // ============================
        // ========= GROUPS ===========
        // ============================


        // --- Profile groups ---
        async function loadProfileGroups(userId) {
            const section = document.getElementById('profileGroupsSection');
            const list = document.getElementById('profileGroupsList');
            if (!section || !list) return;
            const _r3 = await fetch(`https://poetry-blog-ff72f-default-rtdb.europe-west1.firebasedatabase.app/groups.json`);
            const _d3 = await _r3.json();
            if (!_d3) { section.style.display = 'none'; return; }
            const myGroups = Object.entries(_d3)
                .map(([id, g]) => ({ id, ...g }))
                .filter(g => g.members && g.members[userId]);
            if (myGroups.length === 0) { section.style.display = 'none'; return; }
            section.style.display = 'block';
            list.innerHTML = myGroups.map(g => `
                <span onclick="showGroupPage('${g.id}')" style="cursor:pointer; background:var(--bg-secondary); border:1px solid var(--border); border-radius:20px; padding:0.2rem 0.65rem; font-size:0.82rem; color:var(--accent); font-family:'Philosopher',sans-serif; transition:background 0.15s;" onmouseover="this.style.background='var(--accent-light)';this.style.color='white'" onmouseout="this.style.background='var(--bg-secondary)';this.style.color='var(--accent)'">${g.name}</span>
            `).join('');
        }

        // --- Home groups preview ---
        async function loadHomeGroupsPreview() {
            const container = document.getElementById('homeGroupsPreview');
            if (!container) return;
            const _r2 = await fetch(`https://poetry-blog-ff72f-default-rtdb.europe-west1.firebasedatabase.app/groups.json`);
            const _d2 = await _r2.json();
            if (!_d2) { container.innerHTML = '<p style="color:var(--text-lighter); font-size:0.9rem;">Груп ще немає.</p>'; return; }
            const groups = Object.entries(_d2).map(([id, v]) => ({ id, ...v }));
            groups.sort((a, b) => (b.createdAt || 0) - (a.createdAt || 0));
            const preview = groups.slice(0, 4);
            container.innerHTML = preview.map(g => {
                const memberCount = g.members ? Object.keys(g.members).length : 0;
                return `<div onclick="showGroupPage('${g.id}')" style="display:flex; align-items:center; gap:0.75rem; padding:0.65rem; border-radius:10px; border:1px solid var(--border); cursor:pointer; transition:background 0.15s;" onmouseover="this.style.background='var(--bg-secondary)'" onmouseout="this.style.background=''">
                    ${g.avatarUrl ? `<img src="${g.avatarUrl}" style="width:40px;height:40px;border-radius:50%;object-fit:cover;flex-shrink:0;">` : `<div style="width:40px;height:40px;border-radius:50%;background:var(--accent-light);color:white;display:flex;align-items:center;justify-content:center;font-size:1.2rem;flex-shrink:0;">🫂</div>`}
                    <div style="min-width:0;">
                        <div style="font-weight:700; font-size:0.9rem; color:var(--primary); white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">${g.name}</div>
                        <div style="font-size:0.78rem; color:var(--text-lighter);">👥 ${memberCount}</div>
                    </div>
                </div>`;
            }).join('');
        }

        // --- Load & render groups list ---
        async function loadGroupsList() {
            const container = document.getElementById('groupsList');
            if (!container) return;
            container.innerHTML = '<div class="loading">Завантаження...</div>';
            const _r1 = await fetch(`https://poetry-blog-ff72f-default-rtdb.europe-west1.firebasedatabase.app/groups.json`);
            const _d1 = await _r1.json();
            if (!_d1) {
                container.innerHTML = '<p style="color:var(--text-lighter); text-align:center; padding:2rem; grid-column:1/-1;">Груп ще немає. Будь першим!</p>';
                return;
            }
            const groups = Object.entries(_d1).map(([id, v]) => ({ id, ...v }));
            groups.sort((a, b) => (b.createdAt || 0) - (a.createdAt || 0));

            container.innerHTML = groups.map(g => {
                const memberCount = g.members ? Object.keys(g.members).length : 0;
                const isMember = window.currentUser && g.members && g.members[window.currentUser.uid];
                const avatarHtml = g.avatarUrl
                    ? `<img src="${g.avatarUrl}" style="width:56px;height:56px;border-radius:50%;object-fit:cover;flex-shrink:0;">`
                    : `<div style="width:56px;height:56px;border-radius:50%;background:var(--accent-light);color:white;display:flex;align-items:center;justify-content:center;font-size:1.5rem;flex-shrink:0;">🫂</div>`;
                return `<div class="card" style="cursor:pointer; transition:box-shadow 0.2s;" onclick="showGroupPage('${g.id}')" onmouseover="this.style.boxShadow='0 4px 20px rgba(0,0,0,0.12)'" onmouseout="this.style.boxShadow=''">
                    <div style="display:flex; gap:1rem; align-items:flex-start;">
                        ${avatarHtml}
                        <div style="flex:1; min-width:0;">
                            <div style="font-family:'Philosopher',sans-serif; font-weight:700; font-size:1.1rem; color:var(--primary); margin-bottom:0.25rem;">${g.name}</div>
                            ${g.description ? `<div style="color:var(--text-light); font-size:0.88rem; margin-bottom:0.5rem; display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden;">${g.description}</div>` : ''}
                            <div style="display:flex; align-items:center; gap:0.75rem; flex-wrap:wrap;">
                                <span style="color:var(--text-lighter); font-size:0.82rem;">👥 ${memberCount} учасників</span>
                                ${g.tag ? `<span style="color:var(--accent); font-size:0.82rem;">#${g.tag}</span>` : ''}
                                ${isMember ? `<span style="color:var(--accent); font-size:0.82rem; font-weight:600;">✓ Учасник</span>` : ''}
                            </div>
                        </div>
                    </div>
                </div>`;
            }).join('');
        }

        // --- Load single group page ---
        async function loadGroupPage(groupId) {
            window.currentGroupId = groupId;
            const _tok4 = window.currentUser ? await window.currentUser.getIdToken() : '';
            const _r4 = await fetch(`https://poetry-blog-ff72f-default-rtdb.europe-west1.firebasedatabase.app/groups/${groupId}.json?auth=${_tok4}`);
            const _d4 = await _r4.json();
            if (!_d4) { alert('Групу не знайдено'); showGroups(); return; }
            const g = { id: groupId, ..._d4 };

            const avatarEl = document.getElementById('groupPageAvatar');
            avatarEl.innerHTML = g.avatarUrl
                ? `<img src="${g.avatarUrl}" style="width:72px;height:72px;border-radius:50%;object-fit:cover;">`
                : '🫂';

            document.getElementById('groupPageName').textContent = g.name;
            document.getElementById('groupPageDesc').textContent = g.description || '';
            const memberCount = g.members ? Object.keys(g.members).length : 0;
            const postCount = g.posts ? Object.keys(g.posts).length : 0;
            document.getElementById('groupPageMeta').innerHTML = `👥 ${memberCount} учасників &nbsp;·&nbsp; 📝 ${postCount} публікацій${g.tag ? ` &nbsp;·&nbsp; <span style="color:var(--accent);">#${g.tag}</span>` : ''}`;

            const me = window.currentUser?.uid;
            const isMember = me && g.members && g.members[me];
            const isAdmin = me && g.adminId === me;
            const btns = document.getElementById('groupPageBtns');
            btns.innerHTML = '';

            if (me) {
                if (isAdmin) {
                    btns.innerHTML += `<span style="color:var(--accent); font-weight:700; font-size:0.9rem; align-self:center;">👑 Адмін</span>`;
                    btns.innerHTML += `<button class="btn btn-primary btn-small" onclick="showGroupPostModal('${groupId}')">📝 Написати</button>`;
                    btns.innerHTML += `<button class="btn btn-secondary btn-small" onclick="showRepostModal('${groupId}')">🔁 Репост</button>`;
                    btns.innerHTML += `<button class="btn btn-secondary btn-small" onclick="showInviteModal('${groupId}')">📨 Запросити</button>`;
                } else if (isMember) {
                    btns.innerHTML += `<button class="btn btn-primary btn-small" onclick="showGroupPostModal('${groupId}')">📝 Написати</button>`;
                    btns.innerHTML += `<button class="btn btn-secondary btn-small" onclick="showRepostModal('${groupId}')">🔁 Репост</button>`;
                    btns.innerHTML += `<button class="btn btn-secondary btn-small" onclick="showInviteModal('${groupId}')">📨 Запросити</button>`;
                    btns.innerHTML += `<button class="btn btn-secondary btn-small" onclick="leaveGroup('${groupId}')">🚪 Вийти</button>`;
                } else {
                    btns.innerHTML += `<button class="btn btn-primary btn-small" onclick="joinGroup('${groupId}')">➕ Вступити</button>`;
                }
            }

            // Load posts
            renderGroupPosts(g);
        }

        function renderGroupPosts(g) {
            const container = document.getElementById('groupPagePosts');
            if (!g.posts) {
                container.innerHTML = '<div class="card" style="text-align:center; color:var(--text-lighter); padding:2rem;">Ще немає публікацій. Будь першим!</div>';
                return;
            }
            const posts = Object.entries(g.posts).map(([id, p]) => ({ id, ...p }));
            posts.sort((a, b) => (b.date || 0) - (a.date || 0));
            const me = window.currentUser?.uid;
            const isAdmin = me && g.adminId === me;

            container.innerHTML = posts.map(p => {
                const author = window.allUsers.find(u => u.id === p.authorId);
                const authorName = author?.name || 'Користувач';
                const isRepost = !!p.originalPostId;
                const canDelete = isAdmin || (me && p.authorId === me);
                const preview = (p.content || '').length > 300 ? p.content.substring(0, 300) + '...' : (p.content || '');

                return `<div class="card" style="margin-bottom:1.25rem;" id="gpost-${p.id}">
                    ${isRepost ? `<div style="color:var(--accent); font-size:0.82rem; margin-bottom:0.5rem; display:flex; align-items:center; gap:0.4rem;">🔁 Репост від <span onclick="showUserProfile('${p.authorId}')" style="cursor:pointer; text-decoration:underline;">${authorName}</span></div>` : ''}
                    <span class="post-type-badge">${p.type === 'poetry' ? 'ПОЕЗІЯ' : 'ДУМКА'}</span>
                    <h3 style="font-family:'Philosopher',sans-serif; font-size:1.4rem; color:var(--primary); margin:0.5rem 0; cursor:pointer;" onclick="showPost('${p.originalPostId || p.id}')">${p.title || 'Без назви'}</h3>
                    <div style="font-size:0.85rem; color:var(--text-lighter); margin-bottom:0.75rem;">
                        ✍️ <span onclick="showUserProfile('${p.authorId}')" style="cursor:pointer; color:var(--accent);">${authorName}</span>
                        &nbsp;·&nbsp; ${new Date(p.date).toLocaleDateString('uk-UA')}
                    </div>
                    <div class="post-content" style="white-space:pre-wrap; margin-bottom:0.75rem;">${preview}</div>
                    ${p.hashtags ? `<div style="color:var(--accent); font-size:0.9rem; margin-bottom:0.5rem;">${p.hashtags}</div>` : ''}
                    ${canDelete ? `<button class="btn btn-secondary btn-small" onclick="deleteGroupPost('${g.id}', '${p.id}')">🗑️ Видалити</button>` : ''}
                </div>`;
            }).join('');
            applyFontSizeToAll();
        }

        // --- Join / Leave ---
        window.joinGroup = async function(groupId) {
            const me = window.currentUser?.uid;
            if (!me) { alert('Спочатку увійдіть'); return; }
            const _tok5 = await window.currentUser.getIdToken();
            await fetch(`https://poetry-blog-ff72f-default-rtdb.europe-west1.firebasedatabase.app/groups/${groupId}/members/${me}.json?auth=${_tok5}`, {
                method: 'PUT', headers: {'Content-Type':'application/json'},
                body: JSON.stringify({ joinedAt: Date.now() })
            });
            loadGroupPage(groupId);
        };

        window.leaveGroup = async function(groupId) {
            const me = window.currentUser?.uid;
            if (!me) return;
            if (!confirm('Вийти з групи?')) return;
            const _tok6 = await window.currentUser.getIdToken();
            await fetch(`https://poetry-blog-ff72f-default-rtdb.europe-west1.firebasedatabase.app/groups/${groupId}/members/${me}.json?auth=${_tok6}`, { method: 'DELETE' });
            loadGroupPage(groupId);
        };

        // --- Create Group ---
        window.showCreateGroupModal = function() {
            document.getElementById('createGroupModal').style.display = 'flex';
        };
        window.closeCreateGroupModal = function() {
            document.getElementById('createGroupModal').style.display = 'none';
        };

        window.handleCreateGroup = async function() {
            const me = window.currentUser?.uid;
            if (!me) { alert('Спочатку увійдіть'); return; }
            const name = document.getElementById('groupNameInput').value.trim();
            const desc = document.getElementById('groupDescInput').value.trim();
            const avatar = document.getElementById('groupAvatarInput').value.trim();
            const tag = document.getElementById('groupTagInput').value.trim().replace('#', '');
            if (!name) { alert('Введіть назву групи'); return; }

            const _tok7 = await window.currentUser.getIdToken();
            const _newId = 'g' + Date.now();
            await fetch(`https://poetry-blog-ff72f-default-rtdb.europe-west1.firebasedatabase.app/groups/${_newId}.json?auth=${_tok7}`, {
                method: 'PUT', headers: {'Content-Type':'application/json'},
                body: JSON.stringify({ name, description: desc, avatarUrl: avatar, tag,
                    adminId: me, createdAt: Date.now(),
                    members: { [me]: { joinedAt: Date.now() } } })
            });
            closeCreateGroupModal();
            document.getElementById('groupNameInput').value = '';
            document.getElementById('groupDescInput').value = '';
            document.getElementById('groupAvatarInput').value = '';
            document.getElementById('groupTagInput').value = '';
            showGroupPage(_newId);
        };

        // --- Group Post Modal ---
        window.showGroupPostModal = function(groupId) {
            document.getElementById('groupPostGroupId').value = groupId;
            document.getElementById('groupPostModal').style.display = 'flex';
        };
        window.closeGroupPostModal = function() {
            document.getElementById('groupPostModal').style.display = 'none';
        };

        window.handleSubmitGroupPost = async function() {
            const me = window.currentUser?.uid;
            const groupId = document.getElementById('groupPostGroupId').value;
            const type = document.getElementById('groupPostType').value;
            const title = document.getElementById('groupPostTitle').value.trim();
            const content = document.getElementById('groupPostContent').value.trim();
            const hashtags = document.getElementById('groupPostHashtags').value.trim();
            if (!title || !content) { alert('Заповніть назву та текст'); return; }

            const _tok8 = await window.currentUser.getIdToken();
            const _pid8 = 'p' + Date.now();
            await fetch(`https://poetry-blog-ff72f-default-rtdb.europe-west1.firebasedatabase.app/groups/${groupId}/posts/${_pid8}.json?auth=${_tok8}`, {
                method: 'PUT', headers: {'Content-Type':'application/json'},
                body: JSON.stringify({ type, title, content, hashtags, authorId: me, date: Date.now() })
            });
            closeGroupPostModal();
            document.getElementById('groupPostTitle').value = '';
            document.getElementById('groupPostContent').value = '';
            document.getElementById('groupPostHashtags').value = '';
            loadGroupPage(groupId);
        };

        // --- Delete Group Post ---
        window.deleteGroupPost = async function(groupId, postId) {
            if (!confirm('Видалити публікацію з групи?')) return;
            const _tok9 = await window.currentUser.getIdToken();
            await fetch(`https://poetry-blog-ff72f-default-rtdb.europe-west1.firebasedatabase.app/groups/${groupId}/posts/${postId}.json?auth=${_tok9}`, { method: 'DELETE' });
            loadGroupPage(groupId);
        };

        // --- Repost Modal ---
        // Глобальний масив постів для репосту — доступний з inline onclick
        window._repostPosts = [];

        window.repostPickPost = function(idx) {
            const post = window._repostPosts[idx];
            if (post) window.doRepost(post.id);
        };

        window.showRepostModal = async function(groupId) {
            window._repostTargetGroup = groupId;
            document.getElementById('repostModal').style.display = 'flex';
            const me = window.currentUser?.uid;
            const list = document.getElementById('repostGroupList');
            list.innerHTML = '<p style="color:var(--text-lighter);">Завантаження ваших постів...</p>';

            const _tok10 = await window.currentUser.getIdToken();
            const _r10 = await fetch(`https://poetry-blog-ff72f-default-rtdb.europe-west1.firebasedatabase.app/posts.json?auth=${_tok10}`);
            const _d10 = await _r10.json();
            if (!_d10) { list.innerHTML = '<p style="color:var(--text-lighter);">Немає постів</p>'; return; }
            const myPosts = Object.entries(_d10)
                .map(([id, p]) => ({ id, ...p }))
                .filter(p => p.userId === me);
            myPosts.sort((a, b) => (b.date || 0) - (a.date || 0));

            if (myPosts.length === 0) { list.innerHTML = '<p style="color:var(--text-lighter);">У вас немає публікацій для репосту</p>'; return; }

            window._repostPosts = myPosts;

            list.innerHTML = myPosts.map((p, i) => `
                <div onclick="window.repostPickPost(${i})" style="width:100%; text-align:left; padding:0.65rem 0.75rem; border-radius:8px; cursor:pointer; border:1px solid var(--border); background:var(--bg-card); transition:background 0.15s; box-sizing:border-box;" onmouseover="this.style.background='var(--bg-secondary)'" onmouseout="this.style.background='var(--bg-card)'">
                    <div style="font-weight:700; font-size:0.9rem; color:var(--primary); margin-bottom:0.2rem; pointer-events:none;">${p.title || 'Без назви'}</div>
                    <div style="font-size:0.78rem; color:var(--text-lighter); pointer-events:none;">${p.type === 'poetry' ? '📜 Поезія' : '💭 Думка'} · ${new Date(p.date).toLocaleDateString('uk-UA')}</div>
                </div>
            `).join('');
        };

        window.closeRepostModal = function() {
            document.getElementById('repostModal').style.display = 'none';
        };

        window.doRepost = async function(postId) {
            const me = window.currentUser?.uid;
            const groupId = window._repostTargetGroup;

            // Беремо пост з вже завантажених даних (без зайвого fetch)
            const post = window._repostPosts.find(p => p.id == postId);
            if (!post) { alert('Пост не знайдено'); return; }

            const token = await window.currentUser.getIdToken();
            const newPostId = 'rp' + Date.now();
            await fetch(`https://poetry-blog-ff72f-default-rtdb.europe-west1.firebasedatabase.app/groups/${groupId}/posts/${newPostId}.json?auth=${token}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    type: post.type,
                    title: post.title,
                    content: post.content,
                    hashtags: post.hashtags || '',
                    authorId: me,
                    originalPostId: String(postId),
                    date: Date.now()
                })
            });
            closeRepostModal();
            loadGroupPage(groupId);
        };

        // ---- INVITE MODAL ----
        let _inviteGroupId = null;
        let _inviteAllUsers = [];

        window.showInviteModal = async function(groupId) {
            _inviteGroupId = groupId;
            document.getElementById('inviteModal').style.display = 'flex';
            document.getElementById('inviteSearchInput').value = '';
            const list = document.getElementById('inviteUserList');
            list.innerHTML = '<p style="color:var(--text-lighter); text-align:center;">Завантаження...</p>';

            const _tok11 = window.currentUser ? await window.currentUser.getIdToken() : '';
            const _r11 = await fetch(`https://poetry-blog-ff72f-default-rtdb.europe-west1.firebasedatabase.app/groups/${groupId}/members.json?auth=${_tok11}`);
            const _d11 = await _r11.json();
            const members = _d11 ? Object.keys(_d11) : [];
            const me = window.currentUser?.uid;

            _inviteAllUsers = (window.allUsers || []).filter(u => u.id !== me && !members.includes(u.id));
            renderInviteList(_inviteAllUsers);
        };

        window.closeInviteModal = function() {
            document.getElementById('inviteModal').style.display = 'none';
        };

        window.filterInviteList = function(q) {
            const filtered = _inviteAllUsers.filter(u => (u.name || '').toLowerCase().includes(q.toLowerCase()));
            renderInviteList(filtered);
        };

        function renderInviteList(users) {
            const list = document.getElementById('inviteUserList');
            if (users.length === 0) {
                list.innerHTML = '<p style="color:var(--text-lighter); text-align:center; padding:1rem;">Нікого не знайдено</p>';
                return;
            }
            list.innerHTML = users.map(u => `
                <div style="display:flex; align-items:center; gap:0.75rem; padding:0.55rem 0.5rem; border-radius:8px; border:1px solid var(--border);">
                    ${u.avatarUrl
                        ? `<img src="${u.avatarUrl}" style="width:36px;height:36px;border-radius:50%;object-fit:cover;flex-shrink:0;">`
                        : `<div style="width:36px;height:36px;border-radius:50%;background:var(--accent-light);color:white;display:flex;align-items:center;justify-content:center;font-weight:700;flex-shrink:0;">${(u.name||'?').charAt(0).toUpperCase()}</div>`
                    }
                    <div style="flex:1; font-weight:600; font-size:0.9rem; color:var(--primary);">${u.name || 'Користувач'}</div>
                    <button class="btn btn-primary btn-small" id="invite-btn-${u.id}" onclick="doInviteUser('${u.id}')">Запросити</button>
                </div>
            `).join('');
        }

        window.doInviteUser = async function(userId) {
            const btn = document.getElementById(`invite-btn-${userId}`);
            if (btn) { btn.disabled = true; btn.textContent = '✓ Додано'; }
            const _tok12 = await window.currentUser.getIdToken();
            await fetch(`https://poetry-blog-ff72f-default-rtdb.europe-west1.firebasedatabase.app/groups/${_inviteGroupId}/members/${userId}.json?auth=${_tok12}`, {
                method: 'PUT', headers: {'Content-Type':'application/json'},
                body: JSON.stringify({ joinedAt: Date.now(), invitedBy: window.currentUser?.uid })
            });
            _inviteAllUsers = _inviteAllUsers.filter(u => u.id !== userId);
        };

        // ---- FRIENDS MODAL ----
        window.showFriendsModal = async function() {
            const me = window.currentUser?.uid;
            if (!me) return;
            const modal = document.getElementById('friendsModal');
            const list = document.getElementById('friendsModalList');
            modal.style.display = 'flex';
            list.innerHTML = '<p style="color:var(--text-lighter); text-align:center;">Завантаження...</p>';

            const snap = await get(ref(database, `friends/${me}`));
            if (!snap.exists()) {
                list.innerHTML = '<p style="color:var(--text-lighter); text-align:center; padding:1.5rem;">У вас поки немає друзів</p>';
                return;
            }

            const friendIds = Object.keys(snap.val());
            const friends = friendIds.map(id => window.allUsers.find(u => u.id === id)).filter(Boolean);

            if (friends.length === 0) {
                list.innerHTML = '<p style="color:var(--text-lighter); text-align:center; padding:1.5rem;">У вас поки немає друзів</p>';
                return;
            }

            list.style.display = 'flex';
            list.style.flexDirection = 'column';
            list.style.gap = '0.25rem';
            list.innerHTML = friends.map(u => {
                const avatar = u.avatarUrl
                    ? `<img src="${u.avatarUrl}" style="width:42px;height:42px;border-radius:50%;object-fit:cover;flex-shrink:0;">`
                    : `<div style="width:42px;height:42px;border-radius:50%;background:var(--accent-light);color:white;display:flex;align-items:center;justify-content:center;font-weight:700;font-size:1.1rem;flex-shrink:0;">${(u.name||'?').charAt(0).toUpperCase()}</div>`;
                const bio = u.bio ? `<div style="font-size:0.8rem;color:var(--text-lighter);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:280px;">${u.bio.substring(0,60)}${u.bio.length>60?'...':''}</div>` : '';
                return `<button data-uid="${u.id}" style="display:flex;align-items:center;gap:0.85rem;padding:0.65rem 0.5rem;border-radius:10px;cursor:pointer;border:none;background:transparent;width:100%;text-align:left;transition:background 0.15s;" onmouseover="this.style.background='var(--bg-secondary)'" onmouseout="this.style.background='transparent'">
                    ${avatar}
                    <div>
                        <div style="font-weight:700;font-family:'Philosopher',sans-serif;color:var(--primary);">${u.name || 'Користувач'}</div>
                        ${bio}
                    </div>
                </button>`;
            }).join('');
            list.onclick = function(e) {
                const btn = e.target.closest('button[data-uid]');
                if (btn) { closeFriendsModal(); showUserProfile(btn.dataset.uid); }
            };
        };

        window.closeFriendsModal = function() {
            document.getElementById('friendsModal').style.display = 'none';
        };

        // ---- CLEANUP OLD MESSAGES ----
        async function deleteOldMessages() {
            const me = window.currentUser?.uid;
            if (!me) return;
            try {
                const token = await window.currentUser.getIdToken();
                const cutoff = Date.now() - 30 * 24 * 60 * 60 * 1000; // 30 днів

                // Отримуємо всі чати де є повідомлення
                const resp = await fetch(`https://poetry-blog-ff72f-default-rtdb.europe-west1.firebasedatabase.app/messages.json?auth=${token}&shallow=true`);
                const chats = await resp.json();
                if (!chats) return;

                // Перевіряємо тільки чати де є поточний юзер
                const myChatIds = Object.keys(chats).filter(chatId => chatId.includes(me));
                if (myChatIds.length === 0) return;

                for (const chatId of myChatIds) {
                    const msgsResp = await fetch(`https://poetry-blog-ff72f-default-rtdb.europe-west1.firebasedatabase.app/messages/${chatId}.json?auth=${token}`);
                    const msgs = await msgsResp.json();
                    if (!msgs) continue;

                    const toDelete = Object.entries(msgs)
                        .filter(([, m]) => m.date && m.date < cutoff)
                        .map(([id]) => id);

                    for (const msgId of toDelete) {
                        await fetch(`https://poetry-blog-ff72f-default-rtdb.europe-west1.firebasedatabase.app/messages/${chatId}/${msgId}.json?auth=${token}`, { method: 'DELETE' });
                    }

                    if (toDelete.length > 0) {
                        console.log(`🧹 Видалено ${toDelete.length} старих повідомлень з чату ${chatId}`);
                    }
                }
            } catch(e) {
                console.warn('Cleanup error:', e);
            }
        }

        // ---- BADGE ----
        function startMsgListener() {
            const me = window.currentUser?.uid;
            if (!me) return;
            onValue(ref(database, `friends/${me}`), async snap => {
                if (!snap.exists()) return;
                const friendIds = Object.keys(snap.val());
                let total = 0;
                await Promise.all(friendIds.map(async fid => {
                    const msgsSnap = await get(ref(database, `messages/${getChatId(me, fid)}`));
                    if (msgsSnap.exists()) msgsSnap.forEach(c => { const m = c.val(); if (m.from !== me && !m.read) total++; });
                }));
                const badge = document.getElementById('msgBadge');
                if (badge) {
                    badge.textContent = total > 0 ? total : '';
                    badge.style.display = total > 0 ? 'inline-flex' : 'none';
                }
                const badgeMobile = document.getElementById('msgBadgeMobile');
                if (badgeMobile) {
                    badgeMobile.textContent = total > 0 ? total : '';
                    badgeMobile.style.display = total > 0 ? 'inline-flex' : 'none';
                }
            });
        }


        // Ініціалізуємо повзунок розміру шрифту одразу при завантаженні
        document.addEventListener('DOMContentLoaded', () => initFontSizeSlider());

</script>

    <!-- Create Group Modal -->
    <div id="createGroupModal" onclick="closeCreateGroupModal()" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.55); z-index:1100; align-items:center; justify-content:center;">
        <div onclick="event.stopPropagation()" style="background:var(--bg-card); border-radius:14px; width:100%; max-width:500px; max-height:90vh; overflow-y:auto; margin:1rem; box-shadow:0 12px 40px rgba(0,0,0,0.25);">
            <div style="display:flex; align-items:center; justify-content:space-between; padding:1rem 1.25rem; border-bottom:1px solid var(--border); background:var(--accent); color:white; border-radius:14px 14px 0 0;">
                <span style="font-family:'Philosopher',sans-serif; font-weight:700; font-size:1.05rem;">➕ Створити групу</span>
                <button onclick="closeCreateGroupModal()" style="background:none;border:none;font-size:1.3rem;cursor:pointer;color:white;opacity:0.85;">✕</button>
            </div>
            <div style="padding:1.25rem;">
                <div class="form-group">
                    <label class="form-label">Назва групи *</label>
                    <input type="text" class="form-input" id="groupNameInput" placeholder="Наприклад: Любителі хайку">
                </div>
                <div class="form-group">
                    <label class="form-label">Опис</label>
                    <textarea class="form-input" id="groupDescInput" rows="3" placeholder="Про що ця група..."></textarea>
                </div>
                <div class="form-group">
                    <label class="form-label">Аватар (посилання на зображення)</label>
                    <input type="url" class="form-input" id="groupAvatarInput" placeholder="https://example.com/image.jpg">
                </div>
                <div class="form-group">
                    <label class="form-label">Хештег групи (без #)</label>
                    <input type="text" class="form-input" id="groupTagInput" placeholder="хайку">
                </div>
                <button class="btn btn-primary" style="width:100%; margin-top:0.5rem;" onclick="handleCreateGroup()">Створити</button>
            </div>
        </div>
    </div>

    <!-- Repost to Group Modal -->
    <div id="repostModal" onclick="closeRepostModal()" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.55); z-index:1100; align-items:center; justify-content:center;">
        <div onclick="event.stopPropagation()" style="background:var(--bg-card); border-radius:14px; width:100%; max-width:440px; margin:1rem; box-shadow:0 12px 40px rgba(0,0,0,0.25); overflow:hidden;">
            <div style="display:flex; align-items:center; justify-content:space-between; padding:1rem 1.25rem; border-bottom:1px solid var(--border); background:var(--accent); color:white;">
                <span style="font-family:'Philosopher',sans-serif; font-weight:700; font-size:1.05rem;">🔁 Репост у групу</span>
                <button onclick="closeRepostModal()" style="background:none;border:none;font-size:1.3rem;cursor:pointer;color:white;opacity:0.85;">✕</button>
            </div>
            <div style="padding:1.25rem;">
                <p style="color:var(--text-light); margin-bottom:1rem; font-size:0.95rem;">Оберіть публікацію для репосту:</p>
                <div id="repostGroupList" style="display:flex; flex-direction:column; gap:0.5rem; max-height:300px; overflow-y:auto;"></div>
            </div>
        </div>
    </div>

    <!-- Group Post Modal -->
    <div id="groupPostModal" onclick="closeGroupPostModal()" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.55); z-index:1100; align-items:center; justify-content:center;">
        <div onclick="event.stopPropagation()" style="background:var(--bg-card); border-radius:14px; width:100%; max-width:560px; max-height:90vh; overflow-y:auto; margin:1rem; box-shadow:0 12px 40px rgba(0,0,0,0.25);">
            <div style="display:flex; align-items:center; justify-content:space-between; padding:1rem 1.25rem; border-bottom:1px solid var(--border); background:var(--accent); color:white; border-radius:14px 14px 0 0;">
                <span id="groupPostModalTitle" style="font-family:'Philosopher',sans-serif; font-weight:700; font-size:1.05rem;">📝 Публікація в групу</span>
                <button onclick="closeGroupPostModal()" style="background:none;border:none;font-size:1.3rem;cursor:pointer;color:white;opacity:0.85;">✕</button>
            </div>
            <div style="padding:1.25rem;">
                <div class="form-group">
                    <label class="form-label">Тип</label>
                    <select class="form-input" id="groupPostType">
                        <option value="poetry">Поезія</option>
                        <option value="thought">Думка</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Назва</label>
                    <input type="text" class="form-input" id="groupPostTitle">
                </div>
                <div class="form-group">
                    <label class="form-label">Текст</label>
                    <textarea class="form-input" id="groupPostContent" rows="8"></textarea>
                </div>
                <div class="form-group">
                    <label class="form-label">Хештеги</label>
                    <input type="text" class="form-input" id="groupPostHashtags">
                </div>
                <input type="hidden" id="groupPostGroupId">
                <button class="btn btn-primary" style="width:100%; margin-top:0.5rem;" onclick="handleSubmitGroupPost()">Опублікувати</button>
            </div>
        </div>
    </div>

    <!-- Invite to Group Modal -->
    <div id="inviteModal" onclick="closeInviteModal()" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.55); z-index:1100; align-items:center; justify-content:center;">
        <div onclick="event.stopPropagation()" style="background:var(--bg-card); border-radius:14px; width:100%; max-width:460px; max-height:80vh; display:flex; flex-direction:column; margin:1rem; box-shadow:0 12px 40px rgba(0,0,0,0.25); overflow:hidden;">
            <div style="display:flex; align-items:center; justify-content:space-between; padding:1rem 1.25rem; border-bottom:1px solid var(--border); background:var(--accent); color:white;">
                <span style="font-family:'Philosopher',sans-serif; font-weight:700; font-size:1.05rem;">📨 Запросити у групу</span>
                <button onclick="closeInviteModal()" style="background:none;border:none;font-size:1.3rem;cursor:pointer;color:white;opacity:0.85;">✕</button>
            </div>
            <div style="padding:0.75rem 1rem 0.25rem;">
                <input type="text" id="inviteSearchInput" class="form-input" placeholder="Пошук за іменем..." oninput="filterInviteList(this.value)" style="margin-bottom:0.5rem;">
            </div>
            <div id="inviteUserList" style="overflow-y:auto; padding:0.25rem 1rem 1rem; flex:1; display:flex; flex-direction:column; gap:0.4rem;"></div>
        </div>
    </div>

    <!-- Friends Modal -->
    <div id="friendsModal" onclick="closeFriendsModal()" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.55); z-index:1100; align-items:center; justify-content:center;">
        <div onclick="event.stopPropagation()" style="background:var(--bg-card); border-radius:14px; width:100%; max-width:460px; max-height:80vh; display:flex; flex-direction:column; margin:1rem; box-shadow:0 12px 40px rgba(0,0,0,0.25); overflow:hidden;">
            <div style="display:flex; align-items:center; justify-content:space-between; padding:1rem 1.25rem; border-bottom:1px solid var(--border); background:var(--accent); color:white;">
                <span style="font-family:'Philosopher',sans-serif; font-weight:700; font-size:1.05rem;">👥 Мої друзі</span>
                <button onclick="closeFriendsModal()" style="background:none;border:none;font-size:1.3rem;cursor:pointer;color:white;opacity:0.85;">✕</button>
            </div>
            <div id="friendsModalList" style="overflow-y:auto; padding:0.75rem 1rem; flex:1;">
                <p style="color:var(--text-lighter); text-align:center;">Завантаження...</p>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer style="
        margin-top: auto;
        padding: 1.5rem 2rem;
        background: var(--bg-card);
        border-top: 2px solid var(--border);
        text-align: center;
        font-family: 'Philosopher', sans-serif;
        color: var(--text-lighter);
        font-size: 0.95rem;
        letter-spacing: 0.03em;
    ">
        Розробник by <span style="color: var(--accent); font-weight: 700;">Krasovsky</span>
    </footer>
</body>
</html>
